#!/bin/sh

# Map-E (MAP-E) 自動設定スクリプト
# OpenWrt の BusyBox Ash 互換
# Last Updated: 2025-02-21

# ** 設定変数 **
CONFIG_FILE="/etc/config/network"
WAN_INTERFACE="wan"
MAP_E_SECTION="map-e"
MAP_E_CONFIG="/etc/config/map-e"
MAP_E_TUNNEL_INTERFACE="map-e0"
MAP_E_RULE="map-rule"

RULE_PREFIX31="
hex_240b0010="106,72"
hex_240b0012="14,8"
hex_240b0250="14,10"
hex_240b0252="14,12"
hex_24047a80="133,200"
hex_24047a84="133,206"
"

RULE_PREFIX38="
hex_24047a8200="125,196,208"
hex_24047a8204="125,196,212"
hex_24047a8208="125,198,140"
hex_24047a820c="125,198,144"
hex_24047a8210="125,198,212"
hex_24047a8214="125,198,244"
hex_24047a8218="122,131,104"
hex_24047a821c="125,195,20"
hex_24047a8220="133,203,160"
hex_24047a8224="133,203,164"
hex_24047a8228="133,203,168"
hex_24047a822c="133,203,172"
hex_24047a8230="133,203,176"
hex_24047a8234="133,203,180"
hex_24047a8238="133,203,184"
hex_24047a823c="133,203,188"
hex_24047a8240="133,209,0"
hex_24047a8244="133,209,4"
hex_24047a8248="133,209,8"
hex_24047a824c="133,209,12"
hex_24047a8250="133,209,16"
hex_24047a8254="133,209,20"
hex_24047a8258="133,209,24"
hex_24047a825c="133,209,28"
hex_24047a8260="133,204,192"
hex_24047a8264="133,204,196"
hex_24047a8268="133,204,200"
hex_24047a826c="133,204,204"
hex_24047a8270="133,204,208"
hex_24047a8274="133,204,212"
hex_24047a8278="133,204,216"
hex_24047a827c="133,204,220"
hex_24047a8280="133,203,224"
hex_24047a8284="133,203,228"
hex_24047a8288="133,203,232"
hex_24047a828c="133,203,236"
hex_24047a8290="133,203,240"
hex_24047a8294="133,203,244"
hex_24047a8298="133,203,248"
hex_24047a829c="133,203,252"
hex_24047a82a0="125,194,192"
hex_24047a82a4="125,194,196"
hex_24047a82a8="125,194,200"
hex_24047a82ac="125,194,204"
hex_24047a82b0="119,239,128"
hex_24047a82b4="119,239,132"
hex_24047a82b8="119,239,136"
hex_24047a82bc="119,239,140"
hex_24047a82c0="125,194,32"
hex_24047a82c4="125,194,36"
hex_24047a82c8="125,194,40"
hex_24047a82cc="125,194,44"
hex_24047a82d0="125,195,24"
hex_24047a82d4="125,195,28"
hex_24047a82d8="122,130,192"
hex_24047a82dc="122,130,196"
hex_24047a82e0="122,135,64"
hex_24047a82e4="122,135,68"
hex_24047a82e8="125,192,240"
hex_24047a82ec="125,192,244"
hex_24047a82f0="125,193,176"
hex_24047a82f4="125,193,180"
hex_24047a82f8="122,130,176"
hex_24047a82fc="122,130,180"
hex_24047a8300="122,131,24"
hex_24047a8304="122,131,28"
hex_24047a8308="122,131,32"
hex_24047a830c="122,131,36"
hex_24047a8310="119,243,112"
hex_24047a8314="119,243,116"
hex_24047a8318="219,107,136"
hex_24047a831c="219,107,140"
hex_24047a8320="220,144,224"
hex_24047a8324="220,144,228"
hex_24047a8328="125,194,64"
hex_24047a832c="125,194,68"
hex_24047a8330="221,171,40"
hex_24047a8334="221,171,44"
hex_24047a8338="110,233,80"
hex_24047a833c="110,233,84"
hex_24047a8340="119,241,184"
hex_24047a8344="119,241,188"
hex_24047a8348="119,243,56"
hex_24047a834c="119,243,60"
hex_24047a8350="125,199,8"
hex_24047a8354="125,199,12"
hex_24047a8358="125,196,96"
hex_24047a835c="125,196,100"
hex_24047a8360="122,130,104"
hex_24047a8364="122,130,108"
hex_24047a8368="122,130,112"
hex_24047a836c="122,130,116"
hex_24047a8370="49,129,152"
hex_24047a8374="49,129,156"
hex_24047a8378="49,129,192"
hex_24047a837c="49,129,196"
hex_24047a8380="49,129,120"
hex_24047a8384="49,129,124"
hex_24047a8388="221,170,40"
hex_24047a838c="221,170,44"
hex_24047a8390="60,239,108"
hex_24047a8394="60,236,24"
hex_24047a8398="122,130,120"
hex_24047a839c="60,236,84"
hex_24047a83a0="60,239,180"
hex_24047a83a4="60,239,184"
hex_24047a83a8="118,110,136"
hex_24047a83ac="119,242,136"
hex_24047a83b0="60,238,188"
hex_24047a83b4="60,238,204"
hex_24047a83b8="122,134,52"
hex_24047a83bc="119,244,60"
hex_24047a83c0="119,243,100"
hex_24047a83c4="221,170,236"
hex_24047a83c8="221,171,48"
hex_24047a83cc="60,238,36"
hex_24047a83d0="125,195,236"
hex_24047a83d4="60,236,20"
hex_24047a83d8="118,108,76"
hex_24047a83dc="118,110,108"
hex_24047a83e0="118,110,112"
hex_24047a83e4="118,111,88"
hex_24047a83e8="118,111,228"
hex_24047a83ec="118,111,236"
hex_24047a83f0="119,241,148"
hex_24047a83f4="119,242,124"
hex_24047a83f8="125,194,28"
hex_24047a83fc="125,194,96"
hex_24047a8600="133,204,128"
hex_24047a8604="133,204,132"
hex_24047a8608="133,204,136"
hex_24047a860c="133,204,140"
hex_24047a8610="133,204,144"
hex_24047a8614="133,204,148"
hex_24047a8618="133,204,152"
hex_24047a861c="133,204,156"
hex_24047a8620="133,204,160"
hex_24047a8624="133,204,164"
hex_24047a8628="133,204,168"
hex_24047a862c="133,204,172"
hex_24047a8630="133,204,176"
hex_24047a8634="133,204,180"
hex_24047a8638="133,204,184"
hex_24047a863c="133,204,188"
hex_24047a8640="133,203,192"
hex_24047a8644="133,203,196"
hex_24047a8648="133,203,200"
hex_24047a864c="133,203,204"
hex_24047a8650="133,203,208"
hex_24047a8654="133,203,212"
hex_24047a8658="133,203,216"
hex_24047a865c="133,203,220"
hex_24047a8660="133,204,0"
hex_24047a8664="133,204,4"
hex_24047a8668="133,204,8"
hex_24047a866c="133,204,12"
hex_24047a8670="133,204,16"
hex_24047a8674="133,204,20"
hex_24047a8678="133,204,24"
hex_24047a867c="133,204,28"
hex_24047a8680="133,204,64"
hex_24047a8684="133,204,68"
hex_24047a8688="133,204,72"
hex_24047a868c="133,204,76"
hex_24047a8690="133,204,80"
hex_24047a8694="133,204,84"
hex_24047a8698="133,204,88"
hex_24047a869c="133,204,92"
hex_24047a86a0="221,171,112"
hex_24047a86a4="221,171,116"
hex_24047a86a8="221,171,120"
hex_24047a86ac="221,171,124"
hex_24047a86b0="125,195,184"
hex_24047a86b4="125,196,216"
hex_24047a86b8="221,171,108"
hex_24047a86bc="219,107,152"
hex_24047a86c0="60,239,128"
hex_24047a86c4="60,239,132"
hex_24047a86c8="60,239,136"
hex_24047a86cc="60,239,140"
hex_24047a86d0="118,110,80"
hex_24047a86d4="118,110,84"
hex_24047a86d8="118,110,88"
hex_24047a86dc="118,110,92"
hex_24047a86e0="125,194,176"
hex_24047a86e4="125,194,180"
hex_24047a86e8="125,194,184"
hex_24047a86ec="125,194,188"
hex_24047a86f0="60,239,112"
hex_24047a86f4="60,239,116"
hex_24047a86f8="60,239,120"
hex_24047a86fc="60,239,124"
hex_24047a8700="125,195,56"
hex_24047a8704="125,195,60"
hex_24047a8708="125,196,32"
hex_24047a870c="125,196,36"
hex_24047a8710="118,108,80"
hex_24047a8714="118,108,84"
hex_24047a8718="118,111,80"
hex_24047a871c="118,111,84"
hex_24047a8720="218,227,176"
hex_24047a8724="218,227,180"
hex_24047a8728="60,239,208"
hex_24047a872c="60,239,212"
hex_24047a8730="118,109,56"
hex_24047a8734="118,109,60"
hex_24047a8738="122,131,88"
hex_24047a873c="122,131,92"
hex_24047a8740="122,131,96"
hex_24047a8744="122,131,100"
hex_24047a8748="122,130,48"
hex_24047a874c="122,130,52"
hex_24047a8750="125,198,224"
hex_24047a8754="125,198,228"
hex_24047a8758="119,243,104"
hex_24047a875c="119,243,108"
hex_24047a8760="118,109,152"
hex_24047a8764="118,109,156"
hex_24047a8768="118,111,104"
hex_24047a876c="118,111,108"
hex_24047a8770="119,239,48"
hex_24047a8774="119,239,52"
hex_24047a8778="122,130,16"
hex_24047a877c="122,130,20"
hex_24047a8780="125,196,128"
hex_24047a8784="125,196,132"
hex_24047a8788="122,131,48"
hex_24047a878c="122,131,52"
hex_24047a8790="122,134,104"
hex_24047a8794="122,134,108"
hex_24047a8798="60,238,208"
hex_24047a879c="60,238,212"
hex_24047a87a0="220,144,192"
hex_24047a87a4="220,144,196"
hex_24047a87a8="110,233,48"
hex_24047a87ac="122,131,84"
hex_24047a87b0="111,169,152"
hex_24047a87b4="119,241,132"
hex_24047a87b8="119,241,136"
hex_24047a87bc="119,244,68"
hex_24047a87c0="60,236,92"
hex_24047a87c4="60,237,108"
hex_24047a87c8="60,238,12"
hex_24047a87cc="60,238,44"
hex_24047a87d0="60,238,216"
hex_24047a87d4="60,238,232"
hex_24047a87d8="49,129,72"
hex_24047a87dc="110,233,4"
hex_24047a87e0="110,233,192"
hex_24047a87e4="119,243,20"
hex_24047a87e8="119,243,24"
hex_24047a87ec="125,193,4"
hex_24047a87f0="125,193,148"
hex_24047a87f4="118,110,76"
hex_24047a87f8="118,110,96"
hex_24047a87fc="125,193,152"
"

RULE_PREFIX38_20="
hex_2400405000="153,240,0"
hex_2400405004="153,240,16"
hex_2400405008="153,240,32"
hex_240040500c="153,240,48"
hex_2400405010="153,240,64"
hex_2400405014="153,240,80"
hex_2400405018="153,240,96"
hex_240040501c="153,240,112"
hex_2400405020="153,240,128"
hex_2400405024="153,240,144"
hex_2400405028="153,240,160"
hex_240040502c="153,240,176"
hex_2400405030="153,240,192"
hex_2400405034="153,240,208"
hex_2400405038="153,240,224"
hex_240040503c="153,240,240"
hex_2400405040="153,241,0"
hex_2400405044="153,241,16"
hex_2400405048="153,241,32"
hex_240040504c="153,241,48"
hex_2400405050="153,241,64"
hex_2400405054="153,241,80"
hex_2400405058="153,241,96"
hex_240040505c="153,241,112"
hex_2400405060="153,241,128"
hex_2400405064="153,241,144"
hex_2400405068="153,241,160"
hex_240040506c="153,241,176"
hex_2400405070="153,241,192"
hex_2400405074="153,241,208"
hex_2400405078="153,241,224"
hex_240040507c="153,241,240"
hex_2400405080="153,242,0"
hex_2400405084="153,242,16"
hex_2400405088="153,242,32"
hex_240040508c="153,242,48"
hex_2400405090="153,242,64"
hex_2400405094="153,242,80"
hex_2400405098="153,242,96"
hex_240040509c="153,242,112"
hex_24004050a0="153,242,128"
hex_24004050a4="153,242,144"
hex_24004050a8="153,242,160"
hex_24004050ac="153,242,176"
hex_24004050b0="153,242,192"
hex_24004050b4="153,242,208"
hex_24004050b8="153,242,224"
hex_24004050bc="153,242,240"
hex_24004050c0="153,243,0"
hex_24004050c4="153,243,16"
hex_24004050c8="153,243,32"
hex_24004050cc="153,243,48"
hex_24004050d0="153,243,64"
hex_24004050d4="153,243,80"
hex_24004050d8="153,243,96"
hex_24004050dc="153,243,112"
hex_24004050e0="153,243,128"
hex_24004050e4="153,243,144"
hex_24004050e8="153,243,160"
hex_24004050ec="153,243,176"
hex_24004050f0="153,243,192"
hex_24004050f4="153,243,208"
hex_24004050f8="153,243,224"
hex_24004050fc="153,243,240"
hex_2400405100="122,26,0"
hex_2400405104="122,26,16"
hex_2400405108="122,26,32"
hex_240040510c="122,26,48"
hex_2400405110="122,26,64"
hex_2400405114="122,26,80"
hex_2400405118="122,26,96"
hex_240040511c="122,26,112"
hex_2400405120="114,146,64"
hex_2400405124="114,146,80"
hex_2400405128="114,146,96"
hex_240040512c="114,146,112"
hex_2400405130="114,148,192"
hex_2400405134="114,148,208"
hex_2400405138="114,148,224"
hex_240040513c="114,148,240"
hex_2400405140="114,150,192"
hex_2400405144="114,150,208"
hex_2400405148="114,150,224"
hex_240040514c="114,150,240"
hex_2400405150="114,163,64"
hex_2400405154="114,163,80"
hex_2400405158="114,163,96"
hex_240040515c="114,163,112"
hex_2400405180="114,172,192"
hex_2400405184="114,172,208"
hex_2400405188="114,172,224"
hex_240040518c="114,172,240"
hex_2400405190="114,177,64"
hex_2400405194="114,177,80"
hex_2400405198="114,177,96"
hex_240040519c="114,177,112"
hex_24004051a0="118,0,64"
hex_24004051a4="118,0,80"
hex_24004051a8="118,0,96"
hex_24004051ac="118,0,112"
hex_24004051b0="118,7,64"
hex_24004051b4="118,7,80"
hex_24004051b8="118,7,96"
hex_24004051bc="118,7,112"
hex_2400405200="123,225,192"
hex_2400405204="123,225,208"
hex_2400405208="123,225,224"
hex_240040520c="123,225,240"
hex_2400405210="153,134,0"
hex_2400405214="153,134,16"
hex_2400405218="153,134,32"
hex_240040521c="153,134,48"
hex_2400405220="153,139,128"
hex_2400405224="153,139,144"
hex_2400405228="153,139,160"
hex_240040522c="153,139,176"
hex_2400405230="153,151,64"
hex_2400405234="153,151,80"
hex_2400405238="153,151,96"
hex_240040523c="153,151,112"
hex_24004051c0="118,8,192"
hex_24004051c4="118,8,208"
hex_24004051c8="118,8,224"
hex_24004051cc="118,8,240"
hex_24004051d0="118,9,0"
hex_24004051d4="118,9,16"
hex_24004051d8="118,9,32"
hex_24004051dc="118,9,48"
hex_24004051e0="123,218,64"
hex_24004051e4="123,218,80"
hex_24004051e8="123,218,96"
hex_24004051ec="123,218,112"
hex_24004051f0="123,220,128"
hex_24004051f4="123,220,144"
hex_24004051f8="123,220,160"
hex_24004051fc="123,220,176"
hex_2400405240="153,170,64"
hex_2400405244="153,170,80"
hex_2400405248="153,170,96"
hex_240040524c="153,170,112"
hex_2400405250="153,170,192"
hex_2400405254="153,170,208"
hex_2400405258="153,170,224"
hex_240040525c="153,170,240"
hex_2400405260="61,127,128"
hex_2400405264="61,127,144"
hex_2400405268="114,146,0"
hex_240040526c="114,146,16"
hex_2400405270="114,146,128"
hex_2400405274="114,146,144"
hex_2400405278="114,148,64"
hex_240040527c="114,148,80"
hex_2400405280="114,148,160"
hex_2400405284="114,148,176"
hex_2400405288="114,149,0"
hex_240040528c="114,149,16"
hex_2400405290="114,150,160"
hex_2400405294="114,150,176"
hex_2400405298="114,158,0"
hex_240040529c="114,158,16"
hex_2400405160="114,163,128"
hex_2400405164="114,163,144"
hex_2400405168="114,163,160"
hex_240040516c="114,163,176"
hex_2400405170="114,167,64"
hex_2400405174="114,167,80"
hex_2400405178="114,167,96"
hex_240040517c="114,167,112"
hex_2400405300="114,162,128"
hex_2400405304="114,162,144"
hex_2400405308="114,163,0"
hex_240040530c="114,163,16"
hex_2400405310="114,165,224"
hex_2400405314="114,165,240"
hex_2400405318="114,167,192"
hex_240040531c="114,167,208"
hex_2400405320="114,177,128"
hex_2400405324="114,177,144"
hex_2400405328="114,178,224"
hex_240040532c="114,178,240"
hex_2400405330="118,1,0"
hex_2400405334="118,1,16"
hex_2400405338="118,3,192"
hex_240040533c="118,3,208"
hex_2400405340="118,6,64"
hex_2400405344="118,6,80"
hex_2400405348="118,7,160"
hex_240040534c="118,7,176"
hex_2400405360="118,9,128"
hex_2400405364="118,9,144"
hex_2400405368="118,22,128"
hex_240040536c="118,22,144"
hex_2400405370="122,16,0"
hex_2400405374="122,16,16"
hex_2400405378="123,220,0"
hex_240040537c="123,220,16"
hex_2400405350="118,7,192"
hex_2400405354="118,7,208"
hex_2400405358="118,9,64"
hex_240040535c="118,9,80"
hex_2400405380="153,173,0"
hex_2400405384="153,173,16"
hex_2400405388="153,173,32"
hex_240040538c="153,173,48"
hex_2400405390="153,173,64"
hex_2400405394="153,173,80"
hex_2400405398="153,173,96"
hex_240040539c="153,173,112"
hex_24004053a0="153,173,128"
hex_24004053a4="153,173,144"
hex_24004053a8="153,173,160"
hex_24004053ac="153,173,176"
hex_24004053b0="153,173,192"
hex_24004053b4="153,173,208"
hex_24004053b8="153,173,224"
hex_24004053bc="153,173,240"
hex_24004053c0="153,238,0"
hex_24004053c4="153,238,16"
hex_24004053c8="153,238,32"
hex_24004053cc="153,238,48"
hex_24004053d0="153,238,64"
hex_24004053d4="153,238,80"
hex_24004053d8="153,238,96"
hex_24004053dc="153,238,112"
hex_24004053e0="153,238,128"
hex_24004053e4="153,238,144"
hex_24004053e8="153,238,160"
hex_24004053ec="153,238,176"
hex_24004053f0="153,238,192"
hex_24004053f4="153,238,208"
hex_24004053f8="153,238,224"
hex_24004053fc="153,238,240"
hex_2400415000="153,239,0"
hex_2400415004="153,239,16"
hex_2400415008="153,239,32"
hex_240041500c="153,239,48"
hex_2400415010="153,239,64"
hex_2400415014="153,239,80"
hex_2400415018="153,239,96"
hex_240041501c="153,239,112"
hex_2400415020="153,239,128"
hex_2400415024="153,239,144"
hex_2400415028="153,239,160"
hex_240041502c="153,239,176"
hex_2400415030="153,239,192"
hex_2400415034="153,239,208"
hex_2400415038="153,239,224"
hex_240041503c="153,239,240"
hex_2400415040="153,252,0"
hex_2400415044="153,252,16"
hex_2400415048="153,252,32"
hex_240041504c="153,252,48"
hex_2400415050="153,252,64"
hex_2400415054="153,252,80"
hex_2400415058="153,252,96"
hex_240041505c="153,252,112"
hex_2400415060="153,252,128"
hex_2400415064="153,252,144"
hex_2400415068="153,252,160"
hex_240041506c="153,252,176"
hex_2400415070="153,252,192"
hex_2400415074="153,252,208"
hex_2400415078="153,252,224"
hex_240041507c="153,252,240"
hex_2400415080="123,222,96"
hex_2400415084="123,222,112"
hex_2400415088="123,225,96"
hex_240041508c="123,225,112"
hex_2400415090="123,225,160"
hex_2400415094="123,225,176"
hex_2400415098="124,84,96"
hex_240041509c="124,84,112"
hex_2400415380="180,12,128"
hex_2400415384="180,12,144"
hex_2400415388="180,26,96"
hex_240041538c="180,26,112"
hex_2400415390="180,26,160"
hex_2400415394="180,26,176"
hex_2400415398="180,26,224"
hex_240041539c="180,26,240"
hex_24004153a0="180,30,0"
hex_24004153a4="180,30,16"
hex_24004153a8="180,31,96"
hex_24004153ac="180,31,112"
hex_24004153c0="180,46,0"
hex_24004153c4="180,46,16"
hex_24004153c8="180,48,0"
hex_24004153cc="180,48,16"
hex_24004153d0="180,50,192"
hex_24004153d4="180,50,208"
hex_24004153d8="180,53,0"
hex_24004153dc="180,53,16"
hex_24004153b0="180,32,64"
hex_24004153b4="180,32,80"
hex_24004153b8="180,34,160"
hex_24004153bc="180,34,176"
hex_24004153e0="218,230,128"
hex_24004153e4="218,230,144"
hex_24004153e8="219,161,64"
hex_24004153ec="219,161,80"
hex_24004153f0="220,96,64"
hex_24004153f4="220,96,80"
hex_24004153f8="220,99,0"
hex_24004153fc="220,99,16"
hex_2400415100="180,60,0"
hex_2400415104="180,60,16"
hex_2400415108="180,60,32"
hex_240041510c="180,60,48"
hex_2400415110="180,60,64"
hex_2400415114="180,60,80"
hex_2400415118="180,60,96"
hex_240041511c="180,60,112"
hex_2400415120="180,60,128"
hex_2400415124="180,60,144"
hex_2400415128="180,60,160"
hex_240041512c="180,60,176"
hex_2400415130="180,60,192"
hex_2400415134="180,60,208"
hex_2400415138="180,60,224"
hex_240041513c="180,60,240"
hex_2400415140="153,139,0"
hex_2400415144="153,139,16"
hex_2400415148="153,139,32"
hex_240041514c="153,139,48"
hex_2400415150="153,139,64"
hex_2400415154="153,139,80"
hex_2400415158="153,139,96"
hex_240041515c="153,139,112"
hex_2400415160="219,161,128"
hex_2400415164="219,161,144"
hex_2400415168="219,161,160"
hex_240041516c="219,161,176"
hex_2400415170="219,161,192"
hex_2400415174="219,161,208"
hex_2400415178="219,161,224"
hex_240041517c="219,161,240"
hex_24004151c0="124,84,128"
hex_24004151c4="124,84,144"
hex_24004151c8="124,98,192"
hex_24004151cc="124,98,208"
hex_2400415180="153,187,0"
hex_2400415184="153,187,16"
hex_2400415188="153,187,32"
hex_240041518c="153,187,48"
hex_2400415190="153,191,0"
hex_2400415194="153,191,16"
hex_2400415198="153,191,32"
hex_240041519c="153,191,48"
hex_24004151a0="180,12,64"
hex_24004151a4="180,12,80"
hex_24004151a8="180,12,96"
hex_24004151ac="180,12,112"
hex_24004151b0="180,13,0"
hex_24004151b4="180,13,16"
hex_24004151b8="180,13,32"
hex_24004151bc="180,13,48"
hex_24004151d0="124,100,0"
hex_24004151d4="124,100,16"
hex_24004151d8="124,100,224"
hex_24004151dc="124,100,240"
hex_2400415300="153,165,96"
hex_2400415304="153,165,112"
hex_2400415308="153,165,160"
hex_240041530c="153,165,176"
hex_2400415310="153,171,224"
hex_2400415314="153,171,240"
hex_2400415318="153,175,0"
hex_240041531c="153,175,16"
hex_2400415344="220,106,48"
hex_2400415374="220,106,80"
hex_2400415340="220,106,32"
hex_2400415370="220,106,64"
hex_2400415320="153,181,0"
hex_2400415324="153,181,16"
hex_2400415328="153,183,224"
hex_240041532c="153,183,240"
hex_2400415330="153,184,128"
hex_2400415334="153,184,144"
hex_2400415338="153,187,224"
hex_240041533c="153,187,240"
hex_2400415360="153,191,192"
hex_2400415364="153,191,208"
hex_2400415348="153,188,0"
hex_240041534c="153,188,16"
hex_2400415350="153,190,128"
hex_2400415354="153,190,144"
hex_2400415358="153,191,64"
hex_240041535c="153,191,80"
hex_2400415368="153,194,96"
hex_240041536c="153,194,112"
hex_2400415200="180,16,0"
hex_2400415204="180,16,16"
hex_2400415208="180,16,32"
hex_240041520c="180,16,48"
hex_2400415210="180,29,128"
hex_2400415214="180,29,144"
hex_2400415218="180,29,160"
hex_240041521c="180,29,176"
hex_2400415220="180,59,64"
hex_2400415224="180,59,80"
hex_2400415228="180,59,96"
hex_240041522c="180,59,112"
hex_2400415230="219,161,0"
hex_2400415234="219,161,16"
hex_2400415238="219,161,32"
hex_240041523c="219,161,48"
hex_2400415250="153,131,96"
hex_2400415254="153,131,112"
hex_2400415260="153,131,128"
hex_2400415264="153,131,144"
hex_2400415268="153,132,128"
hex_240041526c="153,132,144"
hex_2400415240="153,129,160"
hex_2400415244="153,129,176"
hex_2400415248="153,130,0"
hex_240041524c="153,130,16"
hex_2400415270="153,134,64"
hex_2400415274="153,134,80"
hex_2400415278="153,137,0"
hex_240041527c="153,137,16"
hex_2400415280="153,139,192"
hex_2400415284="153,139,208"
hex_2400415288="153,151,32"
hex_240041528c="153,151,48"
hex_2400415290="153,156,96"
hex_2400415294="153,156,112"
hex_2400415298="153,156,128"
hex_240041529c="153,156,144"
"

##########################################################################

# ** デバッグ出力（必要なら "1" にする）**
DEBUG=0

debug_log() {
    [ "$DEBUG" -eq 1 ] && echo "[DEBUG] $1"
}

# ** 設定を保存する関数 **
save_config() {
    uci commit network
}

# ** 設定をリロードする関数 **
reload_network() {
    /etc/init.d/network restart
}

# ** 既存の MAP-E 設定を削除する関数 **
remove_map_e_config() {
    debug_log "Removing existing MAP-E configuration..."
    uci delete network.$MAP_E_SECTION 2>/dev/null
    uci delete network.$MAP_E_TUNNEL_INTERFACE 2>/dev/null
    uci delete firewall.$MAP_E_RULE 2>/dev/null
    save_config
}

# ** MAP-E の設定を追加する関数 **
add_map_e_config() {
    debug_log "Adding new MAP-E configuration..."

# network backup
cp /etc/config/network /etc/config/network.map-e.old
cp /etc/config/network /etc/config/dhcp.map-e.old
cp /etc/config/firewall /etc/config/firewall.map-e.old

# WAN
uci set network.wan.auto='0'

# DHCP LAN
uci set dhcp.lan.ra='relay'
uci set dhcp.lan.dhcpv6='relay'
uci set dhcp.lan.ndp='relay'
uci set dhcp.lan.force='1'

# DHCP WAN6        
uci set dhcp.wan6=dhcp
uci set dhcp.wan6.master='1'
uci set dhcp.wan6.ra='relay'
uci set dhcp.wan6.dhcpv6='relay'
uci set dhcp.wan6.ndp='relay'

# WAN6
uci set network.wan6.proto='dhcpv6'
uci set network.wan6.reqaddress='try'
uci set network.wan6.reqprefix='auto'
uci set network.wan6.ip6prefix=${CE}::/64

# WANMAPE
WANMAPE='wanmape'
uci set network.${WANMAPE}=interface
uci set network.${WANMAPE}.proto='map'
uci set network.${WANMAPE}.maptype='map-e'
uci set network.${WANMAPE}.peeraddr=${peeraddr}
uci set network.${WANMAPE}.ipaddr=${ip4a}
uci set network.${WANMAPE}.ip4prefixlen=${ip4prefixlen}
uci set network.${WANMAPE}.ip6prefix=${ip6pfx}::
uci set network.${WANMAPE}.ip6prefixlen=${ip6prefixlen}
uci set network.${WANMAPE}.ealen=${ealen}
uci set network.${WANMAPE}.psidlen=${psidlen}
uci set network.${WANMAPE}.offset=${offset}
uci set network.${WANMAPE}.mtu='1460'
uci set network.${WANMAPE}.encaplimit='ignore'

# FW
ZOON_NO='1'
uci del_list firewall.@zone[${ZOON_NO}].network='wan'
uci add_list firewall.@zone[${ZOON_NO}].network=${WANMAPE}

# Version-specific settings
OPENWRT_RELEAS=$(grep 'DISTRIB_RELEASE' /etc/openwrt_release | cut -d"'" -f2 | cut -c 1-2)
if [[ "${OPENWRT_RELEAS}" = "SN" || "${OPENWRT_RELEAS}" = "24" || "${OPENWRT_RELEAS}" = "23" || "${OPENWRT_RELEAS}" = "22" || "${OPENWRT_RELEAS}" = "21" ]]; then
  uci set dhcp.wan6.interface='wan6'
  uci set dhcp.wan6.ignore='1'
  uci set network.${WANMAPE}.legacymap='1'
  uci set network.${WANMAPE}.tunlink='wan6'
elif [[ "${OPENWRT_RELEAS}" = "19" ]]; then
  uci add_list network.${WANMAPE}.tunlink='wan6'
fi

uci commit

echo -e "\033[1;33m wan ipaddr6: ${NET_ADDR6}\033[0;33m"
echo -e "\033[1;32m wan6 ip6prefix: \033[0;39m"${CE}::/64
echo -e "\033[1;32m ${WANMAPE} peeraddr: \033[0;39m"${peeraddr}
echo -e "\033[1;32m ${WANMAPE} ip4prefixlen: \033[0;39m"${ip4prefixlen}
echo -e "\033[1;32m ${WANMAPE} ip6pfx: \033[0;39m"${ip6pfx}::
echo -e "\033[1;32m ${WANMAPE} ip6prefixlen: \033[0;39m"${ip6prefixlen}
echo -e "\033[1;32m ${WANMAPE} ealen: \033[0;39m"${ealen}
echo -e "\033[1;32m ${WANMAPE} psidlen: \033[0;39m"${psidlen}
echo -e "\033[1;32m ${WANMAPE} offset: \033[0;39m"${offset}

    save_config
    debug_log "MAP-E 設定が完了しました。"
}

# ** ルールを適用する関数 **
apply_rules() {
    for prefix in RULE_PREFIX31 RULE_PREFIX38 RULE_PREFIX38_20; do
        eval "data=\$$prefix"
        debug_log "Applying $prefix rules..."
        
        echo "$data" | while IFS="=" read -r key value; do
            key=$(echo "$key" | tr -d '"')  # 余分な " を削除
            value=$(echo "$value" | tr -d '"')  # 余分な " を削除
            debug_log "Setting rule: $prefix -> $key=$value"
            uci set network.$MAP_E_SECTION.${prefix,,}_$key="$value"
        done
    done

    save_config
}

# ** WAN インターフェースのチェック **
check_wan_interface() {
    if ! uci get network.$WAN_INTERFACE >/dev/null 2>&1; then
        echo "WAN インターフェースが設定されていません。" >&2
        exit 1
    fi
}

# ** スクリプトの実行 **
main() {
    check_wan_interface
    remove_map_e_config
    add_map_e_config
    apply_rules
    reload_network
    echo "MAP-E 設定が完了しました。"
}

main
