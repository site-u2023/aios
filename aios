#!/bin/sh

SCRIPT_VERSION="2025.03.14-00-00"

# =========================================================
# ğŸ“Œ OpenWrt / Alpine Linux POSIX-Compliant Shell Script
# ğŸš€ Last Update: 2025-02-21
#
# ğŸ·ï¸ License: CC0 (Public Domain)
# ğŸ¯ Compatibility: OpenWrt >= 19.07 (Tested on 24.10.0)
#
# âš ï¸ IMPORTANT NOTICE:
# OpenWrt OS exclusively uses **Almquist Shell (ash)** and
# is **NOT** compatible with Bourne-Again Shell (bash).
#
# ğŸ“¢ POSIX Compliance Guidelines:
# âœ… Use `[` instead of `[[` for conditions
# âœ… Use $(command) instead of backticks `command`
# âœ… Use $(( )) for arithmetic instead of let
# âœ… Define functions as func_name() {} (no function keyword)
# âœ… No associative arrays (declare -A is NOT supported)
# âœ… No here-strings (<<< is NOT supported)
# âœ… No -v flag in test or [[
# âœ… Avoid bash-specific string operations like ${var:0:3}
# âœ… Avoid arrays entirely when possible (even indexed arrays can be problematic)
# âœ… Use printf followed by read instead of read -p
# âœ… Use printf instead of echo -e for portable formatting
# âœ… Avoid process substitution <() and >()
# âœ… Prefer case statements over complex if/elif chains
# âœ… Use command -v instead of which or type for command existence checks
# âœ… Keep scripts modular with small, focused functions
# âœ… Use simple error handling instead of complex traps
# âœ… Test scripts with ash/dash explicitly, not just bash
#
# ğŸ› ï¸ Keep it simple, POSIX-compliant, and lightweight for OpenWrt!
### =========================================================
### ğŸ“Œ AI Assistance Request: POSIX-Compliant Debugging Guide
### 
### When debugging or fixing errors in this POSIX shell script:
### 
### 1ï¸âƒ£ Create a minimal reproducible test case (avoid bash features)
### 2ï¸âƒ£ Test with ash/dash explicitly: dash ./test.sh
### 3ï¸âƒ£ Use portable debugging methods: echo, printf, or set -x
### 4ï¸âƒ£ Validate fixes against all POSIX compliance guidelines
### 5ï¸âƒ£ Ensure the solution works in resource-constrained OpenWrt
### 
### âš ï¸ IMPORTANT:
### - Avoid suggesting bash-specific solutions
### - Always test fixes with ash/dash before implementation
### - Prefer simple solutions over complex ones
### - Do not modify production code without test verification
### 
### ğŸ› ï¸ Keep debugging simple, focused, and POSIX-compliant!
### =========================================================

DEV_NULL="${DEV_NULL:-on}"
# ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰
# export DEV_NULL="on"
# é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
# unset DEV_NULL

# åŸºæœ¬å®šæ•°ã®è¨­å®š 
BASE_WGET="${BASE_WGET:-wget --no-check-certificate -q -O}"
# BASE_WGET="${BASE_WGET:-wget -O}"
DEBUG_MODE="${DEBUG_MODE:-false}"
BIN_PATH=$(readlink -f "$0")
BIN_DIR="$(dirname "$BIN_PATH")"
BIN_FILE="$(basename "$BIN_PATH")"
BASE_URL="${BASE_URL:-https://raw.githubusercontent.com/site-u2023/aios/main}"
BASE_DIR="${BASE_DIR:-/tmp/aios}"
CACHE_DIR="${CACHE_DIR:-$BASE_DIR/cache}"
FEED_DIR="${FEED_DIR:-$BASE_DIR/feed}"
LOG_DIR="${LOG_DIR:-$BASE_DIR/logs}"

UPDATE_CACHE="${CACHE_DIR}/update.ch"
GITHUB_TOKEN_FILE="/etc/aios_token"
MSG_MEMORY=""

# ğŸ”µã€€ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ˜ãƒ«ãƒ—ãƒ»ã‚«ãƒ©ãƒ¼ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µ-------------------------------------------------------------------------------------------------------------------------------------------

handle_error() {
    local error_key="$1"
    local file="$2"
    local version="$3"
    local exit_required="${4:-no}"

    local error_message
    error_message=$(get_message "$error_key")

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if [ -z "$error_message" ]; then
        error_message="Unknown error occurred. Key: $error_key"
    fi

    # å¤‰æ•°ã‚’ç½®æ›
    error_message=$(echo "$error_message" | sed -e "s/{file}/$file/g" -e "s/{version}/$version/g")

    # ãƒ­ã‚°è¨˜éŒ² & è¡¨ç¤º
    debug_log "ERROR" "$error_message"
    echo -e "$(color red "$error_message")"

    if [ "$exit_required" = "yes" ]; then
        debug_log "ERROR" "Critical error occurred, exiting: $error_message"
        exit 1
    else
        debug_log "DEBUG" "Non-critical error: $error_message"
        return 1
    fi
}

debug_log() {
    local level="$1"
    local message="$2"
    local file="$3"
    local version="$4"
    local debug_level="${DEBUG_LEVEL:-ERROR}"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    
    # ãƒ¬ãƒ™ãƒ«åˆ¤å®šã®ã‚·ãƒ³ãƒ—ãƒ«åŒ–
    case "$level" in
        "DEBUG"|"INFO"|"WARN"|"ERROR") ;;
        "")
            level="DEBUG"
            message="$1"
            file="$2"
            version="$3"
            ;;
        *)
            message="$1"
            file="$2"
            version="$3"
            level="DEBUG"
            ;;
    esac

    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼‰
    if echo "$message" | grep -q "version\|Version"; then
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
        local cleaned_message="$message"
        # aios - [2025-03-10... ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
        if echo "$message" | grep -q " - "; then
            local prefix=$(echo "$message" | sed 's/ - .*//')
            local version_part=$(echo "$message" | sed 's/.* - //')
            
            # clean_version_stringé–¢æ•°ã‚’å‘¼ã³å‡ºã—
            local cleaned_version=$(clean_version_string "$version_part")
            
            cleaned_message="$prefix - $cleaned_version"
        fi
        message="$cleaned_message"
    fi

    # å¤‰æ•°ã‚’ç½®æ›
    message=$(echo "$message" | sed -e "s/{file}/$file/g" -e "s/{version}/$version/g")

    # ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡
    case "$DEBUG_LEVEL" in
        DEBUG)    allowed_levels="DEBUG INFO WARN ERROR" ;;
        INFO)     allowed_levels="INFO WARN ERROR" ;;
        WARN)     allowed_levels="WARN ERROR" ;;
        ERROR)    allowed_levels="ERROR" ;;
        *)        allowed_levels="ERROR" ;;
    esac

    if echo "$allowed_levels" | grep -q "$level"; then
        local timestamp
        timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        local log_message="[$timestamp] $level: $message"

        # ã‚«ãƒ©ãƒ¼è¡¨ç¤º - æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«å‡ºåŠ›
        case "$level" in
            "ERROR") printf "%s\n" "$(color red "$log_message")" >&2 ;;
            "WARN") printf "%s\n" "$(color yellow "$log_message")" >&2 ;;
            "INFO") printf "%s\n" "$(color cyan "$log_message")" >&2 ;;
            "DEBUG") printf "%s\n" "$(color white "$log_message")" >&2 ;;
        esac

        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
        if [ "$AIOS_INITIALIZED" = "true" ] && [ -d "$LOG_DIR" ]; then
            echo "$log_message" >> "$LOG_DIR/debug.log" 2>/dev/null
        fi
    fi
}

print_help() {
    printf "%s\n\n" "$(get_message "MSG_HELP_USAGE")"
    
    printf "%s\n" "$(get_message "MSG_HELP_OPTIONS_HEADER")"
    printf "  %-25s %s\n" "-h, --help" "$(get_message "MSG_HELP_HELP")"
    printf "  %-25s %s\n" "-v, --version" "$(get_message "MSG_HELP_VERSION")"
    printf "  %-25s %s\n" "-r, --reset" "$(get_message "MSG_HELP_RESET")"
    printf "  %-25s %s\n" "-d, --debug" "$(get_message "MSG_HELP_DEBUG")"
    printf "  %-25s %s\n" "-u, --update" "$(get_message "MSG_HELP_UPDATE")"
    printf "  %-25s %s\n" "-f, --force" "$(get_message "MSG_HELP_FORCE")"
    printf "  %-25s %s\n" "-t, --token" "$(get_message "MSG_HELP_TOKEN")"
    printf "  %-25s %s\n" "-cf, --common_full" "$(get_message "MSG_HELP_FULL")"
    printf "  %-25s %s\n" "-cl, --common_light" "$(get_message "MSG_HELP_LIGHT")"
    printf "  %-25s %s\n" "-cd, --common_debug" "$(get_message "MSG_HELP_COMMON_DEBUG")"
    printf "  %-25s %s\n" "-dr, --dry-run" "$(get_message "MSG_HELP_DRY_RUN")"
    
    printf "\n%s\n" "$(get_message "MSG_HELP_LANGUAGE_HEADER")"
    printf "  %-25s %s\n" "US, JP, ..." "$(get_message "MSG_HELP_LANGUAGE")"
    
    printf "\n%s\n" "$(get_message "MSG_HELP_EXAMPLES_HEADER")"
    printf "  %s\n" "$(get_message "MSG_HELP_EXAMPLE1")"
    printf "  %s\n" "$(get_message "MSG_HELP_EXAMPLE2")"
    printf "  %s\n" "$(get_message "MSG_HELP_EXAMPLE3")"
    printf "  %s\n" "$(get_message "MSG_HELP_EXAMPLE4")"
}

# ğŸ”´ã€€ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ˜ãƒ«ãƒ—ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ã‚«ãƒ©ãƒ¼ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

# åŸºæœ¬è‰²è¡¨ç¤ºé–¢æ•°
color() {
    local color_name="$1"
    local text=""
    
    # è‰²åã‚’æ¶ˆè²»ã—ã¦æ®‹ã‚Šã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦æ‰±ã†
    shift
    text="$*"
    
    # è‰²ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    local color_code
    color_code=$(color_code_map "$color_name")
    printf "%b%s%b" "$color_code" "$text" "\033[0m"
}

# ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°é–¢æ•°ï¼ˆåŸºæœ¬9è‰²+é»’ï¼‰
color_code_map() {
    local color="$1"
    
    case "$color" in
        # åŸºæœ¬è‰²ï¼ˆ9è‰²+é»’ï¼‰
        "red") printf "\033[38;5;196m" ;;
        "orange") printf "\033[38;5;208m" ;;
        "yellow") printf "\033[38;5;226m" ;;
        "green") printf "\033[38;5;46m" ;;
        "cyan") printf "\033[38;5;51m" ;;
        "blue") printf "\033[38;5;33m" ;;
        "indigo") printf "\033[38;5;57m" ;;
        "purple") printf "\033[38;5;129m" ;;
        "magenta") printf "\033[38;5;201m" ;;
        "white") printf "\033[37m" ;;     # ç™½è‰²
        "black") printf "\033[30m" ;;     # é»’è‰²
            
        # ãƒªã‚»ãƒƒãƒˆ
        "reset") printf "\033[0m" ;;
        *) printf "\033[0m" ;;  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒªã‚»ãƒƒãƒˆ
    esac
}

# ğŸ”´ã€€ã‚«ãƒ©ãƒ¼ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

into_memory_message() {
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ–‡å­—åˆ—ã¨ã—ã¦MSG_MEMORYã«è¿½åŠ ã™ã‚‹
    MSG_MEMORY="
US|CONFIG_DOWNLOAD_SUCCESS=Download completed:
US|CONFIG_DOWNLOAD_UNNECESSARY=No update needed:"

    debug_log "DEBUG" "Messages loaded into memory"
}

# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹é–¢æ•°
get_message() {
    local key="$1"
    local params="$2"  # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ–‡å­—åˆ—
    local lang="${lang:-US}" 
    local db_file="${db_file:-${BASE_DIR}/messages_base.db}" 
    local message=""

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸DBãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã®è¨€èªè¨­å®šå‡¦ç†
    if [ -f "${CACHE_DIR}/message.ch" ]; then
        lang=$(cat "${CACHE_DIR}/message.ch")
    elif [ -n "$ACTIVE_LANGUAGE" ]; then
        lang="$ACTIVE_LANGUAGE"
    fi
    
    # ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æ¤œç´¢
    into_memory_message
    if [ -n "$MSG_MEMORY" ]; then
        # è¨€èªå›ºæœ‰ã®ãƒ¡ãƒ¢ãƒªå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢
        message=$(echo "$MSG_MEMORY" | grep "^${lang}|${key}=" 2>/dev/null | cut -d'=' -f2-)
    fi

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã‹ã¤DBãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯æ¤œç´¢
    if [ -z "$message" ] && [ -f "$db_file" ]; then
        # ç¾åœ¨ã®è¨€èªã§DBãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
        message=$(grep "^${lang}|${key}=" "$db_file" 2>/dev/null | cut -d'=' -f2-)
        
        # è¨€èªå›ºæœ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€è‹±èªã‚’ãƒã‚§ãƒƒã‚¯
        if [ -z "$message" ] && [ "$lang" != "US" ]; then
            message=$(grep "^US|${key}=" "$db_file" 2>/dev/null | cut -d'=' -f2-)
        fi
    fi
    
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã¯ã‚­ãƒ¼ã‚’ãã®ã¾ã¾è¿”ã™
    if [ -z "$message" ]; then
        debug_log "WARNING" "Message not found for key: ${key}"
        message="$key"
    fi
    
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç½®æ›å‡¦ç†
    if [ -n "$params" ]; then
        var_name=$(echo "$params" | cut -d'=' -f1)
        var_value=$(echo "$params" | cut -d'=' -f2-)
        
        if [ -n "$var_name" ] && [ -n "$var_value" ]; then
            debug_log "DEBUG" "Replacing placeholder {$var_name} with value"
            var_value_esc=$(echo "$var_value" | sed 's/[\/&]/\\&/g')
            message=$(echo "$message" | sed "s|{$var_name}|$var_value_esc|g")
        fi
    fi
    
    echo "$message"
    return 0
}

# normalize_input é–¢æ•° - ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã‚’æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«åˆ†é›¢
normalize_input() {
    local input="$1"
    local output="$input"
    
    # ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    [ "$DEBUG_MODE" = "true" ] && printf "DEBUG: Starting character normalization for input text\n" >&2
    
    # å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå„è¡Œã¯sedã‚³ãƒãƒ³ãƒ‰ã®è² è·ã‚’åˆ†æ•£ã™ã‚‹ãŸã‚åˆ†å‰²ï¼‰
    
    # æ•°å­—ï¼ˆ0-9ï¼‰: æ—¥æœ¬èªã€ä¸­å›½èªï¼ˆç°¡ä½“å­—ãƒ»ç¹ä½“å­—ï¼‰ã€éŸ“å›½èªã§å…±é€š
    output=$(echo "$output" | sed 's/ï¼/0/g; s/ï¼‘/1/g; s/ï¼’/2/g; s/ï¼“/3/g; s/ï¼”/4/g')
    output=$(echo "$output" | sed 's/ï¼•/5/g; s/ï¼–/6/g; s/ï¼—/7/g; s/ï¼˜/8/g; s/ï¼™/9/g')
    
    # ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆå¤§æ–‡å­—ï¼ˆA-Zï¼‰: å„å›½å…±é€šã®å…¨è§’è‹±å­—
    output=$(echo "$output" | sed 's/ï¼¡/A/g; s/ï¼¢/B/g; s/ï¼£/C/g; s/ï¼¤/D/g; s/ï¼¥/E/g')
    output=$(echo "$output" | sed 's/ï¼¦/F/g; s/ï¼§/G/g; s/ï¼¨/H/g; s/ï¼©/I/g; s/ï¼ª/J/g')
    output=$(echo "$output" | sed 's/ï¼«/K/g; s/ï¼¬/L/g; s/ï¼­/M/g; s/ï¼®/N/g; s/ï¼¯/O/g')
    output=$(echo "$output" | sed 's/ï¼°/P/g; s/ï¼±/Q/g; s/ï¼²/R/g; s/ï¼³/S/g; s/ï¼´/T/g')
    output=$(echo "$output" | sed 's/ï¼µ/U/g; s/ï¼¶/V/g; s/ï¼·/W/g; s/ï¼¸/X/g; s/ï¼¹/Y/g; s/ï¼º/Z/g')
    
    # ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆå°æ–‡å­—ï¼ˆa-zï¼‰: å„å›½å…±é€šã®å…¨è§’è‹±å­—
    output=$(echo "$output" | sed 's/ï½/a/g; s/ï½‚/b/g; s/ï½ƒ/c/g; s/ï½„/d/g; s/ï½…/e/g')
    output=$(echo "$output" | sed 's/ï½†/f/g; s/ï½‡/g/g; s/ï½ˆ/h/g; s/ï½‰/i/g; s/ï½Š/j/g')
    output=$(echo "$output" | sed 's/ï½‹/k/g; s/ï½Œ/l/g; s/ï½/m/g; s/ï½/n/g; s/ï½/o/g')
    output=$(echo "$output" | sed 's/ï½/p/g; s/ï½‘/q/g; s/ï½’/r/g; s/ï½“/s/g; s/ï½”/t/g')
    output=$(echo "$output" | sed 's/ï½•/u/g; s/ï½–/v/g; s/ï½—/w/g; s/ï½˜/x/g; s/ï½™/y/g; s/ï½š/z/g')
    
    # ä¸»è¦ãªè¨˜å·ï¼ˆæ—¥æœ¬èªã€ä¸­å›½èªã€éŸ“å›½èªã§å…±é€šä½¿ç”¨ã•ã‚Œã‚‹è¨˜å·ï¼‰
    output=$(echo "$output" | sed 's/ã€€/ /g')  # å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹
    output=$(echo "$output" | sed 's/ï¼/!/g; s/ï¼‚/"/g; s/ï¼ƒ/#/g; s/ï¼„/$/g; s/ï¼…/%/g')
    output=$(echo "$output" | sed 's/ï¼†/\&/g; s/ï¼‡/'\''/g; s/ï¼ˆ/(/g; s/ï¼‰/)/g; s/ï¼Š/*/g')
    output=$(echo "$output" | sed 's/ï¼‹/+/g; s/ï¼Œ/,/g; s/ï¼/-/g; s/ï¼/./g; s/ï¼/\//g')
    
    # ä¸»è¦ãªè¨˜å·ï¼ˆç¶šãï¼‰
    output=$(echo "$output" | sed 's/ï¼š/:/g; s/ï¼›/;/g; s/ï¼œ/</g; s/ï¼/=/g; s/ï¼/>/g')
    output=$(echo "$output" | sed 's/ï¼Ÿ/?/g; s/ï¼ /@/g; s/ï¼»/[/g; s/ï¼¼/\\/g; s/ï¼½/]/g')
    output=$(echo "$output" | sed 's/ï¼¾/^/g; s/ï¼¿/_/g; s/ï½€/`/g; s/ï½›/{/g; s/ï½œ/|/g')
    output=$(echo "$output" | sed 's/ï½/}/g; s/ï½/~/g')
    
    # éŸ“å›½èªç‰¹æœ‰ã®å…¨è§’è¨˜å·
    output=$(echo "$output" | sed 's/ï¿¦/\\/g; s/ï¿¥/\\/g')
    
    # ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    [ "$DEBUG_MODE" = "true" ] && printf "DEBUG: Character normalization completed\n" >&2
    
    # æ­£è¦åŒ–ã—ãŸçµæœã®ã¿ã‚’è¿”ã™ï¼ˆãƒ‡ãƒãƒƒã‚°æƒ…å ±ãªã—ï¼‰
    printf '%s' "$output"
}

# ç¢ºèªå…¥åŠ›å‡¦ç†é–¢æ•°
confirm() {
    local msg_key="$1"
    local param_name="$2"
    local param_value="$3"
    local direct_msg="$4"
    local msg=""
    local yn=""
    
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ã¨å¤‰æ•°ç½®æ›
    if [ -n "$msg_key" ]; then
        msg=$(get_message "$msg_key")
        # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã¨å€¤ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç½®æ›
        if [ -n "$param_name" ] && [ -n "$param_value" ]; then
            # POSIXã«æº–æ‹ ã—ãŸç½®æ›æ–¹æ³•ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’è¿½åŠ ï¼‰
            local safe_value=$(echo "$param_value" | sed 's/[\/&]/\\&/g')
            msg=$(echo "$msg" | sed "s|{$param_name}|$safe_value|g")
        fi
    else
        # ç›´æ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
        msg="$direct_msg"
    fi
    
    debug_log "DEBUG" "Confirm prompt: $msg_key: $msg"
    
    # ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤º
    printf "%s " "$(color white "$msg")"

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å‡¦ç†
    while true; do
        # readã‚³ãƒãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        if ! read -r yn; then
            debug_log "ERROR" "Failed to read user input"
            return 1
        fi

        printf "\n"

        # å…¥åŠ›ã®æ­£è¦åŒ–ï¼ˆæ•°å­—ã®ã¿æ­£è¦åŒ–ã—ã€å¤§æ–‡å­—å°æ–‡å­—ã¯å¤‰æ›ã—ãªã„ï¼‰
        yn=$(normalize_input "$yn")
        debug_log "DEBUG" "User input: $yn, normalized to: $yn"

        # å…¥åŠ›ã®æ¤œè¨¼ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ä¸¡æ–¹ã«å¯¾å¿œï¼‰
        case "$yn" in
            [Yy]|[Yy][Ee][Ss]) 
                debug_log "DEBUG" "User confirmed: Yes"
                # ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«çµæœã‚’ä¿å­˜ï¼ˆå‘¼ã³å‡ºã—å´ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ï¼‰
                CONFIRM_RESULT="Y"
                return 0 
                ;;
            [Nn]|[Nn][Oo]) 
                debug_log "DEBUG" "User confirmed: No"
                CONFIRM_RESULT="N"
                return 1 
                ;;
            [Rr]|[Rr][Ee][Tt][Uu][Rr][Nn])
                # ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³å¯¾å¿œ
                debug_log "DEBUG" "User selected: Return to previous step"
                CONFIRM_RESULT="R"
                return 2
                ;;
            *) 
                # ç„¡åŠ¹ãªå…¥åŠ›ã®å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                printf "%s\n" "$(color red "$(get_message "MSG_INVALID_INPUT_YNR")")"
                printf "%s " "$(color white "$msg")" 
                ;;
        esac
    done

    printf "%s\n"
}

# ğŸ”´ã€€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒˆãƒ¼ã‚¯ãƒ³ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

github_api_request() {
    local endpoint="$1"
    local token=$(get_github_token)
    local response=""
    
    if [ -n "$token" ]; then
        debug_log "DEBUG" "Attempting authenticated request with token (${#token} chars)"
        response=$(wget -q --header="Authorization: token $token" \
            --header="Accept: application/vnd.github.v3+json" \
            -O- "https://api.github.com/$endpoint" 2>/dev/null)
            
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼ - ãƒªãƒŸãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        if echo "$response" | grep -q '"message":"API rate limit exceeded'; then
            debug_log "WARN" "GitHub API rate limit exceeded"
            return 1
        fi
        
        # èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        if echo "$response" | grep -q '"message":"Bad credentials"'; then
            debug_log "ERROR" "GitHub API authentication failed: Bad credentials"
            return 2
        fi
        
        # ãã®ä»–ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        if echo "$response" | grep -q '"message":"'; then
            local error_msg=$(echo "$response" | grep -o '"message":"[^"]*"' | cut -d':' -f2- | tr -d '"')
            debug_log "ERROR" "GitHub API error: $error_msg"
            return 3
        fi
        
        # æˆåŠŸ
        echo "$response"
        return 0
    else
        debug_log "DEBUG" "No token found, using unauthenticated request"
        wget -q -O- "https://api.github.com/$endpoint" 2>/dev/null
        return $?
    fi
}

save_github_token() {
    token="$1"
    
    if [ -z "$token" ]; then
        debug_log "ERROR" "Empty token provided, cannot save"
        return 1
    fi
    
    # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¦æ¨©é™ã‚’è¨­å®š
    echo "$token" > "$GITHUB_TOKEN_FILE"
    chmod 600 "$GITHUB_TOKEN_FILE"
    
    if [ $? -eq 0 ]; then
        debug_log "INFO" "GitHub token saved to $GITHUB_TOKEN_FILE"
        return 0
    else
        debug_log "ERROR" "Failed to save token to $GITHUB_TOKEN_FILE"
        return 1
    fi
}

get_github_token() {
    if [ -f "$GITHUB_TOKEN_FILE" ] && [ -r "$GITHUB_TOKEN_FILE" ]; then
        # å˜ç´”ã«æ”¹è¡Œã ã‘å‰Šé™¤ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™ï¼ˆã‚ˆã‚Šå …ç‰¢ï¼‰
        cat "$GITHUB_TOKEN_FILE" | tr -d '\n\r' | head -1
        return 0
    fi
    
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã®å–å¾—
    if [ -n "$GITHUB_TOKEN" ]; then
        echo "$GITHUB_TOKEN"
        return 0
    fi
    
    return 1
}

save_version_to_cache() {
    local file_name="$1"
    local version="$2"
    local script_file="$3"
    
    # tmpãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ç½®ãæ›ãˆã‚‹ï¼ˆå¤ã„sedã§ã‚‚å‹•ä½œï¼‰
    if [ -f "$script_file" ]; then
        grep -v "^${file_name}=" "$script_file" > "${script_file}.tmp"
        echo "${file_name}=${version}" >> "${script_file}.tmp"
        mv "${script_file}.tmp" "$script_file"
    else
        echo "${file_name}=${version}" > "$script_file"
    fi
}

setup_github_token() {
    echo "GitHub API Token Setup"
    echo "======================"
    echo "This will save a GitHub Personal Access Token to $GITHUB_TOKEN_FILE"
    echo "The token will be used for API requests to avoid rate limits."
    echo ""
    
    printf "Enter your GitHub Personal Access Token: "
    read -r token
    echo ""
    
    if [ -n "$token" ]; then
        if save_github_token "$token"; then
            echo "Token has been saved successfully!"
            echo "API requests will now use authentication."
        else
            echo "Failed to save token. Please check permissions."
        fi
    else
        echo "No token entered. Operation cancelled."
    fi
}

# ğŸ”´ã€€ãƒˆãƒ¼ã‚¯ãƒ³ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

check_api_rate_limit() {
    if [ "$DEBUG_MODE" = "true" ]; then
        local token="$(get_github_token)"
        local temp_file="/tmp/aios_api_limit.tmp"
        
        # APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        if [ -n "$token" ]; then
            wget -q -O "$temp_file" --header="Authorization: token $token" "https://api.github.com/rate_limit" 2>/dev/null
        else
            wget -q -O "$temp_file" "https://api.github.com/rate_limit" 2>/dev/null
        fi
        
        if [ -f "$temp_file" ] && [ -s "$temp_file" ]; then
            local core_limit=""
            local core_remaining=""
            local core_reset=""
            local now_time=""
            local diff_sec=""
            local mins=""
            local secs=""
            local auth_text=""
            
            # POSIXã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã®ã¿ã§JSONãƒ‘ãƒ¼ã‚¹
            core_limit=$(grep -A3 '"core"' "$temp_file" | grep '"limit"' | head -1 | grep -o '[0-9]\+' | head -1)
            core_remaining=$(grep -A3 '"core"' "$temp_file" | grep '"remaining"' | head -1 | grep -o '[0-9]\+' | head -1)
            core_reset=$(grep -A3 '"core"' "$temp_file" | grep '"reset"' | head -1 | grep -o '[0-9]\+' | head -1)
            
            # æ™‚é–“è¨ˆç®—
            now_time=$(date +%s)
            
            # æ•°å€¤ã¨ã—ã¦æ¯”è¼ƒå¯èƒ½ãªå½¢ã«ç¢ºå®Ÿã«å¤‰æ›
            if [ -n "$core_reset" ] && [ -n "$now_time" ]; then
                core_reset=$(echo "$core_reset" | tr -cd '0-9')
                now_time=$(echo "$now_time" | tr -cd '0-9')
                
                if [ "$core_reset" -gt "$now_time" ]; then
                    diff_sec=$(expr "$core_reset" - "$now_time")
                    mins=$(expr "$diff_sec" / 60)
                    secs=$(expr "$diff_sec" % 60)
                else
                    mins="0"
                    secs="0"
                fi
            else
                mins="0"
                secs="0"
            fi
            
            # èªè¨¼çŠ¶æ…‹åˆ¤å®š
            if [ "$core_limit" = "5000" ]; then
                auth_text="authenticated"
            else
                auth_text="anonymous"
            fi
            
            debug_log "DEBUG" "API Limits: Core $core_remaining/$core_limit ($auth_text), Reset in ${mins}m ${secs}s"
            
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
            rm -f "$temp_file"
        fi
    fi
    return 0
}

clean_version_string() {
    local version_str="$1"
    
    # 1. æ”¹è¡Œã¨å¾©å¸°ã‚’å‰Šé™¤
    local cleaned=$(printf "%s" "$version_str" | tr -d '\n\r')
    
    # 2. è§’æ‹¬å¼§ã‚’å‰Šé™¤
    cleaned=$(printf "%s" "$cleaned" | sed 's/\[//g; s/\]//g')
    
    # 3. ANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
    cleaned=$(printf "%s" "$cleaned" | sed 's/\x1b\[[0-9;]*[mK]//g')
    
    # 4. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®æŠ½å‡ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªæ–¹æ³•ï¼‰
    if echo "$cleaned" | grep -q '20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]'; then
        # å¹´.æœˆ.æ—¥ å½¢å¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡º
        local date_part=$(printf "%s" "$cleaned" | grep -o '20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]')
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ã®æ®‹ã‚Šã®éƒ¨åˆ†ãŒã‚ã‚Œã°è¿½åŠ 
        if echo "$cleaned" | grep -q "${date_part}-"; then
            local remainder=$(printf "%s" "$cleaned" | sed "s/.*${date_part}-//; s/[^0-9a-zA-Z-].*//")
            printf "%s-%s" "$date_part" "$remainder"
        else
            printf "%s" "$date_part"
        fi
    else
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…ƒã®æ–‡å­—åˆ—ã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã—ãŸã‚‚ã®ã‚’è¿”ã™
        printf "%s" "$cleaned"
    fi
}

get_commit_version() {
    local file_path="$1"
    
    # ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±
    local repo_owner="site-u2023"
    local repo_name="aios"
    local api_url="repos/${repo_owner}/${repo_name}/commits?path=${file_path}&per_page=1"
    local temp_file="/tmp/aios_commit_info.tmp"
    local auth_method="direct"
    
    # ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    local token="$(get_github_token)"
    if [ -n "$token" ]; then
        debug_log "DEBUG" "Using token authentication for API request"
        
        # ä¸­é–“çµæœã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã—ãªã„ã€é™ã‹ã«å¤±æ•—ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆ
        if wget -q -O "$temp_file" --header="Authorization: token $token" "https://api.github.com/$api_url" 2>/dev/null; then
            # wgetæˆåŠŸã®å ´åˆ
            auth_method="token"
            if ! grep -q '"sha"' "$temp_file"; then
                # APIã‚¨ãƒ©ãƒ¼ã¾ãŸã¯å¿œç­”ç„¡åŠ¹ã®å ´åˆ
                wget -q -O "$temp_file" "https://api.github.com/$api_url" 2>/dev/null
                auth_method="direct"
            fi
        else
            # wgetå¤±æ•—ã®å ´åˆã¯åŒ¿åã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œ
            wget -q -O "$temp_file" "https://api.github.com/$api_url" 2>/dev/null
            auth_method="direct"
        fi
    else
        debug_log "DEBUG" "No token available, making direct API request"
        wget -q -O "$temp_file" "https://api.github.com/$api_url" 2>/dev/null
        auth_method="direct"
    fi
    
    # å¿œç­”ã®ç¢ºèª
    if [ ! -s "$temp_file" ]; then
        debug_log "DEBUG" "Empty response from GitHub API. Attempting direct file download"
        # APIã«å¤±æ•—ã—ãŸå ´åˆã¯ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        local direct_file="/tmp/aios_direct_file.tmp"
        if wget -q -O "$direct_file" "https://raw.githubusercontent.com/$repo_owner/$repo_name/main/$file_path" 2>/dev/null; then
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆï¼ˆæœ€åˆã®7æ–‡å­—ã ã‘ä½¿ç”¨ï¼‰
            local file_hash=$(sha256sum "$direct_file" 2>/dev/null | cut -c1-7)
            rm -f "$direct_file" 2>/dev/null
            rm -f "$temp_file" 2>/dev/null
            local today=$(date +%Y.%m.%d)
            echo "$today-$file_hash direct"
            return 0
        else
            debug_log "ERROR" "Failed to directly download file"
            rm -f "$direct_file" 2>/dev/null
            rm -f "$temp_file" 2>/dev/null
            echo "$(date +%Y.%m.%d)-unknown $auth_method"
            return 1
        fi
    fi
    
    # APIã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
    if grep -q "API rate limit exceeded" "$temp_file"; then
        debug_log "WARN" "GitHub API rate limit exceeded. Attempting direct file download"
        # ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        local direct_file="/tmp/aios_direct_file.tmp"
        if wget -q -O "$direct_file" "https://raw.githubusercontent.com/$repo_owner/$repo_name/main/$file_path" 2>/dev/null; then
            local file_hash=$(sha256sum "$direct_file" 2>/dev/null | cut -c1-7)
            rm -f "$direct_file" 2>/dev/null
            rm -f "$temp_file" 2>/dev/null
            local today=$(date +%Y.%m.%d)
            echo "$today-$file_hash direct"
            return 0
        else
            debug_log "ERROR" "Failed to directly download file"
            rm -f "$direct_file" 2>/dev/null
            rm -f "$temp_file" 2>/dev/null
            echo "$(date +%Y.%m.%d)-ratelimit $auth_method"
            return 2
        fi
    fi
    
    # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±æŠ½å‡ºï¼ˆjqéä¾å­˜ã®å …ç‰¢æ–¹å¼ï¼‰
    local commit_date=""
    local commit_sha=""
    
    # 1. SHAæƒ…å ±ã®æŠ½å‡ºï¼ˆã‚ˆã‚Šå …ç‰¢ãªè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
    commit_sha=$(grep -o '"sha"[[:space:]]*:[[:space:]]*"[a-f0-9]\+' "$temp_file" | head -1 | grep -o '[a-f0-9]\{7,40\}' | head -c 7)
    
    if [ -z "$commit_sha" ]; then
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‘ã‚¿ãƒ¼ãƒ³
        commit_sha=$(grep -o '[a-f0-9]\{40\}' "$temp_file" | head -1 | head -c 7)
    fi
    
    # 2. æ—¥ä»˜æƒ…å ±ã®æŠ½å‡ºï¼ˆã‚ˆã‚Šå …ç‰¢ãªè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
    # ãƒ‘ã‚¿ãƒ¼ãƒ³1: "date": "YYYY-MM-DD..."
    commit_date=$(grep -o '"date"[[:space:]]*:[[:space:]]*"[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}' "$temp_file" | 
                  head -1 | 
                  grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
    
    if [ -z "$commit_date" ]; then
        # ãƒ‘ã‚¿ãƒ¼ãƒ³2: YYYY-MM-DDTHH:MM:SSZå½¢å¼
        commit_date=$(grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}T[0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\}Z' "$temp_file" | 
                     head -1 | 
                     grep -o '^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
    fi
    
    if [ -z "$commit_date" ] || [ -z "$commit_sha" ]; then
        debug_log "WARN" "Failed to extract commit information. Trying more robust method"
        
        # æœ€çµ‚æ‰‹æ®µ: å…¨ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
        commit_sha=$(tr -cd 'a-f0-9' < "$temp_file" | grep -o '[a-f0-9]\{40\}' | head -1 | head -c 7)
        commit_date=$(grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}' "$temp_file" | head -1)
        
        if [ -z "$commit_sha" ]; then
            commit_sha="unknown"
        fi
        
        if [ -z "$commit_date" ]; then
            commit_date=$(date +%Y-%m-%d)
        fi
    fi
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—æ§‹ç¯‰ã¨çµæœè¿”å´
    if [ -n "$commit_date" ] && [ -n "$commit_sha" ]; then
        # æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å¤‰æ›ï¼ˆYYYY-MM-DD â†’ YYYY.MM.DDï¼‰
        local formatted_date=$(echo "$commit_date" | tr '-' '.')
        local version="${formatted_date}-${commit_sha}"
        
        debug_log "DEBUG" "Successfully extracted commit info: $version (via $auth_method)"
        rm -f "$temp_file" 2>/dev/null
        echo "$version $auth_method"
        return 0
    fi
    
    # å…¨ã¦ã®æ–¹æ³•ãŒå¤±æ•—ã—ãŸå ´åˆ
    debug_log "ERROR" "All methods failed to get commit information"
    rm -f "$temp_file" 2>/dev/null
    echo "$(date +%Y.%m.%d)-fallback $auth_method"
    return 1
}

version_is_newer() {
    local current="$1"  # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³
    local reference="$2"  # ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    
    # ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã‚’è¿½åŠ 
    debug_log "DEBUG" "Comparing: Remote=$current, Local=$reference"
    
    # ã©ã¡ã‚‰ã‹ãŒä¸æ˜ã®å ´åˆã¯æ›´æ–°å¿…è¦
    if echo "$current $reference" | grep -q "No version\|unknown"; then
        debug_log "DEBUG" "Unknown version detected, update required"
        return 0
    fi
    
    # å®Œå…¨ä¸€è‡´ã®å ´åˆã¯æ›´æ–°ä¸è¦
    if [ "$current" = "$reference" ]; then
        debug_log "DEBUG" "Exact match: No update needed"
        return 1
    fi
    
    # æ—¥ä»˜éƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆYYYY.MM.DDå½¢å¼ï¼‰
    local current_date=$(echo "$current" | grep -o "[0-9][0-9][0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]" | head -1)
    local reference_date=$(echo "$reference" | grep -o "[0-9][0-9][0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]" | head -1)
    
    # æ—¥ä»˜ãŒæŠ½å‡ºã§ããªã‹ã£ãŸå ´åˆã¯æ›´æ–°ãŒå¿…è¦
    if [ -z "$current_date" ] || [ -z "$reference_date" ]; then
        debug_log "DEBUG" "Date extraction failed: Update for safety"
        return 0
    fi
    
    # æ—¥ä»˜ã‚’æ•°å€¤ã«å¤‰æ›ï¼ˆåŒºåˆ‡ã‚Šæ–‡å­—ã‚’å‰Šé™¤ï¼‰
    local current_num=$(echo "$current_date" | tr -d '.')
    local reference_num=$(echo "$reference_date" | tr -d '.')
    
    # æ•°å€¤æ¯”è¼ƒï¼ˆæ—¥ä»˜å½¢å¼ï¼‰
    if [ "$current_num" -gt "$reference_num" ]; then
        debug_log "DEBUG" "Remote date is newer: Update required"
        return 0  # ãƒªãƒ¢ãƒ¼ãƒˆï¼ˆcurrentï¼‰ãŒæ–°ã—ã„
    elif [ "$current_num" -lt "$reference_num" ]; then
        debug_log "DEBUG" "Local date is newer: No update needed"
        return 1  # ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆreferenceï¼‰ãŒæ–°ã—ã„
    fi
    
    # æ—¥ä»˜ãŒåŒã˜å ´åˆã¯SHAéƒ¨åˆ†ã‚’æ¯”è¼ƒ
    local current_sha=$(echo "$current" | grep -o "\-[a-z0-9]*" | sed 's/^-//' | head -1)
    local reference_sha=$(echo "$reference" | grep -o "\-[a-z0-9]*" | sed 's/^-//' | head -1)
    
    # SHAæƒ…å ±ã‚’ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
    debug_log "DEBUG" "SHA comparison: Remote=$current_sha, Local=$reference_sha"
    
    if [ -n "$current_sha" ] && [ -n "$reference_sha" ] && [ "$current_sha" != "$reference_sha" ]; then
        debug_log "DEBUG" "Different SHA: Update required"
        return 0  # ç•°ãªã‚‹ã‚³ãƒŸãƒƒãƒˆ
    fi
    
    debug_log "DEBUG" "Same version or unable to compare: No update needed"
    return 1  # åŒä¸€ãƒãƒ¼ã‚¸ãƒ§ãƒ³
}

# ãƒ¡ã‚¤ãƒ³ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•° - ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æã‚‚æ‹…å½“
download() {
    # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æœ€åˆã®å¼•æ•°ã¨ã—ã¦å‡¦ç†ã€æ®‹ã‚Šã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    local file_name="$1"
    shift
    
    # è¨­å®šå¤‰æ•°ã®åˆæœŸåŒ–
    local hidden_mode="false"
    local quiet_mode="${QUIET_MODE:-false}"
    local chmod_mode="false"
    local load_mode="false"
    local script_file="${CACHE_DIR}/script.ch"
    
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã®å‡¦ç†
    while [ $# -gt 0 ]; do
        case "$1" in
            hidden) hidden_mode="true" ;;
            quiet)  quiet_mode="true" ;;
            debug)  DEBUG_MODE="true" ;;
            chmod)  chmod_mode="true" ;;
            load)   load_mode="true" ;;
            *)      debug_log "WARN" "Unknown option: $1, ignoring" ;;
        esac
        shift
    done
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯å‡¦ç†
    local version_data
    version_data=$(download_check_version "$file_name")
    local update_required=$(echo "$version_data" | cut -d'|' -f1)
    local clean_remote_version=$(echo "$version_data" | cut -d'|' -f2)
    local clean_local_version=$(echo "$version_data" | cut -d'|' -f3)
    local auth_message=$(echo "$version_data" | cut -d'|' -f4)
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    local status_type="no_update"
    local status_message="$(get_message "CONFIG_DOWNLOAD_UNNECESSARY")"
    if [ "$update_required" = "true" ]; then
        if ! download_fetch_file "$file_name" "$clean_remote_version" "$chmod_mode"; then
            debug_log "ERROR" "Download process failed for $file_name"
            return 1
        fi
        status_type="success"
        status_message="$(get_message "CONFIG_DOWNLOAD_SUCCESS")"
    fi
    
    # çµæœè¡¨ç¤ºã¨ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    download_finalize "$file_name" "$status_message" "$clean_remote_version" "$auth_message" "$load_mode" "$hidden_mode" "$status_type"
    
    return 0
}

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯é–¢æ•°
download_check_version() {
    local file_name="$1"
    local script_file="${CACHE_DIR}/script.ch"
    local dummy_version="No version control"
    
    # APIåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ï¼‰
    [ "$DEBUG_MODE" = "true" ] && check_api_rate_limit
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®å–å¾—
    local remote_version_info=$(get_commit_version "$file_name")
    local remote_version=$(printf "%s" "$remote_version_info" | cut -d' ' -f1)
    local auth_method=$(printf "%s" "$remote_version_info" | cut -d' ' -f2)
    local local_version=""
    
    # ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å–å¾—
    if [ -f "$script_file" ]; then
        local_version=$(grep "^${file_name}=" "$script_file" | cut -d'=' -f2)
    fi
    [ -z "$local_version" ] && local_version="$dummy_version"

    local clean_remote_version=$(clean_version_string "$remote_version")
    local clean_local_version=$(clean_version_string "$local_version")

    # èªè¨¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨­å®š
    local auth_message=""
    case "$auth_method" in
        token)    auth_message="via token auth" ;;
        standard) auth_message="via standard API" ;;
        *)        auth_message="via direct download" ;;
    esac
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰åˆ¤æ–­
    local update_required=false
    
    if [ "$local_version" = "$dummy_version" ]; then
        debug_log "DEBUG" "First download: $file_name"
        update_required=true
    elif [ "$clean_remote_version" = "$clean_local_version" ]; then
        debug_log "DEBUG" "Exact match: No update needed for $file_name"
        update_required=false
    else
        debug_log "DEBUG" "Starting version comparison: $file_name"
        version_is_newer "$clean_remote_version" "$clean_local_version"
        if [ $? -eq 0 ]; then
            debug_log "DEBUG" "New version detected: Update required for $file_name"
            update_required=true
        else
            debug_log "DEBUG" "Existing version: No update needed for $file_name"
            update_required=false
        fi
    fi
    
    debug_log "DEBUG" "Remote version: $file_name - $clean_remote_version"
    debug_log "DEBUG" "Local version: $file_name - $clean_local_version"
    debug_log "DEBUG" "Update required: $file_name -$(printf "%s" "$update_required")"
    
    # çµæœã‚’è¿”ã™
    echo "${update_required}|${clean_remote_version}|${clean_local_version}|${auth_message}"
    return 0
}

# ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°é–¢æ•°
download_fetch_file() {
    local file_name="$1"
    local clean_remote_version="$2"
    local chmod_mode="$3"
    local install_path="${BASE_DIR}/$file_name"
    local remote_url="${BASE_URL}/$file_name"
    local script_file="${CACHE_DIR}/script.ch"
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    if ! $BASE_WGET "$install_path" "$remote_url"; then
        debug_log "ERROR" "Download failed: $file_name is empty"
        return 1
    fi
    
    # ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
    if [ ! -s "$install_path" ]; then
        debug_log "ERROR" "Download failed: $file_name is empty"
        return 1
    fi
    
    # æ¨©é™è¨­å®š
    if [ "$chmod_mode" = "true" ]; then
        chmod +x "$install_path"
        debug_log "DEBUG" "chmod +x applied to $file_name"
    fi
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®æ›´æ–°
    if [ ! -f "$script_file" ]; then
        printf "%s=%s\n" "${file_name}" "${clean_remote_version}" > "$script_file"
    else
        if grep -q "^${file_name}=" "$script_file"; then
            # ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
            escaped_file=$(echo "$file_name" | sed 's/[\/&]/\\&/g')
            escaped_version=$(echo "$clean_remote_version" | sed 's/[\/&]/\\&/g')
            sed -i "s/^${escaped_file}=.*/${escaped_file}=${escaped_version}/" "$script_file"
        else
            printf "%s=%s\n" "${file_name}" "${clean_remote_version}" >> "$script_file"
        fi
    fi
    
    return 0
}

# çµæœè¡¨ç¤ºã¨ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–¢æ•°
download_finalize() {
    local file_name="$1"
    local status_message="$2"
    local clean_remote_version="$3"
    local auth_message="$4"
    local load_mode="$5"
    local hidden_mode="$6"
    local status_type="$7"
    local install_path="${BASE_DIR}/$file_name"
    
    # èª­ã¿è¾¼ã¿ãŒå¿…è¦ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°è¨­å®š
    local should_load="false"
    local action_message=""
    if [ "$load_mode" = "true" ] || echo "$file_name" | grep -q ".*\\.sh"; then
        should_load="true"
        action_message="Loaded"
    fi
    
    # å‡ºåŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ
    local message="${status_message} ${file_name} ${clean_remote_version} ${auth_message}"
    if [ -n "$action_message" ]; then
        message="${message} (${action_message})"
    fi

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡ºåŠ›ã‚’å…ˆã«è¡Œã†
    if [ "$hidden_mode" = "true" ]; then
        debug_log "DEBUG" "$(color white "Quiet mode ${message}")"
    else
        if [ "$status_type" = "success" ]; then
            printf "%s\n" "$(color white "${message}")"
        else
            printf "%s\n" "$(color white "${message}")" 
        fi
    fi
    
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å‡¦ç†ã‚’å®Ÿè¡Œ
    if [ "$should_load" = "true" ]; then
        debug_log "DEBUG" "Now loading source file: $file_name"
        . "$install_path"
        debug_log "DEBUG" "Successfully loaded: $file_name"
    fi
    
    return 0
}

# ğŸ”´ã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´ã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒãƒŠãƒ¼ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ãƒ¡ã‚¤ãƒ³é–¢æ•° - ãƒãƒŠãƒ¼è¡¨ç¤ºã®çµ±åˆé–¢æ•°
# å¼•æ•°: 
#   $1 - ãƒãƒŠãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆçœç•¥å¯ï¼‰: "unicode", "ascii", "asterisk", "auto"
print_banner() {
    # ã‚¹ã‚¿ã‚¤ãƒ«æŒ‡å®šã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€Œautoã€
    BANNER_STYLE="${1:-auto}"
    
    # è‡ªå‹•æ¤œå‡ºãŒå¿…è¦ãªå ´åˆ
    if [ "$BANNER_STYLE" = "auto" ]; then
        BANNER_STYLE=$(detect_terminal_capability)
        debug_log "DEBUG" "Auto-detected banner style: $BANNER_STYLE"
    fi

    # ã‚¹ã‚¿ã‚¤ãƒ«ã«å¿œã˜ãŸãƒãƒŠãƒ¼è¡¨ç¤º
    case "$BANNER_STYLE" in
        unicode|block)
            print_banner_unicode
            ;;
        ascii|hash|sharp)
            print_banner_ascii
            ;;
        *)
            # ä¸æ˜ãªã‚¹ã‚¿ã‚¤ãƒ«ã®å ´åˆã¯ASCIIã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            debug_log "WARN" "Unknown banner style: $BANNER_STYLE, using ASCII fallback"
            print_banner_ascii
            ;;
    esac
}

print_banner_ascii() {
    debug_log "DEBUG" "Displaying lowercase aios block ASCII art banner"
    
    # ãƒãƒŠãƒ¼ã®å‰ã«ç©ºè¡Œ
    printf "\n"
    
    # ASCIIã‚¢ãƒ¼ãƒˆ
    printf "%s\n" "$(color magenta "               ## #")"
    printf "%s\n" "$(color blue    "     ####      ###       ####      #####")"
    printf "%s\n" "$(color green   "        ##      ##      ##  ##    ##")"
    printf "%s\n" "$(color yellow  "     #####      ##      ##  ##     #####")"
    printf "%s\n" "$(color orange  "    ##  ##      ##      ##  ##         ##")"
    printf "%s\n" "$(color red     "     #####     ####      ####     ######")"
    
    # ãƒãƒŠãƒ¼ã®å¾Œã«ç©ºè¡Œ
    printf "\n"
    
    # ãƒãƒŠãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_DECCRIPTION")")"
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_NAME")")"
    printf "%s\n" "$(color red "$(get_message "MSG_BANNER_DISCLAIMER")")"
    
    debug_log "DEBUG" "Block style lowercase aios banner displayed successfully"
}

print_banner_unicode() {
    debug_log "DEBUG" "Displaying lowercase aios block ASCII art banner"
    
    # ãƒãƒŠãƒ¼ã®å‰ã«ç©ºè¡Œ
    printf "\n"
    
    # ASCIIã‚¢ãƒ¼ãƒˆï¼ˆç’°å¢ƒä¾å­˜æ–‡å­— - ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
    printf "%s\n" "$(color magenta "               â–ˆâ–ˆ â–ˆ")"
    printf "%s\n" "$(color blue    "     â–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ")"
    printf "%s\n" "$(color green   "        â–ˆâ–ˆ      â–ˆâ–ˆ      â–ˆâ–ˆ  â–ˆâ–ˆ    â–ˆâ–ˆ")"
    printf "%s\n" "$(color yellow  "     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆ      â–ˆâ–ˆ  â–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ")"
    printf "%s\n" "$(color orange  "    â–ˆâ–ˆ  â–ˆâ–ˆ      â–ˆâ–ˆ      â–ˆâ–ˆ  â–ˆâ–ˆ         â–ˆâ–ˆ")"
    printf "%s\n" "$(color red     "     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ")"
    
    # ãƒãƒŠãƒ¼ã®å¾Œã«ç©ºè¡Œ
    printf "\n"
    
    # ãƒãƒŠãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_DECCRIPTION")")"
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_NAME")")"
    printf "%s\n" "$(color red "$(get_message "MSG_BANNER_DISCLAIMER")")"
    printf "\n"

    debug_log "DEBUG" "Block style lowercase aios banner displayed successfully"
}

print_information() {
    local architecture=$(cat "${CACHE_DIR}/architecture.ch")
    local osversion=$(cat "${CACHE_DIR}/osversion.ch")
    local package_manager=$(cat "${CACHE_DIR}/package_manager.ch")
    local usbdevice=$(cat "${CACHE_DIR}/usbdevice.ch")

    printf "%s\n" "$(color white "$(get_message "MSG_INFO_ARCHITECTURE" "info=$architecture")")"
    printf "%s\n" "$(color white "$(get_message "MSG_INFO_OSVERSION" "info=$osversion")")"
    printf "%s\n" "$(color white "$(get_message "MSG_INFO_PACKAGEMANAGER" "info=$package_manager")")"
    printf "%s\n" "$(color white "$(get_message "MSG_INFO_USBDEVICE" "info=$usbdevice")")"
    printf "\n"
}

print_country() {
    local country=$(cat "${CACHE_DIR}/language.ch")
    local language=$(cat "${CACHE_DIR}/luci.ch")
    #local message=$(cat "${CACHE_DIR}/message.ch")
    local zonename=$(cat "${CACHE_DIR}/zonename.ch")
    local timezone=$(cat "${CACHE_DIR}/timezone.ch")

    printf "%s\n" "$(color white "$(get_message "MSG_INFO_COUNTRY" "code=$country")")"
    printf "%s\n" "$(color white "$(get_message "MSG_INFO_LANGUAGE" "code=$language")")"
    #printf "%s\n" "$(color white "$(get_message "MSG_INFO_MESSAGE" "code=$message")")"
    printf "%s\n" "$(color white "$(get_message "MSG_INFO_ZONENAME" "code=$zonename")")"
    printf "%s\n" "$(color white "$(get_message "MSG_INFO_TIMEZONE" "code=$timezone")")"
    printf "\n"
}

# ğŸ”´ã€€ãƒãƒŠãƒ¼ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´ã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒ¡ã‚¤ãƒ³ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

check_option() {

    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
    ORIGINAL_ARGS="$@"
    MODE="${MODE:-update}"
    SELECTED_LANGUAGE=""
    DEBUG_MODE="false"
    DEBUG_LEVEL="INFO"
    DRY_RUN="false"
    LOGFILE=""
    FORCE="false"
    RESET="false"
    HELP="false"

    # è¨€èªãŠã‚ˆã³ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã®å‡¦ç†
    while [ "$#" -gt 0 ]; do
        case "$1" in
            -h|--h|-help|--help|-\?|--\?)
                HELP="true"
                print_help
                exit 0
                ;;
            -v|--v|-version|--version)
                script_version
                exit 0
                ;;
            -d|--d|-debug|--debug|-d1|--d1)
                DEBUG_MODE="true"
                DEBUG_LEVEL="DEBUG"
                ;;
            -cf|--cf|-common_full|--common_full)
                MODE="full"
                ;;
            -cl|--cl|-ocommon_light|--ocommon_light)
                MODE="light"
                ;;
            -cd|--cd|-common_debug|--common_debug|--common_debug)
                MODE="debug"
                ;;
            -r|--r|-reset|--reset|-resrt|--resrt)
                MODE="reset"
                RESET="true"
                ;;
            -f|--f|-force|--force)
                FORCE="true"
                ;;
            -dr|--dr|-dry-run|--dry-run)
                DRY_RUN="true"
                ;;
            -l|--l|-logfile|--logfile)
                if [ -n "$2" ] && [ "${2#-}" = "$2" ]; then
                    LOGFILE="$2"
                    shift
                else
                    debug_log "DEBUG" "logfile requires a path argument"
                    exit 1
                fi
                ;;
            -u|--u|-update|--update)
                debug_log "DEBUG" "check_option: aios update"
                MODE="update"
                ;;
            -t|--t|-token|--token)
                setup_github_token
                exit 0
                ;;
            -ta|--ta|-test_api|--test_api)
                MODE="test_api"
                ;;
            -*)
                echo "Warning: Unknown option: $1" >&2
                ;;
            *)
                if [ -z "$SELECTED_LANGUAGE" ]; then
                    SELECTED_LANGUAGE="$1"
                fi
                ;;
        esac
        shift
    done

    # ç’°å¢ƒå¤‰æ•°è¨­å®š
    export SELECTED_LANGUAGE DEBUG_MODE DEBUG_LEVEL MODE DRY_RUN LOGFILE FORCE RESET HELP

    # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
    debug_log "DEBUG" "$BIN_FILE: $SCRIPT_VERSION"
    debug_log "DEBUG" "check_option received before args: $ORIGINAL_ARGS"
    debug_log "DEBUG" "check_option: MODE=$MODE, SELECTED_LANGUAGE=$SELECTED_LANGUAGE DEBUG_MODE=$DEBUG_MODE DEBUG_LEVEL=$DEBUG_LEVEL DRY_RUN=$DRY_RUN LOGFILE=$LOGFILE FORCE=$FORCE RESET=$RESET HELP=$HELP"

    # è¨­å®šã•ã‚ŒãŸè¨€èªã‚’ `check_common()` ã«æ¸¡ã™
    check_common "$SELECTED_LANGUAGE" "$MODE"
}

check_common() {
    local lang_code="$SELECTED_LANGUAGE"
    local mode="$MODE"

    debug_log "DEBUG" "check_common: MODE=$MODE"
    debug_log "DEBUG" "check_common: mode=$mode"

    # ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®å‡¦ç†
    case "$mode" in
        reset|return)
            if ! rm -rf "${CACHE_DIR}"; then
                debug_log "ERROR" "Failed to remove cache directory: ${CACHE_DIR}"
                printf "%s%s%s\n" "$(color yellow "Reset failed: Could not remove cache directory.")"
                return 1
            fi
            # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†ä½œæˆ
            mkdir -p "${CACHE_DIR}" || {
                debug_log "ERROR" "Failed to recreate cache directory: ${CACHE_DIR}"
                printf "%s%s%s\n" "$(color yellow "Reset partially failed: Cache removed but could not be recreated.")"
            }
            printf "%s%s%s\n" "$(color yellow "$(get_message "MSG_RESET_COMPLETE")")"
            exit 0
            ;;
        debug)
            download "dynamic-system-info.sh" "hidden" "chmod" "load"
            download "common-color.sh" "hidden" "chmod" "load
            download "common-country.sh" "hidden" "chmod" "load"
            download "common-country.sh" "hidden" "chmod" "load"
            download "common-package.sh" "hidden" "chmod" "load"
            download "common-feed-package.sh" "hidden" "chmod" "load"
            download "menu.db" "hidden"
            download "country.db" "hidden"
            download "messages_base.db" "hidden"
            download "messages_asian.db" "hidden"
            download "messages_euro.db" "hidden"
            download "messages_etc.db" "hidden"
            download "local-package.db" "hidden"
            download "custom-package.db" "hidden"
            print_banner
            print_information
            select_country "$lang_code"
            print_country
            selector "$MAIN_MENU" 
            ;;
        full)
            download "dynamic-system-info.sh" "chmod" "load"
            download "common-color.sh" "chmod" "load
            download "common-country.sh" "chmod" "load"
            download "common-menu.sh" "chmod" "load"
            download "common-package.sh" "chmod" "load"
            download "common-feed-package.sh" "chmod" "load"
            download "menu.db"
            download "country.db"
            download "messages_base.db"
            download "messages_asian.db"
            download "messages_euro.db"
            download "messages_etc.db"
            download "local-package.db"
            download "custom-package.db"
            print_banner
            print_information
            select_country "$lang_code"
            print_country
            selector "$MAIN_MENU"
            ;;
        update)
            check_update "$ORIGINAL_ARGS"
            ;;
        light)
            ;;
        test_api)
            download "github_api_test.sh" "chmod" "load"
            exit 0
            ;;
        *)
            ;;
    esac
    
    return 0
}

# å®Ÿè¡Œæ¨©é™ã®è¨­å®š
chmod_aios() {
    if ! chmod +x "$BIN_PATH"; then
        debug_log "ERROR" "Failed to set execute permission"
        return 1
    fi
    return 0
}

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤å‡¦ç†
delete_aios() {
    if ! rm -rf "${BASE_DIR}"; then
        debug_log "ERROR" "Failed to delete $BASE_DIR"
        return 1
    fi
    return 0
}

# å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
make_directory() {
    if ! mkdir -p "${BASE_DIR}" "$CACHE_DIR" "$LOG_DIR" "$FEED_DIR"; then
        debug_log "ERROR" "Failed to create required directories"
        return 1
    fi
}

# ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆçŠ¶æ…‹ç¢ºèª
check_update() {
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šï¼ˆå¼•æ•°ãŒãªãã¦ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«ï¼‰
    local lang_code="$SELECTED_LANGUAGE"
    MODE="${MODE:-update}"
    
    # å…¨å¼•æ•°ã‚’å‡¦ç†
    local all_args="$@"
    local has_args=0
    
    # å¼•æ•°ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    [ $# -gt 0 ] && has_args=1
    
    # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé–¢é€£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    local filtered_args=""
    
    # å¼•æ•°ãŒã‚ã‚‹å ´åˆã®ã¿å‡¦ç†
    if [ $has_args -eq 1 ]; then
        while [ $# -gt 0 ]; do
            case "$1" in
                -u|--u|-update|--update)
                    # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé–¢é€£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯é™¤å¤–
                    ;;
                *)
                    # ãã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä¿æŒ
                    filtered_args="${filtered_args:+$filtered_args }$1"
                    ;;
            esac
            shift
        done
    fi
    
    debug_log "DEBUG" "Original args: $all_args"
    debug_log "DEBUG" "Filtered args: $filtered_args"
    
    # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
    download "aios" "chmod"
    MODE="full"

    # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ç§»å‹•ã—ã¦exec
    if [ -f "$BASE_DIR/$BIN_FILE" ]; then
        mv -f "$BASE_DIR/$BIN_FILE" "$BIN_PATH"
    fi

    exec "$BIN_PATH" "$lang_code" $filtered_args
}

# åˆæœŸåŒ–å‡¦ç†ã®ãƒ¡ã‚¤ãƒ³
main() {
    # å®Ÿè¡Œæ¨©é™ã‚’è¨­å®š
    if ! chmod_aios; then
        debug_log "ERROR" "Failed to set execute permission"
        return 1
    fi

    # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    if ! make_directory; then
        debug_log "ERROR" "Failed to create required directories"
        return 1
    fi

    check_option "$@"
}

# ğŸ”´ã€€ãƒ¡ã‚¤ãƒ³ã€€ã“ã“ã¾ã§ã€€ğŸ”´ã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"
