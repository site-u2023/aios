#!/bin/sh

SCRIPT_VERSION="2025.04.09-00-00"

# =========================================================
# ğŸ“Œ OpenWrt / Alpine Linux POSIX-Compliant Shell Script
# ğŸš€ Last Update: 2025-02-21
#
# ğŸ·ï¸ License: CC0 (Public Domain)
# ğŸ¯ Compatibility: OpenWrt >= 19.07 (Tested on 24.10.0)
#
# âš ï¸ IMPORTANT NOTICE:
# OpenWrt OS exclusively uses **Almquist Shell (ash)** and
# is **NOT** compatible with Bourne-Again Shell (bash).
#
# ğŸ“¢ POSIX Compliance Guidelines:
# âœ… Use `[` instead of `[[` for conditions
# âœ… Use $(command) instead of backticks `command`
# âœ… Use $(( )) for arithmetic instead of let
# âœ… Define functions as func_name() {} (no function keyword)
# âœ… No associative arrays (declare -A is NOT supported)
# âœ… No here-strings (<<< is NOT supported)
# âœ… No -v flag in test or [[
# âœ… Avoid bash-specific string operations like ${var:0:3}
# âœ… Avoid arrays entirely when possible (even indexed arrays can be problematic)
# âœ… Use printf followed by read instead of read -p
# âœ… Use printf instead of echo -e for portable formatting
# âœ… Avoid process substitution <() and >()
# âœ… Prefer case statements over complex if/elif chains
# âœ… Use command -v instead of which or type for command existence checks
# âœ… Keep scripts modular with small, focused functions
# âœ… Use simple error handling instead of complex traps
# âœ… Test scripts with ash/dash explicitly, not just bash
#
# ğŸ› ï¸ Keep it simple, POSIX-compliant, and lightweight for OpenWrt!
### =========================================================
### ğŸ“Œ AI Assistance Request: POSIX-Compliant Debugging Guide
### 
### When debugging or fixing errors in this POSIX shell script:
### 
### 1ï¸âƒ£ Create a minimal reproducible test case (avoid bash features)
### 2ï¸âƒ£ Test with ash/dash explicitly: dash ./test.sh
### 3ï¸âƒ£ Use portable debugging methods: echo, printf, or set -x
### 4ï¸âƒ£ Validate fixes against all POSIX compliance guidelines
### 5ï¸âƒ£ Ensure the solution works in resource-constrained OpenWrt
### 
### âš ï¸ IMPORTANT:
### - Avoid suggesting bash-specific solutions
### - Always test fixes with ash/dash before implementation
### - Prefer simple solutions over complex ones
### - Do not modify production code without test verification
### 
### ğŸ› ï¸ Keep debugging simple, focused, and POSIX-compliant!
### =========================================================

# ã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡
DEV_NULL="${DEV_NULL:-on}"       # ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡ï¼ˆon=æœ‰åŠ¹, unset=ç„¡åŠ¹ï¼‰
DEBUG_MODE="${DEBUG_MODE:-false}" # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆtrue=æœ‰åŠ¹, false=ç„¡åŠ¹ï¼‰

# ãƒ‘ã‚¹ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«é–¢é€£
INTERPRETER="${INTERPRETER:-ash}"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿
BIN_PATH="$(readlink -f "$0")"   # å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®çµ¶å¯¾ãƒ‘ã‚¹
BIN_DIR="$(dirname "$BIN_PATH")" # å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
BIN_FILE="$(basename "$BIN_PATH")" # å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«å

# ãƒ™ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
BASE_DIR="${BASE_DIR:-/tmp/aios}"      # åŸºæœ¬ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
CACHE_DIR="${CACHE_DIR:-$BASE_DIR/cache}" # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
FEED_DIR="${FEED_DIR:-$BASE_DIR/feed}" # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
LOG_DIR="${LOG_DIR:-$BASE_DIR/logs}"   # ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

# ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢é€£è¨­å®š
BASE_URL="${BASE_URL:-https://raw.githubusercontent.com/site-u2023/aios/main}" # åŸºæœ¬URL
CACHE_BUST="?cache_bust=$(date +%s)" # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

# wgeté–¢é€£è¨­å®š
BASE_WGET="wget --no-check-certificate -q" # åŸºæœ¬wgetã‚³ãƒãƒ³ãƒ‰
BASE_WGET_AUTH_BEARER='wget --no-check-certificate -q -O "$1" --header="Authorization: Bearer $2" "$3"' # Bearerèªè¨¼ç”¨
BASE_WGET_AUTH_TOKEN='wget --no-check-certificate -q -O "$1" --header="Authorization: token $2" "$3"'   # Tokenèªè¨¼ç”¨

# GitHub APIèªè¨¼é–¢é€£
GITHUB_TOKEN_FILE="/etc/aios_token" # GitHubãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«
UPDATE_CACHE="${CACHE_DIR}/update.ch" # æ›´æ–°æƒ…å ±ã‚­ãƒ£ãƒƒã‚·ãƒ¥

# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¿»è¨³ã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®š
DEFAULT_LANGUAGE="${DEFAULT_LANGUAGE:-en}"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨€èª
MSG_MEMORY=""                          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥
MSG_MEMORY_INITIALIZED="false"         # ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆæœŸåŒ–ãƒ•ãƒ©ã‚°
MSG_MEMORY_LANG=""                     # ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨€èª

# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥
MSG_MEMORY=""
MSG_MEMORY_INITIALIZED="false"
MSG_MEMORY_LANG=""

# GitHub APIãƒ¬ãƒ¼ãƒˆåˆ¶é™æƒ…å ±
API_REMAINING=""       # æ®‹ã‚ŠAPIå‘¼ã³å‡ºã—å›æ•°
API_LIMIT=""           # APIãƒ¬ãƒ¼ãƒˆåˆ¶é™å€¤
API_RESET_TIME=""      # APIåˆ¶é™ãƒªã‚»ãƒƒãƒˆæ™‚é–“ï¼ˆåˆ†ï¼‰
API_AUTH_METHOD=""     # èªè¨¼æ–¹æ³•ï¼ˆtoken/bearer/directï¼‰
API_LAST_CHECK=""      # æœ€çµ‚APIç¢ºèªæ™‚é–“ï¼ˆUnixæ™‚é–“ï¼‰
API_CACHE_TTL="60"     # APIã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé–“ï¼ˆç§’ï¼‰

# ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚­ãƒ£ãƒƒã‚·ãƒ¥é–¢é€£
COMMIT_CACHE_DIR="${CACHE_DIR}/commits" # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
COMMIT_CACHE_TTL="1800" # ã‚³ãƒŸãƒƒãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé–“ï¼ˆ30åˆ†=1800ç§’ï¼‰
SKIP_CACHE="false"     # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ï¼ˆtrue=ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡è¦–ï¼‰

# ğŸ”µã€€ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ‡ãƒãƒƒã‚°ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µ-------------------------------------------------------------------------------------------------------------------------------------------

handle_error() {
    local error_key="$1"
    local file="$2"
    local version="$3"
    local exit_required="${4:-no}"

    local error_message
    error_message=$(get_message "$error_key")

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if [ -z "$error_message" ]; then
        error_message="Unknown error occurred. Key: $error_key"
    fi

    # å¤‰æ•°ã‚’ç½®æ›
    error_message=$(echo "$error_message" | sed -e "s/{file}/$file/g" -e "s/{version}/$version/g")

    # ãƒ­ã‚°è¨˜éŒ² & è¡¨ç¤º
    debug_log "ERROR" "$error_message"
    echo -e "$(color red "$error_message")"

    if [ "$exit_required" = "yes" ]; then
        debug_log "ERROR" "Critical error occurred, exiting: $error_message"
        exit 1
    else
        debug_log "DEBUG" "Non-critical error: $error_message"
        return 1
    fi
}

debug_log() {
    local level="$1"
    local message="$2"
    local file="$3"
    local version="$4"
    local debug_level="${DEBUG_LEVEL:-ERROR}"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    
    # ãƒ¬ãƒ™ãƒ«åˆ¤å®šã®ã‚·ãƒ³ãƒ—ãƒ«åŒ–
    case "$level" in
        "DEBUG"|"INFO"|"WARN"|"ERROR") ;;
        "")
            level="DEBUG"
            message="$1"
            file="$2"
            version="$3"
            ;;
        *)
            message="$1"
            file="$2"
            version="$3"
            level="DEBUG"
            ;;
    esac

    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼‰
    if echo "$message" | grep -q "version\|Version"; then
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
        local cleaned_message="$message"
        # aios - [2025-03-10... ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
        if echo "$message" | grep -q " - "; then
            local prefix=$(echo "$message" | sed 's/ - .*//')
            local version_part=$(echo "$message" | sed 's/.* - //')
            
            # clean_version_stringé–¢æ•°ã‚’å‘¼ã³å‡ºã—
            local cleaned_version=$(clean_version_string "$version_part")
            
            cleaned_message="$prefix - $cleaned_version"
        fi
        message="$cleaned_message"
    fi

    # å¤‰æ•°ã‚’ç½®æ›
    message=$(echo "$message" | sed -e "s/{file}/$file/g" -e "s/{version}/$version/g")

    # ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡
    case "$DEBUG_LEVEL" in
        DEBUG)    allowed_levels="DEBUG INFO WARN ERROR" ;;
        INFO)     allowed_levels="INFO WARN ERROR" ;;
        WARN)     allowed_levels="WARN ERROR" ;;
        ERROR)    allowed_levels="ERROR" ;;
        *)        allowed_levels="ERROR" ;;
    esac

    if echo "$allowed_levels" | grep -q "$level"; then
        local timestamp
        timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        local log_message="[$timestamp] $level: $message"

        # ã‚«ãƒ©ãƒ¼è¡¨ç¤º - æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«å‡ºåŠ›
        case "$level" in
            "ERROR") printf "%s\n" "$(color red "$log_message")" >&2 ;;
            "WARN") printf "%s\n" "$(color yellow "$log_message")" >&2 ;;
            "INFO") printf "%s\n" "$(color cyan "$log_message")" >&2 ;;
            "DEBUG") printf "%s\n" "$(color white "$log_message")" >&2 ;;
        esac

        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
        if [ "$AIOS_INITIALIZED" = "true" ] && [ -d "$LOG_DIR" ]; then
            echo "$log_message" >> "$LOG_DIR/debug.log" 2>/dev/null
        fi
    fi
}

# ğŸ”´ã€€ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ‡ãƒãƒƒã‚°ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒ˜ãƒ«ãƒ—ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µ-------------------------------------------------------------------------------------------------------------------------------------------

print_help() {
    printf "%s\n\n" "$(get_message "MSG_HELP_USAGE")"
    
    printf "%s\n" "$(get_message "MSG_HELP_OPTIONS_HEADER")"
    printf "  %-25s %s\n" "-h, --help" "$(get_message "MSG_HELP_HELP")"
    printf "  %-25s %s\n" "-v, --version" "$(get_message "MSG_HELP_VERSION")"
    printf "  %-25s %s\n" "-r, --reset" "$(get_message "MSG_HELP_RESET")"
    printf "  %-25s %s\n" "-d, --debug" "$(get_message "MSG_HELP_DEBUG")"
    printf "  %-25s %s\n" "-u, --update" "$(get_message "MSG_HELP_UPDATE")"
    printf "  %-25s %s\n" "-f, --force" "$(get_message "MSG_HELP_FORCE")"
    printf "  %-25s %s\n" "-t, --token" "$(get_message "MSG_HELP_TOKEN")"
    printf "  %-25s %s\n" "-cf, --common_full" "$(get_message "MSG_HELP_FULL")"
    printf "  %-25s %s\n" "-cl, --common_light" "$(get_message "MSG_HELP_LIGHT")"
    printf "  %-25s %s\n" "-cd, --common_debug" "$(get_message "MSG_HELP_COMMON_DEBUG")"
    printf "  %-25s %s\n" "-dr, --dry-run" "$(get_message "MSG_HELP_DRY_RUN")"
    printf "  %-25s %s\n" "-nc, --no-cache" "Skip using cached version data"
    
    printf "\n%s\n" "$(get_message "MSG_HELP_LANGUAGE_HEADER")"
    printf "  %-25s %s\n" "US, JP, ..." "$(get_message "MSG_HELP_LANGUAGE")"
    
    printf "\n%s\n" "$(get_message "MSG_HELP_EXAMPLES_HEADER")"
    printf "  %s\n" "$(get_message "MSG_HELP_EXAMPLE1")"
    printf "  %s\n" "$(get_message "MSG_HELP_EXAMPLE2")"
    printf "  %s\n" "$(get_message "MSG_HELP_EXAMPLE3")"
    printf "  %s\n" "$(get_message "MSG_HELP_EXAMPLE4")"
}

# ğŸ”´ã€€ãƒ˜ãƒ«ãƒ—ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ã‚«ãƒ©ãƒ¼ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

# åŸºæœ¬è‰²è¡¨ç¤ºé–¢æ•°
color() {
    local c="$1"; shift
    case "$c" in
        red) printf "\033[38;5;196m%s\033[0m" "$*" ;;
        orange) printf "\033[38;5;208m%s\033[0m" "$*" ;;
        yellow) printf "\033[38;5;226m%s\033[0m" "$*" ;;
        green) printf "\033[38;5;46m%s\033[0m" "$*" ;;
        cyan) printf "\033[38;5;51m%s\033[0m" "$*" ;;
        blue) printf "\033[38;5;33m%s\033[0m" "$*" ;;
        indigo) printf "\033[38;5;57m%s\033[0m" "$*" ;;
        purple) printf "\033[38;5;129m%s\033[0m" "$*" ;;
        magenta) printf "\033[38;5;201m%s\033[0m" "$*" ;;
        white) printf "\033[37m%s\033[0m" "$*" ;;
        black) printf "\033[30m%s\033[0m" "$*" ;;
        *) printf "%s" "$*" ;;
    esac
}

# ğŸ”´ã€€ã‚«ãƒ©ãƒ¼ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ãƒ¡ãƒ¢ãƒªã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–¢æ•°
into_memory_message() {
    local lang="$DEFAULT_LANGUAGE"
    if [ -f "${CACHE_DIR}/message.ch" ]; then
        lang=$(cat "${CACHE_DIR}/message.ch")
    fi
    
    # ãƒ¡ãƒ¢ãƒªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åˆæœŸåŒ– - åŸºæœ¬çš„ãªè£œåŠ©ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’ä¿æŒ
    MSG_MEMORY=""
    
    # åŸºæœ¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨­å®š
    MSG_MEMORY="${MSG_MEMORY}${lang}|CONFIG_DOWNLOAD_SUCCESS=Downloaded{:}"$'\n'
    MSG_MEMORY="${MSG_MEMORY}${lang}|CONFIG_DOWNLOAD_UNNECESSARY=Latest Files{:}"$'\n'
    MSG_MEMORY="${MSG_MEMORY}${lang}|MSG_RESET_COMPLETE=Reset completed. All cached data has been cleared"$'\n'
    MSG_MEMORY="${MSG_MEMORY}${lang}|MSG_DELETE_COMPLETE=Delete completed. All base data has been cleared"$'\n'
    
    # DBãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’è¿½åŠ ã—ãªã„ - DBãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸»è¦ã‚½ãƒ¼ã‚¹
    
    MSG_MEMORY_INITIALIZED="true"
    MSG_MEMORY_LANG="$lang"
}

# ç¿»è¨³ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
init_translation() {
    debug_log "DEBUG" "Initializing translation system"
    
    # message.chãŒç„¡ã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨€èªã‚’è¨­å®š
    if [ ! -f "${CACHE_DIR}/message.ch" ] && [ -f "${BASE_DIR}/message_${DEFAULT_LANGUAGE}.db" ]; then
        echo "$DEFAULT_LANGUAGE" > "${CACHE_DIR}/message.ch"
        debug_log "DEBUG" "Created default language settings: $DEFAULT_LANGUAGE"
    fi
    
    # ãƒ¡ãƒ¢ãƒªå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åˆæœŸåŒ–
    into_memory_message
    
    debug_log "DEBUG" "Translation module initialization complete"
    return 0
}

# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸DBãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å–å¾—ã™ã‚‹é–¢æ•°
check_message_cache() {
    local lang="$1"
    
    # è¨€èªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç¢ºèª
    if [ -z "$lang" ]; then
        # è¨€èªãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€message.chã‹ã‚‰å–å¾—
        if [ -f "${CACHE_DIR}/message.ch" ]; then
            lang=$(cat "${CACHE_DIR}/message.ch")
        else
            lang="$DEFAULT_LANGUAGE"
        fi
    fi
    
    # è¨€èªå›ºæœ‰DBã®ç¢ºèª
    if [ -f "${BASE_DIR}/message_${lang}.db" ]; then
        echo "${BASE_DIR}/message_${lang}.db"
        return 0
    fi
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨€èªDBã®ç¢ºèª
    if [ -f "${BASE_DIR}/message_${DEFAULT_LANGUAGE}.db" ]; then
        echo "${BASE_DIR}/message_${DEFAULT_LANGUAGE}.db"
        return 0
    fi
    
    # ä½•ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç©ºæ–‡å­—åˆ—
    echo ""
    return 0
}

# ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ–‡å­—åˆ—ã®æ­£è¦åŒ–é–¢æ•°
normalize_message() {
    local input="$1"
    local lang="$2"  # è¨€èªã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    local output="$input"
    
    # ä¸­æ‹¬å¼§{} ã®ãƒãƒ¼ãƒãƒ©ã‚¤ã‚º - LC_ALL=Cã‚’é©ç”¨
    output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/ï½›/{/g; s/ï½/}/g')

    # ã‚³ãƒ­ãƒ³ : ã®ãƒãƒ¼ãƒãƒ©ã‚¤ã‚º - LC_ALL=Cã‚’é©ç”¨
    output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/ï¼š/:/g; s/âˆ¶/:/g; s/ê‰/:/g; s/Ë/:/g')

    # ç©ºç™½ : ã®ãƒãƒ¼ãƒãƒ©ã‚¤ã‚º - LC_ALL=Cã‚’é©ç”¨
    output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/ã€€//g; s/[[:space:]]//g')
    
    # è¨€èªã‚³ãƒ¼ãƒ‰ã®å…ˆé ­éƒ¨åˆ†ã‚’å–å¾—ï¼ˆä¾‹: zh-TWã‹ã‚‰zhï¼‰
    local lang_prefix="${lang%%-*}"
    
    # è¨€èªã‚³ãƒ¼ãƒ‰åˆ¥ã®æ•°å­—å¤‰æ›
    case "${lang_prefix}" in
        # CJKè¨€èªã‚°ãƒ«ãƒ¼ãƒ—
        ja|zh|ko)
            # å…¨è§’æ•°å­—ã®å¤‰æ›
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/ï¼/0/g; s/ï¼‘/1/g; s/ï¼’/2/g; s/ï¼“/3/g; s/ï¼”/4/g; s/ï¼•/5/g; s/ï¼–/6/g; s/ï¼—/7/g; s/ï¼˜/8/g; s/ï¼™/9/g')
            ;;
            
        # ã‚¢ãƒ©ãƒ“ã‚¢èªåœ
        ar|ur|ckb)
            # ã‚¢ãƒ©ãƒ“ã‚¢æ•°å­—ã®å¤‰æ›
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/Ù /0/g; s/Ù¡/1/g; s/Ù¢/2/g; s/Ù£/3/g; s/Ù¤/4/g; s/Ù¥/5/g; s/Ù¦/6/g; s/Ù§/7/g; s/Ù¨/8/g; s/Ù©/9/g')
            ;;
            
        # ãƒšãƒ«ã‚·ã‚¢èªåœ
        fa|ps)
            # ãƒšãƒ«ã‚·ã‚¢æ•°å­—ã®å¤‰æ›
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/Û°/0/g; s/Û±/1/g; s/Û²/2/g; s/Û³/3/g; s/Û´/4/g; s/Ûµ/5/g; s/Û¶/6/g; s/Û·/7/g; s/Û¸/8/g; s/Û¹/9/g')
            ;;
            
        # ã‚¤ãƒ³ãƒ‰ç³»ä¸»è¦è¨€èª
        hi|bn|ta|mr|ne|gu|pa)
            # ãƒ‡ãƒ¼ãƒ´ã‚¡ãƒŠãƒ¼ã‚¬ãƒªãƒ¼æ•°å­—ã®å¤‰æ›
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/à¥¦/0/g; s/à¥§/1/g; s/à¥¨/2/g; s/à¥©/3/g; s/à¥ª/4/g; s/à¥«/5/g; s/à¥¬/6/g; s/à¥­/7/g; s/à¥®/8/g; s/à¥¯/9/g')
            
            # ãƒ™ãƒ³ã‚¬ãƒ«æ•°å­—ã®å¤‰æ›
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/à§¦/0/g; s/à§§/1/g; s/à§¨/2/g; s/à§©/3/g; s/à§ª/4/g; s/à§«/5/g; s/à§¬/6/g; s/à§­/7/g; s/à§®/8/g; s/à§¯/9/g')
            
            # ã‚°ã‚¸ãƒ£ãƒ©ãƒ¼ãƒˆãƒ»ãƒ‘ãƒ³ã‚¸ãƒ£ãƒ–æ•°å­—ã®å¤‰æ›
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/à«¦/0/g; s/à«§/1/g; s/à«¨/2/g; s/à«©/3/g; s/à«ª/4/g; s/à««/5/g; s/à«¬/6/g; s/à«­/7/g; s/à«®/8/g; s/à«¯/9/g')
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/à©¦/0/g; s/à©§/1/g; s/à©¨/2/g; s/à©©/3/g; s/à©ª/4/g; s/à©«/5/g; s/à©¬/6/g; s/à©­/7/g; s/à©®/8/g; s/à©¯/9/g')
            ;;
            
        # ã‚¿ã‚¤èªãƒ»æ±å—ã‚¢ã‚¸ã‚¢
        th|lo|km|my)
            # ã‚¿ã‚¤ãƒ»ãƒŸãƒ£ãƒ³ãƒãƒ¼æ•°å­—ã®å¤‰æ›
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/à¹/0/g; s/à¹‘/1/g; s/à¹’/2/g; s/à¹“/3/g; s/à¹”/4/g; s/à¹•/5/g; s/à¹–/6/g; s/à¹—/7/g; s/à¹˜/8/g; s/à¹™/9/g')
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/á€/0/g; s/á/1/g; s/á‚/2/g; s/áƒ/3/g; s/á„/4/g; s/á…/5/g; s/á†/6/g; s/á‡/7/g; s/áˆ/8/g; s/á‰/9/g')
            ;;
            
        # ãƒ­ã‚·ã‚¢èªãƒ»ã‚­ãƒªãƒ«æ–‡å­—åœ
        ru|uk|be|bg|mk|sr|kk)
            # ã‚­ãƒªãƒ«æ–‡å­—ã®ãƒ©ãƒ†ãƒ³æ–‡å­—å¤‰æ›
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/Ğ°/a/g; s/Ğ±/b/g; s/Ğ²/v/g; s/Ğ³/g/g; s/Ğ´/d/g; s/Ğµ/e/g; s/Ñ‘/e/g; s/Ğ¶/zh/g; s/Ğ·/z/g; s/Ğ¸/i/g; s/Ğ¹/i/g; s/Ğº/k/g; s/Ğ»/l/g; s/Ğ¼/m/g; s/Ğ½/n/g; s/Ğ¾/o/g; s/Ğ¿/p/g; s/Ñ€/r/g; s/Ñ/s/g; s/Ñ‚/t/g; s/Ñƒ/u/g; s/Ñ„/f/g; s/Ñ…/h/g; s/Ñ†/ts/g; s/Ñ‡/ch/g; s/Ñˆ/sh/g; s/Ñ‰/shch/g; s/ÑŠ//g; s/Ñ‹/y/g; s/ÑŒ//g; s/Ñ/e/g; s/Ñ/yu/g; s/Ñ/ya/g')
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/Ğ/A/g; s/Ğ‘/B/g; s/Ğ’/V/g; s/Ğ“/G/g; s/Ğ”/D/g; s/Ğ•/E/g; s/Ğ/E/g; s/Ğ–/ZH/g; s/Ğ—/Z/g; s/Ğ˜/I/g; s/Ğ™/I/g; s/Ğš/K/g; s/Ğ›/L/g; s/Ğœ/M/g; s/Ğ/N/g; s/Ğ/O/g; s/ĞŸ/P/g; s/Ğ /R/g; s/Ğ¡/S/g; s/Ğ¢/T/g; s/Ğ£/U/g; s/Ğ¤/F/g; s/Ğ¥/H/g; s/Ğ¦/TS/g; s/Ğ§/CH/g; s/Ğ¨/SH/g; s/Ğ©/SHCH/g; s/Ğª//g; s/Ğ«/Y/g; s/Ğ¬//g; s/Ğ­/E/g; s/Ğ®/YU/g; s/Ğ¯/YA/g')
            ;;
            
        # æ¬§å·è¨€èªï¼ˆãƒ©ãƒ†ãƒ³æ–‡å­—æ‹¡å¼µï¼‰
        pl|cs|hu|ro|sk|sl)
            # æ±æ¬§ç‰¹æ®Šæ–‡å­—ã®å¤‰æ›
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/Ä…/a/g; s/Ä‡/c/g; s/Ä™/e/g; s/Å‚/l/g; s/Å„/n/g; s/Ã³/o/g; s/Å›/s/g; s/Åº/z/g; s/Å¼/z/g')
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/Ã¡/a/g; s/Ä/c/g; s/Ä/d/g; s/Ã©/e/g; s/Ä›/e/g; s/Ã­/i/g; s/Åˆ/n/g; s/Å™/r/g; s/Å¡/s/g; s/Å¥/t/g; s/Ãº/u/g; s/Å¯/u/g; s/Ã½/y/g; s/Å¾/z/g')
            ;;
            
        # è¥¿æ¬§ãƒ»åŒ—æ¬§è¨€èª
        fr|es|de|it|pt|nl|sv|da|no|fi)
            # åŸºæœ¬çš„ãªã‚¢ã‚¯ã‚»ãƒ³ãƒˆè¨˜å·ã®å¤‰æ›
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/[Ã¡Ã Ã¢Ã¤Ã£]/a/g; s/[Ã©Ã¨ÃªÃ«]/e/g; s/[Ã­Ã¬Ã®Ã¯]/i/g; s/[Ã³Ã²Ã´Ã¶Ãµ]/o/g; s/[ÃºÃ¹Ã»Ã¼]/u/g; s/[Ã½Ã¿]/y/g; s/Ã±/n/g; s/Ã§/c/g')
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/[ÃÃ€Ã‚Ã„Ãƒ]/A/g; s/[Ã‰ÃˆÃŠÃ‹]/E/g; s/[ÃÃŒÃÃ]/I/g; s/[Ã“Ã’Ã”Ã–Ã•]/O/g; s/[ÃšÃ™Ã›Ãœ]/U/g; s/[ÃÅ¸]/Y/g; s/Ã‘/N/g; s/Ã‡/C/g')
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/Ã¥/a/g; s/Ã¤/a/g; s/Ã¶/o/g; s/Ã¸/o/g; s/Ã¦/ae/g')
            output=$(LC_ALL=C echo "$output" | LC_ALL=C sed 's/Ã…/A/g; s/Ã„/A/g; s/Ã–/O/g; s/Ã˜/O/g; s/Ã†/AE/g')
            ;;
    esac
    
    # æ­£è¦åŒ–ã—ãŸçµæœã®ã¿ã‚’è¿”ã™
    LC_ALL=C printf '%s' "$output"
    return 0
}

get_message() {
    local key="$1"
    shift  # æœ€åˆã®å¼•æ•°ï¼ˆã‚­ãƒ¼ï¼‰ã‚’é™¤å»
    local lang="$DEFAULT_LANGUAGE"
    local message=""
    
    # è¨€èªã‚³ãƒ¼ãƒ‰ã®å–å¾—
    if [ -f "${CACHE_DIR}/message.ch" ]; then
        lang=$(cat "${CACHE_DIR}/message.ch")
    fi
    
    # DBã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
    local db_file="$(check_message_cache "$lang")"
    if [ -n "$db_file" ] && [ -f "$db_file" ]; then
        message=$(grep "^${lang}|${key}=" "$db_file" 2>/dev/null | cut -d'=' -f2-)
        if [ -z "$message" ] && [ "$lang" != "$DEFAULT_LANGUAGE" ]; then
            message=$(grep "^${DEFAULT_LANGUAGE}|${key}=" "$db_file" 2>/dev/null | cut -d'=' -f2-)
        fi
    else
        if [ "$MSG_MEMORY_INITIALIZED" != "true" ]; then
            into_memory_message
        fi
        if [ -n "$MSG_MEMORY" ]; then
            message=$(echo "$MSG_MEMORY" | grep "^${DEFAULT_LANGUAGE}|${key}=" 2>/dev/null | cut -d'=' -f2-)
        fi
    fi
    
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚­ãƒ¼ã‚’ãã®ã¾ã¾è¿”ã™
    if [ -z "$message" ]; then
        debug_log "DEBUG: Message not found for key: $key"
        message="$key"
    fi
    
    # normalize_messageé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦æ–‡å­—åˆ—ã‚’æ­£è¦åŒ– (è¨€èªã‚³ãƒ¼ãƒ‰ã‚’æ¸¡ã™)
    message=$(normalize_message "$message" "$lang")
    
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç½®æ›å‡¦ç†
    for param in "$@"; do
        param_name=$(echo "$param" | cut -d'=' -f1)
        param_value=$(echo "$param" | cut -d'=' -f2-)
        
        if [ -n "$param_name" ] && [ -n "$param_value" ]; then
            message=$(echo "$message" | sed "s|{$param_name}|$param_value|g")
            debug_log "DEBUG: Replaced {$param_name} with $param_value"
        fi
    done
    
    # å‡ºåŠ›
    printf "%b" "$message"
    return 0
}

# ğŸ”´ã€€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒˆãƒ¼ã‚¯ãƒ³ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã™ã‚‹é–¢æ•°
save_commit_to_cache() {
    local file_path="$1"
    local version="$2"
    local auth_method="$3"
    local cache_file="${COMMIT_CACHE_DIR}/$(echo "$file_path" | tr '/' '_').commit"
    local timestamp=$(date +%s)
    
    debug_log "DEBUG" "Saving commit info to cache: $file_path -> $cache_file"
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚©ãƒ«ãƒ€ãŒãªã‘ã‚Œã°ä½œæˆ
    [ -d "${COMMIT_CACHE_DIR}" ] || mkdir -p "${COMMIT_CACHE_DIR}"
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«æƒ…å ±ã‚’æ›¸ãè¾¼ã¿
    {
        echo "VERSION=$version"
        echo "AUTH_METHOD=$auth_method"
        echo "TIMESTAMP=$timestamp"
        echo "TTL=$COMMIT_CACHE_TTL"
        echo "FILE_PATH=$file_path"
    } > "$cache_file"
    
    return 0
}

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹é–¢æ•°
get_commit_from_cache() {
    local file_path="$1"
    local force="$2"  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¼·åˆ¶ç„¡è¦–ãƒ•ãƒ©ã‚°
    local cache_file="${COMMIT_CACHE_DIR}/$(echo "$file_path" | tr '/' '_').commit"
    local current_time=$(date +%s)
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¹ã‚­ãƒƒãƒ—ãŒæœ‰åŠ¹ã¾ãŸã¯forceãƒ•ãƒ©ã‚°ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡è¦–
    if [ "$SKIP_CACHE" = "true" ] || [ "$force" = "true" ] || [ "$FORCE" = "true" ]; then
        debug_log "DEBUG" "Skipping cache for $file_path (forced)"
        return 1
    fi
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆ
    if [ ! -f "$cache_file" ]; then
        debug_log "DEBUG" "No cache found for $file_path"
        return 1
    fi
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
    . "$cache_file"
    
    # å¿…é ˆå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    if [ -z "$VERSION" ] || [ -z "$TIMESTAMP" ] || [ -z "$TTL" ]; then
        debug_log "WARN" "Invalid cache file for $file_path"
        return 1
    fi
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹æœŸé™å†…ã‹ãƒã‚§ãƒƒã‚¯
    if [ $(( current_time - TIMESTAMP )) -gt "$TTL" ]; then
        debug_log "DEBUG" "Cache expired for $file_path ($(( (current_time - TIMESTAMP) / 60 )) minutes old)"
        return 1
    fi
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ãªå ´åˆã¯çµæœã‚’è¿”ã™
    debug_log "DEBUG" "Using cached commit info for $file_path: $VERSION (age: $(( (current_time - TIMESTAMP) / 60 )) minutes)"
    echo "$VERSION $AUTH_METHOD"
    return 0
}

format_api_status() {
    local auth_method="$1"
    local remaining="$2"
    local limit="$3"
    local reset_minutes="$4"
    local status_text=""
    
    debug_log "DEBUG" "Formatting API status with auth_method=$auth_method, remaining=$remaining, limit=$limit, reset_minutes=$reset_minutes"
    
    if [ "$auth_method" = "token" ] || [ "$auth_method" = "header" ] || [ "$auth_method" = "user" ]; then
        # èªè¨¼APIè¡¨ç¤º
        status_text="API: ${remaining}/${limit} TTL:${reset_minutes}m"
    elif [ "$auth_method" = "direct" ] && [ -n "$remaining" ] && [ -n "$limit" ]; then
        # æœªèªè¨¼APIã§ã‚‚æ®‹ã‚Šå›æ•°ãŒåˆ†ã‹ã‚‹å ´åˆ
        status_text="API: ${remaining}/${limit} TTL:${reset_minutes}m"
    else
        # ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚
        status_text="API: N/A TTL:${reset_minutes}m"
    fi
    
    echo "$status_text"
}

github_api_request() {
    local endpoint="$1"
    local token=$(get_github_token)
    local response=""
    local auth_method="direct"
    local temp_file="${CACHE_DIR}/api_request.tmp"
    local retry_count=0
    local max_retries=2
    
    # é–¢æ•°å†…ã§ã®wgetã‚³ãƒãƒ³ãƒ‰ç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚’å®šç¾©
    local local_wget_ipv_opt="$WGET_IPV_OPT"
    local local_base_wget="$BASE_WGET"
    local local_base_wget_auth_bearer="$BASE_WGET_AUTH_BEARER"
    local local_base_wget_auth_token="$BASE_WGET_AUTH_TOKEN"
    
    # wgetã®æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
    if [ -z "$WGET_SUPPORTS_HEADER" ]; then
        if wget --help 2>&1 | grep -q -- "--header"; then
            export WGET_SUPPORTS_HEADER=1
        else
            export WGET_SUPPORTS_HEADER=0
        fi
    fi
    
    # GitHub APIå‘¼ã³å‡ºã—ã‚’è©¦è¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ä»˜ãï¼‰
    while [ $retry_count -le $max_retries ]; do
        if [ $retry_count -gt 0 ]; then
            debug_log "DEBUG" "Retry attempt $retry_count for API request: $endpoint"
            sleep 1  # ãƒªãƒˆãƒ©ã‚¤é–“éš”
        fi
        
        if [ -n "$token" ]; then
            debug_log "DEBUG" "Using token authentication for API request"
            
            # èªè¨¼æ–¹æ³•1: Bearerãƒ˜ãƒƒãƒ€ãƒ¼èªè¨¼
            if [ "$WGET_SUPPORTS_HEADER" = "1" ]; then
                debug_log "DEBUG" "Trying Bearer authentication"
                
                # ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®Bearerèªè¨¼è¨­å®šã‚’ä½¿ç”¨
                eval $local_base_wget_auth_bearer "$temp_file" "$token" "https://api.github.com/$endpoint" 2>/dev/null
                
                if [ -f "$temp_file" ] && [ -s "$temp_file" ]; then
                    response=$(cat "$temp_file")
                    if ! echo "$response" | grep -q '"message":"Bad credentials"'; then
                        auth_method="bearer"
                        debug_log "DEBUG" "Bearer authentication successful"
                        break  # æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                    else
                        debug_log "DEBUG" "Bearer authentication failed, trying token auth"
                        
                        # ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®Tokenèªè¨¼è¨­å®šã‚’ä½¿ç”¨
                        eval $local_base_wget_auth_token "$temp_file" "$token" "https://api.github.com/$endpoint" 2>/dev/null
                        
                        if [ -f "$temp_file" ] && [ -s "$temp_file" ]; then
                            response=$(cat "$temp_file")
                            if ! echo "$response" | grep -q '"message":"Bad credentials"'; then
                                auth_method="token"
                                debug_log "DEBUG" "Token authentication successful"
                                break  # æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                            else
                                debug_log "DEBUG" "Token authentication failed"
                            fi
                        fi
                    fi
                else
                    debug_log "DEBUG" "Empty response from Bearer authentication"
                fi
            fi
            
            # èªè¨¼æ–¹æ³•2: wgetã®ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
            if [ "$auth_method" = "direct" ] && [ "$WGET_SUPPORTS_HEADER" = "0" ]; then
                debug_log "DEBUG" "Trying user authentication"
                $local_base_wget -O "$temp_file" --user="$token" --password="x-oauth-basic" \
                         "https://api.github.com/$endpoint" 2>/dev/null
                         
                if [ -f "$temp_file" ] && [ -s "$temp_file" ]; then
                    response=$(cat "$temp_file")
                    if ! echo "$response" | grep -q '"message":"Bad credentials"'; then
                        auth_method="user"
                        debug_log "DEBUG" "User authentication successful"
                        break  # æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                    else
                        debug_log "DEBUG" "User authentication failed"
                    fi
                fi
            fi
        fi
        
        # èªè¨¼æ–¹æ³•3: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
        if [ "$auth_method" = "direct" ]; then
            debug_log "DEBUG" "Falling back to direct access"
            $local_base_wget -O "$temp_file" "https://api.github.com/$endpoint" 2>/dev/null
            
            if [ -f "$temp_file" ] && [ -s "$temp_file" ]; then
                response=$(cat "$temp_file")
                if ! echo "$response" | grep -q '"message":"API rate limit exceeded'; then
                    debug_log "DEBUG" "Direct access successful"
                    break  # æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                fi
            fi
        fi
        
        # ãƒªãƒˆãƒ©ã‚¤æ™‚ã®æ¥ç¶šæ–¹æ³•ã‚’å¤‰æ›´ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®ã¿æ›´æ–°ï¼‰
        if [ $retry_count -eq 0 ] && [ -f "${CACHE_DIR}/network.ch" ]; then
            local current_network=$(cat "${CACHE_DIR}/network.ch")
            
            if [ "$current_network" = "v4v6" ]; then
                # ãƒ‡ãƒ¥ã‚¢ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã®å ´åˆã€IPv4ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€‚å¤±æ•—ã—ãŸã‚‰IPv6ã‚’è©¦ã™
                local_wget_ipv_opt="-6"
                # ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚’æ›´æ–°ï¼ˆé–¢æ•°å†…ã§ã®ã¿æœ‰åŠ¹ï¼‰
                local_base_wget="wget --no-check-certificate -q ${local_wget_ipv_opt} -O"
                local_base_wget_auth_bearer="wget --no-check-certificate -q ${local_wget_ipv_opt} -O \"\$1\" --header=\"Authorization: Bearer \$2\" \"\$3\""
                local_base_wget_auth_token="wget --no-check-certificate -q ${local_wget_ipv_opt} -O \"\$1\" --header=\"Authorization: token \$2\" \"\$3\""
                debug_log "DEBUG" "Switching to IPv6 for retry"
            elif [ "$current_network" = "v4" ] || [ "$current_network" = "v6" ]; then
                # ã‚·ãƒ³ã‚°ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã®å ´åˆã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã‚’å¢—ã‚„ã™
                export WGET_TIMEOUT="--timeout=30"
                debug_log "DEBUG" "Increasing timeout for retry"
            fi
        fi
        
        retry_count=$((retry_count + 1))
    done
    
    # ãƒªãƒˆãƒ©ã‚¤å¾Œã®æœ€çµ‚çµæœç¢ºèª
    if [ -z "$response" ]; then
        debug_log "WARN" "Empty response from API request after $max_retries retries"
        rm -f "$temp_file" 2>/dev/null
        return 1
    fi
    
    if echo "$response" | grep -q '"message":"API rate limit exceeded'; then
        debug_log "WARN" "GitHub API rate limit exceeded"
        rm -f "$temp_file" 2>/dev/null
        return 1
    fi
    
    # èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
    if echo "$response" | grep -q '"message":"Bad credentials"'; then
        debug_log "ERROR" "GitHub API authentication failed: Bad credentials"
        rm -f "$temp_file" 2>/dev/null
        return 2
    fi
    
    # ãã®ä»–ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
    if echo "$response" | grep -q '"message":"'; then
        local error_msg=$(echo "$response" | grep -o '"message":"[^"]*"' | cut -d':' -f2- | tr -d '"')
        debug_log "ERROR" "GitHub API error: $error_msg"
        rm -f "$temp_file" 2>/dev/null
        return 3
    fi

    # æˆåŠŸ
    echo "$response"
    rm -f "$temp_file" 2>/dev/null
    
    # wgetè¨­å®šã‚’å…ƒã«æˆ»ã™é–¢æ•°ã‚’å‘¼ã³å‡ºã—
    setup_wget_options
    return 0
}

save_github_token() {
    token="$1"
    
    if [ -z "$token" ]; then
        debug_log "ERROR" "Empty token provided, cannot save"
        return 1
    fi
    
    # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¦æ¨©é™ã‚’è¨­å®š
    echo "$token" > "$GITHUB_TOKEN_FILE"
    chmod 600 "$GITHUB_TOKEN_FILE"
    
    if [ $? -eq 0 ]; then
        debug_log "DEBUG" "GitHub token saved to $GITHUB_TOKEN_FILE"
        return 0
    else
        debug_log "ERROR" "Failed to save token to $GITHUB_TOKEN_FILE"
        return 1
    fi
}

get_github_token() {
    local token=""
    
    if [ -f "$GITHUB_TOKEN_FILE" ] && [ -r "$GITHUB_TOKEN_FILE" ]; then
        # æ”¹è¡Œã‚„ä½™åˆ†ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™
        token=$(cat "$GITHUB_TOKEN_FILE" | tr -d '\n\r\t ' | head -1)
        if [ -n "$token" ]; then
            echo "$token"
            return 0
        fi
    fi
    
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã®å–å¾—ï¼ˆä¸è¦ãªæ–‡å­—ã‚‚å‰Šé™¤ï¼‰
    if [ -n "$GITHUB_TOKEN" ]; then
        echo "$GITHUB_TOKEN" | tr -d '\n\r\t '
        return 0
    fi
    
    return 1
}

save_version_to_cache() {
    local file_name="$1"
    local version="$2"
    local script_file="$3"
    
    # tmpãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ç½®ãæ›ãˆã‚‹ï¼ˆå¤ã„sedã§ã‚‚å‹•ä½œï¼‰
    if [ -f "$script_file" ]; then
        grep -v "^${file_name}=" "$script_file" > "${script_file}.tmp"
        echo "${file_name}=${version}" >> "${script_file}.tmp"
        mv "${script_file}.tmp" "$script_file"
    else
        echo "${file_name}=${version}" > "$script_file"
    fi
}

# ãƒˆãƒ¼ã‚¯ãƒ³ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–¢æ•°ã®æ”¹å–„ç‰ˆ
setup_github_token() {
    echo "GitHub API Token Setup"
    echo "======================"
    
    # wgetæ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
    local wget_capability=$(detect_wget_capabilities)
    debug_log "DEBUG" "Detected wget capability: $wget_capability"
    
    # ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯è­¦å‘Šã—ã¦çµ‚äº†
    if [ "$wget_capability" = "limited" ]; then
        echo "ERROR: GitHub API token authentication is not supported on this system."
        echo "Your version of wget does not support the required authentication methods."
        echo "API requests will be limited to 60 calls per hour."
        echo ""
        echo "This system uses a wget version without authentication support." 
        debug_log "DEBUG" "Token authentication not supported due to limited wget capabilities"
        return 1
    fi
    
    echo "This will save a GitHub Personal Access Token to $GITHUB_TOKEN_FILE"
    echo "The token will be used for API requests to avoid rate limits."
    echo ""
    
    printf "Enter your GitHub Personal Access Token: "
    read -r token
    echo ""
    
    if [ -n "$token" ]; then
        if save_github_token "$token"; then
            echo "Token has been saved successfully!"
            echo "API requests will now use authentication (up to 5000 calls per hour)."
            echo ""
            
            # ä½¿ç”¨å¯èƒ½ãªèªè¨¼æ–¹æ³•ã®è¡¨ç¤º
            case "$wget_capability" in
                header)
                    echo "Your system supports header authentication (optimal)."
                    ;;
                basic)
                    echo "Your system supports basic authentication."
                    ;;
            esac
        else
            echo "Failed to save token. Please check permissions."
        fi
    else
        echo "No token entered. Operation cancelled."
    fi
}

# ğŸ”´ã€€ãƒˆãƒ¼ã‚¯ãƒ³ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

check_network_connectivity() {
    local ip_check_file="${CACHE_DIR}/network.ch"
    local ret4=1
    local ret6=1

    debug_log "DEBUG: Checking IPv4 connectivity"
    ping -c 1 -w 3 8.8.8.8 >/dev/null 2>&1
    ret4=$?

    debug_log "DEBUG: Checking IPv6 connectivity"
    ping6 -c 1 -w 3 2001:4860:4860::8888 >/dev/null 2>&1
    ret6=$?

    if [ "$ret4" -eq 0 ] && [ "$ret6" -eq 0 ]; then
        echo "v4v6" > "${ip_check_file}"
    elif [ "$ret4" -eq 0 ]; then
        echo "v4" > "${ip_check_file}"
    elif [ "$ret6" -eq 0 ]; then
        echo "v6" > "${ip_check_file}"
    else
        echo "" > "${ip_check_file}"
    fi
}

setup_wget_options() {
    # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—
    local network_type=""
    if [ -f "${CACHE_DIR}/network.ch" ]; then
        network_type=$(cat "${CACHE_DIR}/network.ch")
    fi
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®IPãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆç©º=ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã«å¾“ã†ï¼‰
    WGET_IPV_OPT=""
    
    # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã«å¿œã˜ã¦IPãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š 
    case "$network_type" in
        v4)
            WGET_IPV_OPT="-4"
            debug_log "DEBUG" "Setting wget to use IPv4 only"
            ;;
        v6)
            WGET_IPV_OPT="-6"
            debug_log "DEBUG" "Setting wget to use IPv6 only"
            ;;
        v4v6|*)
            # ãƒ‡ãƒ¥ã‚¢ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ç’°å¢ƒã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            WGET_IPV_OPT=""
            debug_log "DEBUG" "Using system default IP settings for wget"
            ;;
    esac
    
    debug_log "DEBUG" "wget IP version updated to: ${WGET_IPV_OPT}"
}

version_is_newer() {
    local current="$1"  # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³
    local reference="$2"  # ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    
    debug_log "DEBUG" "Comparing: Remote=$current, Local=$reference"
    
    # ã©ã¡ã‚‰ã‹ãŒä¸æ˜ã®å ´åˆã¯æ›´æ–°å¿…è¦
    if echo "$current $reference" | grep -q "No version\|unknown"; then
        debug_log "DEBUG" "Unknown version detected, update required"
        return 0
    fi
    
    # å®Œå…¨ä¸€è‡´ã®å ´åˆã¯æ›´æ–°ä¸è¦
    if [ "$current" = "$reference" ]; then
        debug_log "DEBUG" "Exact match: No update needed"
        return 1
    fi
    
    # æ—¥ä»˜éƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆYYYY.MM.DDå½¢å¼ï¼‰
    local current_date=$(echo "$current" | grep -o "[0-9][0-9][0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]" | head -1)
    local reference_date=$(echo "$reference" | grep -o "[0-9][0-9][0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]" | head -1)
    
    # æ—¥ä»˜ãŒæŠ½å‡ºã§ããªã‹ã£ãŸå ´åˆã¯æ›´æ–°ãŒå¿…è¦
    if [ -z "$current_date" ] || [ -z "$reference_date" ]; then
        debug_log "DEBUG" "Date extraction failed: Update for safety"
        return 0
    fi
    
    # æ—¥ä»˜ã‚’æ•°å€¤ã«å¤‰æ›ï¼ˆåŒºåˆ‡ã‚Šæ–‡å­—ã‚’å‰Šé™¤ï¼‰
    local current_num=$(echo "$current_date" | tr -d '.')
    local reference_num=$(echo "$reference_date" | tr -d '.')
    
    # æ•°å€¤æ¯”è¼ƒï¼ˆæ—¥ä»˜å½¢å¼ï¼‰
    if [ "$current_num" -gt "$reference_num" ]; then
        debug_log "DEBUG" "Remote date is newer: Update required"
        return 0  # ãƒªãƒ¢ãƒ¼ãƒˆï¼ˆcurrentï¼‰ãŒæ–°ã—ã„
    elif [ "$current_num" -lt "$reference_num" ]; then
        debug_log "DEBUG" "Local date is newer: No update needed"
        return 1  # ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆreferenceï¼‰ãŒæ–°ã—ã„
    fi
    
    # æ—¥ä»˜ãŒåŒã˜å ´åˆã¯SHAéƒ¨åˆ†ã‚’æ¯”è¼ƒ
    local current_sha=$(echo "$current" | grep -o "\-[a-z0-9]*" | sed 's/^-//' | head -1)
    local reference_sha=$(echo "$reference" | grep -o "\-[a-z0-9]*" | sed 's/^-//' | head -1)
    
    # SHAæƒ…å ±ã‚’ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
    debug_log "DEBUG" "SHA comparison: Remote=$current_sha, Local=$reference_sha"
    
    # ç›´æ¥DLæ™‚ã®ç‰¹åˆ¥å‡¦ç†: ãƒãƒƒã‚·ãƒ¥ã®å…ˆé ­7æ–‡å­—ã ã‘æ¯”è¼ƒã—ã¦ç•°ãªã‚‹å ´åˆã®ã¿æ›´æ–°
    if [ -n "$current_sha" ] && [ -n "$reference_sha" ]; then
        # ã©ã¡ã‚‰ã‹ã«directã¨ã„ã†ãƒãƒ¼ã‚¯ãŒã‚ã‚Œã°ç›´æ¥DLãƒ¢ãƒ¼ãƒ‰ã¨åˆ¤æ–­
        if echo "$current $reference" | grep -q "direct"; then
            # å…ˆé ­7æ–‡å­—ã ã‘æ¯”è¼ƒï¼ˆSHA-1ã¨SHA-256ã‚’æ··åœ¨æ¯”è¼ƒã™ã‚‹å ´åˆã®å¯¾ç­–ï¼‰
            local current_short=$(echo "$current_sha" | head -c 7)
            local reference_short=$(echo "$reference_sha" | head -c 7)
            
            if [ "$current_short" != "$reference_short" ]; then
                debug_log "DEBUG" "Different file hash in direct mode: Update required"
                return 0  # ç•°ãªã‚‹ãƒãƒƒã‚·ãƒ¥
            else
                debug_log "DEBUG" "Same file hash in direct mode: No update needed"
                return 1  # åŒä¸€ãƒãƒƒã‚·ãƒ¥
            fi
        elif [ "$current_sha" != "$reference_sha" ]; then
            debug_log "DEBUG" "Different SHA: Update required"
            return 0  # ç•°ãªã‚‹ã‚³ãƒŸãƒƒãƒˆ
        fi
    fi
    
    debug_log "DEBUG" "Same version or unable to compare: No update needed"
    return 1  # åŒä¸€ãƒãƒ¼ã‚¸ãƒ§ãƒ³
}

# OpenWrtç’°å¢ƒã®wgetæ©Ÿèƒ½æ¤œå‡ºé–¢æ•°ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
detect_wget_capabilities() {
    debug_log "DEBUG" "Detecting wget capabilities for current environment"
    
    local temp_file="${CACHE_DIR}/wget_help.tmp"
    local test_file="${CACHE_DIR}/wget_test_header.tmp"
    local header_support="no"
    local user_support="no"
    
    # wgetã®ãƒ˜ãƒ«ãƒ—ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆ--helpãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆã®ãŸã‚ç©ºãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼‰
    touch "$temp_file"
    wget --help > "$temp_file" 2>&1 || true
    
    # ãƒ‡ãƒãƒƒã‚°ç”¨ã«wgetãƒ˜ãƒ«ãƒ—å†…å®¹ã®å…ˆé ­è¡Œã‚’è¨˜éŒ²
    debug_log "DEBUG" "wget help output beginning:"
    head -3 "$temp_file" | while read line; do
        debug_log "DEBUG" "  $line"
    done
    
    # OpenWrt/BusyBox wgetã®æ¤œå‡ºï¼ˆç‰¹å¾´çš„ãªå‡ºåŠ›ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
    if grep -q "BusyBox" "$temp_file" || ! grep -q "\-\-header" "$temp_file"; then
        debug_log "DEBUG" "Detected BusyBox wget without header support"
        rm -f "$temp_file"
        echo "limited"
        return 1
    fi
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚µãƒãƒ¼ãƒˆã‚’ç¢ºèª - ã‚ˆã‚Šå³å¯†ãªãƒ‘ã‚¿ãƒ¼ãƒ³
    if grep -q -- "--header=" "$temp_file" || grep -q -- "--header " "$temp_file"; then
        debug_log "DEBUG" "wget supports header authentication"
        header_support="yes"
    fi
    
    # åŸºæœ¬èªè¨¼ã®ã‚µãƒãƒ¼ãƒˆã‚’ç¢ºèª - ã‚ˆã‚Šå³å¯†ãªãƒ‘ã‚¿ãƒ¼ãƒ³
    if grep -q -- "--user=" "$temp_file" || grep -q -- "--user " "$temp_file"; then
        debug_log "DEBUG" "wget supports basic authentication"
        user_support="yes"
    fi
    
    # å®Ÿéš›ã«æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ï¼ˆãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆæ¤œå‡ºã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
    if [ "$header_support" = "yes" ]; then
        debug_log "DEBUG" "Testing header support with actual command"
        rm -f "$temp_file"
        echo "header"
        return 0
    elif [ "$user_support" = "yes" ]; then
        debug_log "DEBUG" "Basic authentication is supported"
        rm -f "$temp_file"
        echo "basic" 
        return 0
    else
        debug_log "DEBUG" "No authentication methods supported"
        rm -f "$temp_file"
        echo "limited"
        return 1
    fi
}

# APIãƒ¬ãƒ¼ãƒˆåˆ¶é™æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯ã¨å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ä»˜ãï¼‰
check_api_rate_limit() {
    local token="$(get_github_token)"
    local temp_file="${CACHE_DIR}/api_limit.tmp"
    local auth_method="direct"
    local current_time=$(date +%s)
    
    # IPãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®šã®åˆæœŸåŒ–ç¢ºèª
    if [ -z "$WGET_IPV_OPT" ]; then
        setup_wget_options
        debug_log "DEBUG" "Initialized wget IP options before checking API rate limit"
    fi
    
    # å…ˆã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆåˆå›å®Ÿè¡Œæ™‚ï¼‰
    if [ -z "$API_LAST_CHECK" ] && [ -f "${CACHE_DIR}/api_rate.ch" ]; then
        debug_log "DEBUG" "Loading API rate information from cache file"
        . "${CACHE_DIR}/api_rate.ch"
    fi
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé–“å†…ã®å ´åˆã¯ä¿å­˜å€¤ã‚’è¿”ã™
    if [ -n "$API_REMAINING" ] && [ $(( current_time - API_LAST_CHECK )) -lt ${API_CACHE_TTL:-60} ]; then
        debug_log "DEBUG" "Using cached API rate limit info: $API_REMAINING/$API_LIMIT, age: $(( current_time - API_LAST_CHECK ))s"
        echo "API: ${API_REMAINING}/${API_LIMIT} TTL:${API_RESET_TIME}m"
        return 0
    fi
    
    # æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    [ -f "$temp_file" ] && rm -f "$temp_file"
    
    # wgetæ©Ÿèƒ½ã¨èªè¨¼æ–¹æ³•ã®æ¤œå‡ºï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
    if [ -z "$WGET_CAPABILITY" ] && [ -n "$token" ]; then
        WGET_CAPABILITY=$(detect_wget_capabilities)
        debug_log "DEBUG" "Detected wget capability: $WGET_CAPABILITY"
        
        # ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¦ã‚‚èªè¨¼æ©Ÿèƒ½ãŒä½¿ãˆãªã„å ´åˆã€è­¦å‘Šè¡¨ç¤º
        if [ "$WGET_CAPABILITY" = "limited" ] && [ -f "$GITHUB_TOKEN_FILE" ]; then
            debug_log "WARN" "GitHub token is set but authentication is not supported with current wget version"
        fi
    fi
    
    # èªè¨¼æ–¹æ³•ã®é¸æŠ
    if [ -n "$token" ] && [ "$WGET_CAPABILITY" != "limited" ]; then
        if [ "$WGET_CAPABILITY" = "header" ]; then
            # ãƒ˜ãƒƒãƒ€ãƒ¼èªè¨¼ï¼ˆæœ€é©ï¼‰
            $BASE_WGET -O "$temp_file" --header="Authorization: token $token" \
                 "https://api.github.com/rate_limit" 2>/dev/null
            
            if [ -f "$temp_file" ] && [ -s "$temp_file" ] && ! grep -q "Bad credentials\|Unauthorized" "$temp_file"; then
                auth_method="token"
                debug_log "DEBUG" "Successfully authenticated with token header"
            fi
        elif [ "$WGET_CAPABILITY" = "basic" ]; then
            # åŸºæœ¬èªè¨¼
            $BASE_WGET -O "$temp_file" --user="$token" --password="x-oauth-basic" \
                 "https://api.github.com/rate_limit" 2>/dev/null
                 
            if [ -f "$temp_file" ] && [ -s "$temp_file" ] && ! grep -q "Bad credentials\|Unauthorized" "$temp_file"; then
                auth_method="basic"
                debug_log "DEBUG" "Successfully authenticated with basic auth"
            fi
        fi
    fi
    
    # éèªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆèªè¨¼ã«å¤±æ•—ã—ãŸå ´åˆã¾ãŸã¯èªè¨¼ãªã—ã®å ´åˆï¼‰
    if [ "$auth_method" = "direct" ]; then
        debug_log "DEBUG" "Making direct API request"
        $BASE_WGET -O "$temp_file" "https://api.github.com/rate_limit" 2>/dev/null
    fi
    
    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ
    if [ -f "$temp_file" ] && [ -s "$temp_file" ]; then
        # ãƒ¬ãƒ¼ãƒˆæƒ…å ±ã®æŠ½å‡º
        local core_limit=$(grep -o '"limit"[ ]*:[ ]*[0-9]\+' "$temp_file" | head -1 | grep -o '[0-9]\+')
        local core_remaining=$(grep -o '"remaining"[ ]*:[ ]*[0-9]\+' "$temp_file" | head -1 | grep -o '[0-9]\+')
        local core_reset=$(grep -o '"reset"[ ]*:[ ]*[0-9]\+' "$temp_file" | head -1 | grep -o '[0-9]\+')
        
        # ã‚³ã‚¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³å„ªå…ˆ
        if [ -z "$core_limit" ] || [ -z "$core_remaining" ] || [ -z "$core_reset" ]; then
            local core_section=$(sed -n '/"core":/,/},/p' "$temp_file")
            [ -z "$core_limit" ] && core_limit=$(echo "$core_section" | grep -o '"limit"[ ]*:[ ]*[0-9]\+' | head -1 | grep -o '[0-9]\+')
            [ -z "$core_remaining" ] && core_remaining=$(echo "$core_section" | grep -o '"remaining"[ ]*:[ ]*[0-9]\+' | head -1 | grep -o '[0-9]\+')
            [ -z "$core_reset" ] && core_reset=$(echo "$core_section" | grep -o '"reset"[ ]*:[ ]*[0-9]\+' | head -1 | grep -o '[0-9]\+')
        fi
        
        # ãƒªã‚»ãƒƒãƒˆæ™‚é–“ã®è¨ˆç®—
        local reset_minutes=60
        if [ -n "$core_reset" ] && [ "$core_reset" -gt 1000000000 ]; then
            local now_time=$(date +%s)
            if [ "$core_reset" -gt "$now_time" ]; then
                local reset_seconds=$(( core_reset - now_time ))
                reset_minutes=$(( reset_seconds / 60 ))
                [ "$reset_minutes" -lt 1 ] && reset_minutes=1
            else
                reset_minutes=0
            fi
        else
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
            if [ "$auth_method" != "direct" ]; then
                reset_minutes=60
            else
                reset_minutes=5
            fi
        fi
        
        # ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
        API_REMAINING=$core_remaining
        API_LIMIT=$core_limit
        API_RESET_TIME=$reset_minutes
        API_AUTH_METHOD=$auth_method
        API_LAST_CHECK=$current_time
        
        # å€¤ã®ãƒã‚§ãƒƒã‚¯ã¨æ•´å½¢
        [ -z "$API_LIMIT" ] && API_LIMIT="?"
        [ -z "$API_REMAINING" ] && API_REMAINING="?"
    else
        # æƒ…å ±å–å¾—å¤±æ•—æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        if [ "$auth_method" != "direct" ]; then
            API_LIMIT="5000"
            API_REMAINING="?"
            API_RESET_TIME="60"
        else
            API_LIMIT="60"
            API_REMAINING="?"
            API_RESET_TIME="5"
        fi
        API_AUTH_METHOD=$auth_method
        API_LAST_CHECK=$current_time
    fi
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
    save_api_rate_cache
    
    # çµæœæ–‡å­—åˆ—ã®ç”Ÿæˆ
    local status_text="API: ${API_REMAINING}/${API_LIMIT} TTL:${API_RESET_TIME}m"
    debug_log "DEBUG" "Final API status: $status_text (auth_method=$auth_method)"
    
    # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
    [ -f "$temp_file" ] && rm -f "$temp_file"
    
    # çµæœã‚’è¿”ã™
    echo "$status_text"
}

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«APIãƒ¬ãƒ¼ãƒˆåˆ¶é™æƒ…å ±ã‚’ä¿å­˜
save_api_rate_cache() {
    local cache_file="${CACHE_DIR}/api_rate.ch"
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã‘ã‚Œã°ä½œæˆ
    [ ! -d "$CACHE_DIR" ] && mkdir -p "$CACHE_DIR"
    
    # ä¿å­˜å†…å®¹ã®ä½œæˆ
    {
        echo "API_REMAINING=\"$API_REMAINING\""
        echo "API_LIMIT=\"$API_LIMIT\""
        echo "API_RESET_TIME=\"$API_RESET_TIME\""
        echo "API_AUTH_METHOD=\"$API_AUTH_METHOD\""
        echo "API_LAST_CHECK=\"$API_LAST_CHECK\""
    } > "$cache_file"
    
    debug_log "DEBUG" "API rate info cached to $cache_file"
}

clean_version_string() {
    local version_str="$1"
    
    # 1. æ”¹è¡Œã¨å¾©å¸°ã‚’å‰Šé™¤
    local cleaned=$(printf "%s" "$version_str" | tr -d '\n\r')
    
    # 2. è§’æ‹¬å¼§ã‚’å‰Šé™¤
    cleaned=$(printf "%s" "$cleaned" | sed 's/\[//g; s/\]//g')
    
    # 3. ANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
    cleaned=$(printf "%s" "$cleaned" | sed 's/\x1b\[[0-9;]*[mK]//g')
    
    # 4. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®æŠ½å‡ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªæ–¹æ³•ï¼‰
    if echo "$cleaned" | grep -q '20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]'; then
        # å¹´.æœˆ.æ—¥ å½¢å¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡º
        local date_part=$(printf "%s" "$cleaned" | grep -o '20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]')
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ã®æ®‹ã‚Šã®éƒ¨åˆ†ãŒã‚ã‚Œã°è¿½åŠ 
        if echo "$cleaned" | grep -q "${date_part}-"; then
            local remainder=$(printf "%s" "$cleaned" | sed "s/.*${date_part}-//; s/[^0-9a-zA-Z-].*//")
            printf "%s-%s" "$date_part" "$remainder"
        else
            printf "%s" "$date_part"
        fi
    else
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…ƒã®æ–‡å­—åˆ—ã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã—ãŸã‚‚ã®ã‚’è¿”ã™
        printf "%s" "$cleaned"
    fi
}

# ã‚³ãƒŸãƒƒãƒˆæƒ…å ±å–å¾—é–¢æ•°ã®æ”¹è‰¯ç‰ˆ
get_commit_version() {
    local file_path="$1"
    local force_refresh="$2"  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¼·åˆ¶æ›´æ–°ãƒ•ãƒ©ã‚°
    local temp_file="${CACHE_DIR}/commit_info.tmp" 
    local direct_file="${CACHE_DIR}/direct_file.tmp"

    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨æ™‚ã€ã¾ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰æƒ…å ±ã‚’å–å¾—
    if [ "$SKIP_CACHE" != "true" ] && [ "$force_refresh" != "true" ] && [ "$FORCE" != "true" ]; then
        get_commit_from_cache "$file_path"
        if [ $? -eq 0 ]; then
            return 0  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã®æƒ…å ±å–å¾—ã«æˆåŠŸã—ãŸå ´åˆçµ‚äº†
        fi
    fi

    # ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±
    local repo_owner="site-u2023"
    local repo_name="aios"
    local api_url="repos/${repo_owner}/${repo_name}/commits?path=${file_path}&per_page=1"
    local auth_method="direct"
    local retry_count=0
    local max_retries=2
    
    # ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã¨APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    local token="$(get_github_token)"
    
    # APIå‘¼ã³å‡ºã—ã‚’è©¦è¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ä»˜ãï¼‰
    while [ $retry_count -le $max_retries ]; do
        if [ $retry_count -gt 0 ]; then
            debug_log "DEBUG" "Retry attempt $retry_count for commit version request: $file_path"
            sleep 1  # ãƒªãƒˆãƒ©ã‚¤é–“éš”
        fi
        
        # èªè¨¼æ–¹æ³•ã«å¿œã˜ãŸAPIå‘¼ã³å‡ºã—
        if [ -n "$token" ] && [ "$API_AUTH_METHOD" != "direct" ]; then
            if [ "$API_AUTH_METHOD" = "token" ] || [ "$WGET_CAPABILITY" = "header" ]; then
                # ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ã§GitHub APIã«ã‚¢ã‚¯ã‚»ã‚¹
                wget -q --no-check-certificate ${WGET_IPV_OPT} -O "$temp_file" --header="Authorization: token $token" \
                     "https://api.github.com/$api_url" 2>/dev/null
                auth_method="token"
            elif [ "$API_AUTH_METHOD" = "basic" ] || [ "$WGET_CAPABILITY" = "basic" ]; then
                # åŸºæœ¬èªè¨¼ã§GitHub APIã«ã‚¢ã‚¯ã‚»ã‚¹
                wget -q --no-check-certificate ${WGET_IPV_OPT} -O "$temp_file" --user="$token" --password="x-oauth-basic" \
                     "https://api.github.com/$api_url" 2>/dev/null
                auth_method="basic"
            else
                # èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹
                wget -q --no-check-certificate ${WGET_IPV_OPT} -O "$temp_file" "https://api.github.com/$api_url" 2>/dev/null
                auth_method="direct"
            fi
        else
            # èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹
            wget -q --no-check-certificate ${WGET_IPV_OPT} -O "$temp_file" "https://api.github.com/$api_url" 2>/dev/null
            auth_method="direct"
        fi
        
        # å¿œç­”ãƒã‚§ãƒƒã‚¯
        if [ -s "$temp_file" ] && ! grep -q "API rate limit exceeded\|Not Found" "$temp_file"; then
            debug_log "DEBUG" "Successfully retrieved commit information"
            break  # æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
        fi
        
        # ãƒªãƒˆãƒ©ã‚¤æ™‚ã®æ¥ç¶šæ–¹æ³•ã‚’å¤‰æ›´
        if [ $retry_count -eq 0 ] && [ -f "${CACHE_DIR}/network.ch" ]; then
            local current_network=$(cat "${CACHE_DIR}/network.ch")
            
            if [ "$current_network" = "v4v6" ]; then
                # IPv6ã‚’è©¦ã™
                WGET_IPV_OPT="-6"
                BASE_WGET="wget --no-check-certificate -q ${WGET_IPV_OPT} -O"
                debug_log "DEBUG" "Switching to IPv6 for retry"
            elif [ "$current_network" = "v4" ] || [ "$current_network" = "v6" ]; then
                # ã‚·ãƒ³ã‚°ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã®å ´åˆã¯ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã™
                debug_log "DEBUG" "Switching to direct file download"
                break
            fi
        fi
        
        retry_count=$((retry_count + 1))
    done
    
    # APIã§ã®å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã¯ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è©¦è¡Œ
    if [ ! -s "$temp_file" ] || grep -q "API rate limit exceeded\|Not Found" "$temp_file"; then
        debug_log "DEBUG" "API call failed, falling back to direct file check"
        
        # ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚‚IPv4/IPv6ä¸¡æ–¹ã‚’è©¦ã™
        retry_count=0
        while [ $retry_count -le 1 ]; do
            if wget -q --no-check-certificate ${WGET_IPV_OPT} -O "$direct_file" "https://raw.githubusercontent.com/$repo_owner/$repo_name/main/$file_path" 2>/dev/null; then
                if [ -s "$direct_file" ]; then
                    # ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆ
                    local file_hash=$(sha256sum "$direct_file" 2>/dev/null | cut -c1-7)
                    rm -f "$direct_file" "$temp_file" 2>/dev/null
                    local today=$(date +%Y.%m.%d)
                    
                    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
                    local version="$today-$file_hash"
                    auth_method="direct"
                    
                    # wgetè¨­å®šã‚’å…ƒã«æˆ»ã™
                    setup_wget_options
                    
                    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                    save_commit_to_cache "$file_path" "$version" "$auth_method"
                    
                    echo "$version $auth_method"
                    return 0
                fi
            fi
            
            # ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ãƒªãƒˆãƒ©ã‚¤ã‚‚æ¥ç¶šæ–¹æ³•ã‚’å¤‰æ›´
            if [ $retry_count -eq 0 ] && [ -f "${CACHE_DIR}/network.ch" ]; then
                local current_network=$(cat "${CACHE_DIR}/network.ch")
                if [ "$current_network" = "v4v6" ]; then
                    WGET_IPV_OPT="-6"
                    BASE_WGET="wget --no-check-certificate -q ${WGET_IPV_OPT} -O"
                    debug_log "DEBUG" "Switching to IPv6 for direct file download retry"
                fi
            fi
            
            retry_count=$((retry_count + 1))
        done
        
        debug_log "ERROR" "Failed to download file: $file_path"
        rm -f "$direct_file" "$temp_file" 2>/dev/null
        
        # wgetè¨­å®šã‚’å…ƒã«æˆ»ã™
        setup_wget_options
        echo "$(date +%Y.%m.%d)-unknown $auth_method"
        return 1
    fi
    
    # APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’æŠ½å‡º
    local commit_date=""
    local commit_sha=""
    
    # SHAæƒ…å ±ã®æŠ½å‡ºï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
    commit_sha=$(grep -o '"sha"[[:space:]]*:[[:space:]]*"[a-f0-9]\+' "$temp_file" | head -1 | grep -o '[a-f0-9]\{7,40\}' | head -c 7)
    if [ -z "$commit_sha" ]; then
        commit_sha=$(grep -o '[a-f0-9]\{40\}' "$temp_file" | head -1 | head -c 7)
    fi
    
    # æ—¥ä»˜æƒ…å ±ã®æŠ½å‡ºï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
    commit_date=$(grep -o '"date"[[:space:]]*:[[:space:]]*"[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}' "$temp_file" | head -1 | grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
    if [ -z "$commit_date" ]; then
        commit_date=$(grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}T[0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\}Z' "$temp_file" | head -1 | grep -o '^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
    fi
    
    # æƒ…å ±ãŒå–å¾—ã§ããªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if [ -z "$commit_date" ] || [ -z "$commit_sha" ]; then
        debug_log "WARN" "Failed to extract commit information. Using fallback method."
        commit_sha=$(tr -cd 'a-f0-9' < "$temp_file" | grep -o '[a-f0-9]\{40\}' | head -1 | head -c 7)
        commit_date=$(grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}' "$temp_file" | head -1)
        
        [ -z "$commit_sha" ] && commit_sha="unknown"
        [ -z "$commit_date" ] && commit_date=$(date +%Y-%m-%d)
    fi
    
    # çµæœã®çµ„ã¿ç«‹ã¦
    if [ -n "$commit_date" ] && [ -n "$commit_sha" ]; then
        # æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å¤‰æ›
        local formatted_date=$(echo "$commit_date" | tr '-' '.')
        local version="${formatted_date}-${commit_sha}"
        
        rm -f "$temp_file" 2>/dev/null
        
        # wgetè¨­å®šã‚’å…ƒã«æˆ»ã™
        setup_wget_options
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        save_commit_to_cache "$file_path" "$version" "$auth_method"
        
        echo "$version $auth_method"
        return 0
    fi
    
    # å…¨ã¦ã®æ–¹æ³•ãŒå¤±æ•—ã—ãŸå ´åˆ
    rm -f "$temp_file" 2>/dev/null
    
    # wgetè¨­å®šã‚’å…ƒã«æˆ»ã™
    setup_wget_options
    echo "$(date +%Y.%m.%d)-fallback $auth_method" 
    return 1
}

download() {
    # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æœ€åˆã®å¼•æ•°ã¨ã—ã¦å‡¦ç†
    local file_name="$1"
    shift

    debug_log "DEBUG" "Download function called for file='${file_name}'"
    
    # ç©ºãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒã‚§ãƒƒã‚¯
    if [ -z "$file_name" ]; then
        debug_log "ERROR" "Empty filename detected in download function call"
        return 1
    fi

    # è¨­å®šå¤‰æ•°ã®åˆæœŸåŒ–
    local hidden_mode="false"
    local quiet_mode="${QUIET_MODE:-false}"
    local chmod_mode="false"
    local load_mode="false"
    local interpreter_name=""  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ç©ºã«
    
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã®å‡¦ç†ï¼ˆæ”¹å–„ç‰ˆï¼‰
    while [ $# -gt 0 ]; do
        local option="$1"
        local value="true"
        
        # ã‚­ãƒ¼=å€¤å½¢å¼ã®å ´åˆã¯åˆ†è§£å‡¦ç†
        if echo "$option" | grep -q "="; then
            value=$(echo "$option" | cut -d'=' -f2)
            option=$(echo "$option" | cut -d'=' -f1)
        fi
        
        # ã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆ¤å®šï¼ˆå€¤ãŒtrueã®å ´åˆã®ã¿å‡¦ç†ï¼‰
        if [ "$value" = "true" ]; then
            case "$option" in
                # ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                bash)   interpreter_name="bash" ;;
                python3) interpreter_name="python" ;;
                node)   interpreter_name="node" ;;
                perl)   interpreter_name="perl" ;;
                # ãƒ¢ãƒ¼ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                hidden) hidden_mode="true" ;;
                quiet)  quiet_mode="true" ;;
                debug)  DEBUG_MODE="true" ;;
                chmod)  chmod_mode="true" ;;
                load)   load_mode="true" ;;
                # ä¸æ˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                *)      debug_log "WARN" "Unknown option: $1, ignoring" ;;
            esac
        fi
        shift
    done

    # ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ãŒè¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    [ -z "$interpreter_name" ] && interpreter_name="ash"

    debug_log "DEBUG" "Processing with options: hidden=${hidden_mode}, quiet=${quiet_mode}, chmod=${chmod_mode}, load=${load_mode}, interpreter=${interpreter_name}"

    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±å–å¾—
    local version_data
    version_data=$(download_check_version "$file_name")
    
    local update_required=$(echo "$version_data" | cut -d'|' -f1)
    local clean_remote_version=$(echo "$version_data" | cut -d'|' -f2)
    local clean_local_version=$(echo "$version_data" | cut -d'|' -f3)
    local api_status=$(echo "$version_data" | cut -d'|' -f4)
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã‚’è¿½åŠ 
    local file_exists="true"
    if [ ! -f "${BASE_DIR}/$file_name" ]; then
        debug_log "DEBUG" "File ${BASE_DIR}/$file_name does not exist, forcing download"
        file_exists="false"
        update_required="true"
    elif [ ! -s "${BASE_DIR}/$file_name" ]; then
        debug_log "DEBUG" "File ${BASE_DIR}/$file_name exists but is empty, forcing download"
        file_exists="false"
        update_required="true"
    fi
    
    # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯å¸¸ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    if [ "$DEBUG_MODE" = "true" ]; then
        debug_log "DEBUG" "Debug mode enabled, forcing download for ${file_name}"
        update_required="true"
    fi
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    local status_type="no_update"
    local status_message="$(get_message "CONFIG_DOWNLOAD_UNNECESSARY")"
    
    if [ "$update_required" = "true" ] || [ "$file_exists" = "false" ]; then
        debug_log "DEBUG" "Executing download_fetch_file for ${file_name}"
        if ! download_fetch_file "$file_name" "$clean_remote_version" "$chmod_mode"; then
            debug_log "ERROR" "Download process failed for $file_name"
            return 1
        fi
        status_type="success"
        status_message="$(get_message "CONFIG_DOWNLOAD_SUCCESS")"
        
        # aiosãƒ•ã‚¡ã‚¤ãƒ«ã¯å¸¸ã«å®Ÿè¡Œæ¨©é™ã‚’è¨­å®šã™ã‚‹ï¼ˆè¿½åŠ ï¼‰
        if [ "$file_name" = "aios" ]; then
            debug_log "DEBUG" "Special handling: Setting execute permission for aios file"
            chmod +x "${BASE_DIR}/${file_name}"
        fi
    else
        debug_log "DEBUG" "Skipping download for ${file_name} (not needed)"
    fi
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’å†ç¢ºèª
    if [ ! -f "${BASE_DIR}/$file_name" ]; then
        debug_log "ERROR" "File not found after download attempt: $file_name"
        return 1
    fi

    debug_log "DEBUG" "Calling download_finalize with file=${file_name}, status=${status_type}, interpreter=${interpreter_name}"

    # çµæœè¡¨ç¤ºã¨ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    download_finalize "$file_name" "$status_message" "$clean_remote_version" "$api_status" "$load_mode" "$hidden_mode" "$status_type" "$interpreter_name"
    
    return 0
}

download_check_version() {
    local file_name="$1"
    local script_file="${CACHE_DIR}/script.ch"
    local dummy_version="No version control"

    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®å–å¾—
    local remote_version_info=$(get_commit_version "$file_name")
    local remote_version=$(printf "%s" "$remote_version_info" | cut -d' ' -f1)
    local auth_method=$(printf "%s" "$remote_version_info" | cut -d' ' -f2)
    local local_version=""
    
    # ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å–å¾—
    if [ -f "$script_file" ]; then
        local_version=$(grep "^${file_name}=" "$script_file" | cut -d'=' -f2)
    fi
    [ -z "$local_version" ] && local_version="$dummy_version"

    local clean_remote_version=$(clean_version_string "$remote_version")
    local clean_local_version=$(clean_version_string "$local_version")

    # APIãƒ¬ãƒ¼ãƒˆåˆ¶é™æƒ…å ±ã®å–å¾—ï¼ˆå…ƒã®è¡¨ç¤ºã«æˆ»ã™ï¼‰
    local api_status=$(check_api_rate_limit)
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰åˆ¤æ–­
    local update_required=false
    
    if [ "$local_version" = "$dummy_version" ]; then
        debug_log "DEBUG" "First download: $file_name"
        update_required=true
    elif [ "$clean_remote_version" = "$clean_local_version" ]; then
        debug_log "DEBUG" "Exact match: No update needed for $file_name"
        update_required=false
    else
        debug_log "DEBUG" "Starting version comparison: $file_name"
        version_is_newer "$clean_remote_version" "$clean_local_version"
        if [ $? -eq 0 ]; then
            debug_log "DEBUG" "New version detected: Update required for $file_name"
            update_required=true
        else
            debug_log "DEBUG" "Existing version: No update needed for $file_name"
            update_required=false
        fi
    fi
    
    debug_log "DEBUG" "Remote version: $file_name - $clean_remote_version"
    debug_log "DEBUG" "Local version: $file_name - $clean_local_version"
    debug_log "DEBUG" "API status: $api_status"
    
    # çµæœã‚’è¿”ã™
    echo "${update_required}|${clean_remote_version}|${clean_local_version}|${api_status}"
    return 0
}

download_fetch_file() {
    local file_name="$1"
    local clean_remote_version="$2"
    local chmod_mode="$3"
    local install_path="${BASE_DIR}/$file_name"
    local script_file="${CACHE_DIR}/script.ch"
    
    debug_log "DEBUG" "download_fetch_file called for ${file_name}"
    
    # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã®è¨­å®š
    local remote_url="${BASE_URL}/$file_name"
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°ã®é©ç”¨
    if [ "$FORCE" = "true" ] || echo "$clean_remote_version" | grep -q "direct"; then
        remote_url="${remote_url}${CACHE_BUST}"
    fi
    
    debug_log "DEBUG" "Downloading from ${remote_url} to ${install_path}"
    
    # IPãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®šãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯è¨­å®šã™ã‚‹
    if [ -z "$WGET_IPV_OPT" ]; then
        setup_wget_options
    fi
    
    # BusyBox wgetå‘ã‘ã«æœ€é©åŒ–ã—ãŸæ˜ç¤ºçš„ãªã‚³ãƒãƒ³ãƒ‰æ§‹æ–‡
    if ! wget -q --no-check-certificate ${WGET_IPV_OPT} -O "$install_path" "$remote_url" 2>/dev/null; then
        debug_log "ERROR" "Download failed: $file_name"
        return 1
    fi
    
    # ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
    if [ ! -f "$install_path" ]; then
        debug_log "ERROR" "Downloaded file not found: $file_name"
        return 1
    fi
    
    if [ ! -s "$install_path" ]; then
        debug_log "ERROR" "Downloaded file is empty: $file_name"
        return 1
    fi
    
    debug_log "DEBUG" "File successfully downloaded to ${install_path}"
    
    # æ¨©é™è¨­å®š
    if [ "$chmod_mode" = "true" ]; then
        chmod +x "$install_path"
        debug_log "DEBUG" "chmod +x applied to $file_name"
    fi
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
    save_version_to_cache "$file_name" "$clean_remote_version" "$script_file"
    
    return 0
}

download_finalize() {
    local file_name="$1"
    local status_message="$2" 
    local clean_remote_version="$3"
    local api_status="$4"
    local load_mode="$5"
    local hidden_mode="$6"
    local status_type="$7"
    local interpreter="${8:-ash}"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ashã«è¨­å®š
    
    debug_log "DEBUG" "Finalizing download for ${file_name}, status=${status_type}, interpreter=${interpreter}"
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    if [ ! -f "${BASE_DIR}/${file_name}" ]; then
        debug_log "ERROR" "File not found: ${BASE_DIR}/${file_name}"
        return 1
    fi
    
    # éš ã—ãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
    if [ "$hidden_mode" = "true" ]; then
        debug_log "DEBUG" "Hidden mode is active, skipping status message"
        # éš ã—ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãªã„
    else        
        # ãƒ•ã‚¡ã‚¤ãƒ«åãŒDBãƒ•ã‚¡ã‚¤ãƒ«ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ (.dbæ‹¡å¼µå­)
        if echo "$file_name" | grep -q "\.db$"; then
            debug_log "DEBUG" "DB file handling for ${file_name}"
        fi
        
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        if [ "$status_type" = "success" ]; then
            # æˆåŠŸæ™‚
            if [ "$load_mode" = "true" ]; then
                printf "%s\n" "${status_message} ${file_name} ${clean_remote_version} ${api_status} Loaded"
            else
                printf "%s\n" "${status_message} ${file_name} ${clean_remote_version} ${api_status}"
            fi
        else
            # æ›´æ–°ä¸è¦æ™‚ãªã©
            if [ "$load_mode" = "true" ]; then
                printf "%s\n" "${status_message} ${file_name} ${clean_remote_version} ${api_status} Loaded"
            else
                printf "%s\n" "${status_message} ${file_name} ${clean_remote_version} ${api_status}"
            fi
        fi
    fi
    
    # ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ã¿å‡¦ç†
    if [ "$load_mode" = "true" ]; then
        debug_log "DEBUG" "Loading file with ${interpreter}: ${BASE_DIR}/${file_name}"
        
        if [ -s "${BASE_DIR}/${file_name}" ]; then
            # ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            if [ "$interpreter" != "$INTERPRETER" ]; then
                if ! command -v "$interpreter" > /dev/null 2>&1; then
                    printf "%s\n" "$(color red "Error: Interpreter '${interpreter}' is not installed on this system.")"
                    install_package ${interpreter} yn hidden
                    
                    # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã«å†åº¦ç¢ºèª
                    if ! command -v "$interpreter" > /dev/null 2>&1; then
                        debug_log "EBUG" "Interpreter still not found after installation attempt: ${interpreter}"
                        return 1
                    else
                        debug_log "DEBUG" "Executing with specified interpreter: ${interpreter}"
                        $interpreter "${BASE_DIR}/${file_name}"
                    fi
                else
                    debug_log "DEBUG" "Executing with specified interpreter: ${interpreter}"
                    $interpreter "${BASE_DIR}/${file_name}"
                fi
            else
                debug_log "DEBUG" "File loaded with source"
                . "${BASE_DIR}/${file_name}"
            fi
        else
            debug_log "ERROR" "Cannot load empty file: ${file_name}"
            return 1
        fi
    fi
    
    return 0
}

# ğŸ”´ã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´ã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒãƒŠãƒ¼ãƒ»ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ãƒ¡ã‚¤ãƒ³é–¢æ•° - ãƒãƒŠãƒ¼è¡¨ç¤ºã®çµ±åˆé–¢æ•°
# å¼•æ•°: 
#   $1 - ãƒãƒŠãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆçœç•¥å¯ï¼‰: "unicode", "ascii", "asterisk", "auto"
print_banner() {
    # ã‚¹ã‚¿ã‚¤ãƒ«æŒ‡å®šã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€Œautoã€
    BANNER_STYLE="${1:-auto}"
    
    # è‡ªå‹•æ¤œå‡ºãŒå¿…è¦ãªå ´åˆ
    if [ "$BANNER_STYLE" = "auto" ]; then
        BANNER_STYLE=$(detect_terminal_capability)
        debug_log "DEBUG" "Auto-detected banner style: $BANNER_STYLE"
    fi

    # ã‚¹ã‚¿ã‚¤ãƒ«ã«å¿œã˜ãŸãƒãƒŠãƒ¼è¡¨ç¤º
    case "$BANNER_STYLE" in
        unicode|block)
            print_banner_unicode
            ;;
        ascii|hash|sharp)
            print_banner_ascii
            ;;
        *)
            # ä¸æ˜ãªã‚¹ã‚¿ã‚¤ãƒ«ã®å ´åˆã¯ASCIIã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            debug_log "WARN" "Unknown banner style: $BANNER_STYLE, using ASCII fallback"
            print_banner_ascii
            ;;
    esac
}

print_banner_ascii() {
    debug_log "DEBUG" "Displaying lowercase aios block ASCII art banner"
    
    # ASCIIã‚¢ãƒ¼ãƒˆ
    printf "\n"
    printf "%s\n" "$(color magenta "               ## #")"
    printf "%s\n" "$(color blue    "     ####      ###       ####      #####")"
    printf "%s\n" "$(color green   "        ##      ##      ##  ##    ##")"
    printf "%s\n" "$(color yellow  "     #####      ##      ##  ##     #####")"
    printf "%s\n" "$(color orange  "    ##  ##      ##      ##  ##         ##")"
    printf "%s\n" "$(color red     "     #####     ####      ####     ######")"
    printf "\n"
    
    # ãƒãƒŠãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_DECCRIPTION")")"
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_NAME")")"
    printf "%s\n" "$(color red "$(get_message "MSG_BANNER_DISCLAIMER")")"
    printf "\n"

    debug_log "DEBUG" "Block style lowercase aios banner displayed successfully"
}

print_banner_unicode() {
    debug_log "DEBUG" "Displaying lowercase aios block ASCII art banner"
    
    # ASCIIã‚¢ãƒ¼ãƒˆï¼ˆç’°å¢ƒä¾å­˜æ–‡å­— - ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
    printf "\n"
    printf "%s\n" "$(color magenta "               â–ˆâ–ˆ â–ˆ")"
    printf "%s\n" "$(color blue    "     â–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ")"
    printf "%s\n" "$(color green   "        â–ˆâ–ˆ      â–ˆâ–ˆ      â–ˆâ–ˆ  â–ˆâ–ˆ    â–ˆâ–ˆ")"
    printf "%s\n" "$(color yellow  "     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆ      â–ˆâ–ˆ  â–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ")"
    printf "%s\n" "$(color orange  "    â–ˆâ–ˆ  â–ˆâ–ˆ      â–ˆâ–ˆ      â–ˆâ–ˆ  â–ˆâ–ˆ         â–ˆâ–ˆ")"
    printf "%s\n" "$(color red     "     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ")"
    printf "\n"

    # ãƒãƒŠãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_DECCRIPTION")")"
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_NAME")")"
    printf "%s\n" "$(color red "$(get_message "MSG_BANNER_DISCLAIMER")")"
    printf "\n"

    debug_log "DEBUG" "Block style lowercase aios banner displayed successfully"
}

display_detected_device() {
    local cpucore=$(cat "${CACHE_DIR}/cpu_core.ch")
    local network=$(cat "${CACHE_DIR}/network.ch")
    local architecture=$(cat "${CACHE_DIR}/architecture.ch")
    local osversion=$(cat "${CACHE_DIR}/osversion.ch")
    local package_manager=$(cat "${CACHE_DIR}/package_manager.ch")
    local usbdevice=$(cat "${CACHE_DIR}/usbdevice.ch")

    # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    if [ ! -f "${CACHE_DIR}/message.ch" ]; then
        printf "%s\n" "$(color green "$(get_message "MSG_INFO_DEVICE")")"
    fi
    printf "%s\n" "$(color white "$(get_message "MSG_INFO_NETWORK" "info=$network")")"
    printf "%s\n" "$(color white "$(get_message "MSG_INFO_CPUCORE" "info=$cpucore")")"
    printf "%s\n" "$(color white "$(get_message "MSG_INFO_ARCHITECTURE" "info=$architecture")")"
    printf "%s\n" "$(color white "$(get_message "MSG_INFO_OSVERSION" "info=$osversion")")"
    printf "%s\n" "$(color white "$(get_message "MSG_INFO_PACKAGEMANAGER" "info=$package_manager")")"
    printf "%s\n" "$(color white "$(get_message "MSG_INFO_USBDEVICE" "info=$usbdevice")")"
    printf "\n"
}

# ğŸ”´ã€€ãƒãƒŠãƒ¼ãƒ»ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã€€ã“ã“ã¾ã§ã€€ğŸ”´ã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒ¡ã‚¤ãƒ³ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

check_option() {
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
    ORIGINAL_ARGS="$@"
    MODE="${MODE:-update}"
    SELECTED_LANGUAGE=""
    DEBUG_MODE="false"
    DEBUG_LEVEL="INFO"
    DRY_RUN="false"
    LOGFILE=""
    FORCE="false"
    RESET="false"
    HELP="false"
    SKIP_DEVICE_DETECTION="false"
    SKIP_IP_DETECTION="false"
    SKIP_ALL_DETECTION="false"
    SKIP_CACHE="false"

    # è¨€èªãŠã‚ˆã³ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã®å‡¦ç†
    while [ "$#" -gt 0 ]; do
        case "$1" in
            -h|--h|-help|--help|-\?|--\?)
                HELP="true"
                print_help
                exit 0
                ;;
            -v|--v|-version|--version)
                script_version
                exit 0
                ;;
            -d|--d|-debug|--debug|-d1|--d1)
                DEBUG_MODE="true"
                DEBUG_LEVEL="DEBUG"
                ;;
            -cf|--cf|-common_full|--common_full)
                MODE="full"
                ;;
            -cl|--cl|-ocommon_light|--ocommon_light)
                MODE="light"
                ;;
            -cd|--cd|-common_debug|--common_debug|--common_debug)
                MODE="debug"
                ;;
            -r|--r|-resrt|--resrt)
                MODE="reset"
                RESET="true"
                ;;
            -del|--del|-delete|--delete)
                MODE="delete"
                ;;
            -f|--f|-force|--force)
                FORCE="true"
                ;;
            -dr|--dr|-dry-run|--dry-run)
                DRY_RUN="true"
                ;;
            -l|--l|-logfile|--logfile)
                if [ -n "$2" ] && [ "${2#-}" = "$2" ]; then
                    LOGFILE="$2"
                    shift
                else
                    debug_log "DEBUG" "logfile requires a path argument"
                    exit 1
                fi
                ;;
            -u|--u|-update|--update)
                debug_log "DEBUG" "check_option: aios update"
                MODE="update"
                ;;
            -t|--t|-token|--token)
                setup_github_token
                exit 0
                ;;
            -ta|--ta|-test_api|--test_api)
                MODE="test_api"
                ;;
            -sc|--sc|-skip-cache|--skip-cache)
                SKIP_CACHE_DETECTION="true"
                ;;
            -sd|--sd|-skip-dev|--skip-dev)
                SKIP_DEVICE_DETECTION="true"
                ;;
            -scd|--scd|-skip-cache-device|--skip-cache-device)
                SKIP_CACHE_DEVICE_DETECTION="true"
                ;;
            -si|--si|-skip-ip|--skip-ip)
                SKIP_IP_DETECTION="true"
                ;;
            -sa|--sa|-skip-all|--skip-all)
                SKIP_ALL_DETECTION="true"
                ;;
            -nc|--nc|-no-cache|--no-cache)
                SKIP_CACHE="true"
                debug_log "DEBUG" "Cache disabled by command line option"
                ;;
            -*)
                echo "Warning: Unknown option: $1" >&2
                ;;
            *)
                if [ -z "$SELECTED_LANGUAGE" ]; then
                    SELECTED_LANGUAGE="$1"
                fi
                ;;
        esac
        shift
    done

    # ç’°å¢ƒå¤‰æ•°è¨­å®š
    export SELECTED_LANGUAGE DEBUG_MODE DEBUG_LEVEL MODE DRY_RUN LOGFILE FORCE RESET HELP SKIP_CACHE

    # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
    debug_log "DEBUG" "$BIN_FILE: $SCRIPT_VERSION"
    debug_log "DEBUG" "check_option received args: $ORIGINAL_ARGS"
    debug_log "DEBUG" "check_option: MODE=$MODE, SKIP_CACHE=$SKIP_CACHE, SELECTED_LANGUAGE=$SELECTED_LANGUAGE"

    # è¨­å®šã•ã‚ŒãŸè¨€èªã‚’ `check_common()` ã«æ¸¡ã™
    check_common "$SELECTED_LANGUAGE" "$MODE"
}

check_common() {
    local lang_code="$SELECTED_LANGUAGE"
    local mode="$MODE"

    debug_log "DEBUG" "check_common: MODE=$MODE"
    debug_log "DEBUG" "check_common: mode=$mode"

    # è¨€èªè¨­å®šã®æ—©æœŸèª­ã¿è¾¼ã¿ï¼ˆè¿½åŠ ï¼‰
    if [ -f "${CACHE_DIR}/message.ch" ]; then
        debug_log "DEBUG" "Early loading language settings from cache"
        # åˆæœŸåŒ–ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã—ã¦äºŒé‡åˆæœŸåŒ–ã‚’é˜²æ­¢
        EARLY_LANG_LOADED=1
    fi

    # ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®å‡¦ç†
    case "$mode" in
        reset|return)
            if ! rm -rf "${CACHE_DIR}"; then
                debug_log "ERROR" "Failed to remove cache directory: ${CACHE_DIR}"
                printf "%s%s%s\n" "$(color yellow "Reset failed: Could not remove cache directory.")"
                return 1
            fi
            # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†ä½œæˆ
            mkdir -p "${CACHE_DIR}" || {
                debug_log "ERROR" "Failed to recreate cache directory: ${CACHE_DIR}"
                printf "%s%s%s\n" "$(color yellow "Reset partially failed: Cache removed but could not be recreated.")"
            }
            printf "%s%s%s\n" "$(color yellow "$(get_message "MSG_RESET_COMPLETE")")"
            exit 0
            ;;
        delete)
            if ! rm -rf "${BASE_DIR}"; then
                debug_log "ERROR" "Failed to remove base directory: ${BASE_DIR}"
                printf "%s%s%s\n" "$(color yellow "Reset failed: Could not remove base directory.")"
                return 1
            fi
            # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†ä½œæˆ
            mkdir -p "${BASE_DIR}" || {
                debug_log "ERROR" "Failed to recreate base directory: ${CACHE_DIR}"
                printf "%s%s%s\n" "$(color yellow "Reset partially failed: Base removed but could not be recreated.")"
            }
            printf "%s%s%s\n" "$(color yellow "$(get_message "MSG_DELETE_COMPLETE")")"
            exit 0
            ;;
        debug)
            download "common-system.sh" "hidden" "chmod" "load"
            download "common-information.sh" "hidden" "chmod" "load"
            download "common-color.sh" "hidden" "chmod" "load"
            download "common-country.sh" "hidden" "chmod" "load"
            download "common-country.sh" "hidden" "chmod" "load"
            download "common-package.sh" "hidden" "chmod" "load"
            download "common-feed-package.sh" "hidden" "chmod" "load"
            download "menu.db" "hidden"
            download "country.db" "hidden"
            download "message_${DEFAULT_LANGUAGE}.db" "hidden"
            download "local-package.db" "hidden"
            download "custom-package.db" "hidden"
            print_banner
            display_detected_device
            select_country "$lang_code"
            update_package_list
            selector "$MAIN_MENU" 
            ;;
        full)
            download "common-system.sh" "chmod" "load"
            download "common-information.sh" "chmod" "load"
            download "common-translation.sh" "chmod" "load"
            download "common-color.sh" "chmod" "load"
            download "common-country.sh" "chmod" "load"
            download "common-menu.sh" "chmod" "load"
            download "common-package.sh" "chmod" "load"
            download "common-feed-package.sh" "chmod" "load"
            download "menu.db"
            download "country.db"
            download "message_${DEFAULT_LANGUAGE}.db"
            download "local-package.db"
            download "custom-package.db"
            print_banner
            display_detected_device
            select_country "$lang_code"
            update_package_list
            selector "$MAIN_MENU"
            ;;
        update)
            check_update "$ORIGINAL_ARGS"
            ;;
        light)
            ;;
        test_api)
            download "github_api_test.sh" "chmod" "load"
            exit 0
            ;;
        *)
            ;;
    esac
    
    return 0
}

# å®Ÿè¡Œæ¨©é™ã®è¨­å®š
chmod_aios() {
    if ! chmod +x "$BIN_PATH"; then
        debug_log "ERROR" "Failed to set execute permission"
        return 1
    fi
    return 0
}

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤å‡¦ç†
delete_aios() {
    if ! rm -rf "${BASE_DIR}"; then
        debug_log "ERROR" "Failed to delete $BASE_DIR"
        return 1
    fi
    return 0
}

# å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
make_directory() {
    if ! mkdir -p "${BASE_DIR}" "$CACHE_DIR" "$LOG_DIR" "$FEED_DIR" "${CACHE_DIR}/commits"; then
        debug_log "ERROR" "Failed to create required directories"
        return 1
    fi
    
    # .gitignoreãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ã‚’gitã§ç„¡è¦–ã™ã‚‹ï¼‰
    if [ ! -f "${CACHE_DIR}/.gitignore" ]; then
        echo "*" > "${CACHE_DIR}/.gitignore" 2>/dev/null
    fi
    
    return 0
}

# ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆçŠ¶æ…‹ç¢ºèª
check_update() {
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šï¼ˆå¼•æ•°ãŒãªãã¦ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«ï¼‰
    local lang_code="$SELECTED_LANGUAGE"
    MODE="${MODE:-update}"
    
    # å…¨å¼•æ•°ã‚’å‡¦ç†
    local all_args="$@"
    local has_args=0
    
    # å¼•æ•°ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    [ $# -gt 0 ] && has_args=1
    
    # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé–¢é€£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    local filtered_args=""
    
    # å¼•æ•°ãŒã‚ã‚‹å ´åˆã®ã¿å‡¦ç†
    if [ $has_args -eq 1 ]; then
        while [ $# -gt 0 ]; do
            case "$1" in
                -u|--u|-update|--update)
                    # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé–¢é€£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯é™¤å¤–
                    ;;
                *)
                    # ãã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä¿æŒ
                    filtered_args="${filtered_args:+$filtered_args }$1"
                    ;;
            esac
            shift
        done
    fi
    
    debug_log "DEBUG" "Original args: $all_args"
    debug_log "DEBUG" "Filtered args: $filtered_args"
    
    # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
    download "aios" "chmod"
    MODE="full"

    # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ç§»å‹•ã—ã¦exec
    if [ -f "$BASE_DIR/$BIN_FILE" ]; then
        mv -f "$BASE_DIR/$BIN_FILE" "$BIN_PATH"
    fi

    exec "$BIN_PATH" "$lang_code" $filtered_args
}

# åˆæœŸåŒ–å‡¦ç†ã®ãƒ¡ã‚¤ãƒ³
main() {
    # å®Ÿè¡Œæ¨©é™ã‚’è¨­å®š
    if ! chmod_aios; then
        debug_log "ERROR" "Failed to set execute permission"
        return 1
    fi

    # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    if ! make_directory; then
        debug_log "ERROR" "Failed to create required directories"
        return 1
    fi

    check_network_connectivity

    setup_wget_options

    check_option "$@"
}

# ğŸ”´ã€€ãƒ¡ã‚¤ãƒ³ã€€ã“ã“ã¾ã§ã€€ğŸ”´ã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"
