#!/bin/sh

SCRIPT_VERSION="2025.03.10-03-17"

echo -e "\033[1;35mCurrent Version: aios - Version: $SCRIPT_VERSION\033[0m"

# =========================================================
# ğŸ“Œ OpenWrt / Alpine Linux POSIX-Compliant Shell Script
# ğŸš€ Last Update: 2025-02-21
#
# ğŸ·ï¸ License: CC0 (Public Domain)
# ğŸ¯ Compatibility: OpenWrt >= 19.07 (Tested on 24.10.0)
#
# âš ï¸ IMPORTANT NOTICE:
# OpenWrt OS exclusively uses **Almquist Shell (ash)** and
# is **NOT** compatible with Bourne-Again Shell (bash).
#
# ğŸ“¢ POSIX Compliance Guidelines:
# âœ… Use `[` instead of `[[` for conditions
# âœ… Use `$(command)` instead of backticks `` `command` ``
# âœ… Use `$(( ))` for arithmetic instead of `let`
# âœ… Define functions as `func_name() {}` (no `function` keyword)
# âœ… No associative arrays (`declare -A` is NOT supported)
# âœ… No here-strings (`<<<` is NOT supported)
# âœ… No `-v` flag in `test` or `[[`
#
# ğŸ› ï¸ Keep it simple, POSIX-compliant, and lightweight for OpenWrt!
# =========================================================
### =========================================================
### ğŸ“Œ AI Assistance Request: Bug Fixing Procedure
### 
### When debugging or fixing errors in this script, follow these steps:
### 
### 1ï¸âƒ£ Create a minimal test script to identify the bug.
### 2ï¸âƒ£ Execute the test and verify the reproducibility of the error.
### 3ï¸âƒ£ Fix the error and re-run the test to confirm the solution.
### 4ï¸âƒ£ Apply the corrected code to the production environment.
### 
### âš ï¸ DO NOT modify the main script without first confirming the fix 
###     through a dedicated test script.
### 
### ğŸ› ï¸ Keep the debugging process structured, efficient, and reliable.
### =========================================================

DEV_NULL="${DEV_NULL:-on}"
# ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰
# export DEV_NULL="on"
# é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
# unset DEV_NULL

# åŸºæœ¬å®šæ•°ã®è¨­å®š 
BASE_WGET="${BASE_WGET:-wget --no-check-certificate -q -O}"
# BASE_WGET="${BASE_WGET:-wget -O}"
DEBUG_MODE="${DEBUG_MODE:-false}"
BIN_PATH=$(readlink -f "$0")
BIN_DIR="$(dirname "$BIN_PATH")"
BIN_FILE="$(basename "$BIN_PATH")"
BASE_URL="${BASE_URL:-https://raw.githubusercontent.com/site-u2023/aios/main}"
BASE_DIR="${BASE_DIR:-/tmp/aios}"
CACHE_DIR="${CACHE_DIR:-$BASE_DIR/cache}"
FEED_DIR="${FEED_DIR:-$BASE_DIR/feed}"
LOG_DIR="${LOG_DIR:-$BASE_DIR/logs}"
UPDATE_CACHE="${CACHE_DIR}/update.ch"
GITHUB_TOKEN_FILE="/etc/aios_token"

# ğŸ”µã€€ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ»ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µ-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# Last Update: 2025-02-16 16:00:00 (JST) ğŸš€
# "Clarity in errors, precision in handling. Every function must be robust."
#
# ã€è¦ä»¶ã€‘
# 1. ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ `messages.db` ã§ç®¡ç†ã—ã€å¤šè¨€èªå¯¾å¿œã™ã‚‹ã€‚
# 2. `debug_log("ERROR", message)` ã‚‚ `message.db` ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
# 3. `{file}`, `{version}` ãªã©ã®å¤‰æ•°ã‚’å‹•çš„ã«ç½®æ›ã€‚
# 4. å½±éŸ¿ç¯„å›²: `aios` & `common.sh`ï¼ˆçŸ›ç›¾ãªãé©ç”¨ï¼‰ã€‚
#########################################################################
handle_error() {
    local error_key="$1"
    local file="$2"
    local version="$3"
    local exit_required="${4:-no}"

    local error_message
    error_message=$(get_message "$error_key")

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if [ -z "$error_message" ]; then
        error_message="Unknown error occurred. Key: $error_key"
    fi

    # å¤‰æ•°ã‚’ç½®æ›
    error_message=$(echo "$error_message" | sed -e "s/{file}/$file/g" -e "s/{version}/$version/g")

    # ãƒ­ã‚°è¨˜éŒ² & è¡¨ç¤º
    debug_log "ERROR" "$error_message"
    echo -e "$(color red "$error_message")"

    if [ "$exit_required" = "yes" ]; then
        debug_log "ERROR" "Critical error occurred, exiting: $error_message"
        exit 1
    else
        debug_log "DEBUG" "Non-critical error: $error_message"
        return 1
    fi
}

#########################################################################
# Last Update: 2025-02-16 16:10:00 (JST) ğŸš€
# "Logging with clarity, debugging with precision."
#
# ã€è¦ä»¶ã€‘
# 1. ã™ã¹ã¦ã®ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ `messages.db` ã§ç®¡ç†ã—ã€å¤šè¨€èªå¯¾å¿œã™ã‚‹ã€‚
# 2. `{file}`, `{version}` ãªã©ã®å¤‰æ•°ã‚’ `sed` ã§å‹•çš„ã«ç½®æ›ã™ã‚‹ã€‚
# 3. `DEBUG_MODE` ã®è¨­å®šã«å¿œã˜ã¦ `DEBUG`, `INFO`, `WARN`, `ERROR` ã‚’ç®¡ç†ã™ã‚‹ã€‚
# 4. å½±éŸ¿ç¯„å›²: `aios` & `common.sh`ï¼ˆçŸ›ç›¾ãªãé©ç”¨ï¼‰ã€‚
#########################################################################
# ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°é–¢æ•°ã®ä¿®æ­£ç‰ˆï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«è¡¨ç¤ºï¼‰
debug_log() {
    local level="$1"
    local message="$2"
    local file="$3"
    local version="$4"

    # `$1` ã«ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ `DEBUG` ã«ã™ã‚‹
    case "$level" in
        "DEBUG"|"INFO"|"WARN"|"ERROR") ;;  # ä½•ã‚‚ã—ãªã„ (æ­£ã—ã„ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«)
        "")
            level="DEBUG"
            message="$1"
            file="$2"
            version="$3"
            ;;
        *)
            message="$1"
            file="$2"
            version="$3"
            level="DEBUG"
            ;;
    esac

    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼‰
    if echo "$message" | grep -q "version\|Version"; then
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
        local cleaned_message="$message"
        # aios - [2025-03-10... ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
        if echo "$message" | grep -q " - "; then
            local prefix=$(echo "$message" | sed 's/ - .*//')
            local version_part=$(echo "$message" | sed 's/.* - //')
            local cleaned_version=$(clean_version_string "$version_part")
            cleaned_message="$prefix - $cleaned_version"
        fi
        message="$cleaned_message"
    fi

    # å¤‰æ•°ã‚’ç½®æ›
    message=$(echo "$message" | sed -e "s/{file}/$file/g" -e "s/{version}/$version/g")

    # ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡
    case "$DEBUG_LEVEL" in
        DEBUG)    allowed_levels="DEBUG INFO WARN ERROR" ;;
        INFO)     allowed_levels="INFO WARN ERROR" ;;
        WARN)     allowed_levels="WARN ERROR" ;;
        ERROR)    allowed_levels="ERROR" ;;
        *)        allowed_levels="ERROR" ;;
    esac

    if echo "$allowed_levels" | grep -q "$level"; then
        local timestamp
        timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        local log_message="[$timestamp] $level: $message"

        # ã‚«ãƒ©ãƒ¼è¡¨ç¤º
        case "$level" in
            "ERROR") echo -e "$(color red "$log_message")" ;;
            "WARN") echo -e "$(color yellow "$log_message")" ;;
            "INFO") echo -e "$(color cyan "$log_message")" ;;
            "DEBUG") echo -e "$(color white "$log_message")" ;;
        esac

        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
        if [ "$AIOS_INITIALIZED" = "true" ]; then
            echo "$log_message" >> "$LOG_DIR/debug.log"
        fi
    fi
}

#########################################################################
# Last Update: 2025-02-16 17:30:00 (JST) ğŸš€
# "Debug with clarity, test with precision. Every log tells a story."
#
# ã€è¦ä»¶ã€‘
# 1. `test_country_search()`, `test_timezone_search()`, `test_cache_contents()` ã‚’çµ±åˆã€‚
# 2. `debug_log()` ã‚’ä½¿ç”¨ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ `message.db` ã‹ã‚‰å–å¾—ã€‚
# 3. `country.db` ã®æ¤œç´¢çµæœãŒé©åˆ‡ã«å‡ºåŠ›ã•ã‚Œã‚‹ã‹ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
# 4. å½±éŸ¿ç¯„å›²: `common.sh` ã®ã¿ï¼ˆ`aios` ã«ã¯å½±éŸ¿ãªã—ï¼‰ã€‚
#########################################################################
test_debug_functions() {
    local test_type="$1"
    local test_input="$2"

    case "$test_type" in
        country)
            debug_log "DEBUG" "MSG_TEST_COUNTRY_SEARCH" "$test_input"
            if [ ! -f "${BASE_DIR}/country.db" ]; then
                handle_error "ERR_FILE_NOT_FOUND" "country.db"
                return 1
            fi
            awk -v query="$test_input" '
                $2 ~ query || $3 ~ query || $4 ~ query || $5 ~ query {
                    print NR, $2, $3, $4, $5, $6, $7, $8, $9
                }' "${BASE_DIR}/country.db"
            ;;

        timezone)
            debug_log "DEBUG" "MSG_TEST_TIMEZONE_SEARCH" "$test_input"
            if [ ! -f "${BASE_DIR}/country.db" ]; then
                handle_error "ERR_FILE_NOT_FOUND" "country.db"
                return 1
            fi
            awk -v country="$test_input" '
                $2 == country || $4 == country || $5 == country {
                    print NR, $5, $6, $7, $8, $9, $10, $11
                }' "${BASE_DIR}/country.db"
            ;;

        cache)
            debug_log "DEBUG" "MSG_TEST_CACHE_CONTENTS"
            for cache_file in "country_tmp.ch" "zone_tmp.ch"; do
                if [ -f "${CACHE_DIR}/$cache_file" ]; then
                    debug_log "DEBUG" "MSG_CACHE_CONTENTS" "$cache_file"
                    cat "${CACHE_DIR}/$cache_file"
                else
                    debug_log "DEBUG" "MSG_CACHE_NOT_FOUND" "$cache_file"
                fi
            done
            ;;
        
        *)
            debug_log "ERROR" "ERR_INVALID_ARGUMENT" "$test_type"
            return 1
            ;;
    esac
}

#########################################################################
# country_DEBUG: é¸æŠã•ã‚ŒãŸå›½ã¨è¨€èªã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
#########################################################################
country_DEBUG() {
    local country_DEBUG_file="${BASE_DIR}/country.ch"
    local selected_language_code=$(cat "${BASE_DIR}/check_country")
    if [ -f "$country_DEBUG_file" ]; then
        grep -w "$selected_language_code" "$country_DEBUG_file"
    else
        printf "%s\n" "$(color red "Country DEBUGrmation not found.")"
    fi
}

#########################################################################
# handle_exit: æ­£å¸¸çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
#########################################################################
handle_exit() {
    local message="$1"
    color yellow "$message"
    exit 0
}

# ğŸ”´ã€€ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ»ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------

#########################################################################
# print_help: ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
#########################################################################
print_help() {
    echo "Usage: aios.sh [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -reset, --reset, -r     Reset all cached data"
    echo "  -help, --help, -h       Show this help message"
    echo "  ja, en, zh-cn, ...      Set language"
    echo ""
    echo "Examples:"
    echo "  sh aios.sh full ja       # Run in full mode with language set to Japanese"
    echo "  sh aios.sh full          # If language cache exists, use it; otherwise, prompt for language"
}

#########################################################################
# color: ANSI ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’ä½¿ã£ã¦è‰²ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°
#########################################################################
color() {
    local color_code
    color_code=$(color_code_map "$1")
    shift
    echo -e "${color_code}$*$(color_code_map "reset")"
}

#########################################################################
# color_code_map: ã‚«ãƒ©ãƒ¼åã‹ã‚‰ ANSI ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’è¿”ã™é–¢æ•°
#########################################################################
color_code_map() {
    local color="$1"
    case "$color" in
        "red") echo "\033[1;31m" ;;
        "green") echo "\033[1;32m" ;;
        "yellow") echo "\033[1;33m" ;;
        "blue") echo "\033[1;34m" ;;
        "magenta") echo "\033[1;35m" ;;
        "cyan") echo "\033[1;36m" ;;
        "white") echo "\033[1;37m" ;;
        "red_underline") echo "\033[4;31m" ;;
        "green_underline") echo "\033[4;32m" ;;
        "yellow_underline") echo "\033[4;33m" ;;
        "blue_underline") echo "\033[4;34m" ;;
        "magenta_underline") echo "\033[4;35m" ;;
        "cyan_underline") echo "\033[4;36m" ;;
        "white_underline") echo "\033[4;37m" ;;
        "red_white") echo "\033[1;41m" ;;
        "green_white") echo "\033[1;42m" ;;
        "yellow_white") echo "\033[1;43m" ;;
        "blue_white") echo "\033[1;44m" ;;
        "magenta_white") echo "\033[1;45m" ;;
        "cyan_white") echo "\033[1;46m" ;;
        "white_black") echo "\033[7;40m" ;;
        "reset") echo "\033[0;39m" ;;
        *) echo "\033[0;39m" ;;  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒªã‚»ãƒƒãƒˆ
    esac
}

#########################################################################
# check_openwrt: OpenWrtã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªãƒ»ç®¡ç†ã®ã¿ã‚’æ‹…å½“
#########################################################################
check_openwrt() {
    local version_file="${CACHE_DIR}/openwrt.ch"

    # **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ä½¿ç”¨**
    if [ -f "$version_file" ]; then
        CURRENT_VERSION=$(cat "$version_file")
    else
        local raw_version=""
        local distrib_id=""

        # **â‘  /etc/openwrt_release ã‹ã‚‰å–å¾—ï¼ˆæœ€å„ªå…ˆï¼‰**
        if [ -f "/etc/openwrt_release" ]; then
            distrib_id=$(awk -F"'" '/DISTRIB_ID/ {print $2}' /etc/openwrt_release)
            
            # **GL.iNet ã‚«ã‚¹ã‚¿ãƒ ç‰ˆã¯å¼¾ã**
            if [ "$distrib_id" != "OpenWrt" ]; then
                handle_error "Unsupported OpenWrt version: $distrib_id (Only OpenWrt - supported)"
                exit 1  # ğŸš¨ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ã‚’çµ‚äº†
            fi

            if grep -q "DISTRIB_RELEASE=" /etc/openwrt_release; then
                raw_version=$(awk -F"'" '/DISTRIB_RELEASE/ {print $2}' /etc/openwrt_release)
            fi
        fi

        # **â‘¡ /etc/openwrt_version ãŒå­˜åœ¨ã™ã‚Œã°ä½¿ç”¨**
        if [ -z "$raw_version" ] && [ -f "/etc/openwrt_version" ]; then
            raw_version=$(cat /etc/openwrt_version)
        fi

        # **â‘¢ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå–å¾—ã§ããªã‘ã‚Œã°ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ã‚’çµ‚äº†**
        if [ -z "$raw_version" ]; then
            handle_error "Could not determine OpenWrt version. Check system files."
            exit 1  # ğŸš¨ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ã‚’çµ‚äº†
        fi

        # **â‘£ ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨è¨˜ã®çµ±ä¸€**
        CURRENT_VERSION=$(echo "$raw_version" | tr '-' '.')

        # **â‘¤ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«æ›¸ãå‡ºã—**
        echo "$CURRENT_VERSION" > "$version_file"
        chmod 444 "$version_file"  # èª­ã¿å–ã‚Šå°‚ç”¨
    fi

    # **â‘¥ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ç¢ºèª**
    if grep -q "^$CURRENT_VERSION=" "${BASE_DIR}/openwrt.db"; then
        local db_entry=$(grep "^$CURRENT_VERSION=" "${BASE_DIR}/openwrt.db" | cut -d'=' -f2)
        PACKAGE_MANAGER=$(echo "$db_entry" | cut -d'|' -f1)
        VERSION_STATUS=$(echo "$db_entry" | cut -d'|' -f2)
        echo -e "$(color green "OpnWrt version: $CURRENT_VERSION - supported ($VERSION_STATUS)")"
    else
        handle_error "Unsupported OpenWrt version: $CURRENT_VERSION"
        exit 1  # ğŸš¨ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ã‚’çµ‚äº†
    fi
}

#########################################################################
# check_architecture: OpenWrtã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç¢ºèªãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥
#########################################################################
check_architecture() {
    local arch_file="${CACHE_DIR}/architecture.ch"

    # **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å†å–å¾—ã—ãªã„**
    if [ -f "$arch_file" ]; then
        arch=$(cat "$arch_file" | tr -d '\r')
        debug_log "DEBUG" "Using cached architecture: $arch"
        return 0
    fi

    # **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å–å¾—**
    local arch=$(uname -m)

    # **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åã®ã¿ï¼‰**
    echo "$arch" > "$arch_file"

    debug_log "DEBUG" "Architecture detected: $arch"
}

#########################################################################
# check_downloader: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆ¤å®šï¼ˆapk / opkg å¯¾å¿œï¼‰
#########################################################################
check_downloader() {
    if [ -f "${BASE_DIR}/downloader.ch" ]; then
        PACKAGE_MANAGER=$(cat "${CACHE_DIR}/downloader.ch")
        PACKAGE_EXTENSION=$(cat "${CACHE_DIR}/extension.ch")
    else
        if command -v apk >/dev/null 2>&1; then
            PACKAGE_MANAGER="apk"
            PACKAGE_EXTENSION="apk"
        elif command -v opkg >/dev/null 2>&1; then
            PACKAGE_MANAGER="opkg"
            PACKAGE_EXTENSION="ipk"
        else 
            PACKAGE_MANAGER="opkg"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ã‚»ãƒƒãƒˆ
            PACKAGE_EXTENSION="ipk" 
        fi
        echo "$PACKAGE_MANAGER" > "${CACHE_DIR}/downloader.ch"
        echo "$PACKAGE_EXTENSION" > "${CACHE_DIR}/extension.ch"
    fi
    echo -e "$(color green "Package Manager: $PACKAGE_MANAGER - supported (stable)")"
    echo -e "$(color green "Package Extension: $PACKAGE_EXTENSION - supported (stable)")"
}

#########################################################################
# Last Update: 2025-02-18 18:00:00 (JST) ğŸš€
# "Efficiency in retrieval, clarity in communication."
# get_message: ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹é–¢æ•°
#
# ã€è¦ä»¶ã€‘
# 1. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯**
#    - `$ACTIVE_LANGUAGE` ã‚’æœ€å„ªå…ˆã§ä½¿ç”¨ï¼ˆ`normalize_language()` ã§è¨­å®šï¼‰
#    - `$ACTIVE_LANGUAGE` ãŒæœªè¨­å®šã®å ´åˆã¯ `US` ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨
#
# 2. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œç´¢ã®é †åº**
#    â‘  `$ACTIVE_LANGUAGE|ã‚­ãƒ¼=` ã§ `messages.db` ã‚’æ¤œç´¢
#    â‘¡ `US|ã‚­ãƒ¼=` ã§ `messages.db` ã‚’æ¤œç´¢ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
#    â‘¢ ã©ã¡ã‚‰ã«ã‚‚è©²å½“ã—ãªã„å ´åˆã€`ã‚­ãƒ¼` ã‚’ãã®ã¾ã¾è¿”ã™
#
# 3. **å‹•ä½œã®æœ€é©åŒ–**
#    - `$ACTIVE_LANGUAGE` ã‚’ç›´æ¥å‚ç…§ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (`message.ch`) ã«ã¯ä¾å­˜ã—ãªã„
#    - `$quiet_flag` ã« `"quiet"` ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã€å‡ºåŠ›ã›ãšã« `return 0`
#
# 4. **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**
#    - è¨€èªå–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ `normalize_language()` ã«çµ±ä¸€ã—ã€è²¬å‹™ã‚’åˆ†é›¢
#    - `get_message()` ã¯ã€Œå–å¾—ã™ã‚‹ã ã‘ã€ã«ç‰¹åŒ–ã—ã€æ›¸ãè¾¼ã¿ãƒ»è¨­å®šã¯è¡Œã‚ãªã„
#
# 5. **å½±éŸ¿ç¯„å›²**
#    - `common.sh` å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—å…¨èˆ¬ï¼ˆ`debug_log()` å«ã‚€ï¼‰
#    - `messages.db` ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›´æ™‚ã‚‚ `get_message()` ã®ä¿®æ­£ã¯ä¸è¦
#########################################################################
get_message() {
    local key="$1"
    local params="$2"
    local quiet_flag="$3"
    local message_db="${BASE_DIR}/messages.db"
    local message_cache="${CACHE_DIR}/message.ch"
    local lang="US"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯US

    # message.chã‹ã‚‰è¨€èªã‚’èª­ã¿å–ã‚‹
    if [ -f "$message_cache" ]; then
        lang=$(cat "$message_cache")
    fi

    # `messages.db` ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ã‚­ãƒ¼ãã®ã¾ã¾ã‚’è¿”ã™
    if [ ! -f "$message_db" ]; then
        message="$key"
    else
        # è¨€èªå„ªå…ˆæ¤œç´¢
        message=$(grep "^${lang}|${key}=" "$message_db" | cut -d'=' -f2-)

        # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢
        if [ -z "$message" ]; then
            message=$(grep "^US|${key}=" "$message_db" | cut -d'=' -f2-)
        fi

        # ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã€ã‚­ãƒ¼ãã®ã¾ã¾ã‚’è¿”ã™
        if [ -z "$message" ]; then
            message="$key"
        fi
    fi

    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç½®æ›
    if [ -n "$params" ]; then
        for param in $params; do
            key=$(echo "$param" | cut -d'=' -f1)
            value=$(echo "$param" | cut -d'=' -f2)
            # `sed` ã‚³ãƒãƒ³ãƒ‰ã§ä½¿ç”¨ã™ã‚‹éš›ã« `value` ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
            escaped_value=$(echo "$value" | sed -e 's/[\/&]/\\&/g')
            message=$(echo "$message" | sed -e "s/{$key}/$escaped_value/g")
        done
    fi

    # quiet ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
    if [ "$quiet_flag" = "quiet" ]; then
        return 0
    else
        echo "$message"
    fi
}

# ğŸ”µã€€ãƒˆãƒ¼ã‚¯ãƒ³ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

# GitHub APIå‘¼ã³å‡ºã—ï¼ˆãƒ‡ãƒãƒƒã‚°å¼·åŒ–ç‰ˆï¼‰
github_api_request() {
    local endpoint="$1"
    local token=$(get_github_token)
    local response=""
    
    if [ -n "$token" ]; then
        debug_log "DEBUG" "Attempting authenticated request with token (${#token} chars)"
        response=$(wget -q --header="Authorization: token $token" \
            --header="Accept: application/vnd.github.v3+json" \
            -O- "https://api.github.com/$endpoint" 2>/dev/null)
            
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼ - ãƒªãƒŸãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        if echo "$response" | grep -q '"message":"API rate limit exceeded'; then
            debug_log "WARN" "GitHub API rate limit exceeded"
            return 1
        fi
        
        # èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        if echo "$response" | grep -q '"message":"Bad credentials"'; then
            debug_log "ERROR" "GitHub API authentication failed: Bad credentials"
            return 2
        fi
        
        # ãã®ä»–ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        if echo "$response" | grep -q '"message":"'; then
            local error_msg=$(echo "$response" | grep -o '"message":"[^"]*"' | cut -d':' -f2- | tr -d '"')
            debug_log "ERROR" "GitHub API error: $error_msg"
            return 3
        fi
        
        # æˆåŠŸ
        echo "$response"
        return 0
    else
        debug_log "DEBUG" "No token found, using unauthenticated request"
        wget -q -O- "https://api.github.com/$endpoint" 2>/dev/null
        return $?
    fi
}

# æ”¹å–„ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³å–å¾—é–¢æ•°
get_github_token() {
    if [ -f "$GITHUB_TOKEN_FILE" ] && [ -r "$GITHUB_TOKEN_FILE" ]; then
        # 1. ç”Ÿã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        local raw_token=$(cat "$GITHUB_TOKEN_FILE")
        
        # 2. è¤‡æ•°ã®å‡¦ç†æ–¹æ³•ã‚’è©¦ã™
        
        # æ–¹æ³•1: æ”¹è¡Œã¨ç©ºç™½ã‚’å‰Šé™¤
        local token=$(echo "$raw_token" | tr -d '\n\r\t ')
        
        # æ–¹æ³•2: ghp_ã§å§‹ã¾ã‚‹40æ–‡å­—ã®è‹±æ•°å­—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
        if [ -z "$token" ] || [ ${#token} -ne 40 ]; then
            token=$(echo "$raw_token" | grep -o 'ghp_[a-zA-Z0-9]\{36\}')
        fi
        
        # æœ€çµ‚ãƒã‚§ãƒƒã‚¯
        if [ -n "$token" ] && [ ${#token} -eq 40 ]; then
            echo "$token"
            return 0
        else
            debug_log "WARN" "Invalid token format in $GITHUB_TOKEN_FILE"
        fi
    fi
    
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã®å–å¾—
    if [ -n "$GITHUB_TOKEN" ]; then
        echo "$GITHUB_TOKEN"
        return 0
    fi
    
    return 1
}

# ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜é–¢æ•°
save_github_token() {
    token="$1"
    
    if [ -z "$token" ]; then
        debug_log "ERROR" "Empty token provided, cannot save"
        return 1
    fi
    
    # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¦æ¨©é™ã‚’è¨­å®š
    echo "$token" > "$GITHUB_TOKEN_FILE"
    chmod 600 "$GITHUB_TOKEN_FILE"
    
    if [ $? -eq 0 ]; then
        debug_log "INFO" "GitHub token saved to $GITHUB_TOKEN_FILE"
        return 0
    else
        debug_log "ERROR" "Failed to save token to $GITHUB_TOKEN_FILE"
        return 1
    fi
}

# GitHub APIå‘¼ã³å‡ºã—ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³å¯¾å¿œç‰ˆï¼‰
github_api() {
    endpoint="$1"
    
    # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    token=$(get_github_token)
    
    if [ -n "$token" ]; then
        # ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆã¯èªè¨¼ä»˜ããƒªã‚¯ã‚¨ã‚¹ãƒˆ
        debug_log "DEBUG" "Using authenticated GitHub API request"
        wget -qO- --header="Authorization: token $token" \
            "https://api.github.com/$endpoint" 2>/dev/null
    else
        # ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯é€šå¸¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        debug_log "DEBUG" "Using unauthenticated GitHub API request"
        wget -qO- "https://api.github.com/$endpoint" 2>/dev/null
    fi
}

# ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®šã‚³ãƒãƒ³ãƒ‰ï¼ˆOpenWrtäº’æ›æ€§å¼·åŒ–ç‰ˆï¼‰
setup_github_token() {
    echo "GitHub API Token Setup"
    echo "======================"
    echo "This will save a GitHub Personal Access Token to $GITHUB_TOKEN_FILE"
    echo "The token will be used for API requests to avoid rate limits."
    echo ""
    
    # sttyãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    if command -v stty >/dev/null 2>&1; then
        # sttyãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã€éè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
        printf "Enter your GitHub Personal Access Token: "
        stty -echo
        read -r token
        stty echo
        echo ""  # æ”¹è¡Œ
    else
        # sttyãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ä»£æ›¿æ–¹æ³•
        echo "NOTE: Your input will be visible as you type (stty not available)"
        printf "Enter your GitHub Personal Access Token: "
        read -r token
        echo ""
    fi
    
    if [ -n "$token" ]; then
        if save_github_token "$token"; then
            echo "Token has been saved successfully!"
            echo "API requests will now use authentication."
        else
            echo "Failed to save token. Please check permissions."
        fi
    else
        echo "No token entered. Operation cancelled."
    fi
}

# ğŸ”´ã€€ãƒˆãƒ¼ã‚¯ãƒ³ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------


# ğŸ”µã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# Last Update: 2025-02-18 23:00:00 (JST) ğŸš€
# "Standardizing version formatting for consistency."
#
# ã€è¦ä»¶ã€‘
# 1. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’çµ±ä¸€**
#    - `YYYY.MM.DD-è‡ªç”±å½¢å¼`
#    - `YYYYMMDDHHMMSS-è‡ªç”±å½¢å¼`
#    - è¨±å¯ã•ã‚Œã‚‹åŒºåˆ‡ã‚Šæ–‡å­—: `- . , ; : ç©ºç™½`
#
# 2. **å‡¦ç†å†…å®¹**
#    - **è¨±å¯ã•ã‚ŒãŸæ–‡å­—ã®ã¿ã‚’æŠ½å‡º**
#    - **å…ˆé ­ã®ã‚¼ãƒ­ã‚’å‰Šé™¤ï¼ˆä¾‹: `02` â†’ `2`ï¼‰**
#    - **å‰å¾Œã®ä½™è¨ˆãªã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤**
#
# 3. **é©ç”¨å¯¾è±¡**
#    - **`download()`**: **ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å–å¾—ãƒ»æ¯”è¼ƒ**
#    - **`compare_versions()`**: **ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆçµ±ä¸€**
#
# 4. **é©ç”¨ã—ãªã„å¯¾è±¡**
#    - **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®è§£é‡ˆã‚’å¤‰æ›´ã—ãªã„ï¼ˆé †ç•ªã®å…¥ã‚Œæ›¿ãˆã¯ã—ãªã„ï¼‰**
#    - **æ—¥ä»˜ä»¥å¤–ã®æ–‡å­—åˆ—ã¯å‰Šé™¤ã›ãšã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ¨™æº–åŒ–ã®ã¿è¡Œã†**
#
# 5. **ä¾å­˜é–¢ä¿‚**
#    - `normalize_input()` ã‚’ä½¿ç”¨ã—ã€iconv ã«ã‚ˆã‚‹å‡¦ç†ã‚’çµ±ä¸€
#
# 6. **å½±éŸ¿ç¯„å›²**
#    - `common.sh` ã«çµ±åˆã—ã€`download()` & `compare_versions()` ã§ä½¿ç”¨
#########################################################################
# Last Update: 2025-03-04 12:45:00 (JST) ğŸš€
# "Efficient downloading with precise versioning and silent modes."
#
# ã€è¦ä»¶ã€‘
# 1. BASE_WGET ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚
# 2. hidden ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
#    - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®æˆå¦ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹ãŒã€æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯å‡ºåŠ›ã‚’æŠ‘åˆ¶ã™ã‚‹ã€‚
# 3. quiet ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
#    - check_option() ã§è¨­å®šã•ã‚ŒãŸ QUIET_MODE ã«å¾“ã„ã€ã™ã¹ã¦ã®ãƒ­ã‚°ã‚’æŠ‘åˆ¶ã™ã‚‹ã€‚
# 4. chmod ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
#    - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã«å®Ÿè¡Œæ¨©é™ (chmod +x) ã‚’ä»˜ä¸ã™ã‚‹ã€‚
# 5. read ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
#    - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆsourceï¼‰ã™ã‚‹ã€‚ï¼ˆãŸã ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«åãŒ *common*.sh ã«ä¸€è‡´ã™ã‚‹å ´åˆã¯è‡ªå‹•ã§èª­ã¿è¾¼ã‚€ï¼‰
#    - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯èª­ã¿è¾¼ã¾ãªã„ã€‚
# 6. å¼•æ•°ã®é †åºã¯è‡ªç”±ï¼ˆhidden, quiet, chmod, read ã®é †ç•ªã¯ä»»æ„ï¼‰ã€‚
# 7. wget ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¡Œã„ã€å¤±æ•—æ™‚ã®è©³ç´°ã‚’ debug_log() ã«è¨˜éŒ²ã™ã‚‹ã€‚
# 8. å½±éŸ¿ç¯„å›²: common.sh ã® download() ã®ã¿ï¼ˆä»–ã®é–¢æ•°ã«ã¯å½±éŸ¿ãªã—ï¼‰ã€‚
#########################################################################
decode_base64() {
    input="$1"
    output=""
    decoder_type=""
    base64_cache="${CACHE_DIR}/base64.ch"
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä»¥å‰æ¤œå‡ºã—ãŸãƒ‡ã‚³ãƒ¼ãƒ€ãƒ¼ã‚’ç¢ºèª
    if [ -f "$base64_cache" ]; then
        # shellcheck disable=SC1090
        . "$base64_cache"
        debug_log "DEBUG" "base64: using cached decoder: $BASE64_DECODER"
    else
        # åˆ©ç”¨å¯èƒ½ãªãƒ‡ã‚³ãƒ¼ãƒ€ãƒ¼ã‚’æ¤œç´¢
        if command -v base64 >/dev/null 2>&1; then
            BASE64_DECODER="coreutils"
            debug_log "DEBUG" "base64: found coreutils-base64"
        elif command -v openssl >/dev/null 2>&1; then
            BASE64_DECODER="openssl" 
            debug_log "DEBUG" "base64: found openssl"
        else
            debug_log "WARN" "base64: no decoder found, attempting to install coreutils-base64"
            
            # DEBUGãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯é€šå¸¸è¡¨ç¤ºã€ãã‚Œä»¥å¤–ã¯ã‚µã‚¤ãƒ¬ãƒ³ãƒˆ
            if [ "$DEBUG_MODE" = "true" ]; then
                debug_log "INFO" "Running: opkg update"
                opkg update
                debug_log "INFO" "Running: opkg install coreutils-base64"
                opkg install coreutils-base64
            else
                # ã‚µã‚¤ãƒ¬ãƒ³ãƒˆã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è©¦è¡Œ
                opkg update >/dev/null 2>&1
                opkg install coreutils-base64 >/dev/null 2>&1
            fi
            
            # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æˆåŠŸã—ãŸã‹ç¢ºèª
            if command -v base64 >/dev/null 2>&1; then
                BASE64_DECODER="coreutils"
                debug_log "INFO" "base64: successfully installed coreutils-base64"
            else
                debug_log "ERROR" "base64: failed to install decoder, decode operation will fail"
                BASE64_DECODER="none"
            fi
        fi
        
        # æ¤œå‡ºçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        mkdir -p "$CACHE_DIR"
        echo "BASE64_DECODER=\"$BASE64_DECODER\"" > "$base64_cache"
    fi
    
    # ãƒ‡ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ
    case "$BASE64_DECODER" in
        "coreutils")
            output=$(echo "$input" | base64 -d 2>/dev/null)
            decoder_type="coreutils-base64"
            ;;
        "openssl")
            output=$(echo "$input" | openssl base64 -d 2>/dev/null)
            decoder_type="openssl"
            ;;
        *)
            debug_log "ERROR" "base64: no decoder available"
            return 1
            ;;
    esac
    
    # çµæœã‚’ç¢ºèª
    if [ $? -eq 0 ] && [ -n "$output" ]; then
        debug_log "DEBUG" "base64: decoded with $decoder_type"
        echo "$output"
        return 0
    else
        debug_log "ERROR" "base64: decode failed with $decoder_type"
        return 1
    fi
}

# èªè¨¼çŠ¶æ…‹ã‚’æ­£ç¢ºã«åˆ¤å®šã™ã‚‹é–¢æ•°
check_token_status() {
    echo "========== GitHub Token Status =========="
    
    # ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
    if [ -f "$GITHUB_TOKEN_FILE" ]; then
        echo "Token file: $GITHUB_TOKEN_FILE (EXISTS)"
        ls -l "$GITHUB_TOKEN_FILE"
        
        # ãƒˆãƒ¼ã‚¯ãƒ³ã®å…ˆé ­éƒ¨åˆ†ã ã‘ã‚’è¡¨ç¤ºï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ï¼‰
        local token=$(cat "$GITHUB_TOKEN_FILE" | tr -d '\n\r\t ')
        local token_preview=${token:0:5}
        echo "Token starts with: ${token_preview}..."
        
        # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®ç¢ºèª
        local rate_info=$(wget -q -O- --header="Authorization: token $token" "https://api.github.com/rate_limit" 2>/dev/null)
        
        if [ -n "$rate_info" ]; then
            # JSONå‡ºåŠ›ã‹ã‚‰å€¤ã‚’æŠ½å‡ºã™ã‚‹éš›ã«ã€ã‚¹ãƒšãƒ¼ã‚¹ã«é–¢ä¿‚ãªãå–å¾—ã§ãã‚‹ã‚ˆã†æ”¹è‰¯
            local limit=$(echo "$rate_info" | grep -o '"limit"[[:space:]]*:[[:space:]]*[0-9]*' | grep -o '[0-9]*')
            local remaining=$(echo "$rate_info" | grep -o '"remaining"[[:space:]]*:[[:space:]]*[0-9]*' | grep -o '[0-9]*')
            
            echo "Current rate limit: $limit"
            echo "Remaining requests: $remaining"
            
            # èªè¨¼çŠ¶æ…‹ã®åˆ¤æ–­ï¼ˆã‚ˆã‚Šå …ç‰¢ãªæ¯”è¼ƒï¼‰
            if [ -n "$limit" ] && [ "$limit" -gt 60 ]; then
                echo "Auth status: âœ… AUTHENTICATED (Higher limits active: $limit)"
            else
                echo "Auth status: âŒ UNAUTHENTICATED (Standard limits: $limit)"
            fi
        else
            echo "Could not retrieve rate limit information"
        fi
    else
        echo "Token file: $GITHUB_TOKEN_FILE (NOT FOUND)"
    fi
    
    echo "========================================"
}

# APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ç¢ºèªé–¢æ•°
check_api_rate_limit() {
    if [ "$DEBUG_MODE" = "true" ]; then
        api_info=$(wget -qO- "https://api.github.com/rate_limit" 2>/dev/null)
        if [ -n "$api_info" ]; then
            api_remaining=$(echo "$api_info" | grep -o '"core":{"limit":[0-9]*,"remaining":[0-9]*' | grep -o 'remaining":[0-9]*' | cut -d':' -f2)
            api_limit=$(echo "$api_info" | grep -o '"core":{"limit":[0-9]*,"remaining":[0-9]*' | grep -o 'limit":[0-9]*' | cut -d':' -f2)
            api_reset=$(echo "$api_info" | grep -o '"reset":[0-9]*' | head -1 | cut -d':' -f2)
            api_now=$(date +%s)
            
            if [ -n "$api_reset" ] && [ -n "$api_now" ]; then
                api_seconds=$(expr "$api_reset" - "$api_now")
                [ "$api_seconds" -lt 0 ] && api_seconds=0
                api_minutes=$(expr "$api_seconds" / 60)
                api_seconds=$(expr "$api_seconds" % 60)
                debug_log "DEBUG" "API Limits: Core ${api_remaining:-?}/${api_limit:-?}, Reset in ${api_minutes}m ${api_seconds}s"
            fi
        fi
    fi
    return 0
}

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹é–¢æ•°
clean_version_string() {
    local version_str="$1"
    
    # 1. æ”¹è¡Œã¨å¾©å¸°ã‚’å‰Šé™¤
    local cleaned=$(echo "$version_str" | tr -d '\n\r')
    
    # 2. è§’æ‹¬å¼§ã‚’å‰Šé™¤
    cleaned=$(echo "$cleaned" | sed 's/\[//g' | sed 's/\]//g')
    
    # 3. ANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
    cleaned=$(echo "$cleaned" | sed -e 's/\x1b\[[0-9;]*m//g' -e 's/[0-9]\+;[0-9]\+m//g')
    
    # 4. ä¸å¿…è¦ãªé‡è¤‡ã‚’å‰Šé™¤ï¼ˆæ—¥ä»˜ã®é‡è¤‡ãªã©ï¼‰
    cleaned=$(echo "$cleaned" | sed -e 's/\(20[0-9][0-9]-[0-9][0-9]-[0-9][0-9]\)\1*/\1/g' -e 's/\(20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]\)\1*/\1/g')
    
    # 5. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä¸€èˆ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã ã‘ã‚’æŠ½å‡ºï¼ˆæ—¥ä»˜-ãƒãƒƒã‚·ãƒ¥å€¤ï¼‰
    local version_pattern=$(echo "$cleaned" | grep -o '20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]-[0-9a-zA-Z]\+' | head -1)
    
    # ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¯ãƒªãƒ¼ãƒ³åŒ–ã—ãŸæ–‡å­—åˆ—ã‚’è¿”ã™
    if [ -n "$version_pattern" ]; then
        echo "$version_pattern"
    else
        echo "$cleaned"
    fi
}

# GitHubã‚³ãƒŸãƒƒãƒˆã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ï¼ˆå®Œå…¨ç‰ˆï¼‰
get_commit_version() {
    local file_path="$1"
    
    # ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã‚’æ˜ç¤ºçš„ã«è¨­å®š
    local repo_owner="site-u2023"
    local repo_name="aios"
    local api_url="repos/${repo_owner}/${repo_name}/commits?path=${file_path}&per_page=1"
    local commit_info=""
    local auth_method="direct"
    
    # ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹APIèªè¨¼
    local token=$(get_github_token)
    
    if [ -n "$token" ]; then
        debug_log "DEBUG" "Using token authentication for API request"
        commit_info=$(wget -qO- --header="Authorization: token $token" \
            "https://api.github.com/$api_url" 2>/dev/null)
            
        # åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã§ãªã„ã“ã¨ã«åŠ ãˆã¦
        # SHAæƒ…å ±ãŒã‚ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§èªè¨¼çŠ¶æ…‹ã‚’æ­£ç¢ºã«åˆ¤å®š
	if [ -n "$commit_info" ] && (echo "$commit_info" | grep -q '"sha"' || echo "$commit_info" | grep -q '"commit"'); then
    	    auth_method="token"
    	    debug_log "DEBUG" "Token authentication successful"
	else
    	    # è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±
    	    debug_log "DEBUG" "Response first 100 chars: $(echo "$commit_info" | head -c 100)"
    	    debug_log "WARN" "Token auth response lacks expected fields"
	fi
    else
        debug_log "DEBUG" "No token available, using direct API request"
        commit_info=$(wget -qO- "https://api.github.com/$api_url" 2>/dev/null)
    fi
    
    if [ -n "$commit_info" ]; then
        # æ—¥ä»˜ã¨SHAã‚’æŠ½å‡ºï¼ˆæ”¹è¡Œã‚’æ­£ã—ãå‡¦ç†ã™ã‚‹ã‚ˆã†æ”¹å–„ï¼‰
        local commit_date=$(echo "$commit_info" | tr -d '\n\r' | grep -o '"date": *"[^"]*"' | head -1 | sed 's/.*"date": *"\([^"]*\)".*/\1/')
        local commit_sha=$(echo "$commit_info" | tr -d '\n\r' | grep -o '"sha": *"[^"]*"' | head -1 | sed 's/.*"sha": *"\([^"]*\)".*/\1/' | cut -c 1-7)
        
        if [ -n "$commit_date" ] && [ -n "$commit_sha" ]; then
            # YYYY.MM.DD-SHA å½¢å¼ã«å¤‰æ›
            local formatted_date=$(echo "$commit_date" | sed 's/T.*Z//g;s/-/./g')
            local clean_version="${formatted_date}-${commit_sha}"
            
            debug_log "DEBUG" "Successfully extracted commit info: $clean_version"
            echo "$clean_version $auth_method"
            return 0
        fi
        debug_log "DEBUG" "Failed to extract commit info from response"
    else
        debug_log "DEBUG" "No API response received for: $file_path"
    fi
    
    # APIå–å¾—å¤±æ•—æ™‚ã¯ç¾åœ¨æ™‚åˆ»ã‚’ä½¿ç”¨
    echo "$(date +%Y.%m.%d)-unknown ${auth_method}"
    return 1
}

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å®‰å…¨ã«æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆå®Œå…¨ç‰ˆï¼‰
update_file_version() {
    local file_name="$1"
    local version="$2"
    local script_file="$3"
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    version=$(clean_version_string "$version")
    
    if [ ! -f "$script_file" ]; then
        printf "%s=%s\n" "${file_name}" "${version}" > "$script_file"
        return 0
    fi
    
    # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ãŸå®‰å…¨ãªæ›¸ãæ›ãˆ
    local tmp_file="${script_file}.tmp"
    > "$tmp_file"  # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆæœŸåŒ–
    
    if grep -q "^${file_name}=" "$script_file"; then
        # è©²å½“è¡Œã‚’ç½®æ›
        while IFS= read -r line; do
            if echo "$line" | grep -q "^${file_name}="; then
                echo "${file_name}=${version}" >> "$tmp_file"
            else
                echo "$line" >> "$tmp_file"
            fi
        done < "$script_file"
    else
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ã—ã¦æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
        cat "$script_file" > "$tmp_file"
        echo "${file_name}=${version}" >> "$tmp_file"
    fi
    
    # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»å‹•
    mv "$tmp_file" "$script_file"
    
    return 0
}

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒé–¢æ•°
version_is_newer() {
    local current="$1"
    local reference="$2"
    
    # ã©ã¡ã‚‰ã‹ãŒä¸æ˜ã®å ´åˆã¯æ›´æ–°å¿…è¦
    if echo "$current $reference" | grep -q "No version\|unknown"; then
        return 0
    fi
    
    # æ—¥ä»˜éƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆYYYY.MM.DDå½¢å¼ï¼‰- ã‚ˆã‚Šå …ç‰¢ãªæ–¹æ³•
    local current_date=$(echo "$current" | grep -o "[0-9][0-9][0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]" | head -1)
    local reference_date=$(echo "$reference" | grep -o "[0-9][0-9][0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]" | head -1)
    
    # æ—¥ä»˜ãŒæŠ½å‡ºã§ããªã‹ã£ãŸå ´åˆã¯æ›´æ–°ãŒå¿…è¦
    if [ -z "$current_date" ] || [ -z "$reference_date" ]; then
        return 0
    fi
    
    # æ—¥ä»˜ã‚’æ•°å€¤ã«å¤‰æ›ï¼ˆåŒºåˆ‡ã‚Šæ–‡å­—ã‚’å‰Šé™¤ï¼‰
    local current_num=$(echo "$current_date" | tr -d '.')
    local reference_num=$(echo "$reference_date" | tr -d '.')
    
    # æ•°å€¤æ¯”è¼ƒï¼ˆæ—¥ä»˜å½¢å¼ï¼‰
    if [ "$current_num" -gt "$reference_num" ]; then
        return 0  # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæ–°ã—ã„
    elif [ "$current_num" -lt "$reference_num" ]; then
        return 1  # ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæ–°ã—ã„
    fi
    
    # æ—¥ä»˜ãŒåŒã˜å ´åˆã¯SHAéƒ¨åˆ†ã‚’æ¯”è¼ƒ
    local current_sha=$(echo "$current" | grep -o "\-[a-z0-9]*" | sed 's/^-//' | head -1)
    local reference_sha=$(echo "$reference" | grep -o "\-[a-z0-9]*" | sed 's/^-//' | head -1)
    
    if [ -n "$current_sha" ] && [ -n "$reference_sha" ] && [ "$current_sha" != "$reference_sha" ]; then
        return 0  # ç•°ãªã‚‹ã‚³ãƒŸãƒƒãƒˆ
    fi
    
    return 1  # åŒä¸€ãƒãƒ¼ã‚¸ãƒ§ãƒ³
}

# ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•°
download() {
    # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æœ€åˆã®å¼•æ•°ã¨ã—ã¦å‡¦ç†ã€æ®‹ã‚Šã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    local file_name="$1"
    shift
    
    # è¨­å®šå¤‰æ•°
    local hidden_mode="false"
    local quiet_mode="${QUIET_MODE:-false}"
    local chmod_mode="false"
    local read_mode="false"
    local script_file="${CACHE_DIR}/script.ch"
    local dummy_version="No version control"
    
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã®å‡¦ç†
    while [ $# -gt 0 ]; do
        case "$1" in
            hidden) hidden_mode="true" ;;
            quiet)  quiet_mode="true" ;;
            debug)  DEBUG_MODE="true" ;;
            chmod)  chmod_mode="true" ;;
            read)   read_mode="true" ;;
            *)      debug_log "WARN" "Unknown option: $1, ignoring" ;;
        esac
        shift
    done
    
    # ãƒ‘ã‚¹è¨­å®š
    local install_path="${BASE_DIR}/$file_name"
    local remote_url="${BASE_URL}/$file_name"
    
    # APIåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ï¼‰
    [ "$DEBUG_MODE" = "true" ] && check_api_rate_limit
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®å–å¾—
    local remote_version_info=$(get_commit_version "$file_name")
    local remote_version=$(printf "%s" "$remote_version_info" | cut -d' ' -f1)
    local auth_method=$(printf "%s" "$remote_version_info" | cut -d' ' -f2)
    local local_version=""
    
    # ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å–å¾—
    if [ -f "$script_file" ]; then
        local_version=$(grep "^${file_name}=" "$script_file" | cut -d'=' -f2)
    fi
    [ -z "$local_version" ] && local_version="$dummy_version"

    local clean_remote_version=$(clean_version_string "$remote_version")
    local clean_local_version=$(clean_version_string "$local_version")

    # èªè¨¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨­å®š
    local auth_message=""
    case "$auth_method" in
        token)    auth_message="via token auth" ;;
        standard) auth_message="via standard API" ;;
        *)        auth_message="via direct download" ;;
    esac
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰åˆ¤æ–­
    local status_message="No update needed"
    local update_required=false
    
    if [ "$local_version" = "$dummy_version" ]; then
        update_required=true
    else
        version_is_newer "$remote_version" "$local_version"
        [ $? -eq 0 ] && update_required=true
    fi
    
    debug_log "DEBUG" "Remote version: $file_name - $clean_remote_version"
    debug_log "DEBUG" "Local version: $file_name - $clean_local_version"
    debug_log "DEBUG" "Update required: $file_name -$(printf "%s" "$update_required")"
    
    if [ "$update_required" = "true" ]; then
        # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        if ! $BASE_WGET "$install_path" "$remote_url"; then
            debug_log "ERROR" "Download failed: $file_name is empty"
            return 1
        fi
        
        # ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
        if [ ! -s "$install_path" ]; then
            debug_log "ERROR" "Download failed: $file_name is empty"
            return 1
        fi
        
        # æ¨©é™è¨­å®š
        if [ "$chmod_mode" = "true" ]; then
            chmod +x "$install_path"
            debug_log "DEBUG" "chmod +x applied to $file_name"
        fi
        
    	# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®æ›´æ–°
    	if [ ! -f "$script_file" ]; then
            printf "%s=%s\n" "${file_name}" "${clean_remote_version}" > "$script_file"
    	else
            if grep -q "^${file_name}=" "$script_file"; then
                # ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’æ”¹è‰¯
                escaped_file=$(echo "$file_name" | sed 's/[\/&]/\\&/g')
                escaped_version=$(echo "$clean_remote_version" | sed 's/[\/&]/\\&/g')
                sed -i "s/^${escaped_file}=.*/${escaped_file}=${escaped_version}/" "$script_file"
            else
                printf "%s=%s\n" "${file_name}" "${clean_remote_version}" >> "$script_file"
            fi
        fi
    
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¿®æ­£
        status_message="Download completed"
    fi
    
    # èª­ã¿è¾¼ã¿å‡¦ç†
    local action_message=""
    if [ "$read_mode" = "true" ] || echo "$file_name" | grep -q "common.*\\.sh"; then
        . "$install_path"
        action_message="Loaded"
    fi
    
    # å‡ºåŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¿®æ­£
    local message="${file_name}: ${status_message} - Version: ${clean_remote_version} ${auth_message}"
    if [ -n "$action_message" ]; then
        message="${message} (${action_message})"
    fi

    # å‡ºåŠ›
    if [ "$hidden_mode" = "true" ]; then
        echo -e "$(color green "${message}")"
    else
        debug_log "DEBUG" "Quiet mode ${message}"
    fi
    
    return 0
}

# ğŸ”´ã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´ã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒ¡ã‚¤ãƒ³ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# ãƒãƒŠãƒ¼è¡¨ç¤º
#########################################################################
print_banner() {
    echo
    color magenta "                    ii i"
    color blue    "         aaaa      iii       oooo      sssss"
    color cyan    "            aa      ii      oo  oo    ss"
    color green   "         aaaaa      ii      oo  oo     sssss"
    color yellow  "        aa  aa      ii      oo  oo         ss"
    color red     "         aaaaa     iiii      oooo     ssssss"
    echo
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_DECCRIPTION")")"
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_NAME")")"
    printf "%s\n" "$(color red "$(get_message "MSG_BANNER_DISCLAIMER")")"
}

#########################################################################
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
# ãƒ†ã‚¹ãƒˆç”¨ï¼ˆæœ€çµ‚çš„ã«æ¨å¥¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ç§»å‹•ï¼‰
#########################################################################
packages() {
    # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    #install_package luci yn hidden
    install_package ttyd yn hidden
    install_package luci-app-ttyd yn hidden
    install_package luci-i18n-ttyd yn hidden
    install_package openssh-sftp-server yn hidden
    install_package luci-mod-dashboard yn hidden
    #install_package coreutils yn hidden
    install_package irqbalance yn hidden

    feed_package gSpotx2f packages-openwrt current luci-app-cpu-perf yn hidden
    feed_package gSpotx2f packages-openwrt current luci-app-cpu-status yn hidden
    feed_package gSpotx2f packages-openwrt current luci-app-temp-status yn hidden
    feed_package gSpotx2f packages-openwrt current luci-app-log-viewer yn hidden
    feed_package gSpotx2f packages-openwrt current luci-app-log yn hidden
    feed_package gSpotx2f packages-openwrt current internet-detector yn hidden disabled

    feed_package_release lisaac luci-app-diskman yn hidden disabled

    feed_package_release jerrykuku luci-theme-argon yn hidden disabled
    
    # install_package list
}

#########################################################################
# åˆæœŸè¨­å®š
#########################################################################
# æ¨©é™è¨­å®š
chmod_aios() {

    echo "$(color magenta "Setting permissions for $BIN_PATH")"

    if ! chmod +x "$BIN_PATH"; then
        debug_log "ERROR" "Failed to set permissions for $BIN_PATH"
        return 1
    fi
}

# åˆæœŸåŒ–å‡¦ç†
delete_aios() {
    debug_log "ERROR" "Deleting $BASE_DIR"
    if ! rm -rf "${BASE_DIR}"; then
        debug_log "ERROR" "Failed to delete $BASE_DIR"
        return 1
    fi
}

# å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
make_directory() {

    echo "$(color magenta "Creating required directories")"

    if ! mkdir -p "${BASE_DIR}" "$CACHE_DIR" "$LOG_DIR" "$FEED_DIR"; then
        debug_log "ERROR" "Failed to create required directories"
        return 1
    fi
}

check_update() {
    # ç¢ºå®Ÿã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    mkdir -p "$CACHE_DIR" 2>/dev/null

    # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¾Œã®ç‰¹æ®Šå‡¦ç†
    POST_UPDATE="false"
    if [ -f "${CACHE_DIR}/post_update_flag" ]; then
        POST_UPDATE="true"
        rm -f "${CACHE_DIR}/post_update_flag"
        debug_log "DEBUG" "Post-update detected, continuing with normal execution"
        MODE="full"  # æ›´æ–°å¾Œã¯æ¨™æº–ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
        return 0
    fi

    # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆçŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
    if [ ! -f "$UPDATE_CACHE" ]; then
        # åˆå›å®Ÿè¡Œ: ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’ã‚»ãƒƒãƒˆ
        debug_log "DEBUG" "First run detected, setting update mode"
        MODE="update"
        # çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¨˜éŒ²ï¼‰
        echo "$SCRIPT_VERSION" > "$UPDATE_CACHE" || debug_log "WARN" "Could not create $UPDATE_CACHE"
    else
        # å†å®Ÿè¡Œ: ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒã‚§ãƒƒã‚¯
        local cached_version=$(cat "$UPDATE_CACHE" 2>/dev/null || echo "unknown")
        if [ "$cached_version" != "$SCRIPT_VERSION" ]; then
            debug_log "DEBUG" "Version changed from $cached_version to $SCRIPT_VERSION"
            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°
            echo "$SCRIPT_VERSION" > "$UPDATE_CACHE" || debug_log "WARN" "Could not update $UPDATE_CACHE"
        fi
        # å¼•æ•°ã§æ˜ç¤ºçš„ãªãƒ¢ãƒ¼ãƒ‰æŒ‡å®šãŒãªã‘ã‚Œã°fullã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
        [ -z "$MODE" ] && MODE="full"
    fi

    # å¸¸ã«æˆåŠŸã‚’è¿”ã™ï¼ˆã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å‡¦ç†ã‚’ç¶™ç¶šï¼‰
    return 0
}

# åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
initialization() {
    # å®Ÿè¡Œæ¨©é™ã‚’è¨­å®š
    if ! chmod_aios; then
        debug_log "ERROR" "Failed to set execute permission"
        return 1
    fi

    # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    if ! make_directory; then
        debug_log "ERROR" "Failed to create required directories"
        return 1
    fi

    check_update || debug_log "WARN" "Update check had issues, continuing anyway"
    return 0
}

#########################################################################
# Last Update: 2025-02-15 10:00:00 (JST) ğŸš€
# check_option: ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æãƒ»æ­£è¦åŒ–é–¢æ•°
#
# ã€æ¦‚è¦ã€‘
# ã“ã®é–¢æ•°ã¯ã€aios èµ·å‹•æ™‚ã«æ¸¡ã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’è§£æã—ã€
# ãƒ€ãƒƒã‚·ãƒ¥ä»˜ãã®å¼•æ•°ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦è§£æã€éãƒ€ãƒƒã‚·ãƒ¥å¼•æ•°ã¯ã™ã¹ã¦
# è¨€èªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ‰±ã„ã€æœ€åˆã«è¦‹ã¤ã‹ã£ãŸå€¤ã‚’ SELECTED_LANGUAGE ã«è¨­å®šã—ã¾ã™ã€‚
#
# â€» MODE ã®æŒ‡å®šã¯å¿…ãšãƒ€ãƒƒã‚·ãƒ¥ä»˜ãã§è¡Œã„ã€ä»¥ä¸‹ã®å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å—ã‘ä»˜ã‘ã¾ã™ã€‚
#     common_full  : -cf, --cf, -common_full, --common_full  â†’ MODE="full"
#     common_light : -cl, --cl, -ocommon_light, --ocommon_light â†’ MODE="light"
#     common_debug : -cd, --cd, -common_debug, --common_debug, --ocommon_debug â†’ MODE="debug"
#     reset        : -r, --r, -reset, --reset, -resrt, --resrt â†’ MODE="reset" ãŠã‚ˆã³ RESET="true"
#
# ã€å¯¾å¿œã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‘
#  - ãƒ˜ãƒ«ãƒ—:         -h, --h, -help, --help, -?, --?  
#  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³:     -v, --v, -version, --version  
#  - ãƒ‡ãƒãƒƒã‚°:       -d, --d, -debug, --debug, -d1, --d1  
#                     â†’ DEBUG_MODE="true", DEBUG_LEVEL="DEBUG"
#                   -d2, --d2, -debug2, --debug2  
#                     â†’ DEBUG_MODE="true", DEBUG_LEVEL="DEBUG2"
#  - ãƒ¢ãƒ¼ãƒ‰æŒ‡å®š:
#       - full:       -cf, --cf, -common_full, --common_full  â†’ MODE="full"
#       - light:      -cl, --cl, -ocommon_light, --ocommon_light â†’ MODE="light"
#       - debug:      -cd, --cd, -common_debug, --common_debug, --ocommon_debug â†’ MODE="debug"
#       - reset:      -r, --r, -reset, --reset, -resrt, --resrt â†’ MODE="reset", RESET="true"
#  - å¼·åˆ¶å®Ÿè¡Œ:       -f, --f, -force, --force  â†’ FORCE="true"
#  - ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³:     -dr, --dr, -dry-run, --dry-run  â†’ DRY_RUN="true"
#  - ãƒ­ã‚°å‡ºåŠ›å…ˆ:     -l, --l, -logfile, --logfile <path>  â†’ LOGFILE ã«æŒ‡å®šãƒ‘ã‚¹
#
# ã€ä»•æ§˜ã€‘
# 1. ãƒ€ãƒƒã‚·ãƒ¥ä»˜ãã®å¼•æ•°ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦è§£æã—ã€éãƒ€ãƒƒã‚·ãƒ¥å¼•æ•°ã¯ã™ã¹ã¦ SELECTED_LANGUAGE ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚
# 2. è§£æçµæœã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° SELECTED_LANGUAGE, DEBUG_MODE, DEBUG_LEVEL, MODE, DRY_RUN, LOGFILE, FORCE, RESET, HELP ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã€
#    å¾Œç¶šã® check_common(), select_country(), debug(), script_version() ãªã©ã«æ­£è¦åŒ–ã•ã‚ŒãŸå€¤ã¨ã—ã¦æ¸¡ã•ã‚Œã¾ã™ã€‚
#
# ã€ä½¿ç”¨ä¾‹ã€‘
#   sh aios.sh -d --dry-run --reset -l /var/log/aios.log -f -cf en
#    â†’ è¨€èª "en" ãŒ SELECTED_LANGUAGE ã«è¨­å®šã•ã‚Œã€MODE ã¯ "full"ï¼ˆ-cfç­‰ã§æŒ‡å®šï¼‰ã€ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ã€
#       ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒªã‚»ãƒƒãƒˆã€ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã€ãƒ­ã‚°å‡ºåŠ›å…ˆ /var/log/aios.logã€å¼·åˆ¶å®Ÿè¡ŒãŒæœ‰åŠ¹ã«ãªã‚‹ã€‚
#########################################################################
check_option() {

    echo "$(color magenta "check_option received before args: $*")"

    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
    SELECTED_LANGUAGE=""
    DEBUG_MODE="false"
    DEBUG_LEVEL="INFO"
    DRY_RUN="false"
    LOGFILE=""
    FORCE="false"
    RESET="false"
    HELP="false"

    # è¨€èªãŠã‚ˆã³ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã®å‡¦ç†
    while [ "$#" -gt 0 ]; do
        case "$1" in
            -h|--h|-help|--help|-\?|--\?)
                HELP="true"
                print_help
                exit 0
                ;;
            -v|--v|-version|--version)
                script_version
                exit 0
                ;;
            -d|--d|-debug|--debug|-d1|--d1)
                DEBUG_MODE="true"
                DEBUG_LEVEL="DEBUG"
                ;;
            -d2|--d2|-debug2|--debug2)
                DEBUG_MODE="true"
                DEBUG_LEVEL="DEBUG2"
                ;;
            -cf|--cf|-common_full|--common_full)
                MODE="full"
                ;;
            -cl|--cl|-ocommon_light|--ocommon_light)
                MODE="light"
                ;;
            -cd|--cd|-common_debug|--common_debug|--ocommon_debug)
                MODE="debug"
                ;;
            -r|--r|-reset|--reset|-resrt|--resrt)
                MODE="reset"
                RESET="true"
                ;;
            -f|--f|-force|--force)
                FORCE="true"
                ;;
            -dr|--dr|-dry-run|--dry-run)
                DRY_RUN="true"
                ;;
            -l|--l|-logfile|--logfile)
                if [ -n "$2" ] && [ "${2#-}" != "$2" ]; then
                    LOGFILE="$2"
                    shift
                else
                    echo "Error: --logfile requires a path argument"
                    exit 1
                fi
                ;;
	    -u|--u|-update|--update)
		debug_log "DEBUG" "check_option: aios update"
    		MODE="update"
    		;;
	    -t|--t|-token|--token)
		setup_github_token
		;;
	    -ts|--ts|--token-status)
    		check_token_status
    		exit 0
    		;;
	    -test_api)
		MODE="test_api"
		;;
            -*)
                echo "Warning: Unknown option: $1" >&2
                ;;
            *)
                if [ -z "$SELECTED_LANGUAGE" ]; then
                    SELECTED_LANGUAGE="$1"
                fi
                ;;
        esac
        shift
    done

    # ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
    export SELECTED_LANGUAGE DEBUG_MODE DEBUG_LEVEL MODE DRY_RUN LOGFILE FORCE RESET HELP

    # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
    debug_log "DEBUG" "check_option: MODE=$MODE, SELECTED_LANGUAGE=$SELECTED_LANGUAGE"
    debug_log "DEBUG" "check_option: DEBUG_MODE=$DEBUG_MODE, DEBUG_LEVEL=$DEBUG_LEVEL"
    debug_log "DEBUG" "check_option: DRY_RUN=$DRY_RUN, LOGFILE=$LOGFILE"
    debug_log "DEBUG" "check_option: FORCE=$FORCE, RESET=$RESET, HELP=$HELP"

    # è¨­å®šã•ã‚ŒãŸè¨€èªã‚’ `check_common()` ã«æ¸¡ã™
    check_common "$SELECTED_LANGUAGE" "$MODE"
}

#########################################################################
# Last Update: 2025-02-16 21:45:00 (JST) ğŸš€
# "Ensuring seamless updates, one script at a time."
#
# ã€è¦ä»¶ã€‘
# 1. `download_script()` ã‚’ `download()` ã«çµ±åˆã—ã€ä¸€è²«æ€§ã‚’ç¢ºä¿ã™ã‚‹ã€‚
# 2. `debug_log()` ã‚’å¼·åŒ–ã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰çŠ¶æ³ã‚’è©³ç´°ã«è¨˜éŒ²ã€‚
# 3. `download()` ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¦‹ç›´ã—ã€å¤±æ•—æ™‚ã®æŒ™å‹•ã‚’æ”¹å–„ã€‚
# 4. `openwrt.db`, `messages.db`, `country.db`, `packages.db` ã‚’é©åˆ‡ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚
# 5. å½±éŸ¿ç¯„å›²: `common.sh`ï¼ˆçŸ›ç›¾ãªãé©ç”¨ï¼‰ã€‚
#########################################################################
check_common() {
    local lang_code="$1"
    local mode="$2"

    debug_log "DEBUG" "check_common: MODE=$MODE"
    debug_log "DEBUG" "check_common: mode=$mode"

    if [ -n "$mode" ]; then
        MODE="$mode"
    fi

    # ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®å‡¦ç†
    case "$MODE" in
        reset)
            rm -f "${CACHE_DIR}/country.ch" \
                  "${CACHE_DIR}/language.ch" \
                  "${CACHE_DIR}/luci.ch" \
                  "${CACHE_DIR}/zone.ch" \
                  "${CACHE_DIR}/zonename.ch" \
                  "${CACHE_DIR}/timezone.ch" \
                  "${CACHE_DIR}/country_success_done" \
                  "${CACHE_DIR}/timezone_success_done"
            echo "$(get_message "MSG_RESET_COMPLETE")"
            exit 0
            ;;
        update)
	    download "aios" "hidden" "chmod"
	    if [ ! -f "${CACHE_DIR}/post_update_flag" ]; then
		MODE="full"
		check_common "$lang_code" "$MODE" "$@"
	    else
		MODE="full"
		exec "$BIN_PATH" $(echo "$@" | sed 's/update//g' | sed 's/--update//g' | sed 's/-u//g' | sed 's/--u//g')
	    fi
	    ;;
        debug)
            download "common-country.sh" "hidden"
            download "common-package.sh" "hidden"
            download "common-feed-package.sh" "hidden"
            download "messages.db" "hidden"
            download "openwrt.db" "hidden"
            download "country.db" "hidden"
            download "local-package.db" "hidden"
            download "custom-package.db" "hidden"
            check_openwrt
            check_architecture
            check_downloader
            print_banner
            select_country "$lang_code"
            download "hidden" "system-config.sh" "chmod" "read"
            #packages
            ;;
        light)
            download "common-country.sh"
            download "common-package.sh"
            download "common-feed-package.sh"
            download "messages.db"
            download "openwrt.db"
            download "country.db"
            download "local-package.db"
            download "custom-package.db"
            check_openwrt
            check_architecture
            check_downloader
            print_banner
            select_country "$lang_code"
            download "hidden" "system-config.sh" "chmod" "read"
            #packages
            ;;
        full)
            download "common-country.sh"
            download "common-package.sh"
            download "common-feed-package.sh"
            download "messages.db"
            download "openwrt.db"
            download "country.db"
            download "local-package.db"
            download "custom-package.db"
            check_openwrt
            check_architecture
            check_downloader
            print_banner
            select_country "$lang_code"
            download "system-config.sh" "chmod" "read"
            #packages
            ;;
        return)
            rm -f "${CACHE_DIR}/country.ch" \
                  "${CACHE_DIR}/language.ch" \
                  "${CACHE_DIR}/luci.ch" \
                  "${CACHE_DIR}/zone.ch" \
                  "${CACHE_DIR}/zonename.ch" \
                  "${CACHE_DIR}/timezone.ch" \
                  "${CACHE_DIR}/country_success_done" \
                  "${CACHE_DIR}/timezone_success_done"
            select_country
            ;;
	test_api)
	    #wget -q -O /tmp/aios/github_api_test.sh "https://raw.githubusercontent.com/site-u2023/aios/main/github_api_test.sh"
	    BASE_WGET ${BASE_DIR}/github_api_test.sh ${BASE_URL}/github_api_test.sh
	    chmod +x ${BASE_DIR}/github_api_test.sh
	    sh ${BASE_DIR}/github_api_test.sh
	    ;;
        *)
            ;;
    esac
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    initialization
    check_option "$@"
}

# ğŸ”´ã€€ãƒ¡ã‚¤ãƒ³ã€€ã“ã“ã¾ã§ã€€ğŸ”´ã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"
