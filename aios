#!/bin/sh

SCRIPT_VERSION="2025.03.05-00-00"

# =========================================================
# ğŸ“Œ OpenWrt / Alpine Linux POSIX-Compliant Shell Script
# ğŸš€ Last Update: 2025-02-21
#
# ğŸ·ï¸ License: CC0 (Public Domain)
# ğŸ¯ Compatibility: OpenWrt >= 19.07 (Tested on 24.10.0)
#
# âš ï¸ IMPORTANT NOTICE:
# OpenWrt OS exclusively uses **Almquist Shell (ash)** and
# is **NOT** compatible with Bourne-Again Shell (bash).
#
# ğŸ“¢ POSIX Compliance Guidelines:
# âœ… Use `[` instead of `[[` for conditions
# âœ… Use `$(command)` instead of backticks `` `command` ``
# âœ… Use `$(( ))` for arithmetic instead of `let`
# âœ… Define functions as `func_name() {}` (no `function` keyword)
# âœ… No associative arrays (`declare -A` is NOT supported)
# âœ… No here-strings (`<<<` is NOT supported)
# âœ… No `-v` flag in `test` or `[[`
#
# ğŸ› ï¸ Keep it simple, POSIX-compliant, and lightweight for OpenWrt!
# =========================================================
### =========================================================
### ğŸ“Œ AI Assistance Request: Bug Fixing Procedure
### 
### When debugging or fixing errors in this script, follow these steps:
### 
### 1ï¸âƒ£ Create a minimal test script to identify the bug.
### 2ï¸âƒ£ Execute the test and verify the reproducibility of the error.
### 3ï¸âƒ£ Fix the error and re-run the test to confirm the solution.
### 4ï¸âƒ£ Apply the corrected code to the production environment.
### 
### âš ï¸ DO NOT modify the main script without first confirming the fix 
###     through a dedicated test script.
### 
### ğŸ› ï¸ Keep the debugging process structured, efficient, and reliable.
### =========================================================

DEV_NULL="${DEV_NULL:-on}"
# ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰
# export DEV_NULL="on"
# é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
# unset DEV_NULL

# åŸºæœ¬å®šæ•°ã®è¨­å®š 
BASE_WGET="${BASE_WGET:-wget --no-check-certificate -q -O}"
# BASE_WGET="${BASE_WGET:-wget -O}"
BASE_URL="${BASE_URL:-https://raw.githubusercontent.com/site-u2023/aios/main}"
BIN_PATH="/usr/bin/aios"
BASE_DIR="${BASE_DIR:-/tmp/aios}"
CACHE_DIR="${CACHE_DIR:-$BASE_DIR/cache}"
LOG_DIR="${LOG_DIR:-$BASE_DIR/logs}"
DL_DIR="${DL_DIR:-$BASE_DIR/download}"
FEED_DIR="${FEED_DIR:-$BASE_DIR/feed}"
mkdir -p "$CACHE_DIR" "$LOG_DIR" "$DL_DIR" "$FEED_DIR"
DEBUG_MODE="${DEBUG_MODE:-false}"

# ğŸ”µã€€ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ»ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µ-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# Last Update: 2025-02-16 16:00:00 (JST) ğŸš€
# "Clarity in errors, precision in handling. Every function must be robust."
#
# ã€è¦ä»¶ã€‘
# 1. ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ `messages.db` ã§ç®¡ç†ã—ã€å¤šè¨€èªå¯¾å¿œã™ã‚‹ã€‚
# 2. `debug_log("ERROR", message)` ã‚‚ `message.db` ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
# 3. `{file}`, `{version}` ãªã©ã®å¤‰æ•°ã‚’å‹•çš„ã«ç½®æ›ã€‚
# 4. å½±éŸ¿ç¯„å›²: `aios` & `common.sh`ï¼ˆçŸ›ç›¾ãªãé©ç”¨ï¼‰ã€‚
#########################################################################
handle_error() {
    local error_key="$1"
    local file="$2"
    local version="$3"
    local exit_required="${4:-no}"

    local error_message
    error_message=$(get_message "$error_key")

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if [ -z "$error_message" ]; then
        error_message="Unknown error occurred. Key: $error_key"
    fi

    # å¤‰æ•°ã‚’ç½®æ›
    error_message=$(echo "$error_message" | sed -e "s/{file}/$file/g" -e "s/{version}/$version/g")

    # ãƒ­ã‚°è¨˜éŒ² & è¡¨ç¤º
    debug_log "ERROR" "$error_message"
    echo -e "$(color red "$error_message")"

    if [ "$exit_required" = "yes" ]; then
        debug_log "ERROR" "Critical error occurred, exiting: $error_message"
        exit 1
    else
        debug_log "DEBUG" "Non-critical error: $error_message"
        return 1
    fi
}

#########################################################################
# Last Update: 2025-02-16 16:10:00 (JST) ğŸš€
# "Logging with clarity, debugging with precision."
#
# ã€è¦ä»¶ã€‘
# 1. ã™ã¹ã¦ã®ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ `messages.db` ã§ç®¡ç†ã—ã€å¤šè¨€èªå¯¾å¿œã™ã‚‹ã€‚
# 2. `{file}`, `{version}` ãªã©ã®å¤‰æ•°ã‚’ `sed` ã§å‹•çš„ã«ç½®æ›ã™ã‚‹ã€‚
# 3. `DEBUG_MODE` ã®è¨­å®šã«å¿œã˜ã¦ `DEBUG`, `INFO`, `WARN`, `ERROR` ã‚’ç®¡ç†ã™ã‚‹ã€‚
# 4. å½±éŸ¿ç¯„å›²: `aios` & `common.sh`ï¼ˆçŸ›ç›¾ãªãé©ç”¨ï¼‰ã€‚
#########################################################################
debug_log() {
    local level="$1"
    local message="$2"
    local file="$3"
    local version="$4"

    # `$1` ã«ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ `DEBUG` ã«ã™ã‚‹
    case "$level" in
        "DEBUG"|"INFO"|"WARN"|"ERROR") ;;  # ä½•ã‚‚ã—ãªã„ (æ­£ã—ã„ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«)
        "")
            level="DEBUG"
            message="$1"
            file="$2"
            version="$3"
            ;;
        *)
            message="$1"
            file="$2"
            version="$3"
            level="DEBUG"
            ;;
    esac

    # å¤‰æ•°ã‚’ç½®æ›
    message=$(echo "$message" | sed -e "s/{file}/$file/g" -e "s/{version}/$version/g")

    # ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡
    case "$DEBUG_LEVEL" in
        DEBUG)    allowed_levels="DEBUG INFO WARN ERROR" ;;
        INFO)     allowed_levels="INFO WARN ERROR" ;;
        WARN)     allowed_levels="WARN ERROR" ;;
        ERROR)    allowed_levels="ERROR" ;;
        *)        allowed_levels="ERROR" ;;
    esac

    if echo "$allowed_levels" | grep -q "$level"; then
        local timestamp
        timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        local log_message="[$timestamp] $level: $message"

        # ã‚«ãƒ©ãƒ¼è¡¨ç¤º
        case "$level" in
            "ERROR") echo -e "$(color red "$log_message")" ;;
            "WARN") echo -e "$(color yellow "$log_message")" ;;
            "INFO") echo -e "$(color cyan "$log_message")" ;;
            "DEBUG") echo -e "$(color white "$log_message")" ;;
        esac

        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
        echo "$log_message" >> "$LOG_DIR/debug.log"
    fi
}

#########################################################################
# Last Update: 2025-02-16 17:30:00 (JST) ğŸš€
# "Debug with clarity, test with precision. Every log tells a story."
#
# ã€è¦ä»¶ã€‘
# 1. `test_country_search()`, `test_timezone_search()`, `test_cache_contents()` ã‚’çµ±åˆã€‚
# 2. `debug_log()` ã‚’ä½¿ç”¨ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ `message.db` ã‹ã‚‰å–å¾—ã€‚
# 3. `country.db` ã®æ¤œç´¢çµæœãŒé©åˆ‡ã«å‡ºåŠ›ã•ã‚Œã‚‹ã‹ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
# 4. å½±éŸ¿ç¯„å›²: `common.sh` ã®ã¿ï¼ˆ`aios` ã«ã¯å½±éŸ¿ãªã—ï¼‰ã€‚
#########################################################################
test_debug_functions() {
    local test_type="$1"
    local test_input="$2"

    case "$test_type" in
        country)
            debug_log "DEBUG" "MSG_TEST_COUNTRY_SEARCH" "$test_input"
            if [ ! -f "${BASE_DIR}/country.db" ]; then
                handle_error "ERR_FILE_NOT_FOUND" "country.db"
                return 1
            fi
            awk -v query="$test_input" '
                $2 ~ query || $3 ~ query || $4 ~ query || $5 ~ query {
                    print NR, $2, $3, $4, $5, $6, $7, $8, $9
                }' "${BASE_DIR}/country.db"
            ;;

        timezone)
            debug_log "DEBUG" "MSG_TEST_TIMEZONE_SEARCH" "$test_input"
            if [ ! -f "${BASE_DIR}/country.db" ]; then
                handle_error "ERR_FILE_NOT_FOUND" "country.db"
                return 1
            fi
            awk -v country="$test_input" '
                $2 == country || $4 == country || $5 == country {
                    print NR, $5, $6, $7, $8, $9, $10, $11
                }' "${BASE_DIR}/country.db"
            ;;

        cache)
            debug_log "DEBUG" "MSG_TEST_CACHE_CONTENTS"
            for cache_file in "country_tmp.ch" "zone_tmp.ch"; do
                if [ -f "${CACHE_DIR}/$cache_file" ]; then
                    debug_log "DEBUG" "MSG_CACHE_CONTENTS" "$cache_file"
                    cat "${CACHE_DIR}/$cache_file"
                else
                    debug_log "DEBUG" "MSG_CACHE_NOT_FOUND" "$cache_file"
                fi
            done
            ;;
        
        *)
            debug_log "ERROR" "ERR_INVALID_ARGUMENT" "$test_type"
            return 1
            ;;
    esac
}

# ğŸ”´ã€€ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ»ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------

#########################################################################
# print_help: ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
#########################################################################
print_help() {
    echo "Usage: aios.sh [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -reset, --reset, -r     Reset all cached data"
    echo "  -help, --help, -h       Show this help message"
    echo "  ja, en, zh-cn, ...      Set language"
    echo ""
    echo "Examples:"
    echo "  sh aios.sh full ja       # Run in full mode with language set to Japanese"
    echo "  sh aios.sh full          # If language cache exists, use it; otherwise, prompt for language"
}

#########################################################################
# color: ANSI ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’ä½¿ã£ã¦è‰²ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°
#########################################################################
color() {
    local color_code
    color_code=$(color_code_map "$1")
    shift
    echo -e "${color_code}$*$(color_code_map "reset")"
}

#########################################################################
# color_code_map: ã‚«ãƒ©ãƒ¼åã‹ã‚‰ ANSI ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’è¿”ã™é–¢æ•°
#########################################################################
color_code_map() {
    local color="$1"
    case "$color" in
        "red") echo "\033[1;31m" ;;
        "green") echo "\033[1;32m" ;;
        "yellow") echo "\033[1;33m" ;;
        "blue") echo "\033[1;34m" ;;
        "magenta") echo "\033[1;35m" ;;
        "cyan") echo "\033[1;36m" ;;
        "white") echo "\033[1;37m" ;;
        "red_underline") echo "\033[4;31m" ;;
        "green_underline") echo "\033[4;32m" ;;
        "yellow_underline") echo "\033[4;33m" ;;
        "blue_underline") echo "\033[4;34m" ;;
        "magenta_underline") echo "\033[4;35m" ;;
        "cyan_underline") echo "\033[4;36m" ;;
        "white_underline") echo "\033[4;37m" ;;
        "red_white") echo "\033[1;41m" ;;
        "green_white") echo "\033[1;42m" ;;
        "yellow_white") echo "\033[1;43m" ;;
        "blue_white") echo "\033[1;44m" ;;
        "magenta_white") echo "\033[1;45m" ;;
        "cyan_white") echo "\033[1;46m" ;;
        "white_black") echo "\033[7;40m" ;;
        "reset") echo "\033[0;39m" ;;
        *) echo "\033[0;39m" ;;  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒªã‚»ãƒƒãƒˆ
    esac
}

#########################################################################
# check_openwrt: OpenWrtã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªãƒ»ç®¡ç†ã®ã¿ã‚’æ‹…å½“
#########################################################################
check_openwrt() {
    local version_file="${CACHE_DIR}/openwrt.ch"

    # **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ä½¿ç”¨**
    if [ -f "$version_file" ]; then
        CURRENT_VERSION=$(cat "$version_file")
    else
        local raw_version=""
        local distrib_id=""

        # **â‘  /etc/openwrt_release ã‹ã‚‰å–å¾—ï¼ˆæœ€å„ªå…ˆï¼‰**
        if [ -f "/etc/openwrt_release" ]; then
            distrib_id=$(awk -F"'" '/DISTRIB_ID/ {print $2}' /etc/openwrt_release)
            
            # **GL.iNet ã‚«ã‚¹ã‚¿ãƒ ç‰ˆã¯å¼¾ã**
            if [ "$distrib_id" != "OpenWrt" ]; then
                handle_error "Unsupported OpenWrt version: $distrib_id (Only OpenWrt is supported)"
                exit 1  # ğŸš¨ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ã‚’çµ‚äº†
            fi

            if grep -q "DISTRIB_RELEASE=" /etc/openwrt_release; then
                raw_version=$(awk -F"'" '/DISTRIB_RELEASE/ {print $2}' /etc/openwrt_release)
            fi
        fi

        # **â‘¡ /etc/openwrt_version ãŒå­˜åœ¨ã™ã‚Œã°ä½¿ç”¨**
        if [ -z "$raw_version" ] && [ -f "/etc/openwrt_version" ]; then
            raw_version=$(cat /etc/openwrt_version)
        fi

        # **â‘¢ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå–å¾—ã§ããªã‘ã‚Œã°ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ã‚’çµ‚äº†**
        if [ -z "$raw_version" ]; then
            handle_error "Could not determine OpenWrt version. Check system files."
            exit 1  # ğŸš¨ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ã‚’çµ‚äº†
        fi

        # **â‘£ ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨è¨˜ã®çµ±ä¸€**
        CURRENT_VERSION=$(echo "$raw_version" | tr '-' '.')

        # **â‘¤ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«æ›¸ãå‡ºã—**
        echo "$CURRENT_VERSION" > "$version_file"
        chmod 444 "$version_file"  # èª­ã¿å–ã‚Šå°‚ç”¨
    fi

    # **â‘¥ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ç¢ºèª**
    if grep -q "^$CURRENT_VERSION=" "${BASE_DIR}/openwrt.db"; then
        local db_entry=$(grep "^$CURRENT_VERSION=" "${BASE_DIR}/openwrt.db" | cut -d'=' -f2)
        PACKAGE_MANAGER=$(echo "$db_entry" | cut -d'|' -f1)
        VERSION_STATUS=$(echo "$db_entry" | cut -d'|' -f2)
        echo -e "$(color green "OpnWrt version: $CURRENT_VERSION is supported ($VERSION_STATUS)")"
    else
        handle_error "Unsupported OpenWrt version: $CURRENT_VERSION"
        exit 1  # ğŸš¨ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ã‚’çµ‚äº†
    fi
}

#########################################################################
# check_architecture: OpenWrtã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç¢ºèªãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥
#########################################################################
check_architecture() {
    local arch_file="${CACHE_DIR}/architecture.ch"

    # **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å†å–å¾—ã—ãªã„**
    if [ -f "$arch_file" ]; then
        arch=$(cat "$arch_file" | tr -d '\r')
        debug_log "DEBUG" "Using cached architecture: $arch"
        return 0
    fi

    # **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å–å¾—**
    local arch=$(uname -m)

    # **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åã®ã¿ï¼‰**
    echo "$arch" > "$arch_file"

    debug_log "DEBUG" "Architecture detected: $arch"
}

#########################################################################
# check_downloader: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆ¤å®šï¼ˆapk / opkg å¯¾å¿œï¼‰
#########################################################################
check_downloader() {
    if [ -f "${BASE_DIR}/downloader.ch" ]; then
        PACKAGE_MANAGER=$(cat "${CACHE_DIR}/downloader.ch")
    else
        if command -v apk >/dev/null 2>&1; then
            PACKAGE_MANAGER="apk"
        elif command -v opkg >/dev/null 2>&1; then
            PACKAGE_MANAGER="opkg"
        else 
            PACKAGE_MANAGER="opkg"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ã‚»ãƒƒãƒˆ
        fi
        echo "$PACKAGE_MANAGER" > "${CACHE_DIR}/downloader.ch"
    fi
    echo -e "$(color green "Package Manager: $PACKAGE_MANAGER is supported (stable)")"
}

#########################################################################
# Last Update: 2025-02-18 18:00:00 (JST) ğŸš€
# "Efficiency in retrieval, clarity in communication."
# get_message: ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹é–¢æ•°
#
# ã€è¦ä»¶ã€‘
# 1. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯**
#    - `$ACTIVE_LANGUAGE` ã‚’æœ€å„ªå…ˆã§ä½¿ç”¨ï¼ˆ`normalize_language()` ã§è¨­å®šï¼‰
#    - `$ACTIVE_LANGUAGE` ãŒæœªè¨­å®šã®å ´åˆã¯ `US` ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨
#
# 2. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œç´¢ã®é †åº**
#    â‘  `$ACTIVE_LANGUAGE|ã‚­ãƒ¼=` ã§ `messages.db` ã‚’æ¤œç´¢
#    â‘¡ `US|ã‚­ãƒ¼=` ã§ `messages.db` ã‚’æ¤œç´¢ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
#    â‘¢ ã©ã¡ã‚‰ã«ã‚‚è©²å½“ã—ãªã„å ´åˆã€`ã‚­ãƒ¼` ã‚’ãã®ã¾ã¾è¿”ã™
#
# 3. **å‹•ä½œã®æœ€é©åŒ–**
#    - `$ACTIVE_LANGUAGE` ã‚’ç›´æ¥å‚ç…§ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (`message.ch`) ã«ã¯ä¾å­˜ã—ãªã„
#    - `$quiet_flag` ã« `"quiet"` ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã€å‡ºåŠ›ã›ãšã« `return 0`
#
# 4. **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**
#    - è¨€èªå–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ `normalize_language()` ã«çµ±ä¸€ã—ã€è²¬å‹™ã‚’åˆ†é›¢
#    - `get_message()` ã¯ã€Œå–å¾—ã™ã‚‹ã ã‘ã€ã«ç‰¹åŒ–ã—ã€æ›¸ãè¾¼ã¿ãƒ»è¨­å®šã¯è¡Œã‚ãªã„
#
# 5. **å½±éŸ¿ç¯„å›²**
#    - `common.sh` å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—å…¨èˆ¬ï¼ˆ`debug_log()` å«ã‚€ï¼‰
#    - `messages.db` ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›´æ™‚ã‚‚ `get_message()` ã®ä¿®æ­£ã¯ä¸è¦
#########################################################################
get_message() {
    local key="$1"
    local quiet_flag="$2"
    local message_db="${BASE_DIR}/messages.db"
    local lang="${ACTIVE_LANGUAGE:-US}"  # `ACTIVE_LANGUAGE` ãŒæœªè¨­å®šãªã‚‰ `US`

    # `messages.db` ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ã‚­ãƒ¼ãã®ã¾ã¾ã‚’è¿”ã™
    if [ ! -f "$message_db" ]; then
        debug_log "DEBUG" "messages.db not found. Returning key as message."
        message="$key"
    else
        # **è¨€èªå„ªå…ˆæ¤œç´¢**
        message=$(grep "^${lang}|${key}=" "$message_db" | cut -d'=' -f2-)

        # **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢**
        if [ -z "$message" ]; then
            message=$(grep "^US|${key}=" "$message_db" | cut -d'=' -f2-)
        fi

        # **ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã€ã‚­ãƒ¼ãã®ã¾ã¾ã‚’è¿”ã™**
        if [ -z "$message" ]; then
            debug_log "DEBUG" "Message key '$key' not found in messages.db."
            message="$key"
        fi
    fi

    # **quiet ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ**
    if [ "$quiet_flag" = "quiet" ]; then
        return 0
    else
        echo "$message"
    fi
}

# ğŸ”µã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# Last Update: 2025-02-18 23:00:00 (JST) ğŸš€
# "Standardizing version formatting for consistency."
#
# ã€è¦ä»¶ã€‘
# 1. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’çµ±ä¸€**
#    - `YYYY.MM.DD-è‡ªç”±å½¢å¼`
#    - `YYYYMMDDHHMMSS-è‡ªç”±å½¢å¼`
#    - è¨±å¯ã•ã‚Œã‚‹åŒºåˆ‡ã‚Šæ–‡å­—: `- . , ; : ç©ºç™½`
#
# 2. **å‡¦ç†å†…å®¹**
#    - **è¨±å¯ã•ã‚ŒãŸæ–‡å­—ã®ã¿ã‚’æŠ½å‡º**
#    - **å…ˆé ­ã®ã‚¼ãƒ­ã‚’å‰Šé™¤ï¼ˆä¾‹: `02` â†’ `2`ï¼‰**
#    - **å‰å¾Œã®ä½™è¨ˆãªã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤**
#
# 3. **é©ç”¨å¯¾è±¡**
#    - **`download()`**: **ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å–å¾—ãƒ»æ¯”è¼ƒ**
#    - **`compare_versions()`**: **ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆçµ±ä¸€**
#
# 4. **é©ç”¨ã—ãªã„å¯¾è±¡**
#    - **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®è§£é‡ˆã‚’å¤‰æ›´ã—ãªã„ï¼ˆé †ç•ªã®å…¥ã‚Œæ›¿ãˆã¯ã—ãªã„ï¼‰**
#    - **æ—¥ä»˜ä»¥å¤–ã®æ–‡å­—åˆ—ã¯å‰Šé™¤ã›ãšã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ¨™æº–åŒ–ã®ã¿è¡Œã†**
#
# 5. **ä¾å­˜é–¢ä¿‚**
#    - `normalize_input()` ã‚’ä½¿ç”¨ã—ã€iconv ã«ã‚ˆã‚‹å‡¦ç†ã‚’çµ±ä¸€
#
# 6. **å½±éŸ¿ç¯„å›²**
#    - `common.sh` ã«çµ±åˆã—ã€`download()` & `compare_versions()` ã§ä½¿ç”¨
#########################################################################
# Last Update: 2025-03-04 12:45:00 (JST) ğŸš€
# "Efficient downloading with precise versioning and silent modes."
#
# ã€è¦ä»¶ã€‘
# 1. BASE_WGET ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚
# 2. hidden ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
#    - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®æˆå¦ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹ãŒã€æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯å‡ºåŠ›ã‚’æŠ‘åˆ¶ã™ã‚‹ã€‚
# 3. quiet ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
#    - check_option() ã§è¨­å®šã•ã‚ŒãŸ QUIET_MODE ã«å¾“ã„ã€ã™ã¹ã¦ã®ãƒ­ã‚°ã‚’æŠ‘åˆ¶ã™ã‚‹ã€‚
# 4. chmod ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
#    - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã«å®Ÿè¡Œæ¨©é™ (chmod +x) ã‚’ä»˜ä¸ã™ã‚‹ã€‚
# 5. read ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
#    - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆsourceï¼‰ã™ã‚‹ã€‚ï¼ˆãŸã ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«åãŒ *common*.sh ã«ä¸€è‡´ã™ã‚‹å ´åˆã¯è‡ªå‹•ã§èª­ã¿è¾¼ã‚€ï¼‰
#    - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯èª­ã¿è¾¼ã¾ãªã„ã€‚
# 6. å¼•æ•°ã®é †åºã¯è‡ªç”±ï¼ˆhidden, quiet, chmod, read ã®é †ç•ªã¯ä»»æ„ï¼‰ã€‚
# 7. wget ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¡Œã„ã€å¤±æ•—æ™‚ã®è©³ç´°ã‚’ debug_log() ã«è¨˜éŒ²ã™ã‚‹ã€‚
# 8. å½±éŸ¿ç¯„å›²: common.sh ã® download() ã®ã¿ï¼ˆä»–ã®é–¢æ•°ã«ã¯å½±éŸ¿ãªã—ï¼‰ã€‚
#########################################################################
# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°
normalize_version() {
    input="$1"
    input=$(echo "$input" | sed 's/[^0-9A-Za-z._-]//g')
    input=$(echo "$input" | tr -d '\n' | sed 's/ *$//')
    input=$(echo "$input" | sed -E 's/(^|[._-])0+([0-9])/\1\2/g')
    input=$(echo "$input" | sed 's/[._-]\{1,1\}/./g')
    echo "$input"
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã—ã€æ­£è¦åŒ–ã™ã‚‹é–¢æ•°
get_script_version() {
    local script_file="$1"
    local script_db="${CACHE_DIR}/script.ch"

    if [ -z "$script_file" ] || [ ! -f "$script_file" ]; then
        debug_log "ERROR" "Script file not found: $script_file"
        echo "Error: Script file not found: $script_file" >&2
        return 1
    fi

    local version=""
    version=$(grep -Eo 'SCRIPT_VERSION=["'"'"'][0-9]{4}[-.][0-9]{2}[-.][0-9]{2}[-.0-9]*["'"'"']' "$script_file" | cut -d'=' -f2 | tr -d '"')
    version=$(normalize_version "$version")
    if [ -z "$version" ]; then
        debug_log "ERROR" "Could not extract SCRIPT_VERSION from $script_file"
        echo "Error: Could not extract SCRIPT_VERSION from $script_file" >&2
        return 1
    fi

    echo "$version"
}

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸ã—ãŸå¾Œã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
download() {
    local hidden_mode="false"
    local quiet_mode="${QUIET_MODE:-false}"
    local chmod_mode="false"
    local read_mode="false"
    local file_name=""
    local local_version=""
    local remote_version=""
    local script_db="${CACHE_DIR}/script.ch"
    local dummy_version="2025.01.01-00-00"

    while [ "$#" -gt 0 ]; do
        case "$1" in
            hidden) hidden_mode="true" ;;
            quiet) quiet_mode="true" ;;
            debug) DEBUG_MODE="true" ;;
            chmod) chmod_mode="true" ;;
            read) read_mode="true" ;;
            *) file_name="$1" ;;
        esac
        shift
    done

    local install_path="${BASE_DIR}/${file_name}"
    local remote_url="${BASE_URL}/${file_name}"

    if [ ! -f "$script_db" ]; then
        touch "$script_db"
    fi

    remote_version=$(wget -qO- "$remote_url" | grep -Eo 'SCRIPT_VERSION=["'"'"'][0-9]{4}[-.][0-9]{2}[-.][0-9]{2}[-.0-9]*["'"'"']' | cut -d'=' -f2 | tr -d '"')
    remote_version=$(normalize_version "$remote_version")
    if [ -z "$remote_version" ]; then
        remote_version="$dummy_version"
    fi

    if grep -q "^${file_name}=" "$script_db"; then
        local_version=$(grep "^${file_name}=" "$script_db" | cut -d'=' -f2)
        local_version=$(normalize_version "$local_version")
    fi

    if [ -z "$local_version" ] || [ "$local_version" != "$remote_version" ]; then
        if ! $BASE_WGET "$install_path" "$remote_url"; then
            debug_log "ERROR" "Download failed: $file_name"
            echo "Error: Download failed: $file_name" >&2
            return 1
        fi

        if [ ! -s "$install_path" ]; then
            debug_log "ERROR" "Download failed: $file_name is empty"
            echo "Error: Download failed: $file_name is empty." >&2
            return 1
        fi

        debug_log "DEBUG" "Download completed: $file_name - Version: $remote_version"
        echo "$(color green "Download completed: $file_name - Version: $remote_version")"

        if [ "$chmod_mode" = "true" ]; then
            chmod +x "$install_path"
            debug_log "DEBUG" "chmod +x applied to $file_name"
        fi

        if grep -q "^${file_name}=" "$script_db"; then
            sed -i "s|^${file_name}=.*|${file_name}=${remote_version}|" "$script_db"
        else
            echo "${file_name}=${remote_version}" >> "$script_db"
        fi
    else
        if [ "$quiet_mode" != "true" ]; then
            debug_log "DEBUG" "$file_name is already up-to-date. (Version: $local_version)"
            echo "$(color green "$file_name is already up-to-date. (Version: $local_version)")"
        fi
    fi

    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿
    if [ -f "$install_path" ]; then
        . "$install_path"
        debug_log "DEBUG" "Sourced: $install_path"
    else
        debug_log "ERROR" "File not found for sourcing: $install_path"
    fi
}

# ğŸ”´ã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´ã€€-------------------------------------------------------------------------------------------------------------------------------------------

#########################################################################
# country_DEBUG: é¸æŠã•ã‚ŒãŸå›½ã¨è¨€èªã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
#########################################################################
country_DEBUG() {
    local country_DEBUG_file="${BASE_DIR}/country.ch"
    local selected_language_code=$(cat "${BASE_DIR}/check_country")
    if [ -f "$country_DEBUG_file" ]; then
        grep -w "$selected_language_code" "$country_DEBUG_file"
    else
        printf "%s\n" "$(color red "Country DEBUGrmation not found.")"
    fi
}

#########################################################################
# handle_exit: æ­£å¸¸çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
#########################################################################
handle_exit() {
    local message="$1"
    color yellow "$message"
    exit 0
}

# ğŸ”µã€€ãƒ¡ã‚¤ãƒ³ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# åˆæœŸè¨­å®š
#########################################################################
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
check_version() {
    echo "$(color green "Download completed: $(basename "$0") - Version: $SCRIPT_VERSION")"
}

# æ¨©é™è¨­å®š
chmod_aios() {
    chmod +x "$BIN_PATH"
}

# åˆæœŸåŒ–å‡¦ç†
delete_aios() {
    rm -rf "${BASE_DIR}"
}

# å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
make_directory() {
    mkdir -p "$BASE_DIR" "$CACHE_DIR" "$LOG_DIR" "$FEED_DIR"
}

# åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
initialization() {
#    check_version
    chmod_aios
    delete_aios
    make_directory
}

#########################################################################
# ãƒãƒŠãƒ¼è¡¨ç¤º
#########################################################################
print_banner() {
    echo
    color magenta "                    ii i"
    color blue    "         aaaa      iii       oooo      sssss"
    color cyan    "            aa      ii      oo  oo    ss"
    color green   "         aaaaa      ii      oo  oo     sssss"
    color yellow  "        aa  aa      ii      oo  oo         ss"
    color red     "         aaaaa     iiii      oooo     ssssss"
    echo
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_DECCRIPTION")")"
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_NAME")")"
    printf "%s\n" "$(color red "$(get_message "MSG_BANNER_DISCLAIMER")")"
}

#########################################################################
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
#########################################################################
packages() {
    # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    #install_package luci yn hidden
    install_package ttyd yn hidden
    install_package luci-app-ttyd yn hidden
    install_package luci-i18n-ttyd yn hidden
    install_package openssh-sftp-server yn hidden
    install_package luci-mod-dashboard yn hidden
    #install_package coreutils yn hidden
    install_package irqbalance yn hidden

    feed_package gSpotx2f packages-openwrt current luci-app-cpu-perf yn hidden
    feed_package gSpotx2f packages-openwrt current luci-app-cpu-status yn hidden
    feed_package gSpotx2f packages-openwrt current luci-app-temp-status yn hidden
    feed_package gSpotx2f packages-openwrt current luci-app-log-viewer yn hidden
    feed_package gSpotx2f packages-openwrt current luci-app-log yn hidden
    feed_package gSpotx2f packages-openwrt current internet-detector yn hidden disabled

    feed_package "lisaac" "luci-app-diskman" "current" "luci-app-diskman" "yn" "hidden" "disabled"

    feed_package "jerrykuku" "luci-theme-argon" "themes" "luci-theme-argon" "yn" "hidden"

    # install_package list
}

#########################################################################
# Last Update: 2025-02-15 10:00:00 (JST) ğŸš€
# check_option: ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æãƒ»æ­£è¦åŒ–é–¢æ•°
#
# ã€æ¦‚è¦ã€‘
# ã“ã®é–¢æ•°ã¯ã€aios èµ·å‹•æ™‚ã«æ¸¡ã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’è§£æã—ã€
# ãƒ€ãƒƒã‚·ãƒ¥ä»˜ãã®å¼•æ•°ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦è§£æã€éãƒ€ãƒƒã‚·ãƒ¥å¼•æ•°ã¯ã™ã¹ã¦
# è¨€èªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ‰±ã„ã€æœ€åˆã«è¦‹ã¤ã‹ã£ãŸå€¤ã‚’ SELECTED_LANGUAGE ã«è¨­å®šã—ã¾ã™ã€‚
#
# â€» MODE ã®æŒ‡å®šã¯å¿…ãšãƒ€ãƒƒã‚·ãƒ¥ä»˜ãã§è¡Œã„ã€ä»¥ä¸‹ã®å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å—ã‘ä»˜ã‘ã¾ã™ã€‚
#     common_full  : -cf, --cf, -common_full, --common_full  â†’ MODE="full"
#     common_light : -cl, --cl, -ocommon_light, --ocommon_light â†’ MODE="light"
#     common_debug : -cd, --cd, -common_debug, --common_debug, --ocommon_debug â†’ MODE="debug"
#     reset        : -r, --r, -reset, --reset, -resrt, --resrt â†’ MODE="reset" ãŠã‚ˆã³ RESET="true"
#
# ã€å¯¾å¿œã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‘
#  - ãƒ˜ãƒ«ãƒ—:         -h, --h, -help, --help, -?, --?  
#  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³:     -v, --v, -version, --version  
#  - ãƒ‡ãƒãƒƒã‚°:       -d, --d, -debug, --debug, -d1, --d1  
#                     â†’ DEBUG_MODE="true", DEBUG_LEVEL="DEBUG"
#                   -d2, --d2, -debug2, --debug2  
#                     â†’ DEBUG_MODE="true", DEBUG_LEVEL="DEBUG2"
#  - ãƒ¢ãƒ¼ãƒ‰æŒ‡å®š:
#       - full:       -cf, --cf, -common_full, --common_full  â†’ MODE="full"
#       - light:      -cl, --cl, -ocommon_light, --ocommon_light â†’ MODE="light"
#       - debug:      -cd, --cd, -common_debug, --common_debug, --ocommon_debug â†’ MODE="debug"
#       - reset:      -r, --r, -reset, --reset, -resrt, --resrt â†’ MODE="reset", RESET="true"
#  - å¼·åˆ¶å®Ÿè¡Œ:       -f, --f, -force, --force  â†’ FORCE="true"
#  - ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³:     -dr, --dr, -dry-run, --dry-run  â†’ DRY_RUN="true"
#  - ãƒ­ã‚°å‡ºåŠ›å…ˆ:     -l, --l, -logfile, --logfile <path>  â†’ LOGFILE ã«æŒ‡å®šãƒ‘ã‚¹
#
# ã€ä»•æ§˜ã€‘
# 1. ãƒ€ãƒƒã‚·ãƒ¥ä»˜ãã®å¼•æ•°ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦è§£æã—ã€éãƒ€ãƒƒã‚·ãƒ¥å¼•æ•°ã¯ã™ã¹ã¦ SELECTED_LANGUAGE ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚
# 2. è§£æçµæœã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° SELECTED_LANGUAGE, DEBUG_MODE, DEBUG_LEVEL, MODE, DRY_RUN, LOGFILE, FORCE, RESET, HELP ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã€
#    å¾Œç¶šã® check_common(), select_country(), debug(), script_version() ãªã©ã«æ­£è¦åŒ–ã•ã‚ŒãŸå€¤ã¨ã—ã¦æ¸¡ã•ã‚Œã¾ã™ã€‚
#
# ã€ä½¿ç”¨ä¾‹ã€‘
#   sh aios.sh -d --dry-run --reset -l /var/log/aios.log -f -cf en
#    â†’ è¨€èª "en" ãŒ SELECTED_LANGUAGE ã«è¨­å®šã•ã‚Œã€MODE ã¯ "full"ï¼ˆ-cfç­‰ã§æŒ‡å®šï¼‰ã€ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ã€
#       ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒªã‚»ãƒƒãƒˆã€ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã€ãƒ­ã‚°å‡ºåŠ›å…ˆ /var/log/aios.logã€å¼·åˆ¶å®Ÿè¡ŒãŒæœ‰åŠ¹ã«ãªã‚‹ã€‚
#########################################################################
check_option() {
    debug_log DEBUG "check_option received before args: $*"

    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
    SELECTED_LANGUAGE=""
    MODE="full"
    DEBUG_MODE="false"
    DEBUG_LEVEL="INFO"
    DRY_RUN="false"
    LOGFILE=""
    FORCE="false"
    RESET="false"
    HELP="false"

    # è¨€èªãŠã‚ˆã³ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã®å‡¦ç†
    while [ "$#" -gt 0 ]; do
        case "$1" in
            -h|--h|-help|--help|-\?|--\?)
                HELP="true"
                print_help
                exit 0
                ;;
            -v|--v|-version|--version)
                script_version
                exit 0
                ;;
            -d|--d|-debug|--debug|-d1|--d1)
                DEBUG_MODE="true"
                DEBUG_LEVEL="DEBUG"
                ;;
            -d2|--d2|-debug2|--debug2)
                DEBUG_MODE="true"
                DEBUG_LEVEL="DEBUG2"
                ;;
            -cf|--cf|-common_full|--common_full)
                MODE="full"
                ;;
            -cl|--cl|-ocommon_light|--ocommon_light)
                MODE="light"
                ;;
            -cd|--cd|-common_debug|--common_debug|--ocommon_debug)
                MODE="debug"
                ;;
            -r|--r|-reset|--reset|-resrt|--resrt)
                MODE="reset"
                RESET="true"
                ;;
            -f|--f|-force|--force)
                FORCE="true"
                ;;
            -dr|--dr|-dry-run|--dry-run)
                DRY_RUN="true"
                ;;
            -l|--l|-logfile|--logfile)
                if [ -n "$2" ] && [ "${2#-}" != "$2" ]; then
                    LOGFILE="$2"
                    shift
                else
                    echo "Error: --logfile requires a path argument"
                    exit 1
                fi
                ;;
            -*)
                echo "Warning: Unknown option: $1" >&2
                ;;
            *)
                if [ -z "$SELECTED_LANGUAGE" ]; then
                    SELECTED_LANGUAGE="$1"
                fi
                ;;
        esac
        shift
    done

    # ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
    export SELECTED_LANGUAGE DEBUG_MODE DEBUG_LEVEL MODE DRY_RUN LOGFILE FORCE RESET HELP

    # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
    debug_log DEBUG "check_option: SELECTED_LANGUAGE='$SELECTED_LANGUAGE', MODE='$MODE', DEBUG_MODE='$DEBUG_MODE', DEBUG_LEVEL='$DEBUG_LEVEL', DRY_RUN='$DRY_RUN', LOGFILE='$LOGFILE', FORCE='$FORCE', RESET='$RESET', HELP='$HELP'"

    # è¨­å®šã•ã‚ŒãŸè¨€èªã‚’ `check_common()` ã«æ¸¡ã™
    check_common "$SELECTED_LANGUAGE"
}

#########################################################################
# Last Update: 2025-02-16 21:45:00 (JST) ğŸš€
# "Ensuring seamless updates, one script at a time."
#
# ã€è¦ä»¶ã€‘
# 1. `download_script()` ã‚’ `download()` ã«çµ±åˆã—ã€ä¸€è²«æ€§ã‚’ç¢ºä¿ã™ã‚‹ã€‚
# 2. `debug_log()` ã‚’å¼·åŒ–ã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰çŠ¶æ³ã‚’è©³ç´°ã«è¨˜éŒ²ã€‚
# 3. `download()` ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¦‹ç›´ã—ã€å¤±æ•—æ™‚ã®æŒ™å‹•ã‚’æ”¹å–„ã€‚
# 4. `openwrt.db`, `messages.db`, `country.db`, `packages.db` ã‚’é©åˆ‡ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚
# 5. å½±éŸ¿ç¯„å›²: `common.sh`ï¼ˆçŸ›ç›¾ãªãé©ç”¨ï¼‰ã€‚
#########################################################################
check_common() {
    local lang_code="$1"
    local mode="${2:-full}" 
 
    # ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®å‡¦ç†
    case "$mode" in
        reset)
            rm -f "${CACHE_DIR}/country.ch" \
                  "${CACHE_DIR}/language.ch" \
                  "${CACHE_DIR}/luci.ch" \
                  "${CACHE_DIR}/zone.ch" \
                  "${CACHE_DIR}/zonename.ch" \
                  "${CACHE_DIR}/timezone.ch" \
                  "${CACHE_DIR}/country_success_done" \
                  "${CACHE_DIR}/timezone_success_done"
            echo "$(get_message "MSG_RESET_COMPLETE")"
            exit 0
            ;;
        full)
            initialization
            download "hidden" "aios" "chmod" "read"
            download "hidden" "common-country.sh" "chmod"
            download "hidden" "common-package.sh" "chmod"
            download "hidden" "common-feed-package.sh" "chmod"
            download "hidden" "messages.db"
            download "hidden" "openwrt.db"
            download "hidden" "country.db"
            download "hidden" "local-package.db"
            download "hidden" "custom-package.db"
            check_openwrt
            check_architecture
            check_downloader
            print_banner
            select_country "$lang_code"
            packages
            ;;
        light|debug)
            initialization
            download "aios" "chmod" "read"
            download "common-country.sh"
            download "common-package.sh"
            download "common-feed-package.sh"
            download "messages.db"
            download "openwrt.db"
            download "country.db"
            download "local-package.db"
            download "custom-package.db"
            check_openwrt
            check_architecture
            check_downloader
            print_banner
            select_country "$lang_code"
            packages
            ;;
        return)
            rm -f "${CACHE_DIR}/country.ch" \
                  "${CACHE_DIR}/language.ch" \
                  "${CACHE_DIR}/luci.ch" \
                  "${CACHE_DIR}/zone.ch" \
                  "${CACHE_DIR}/zonename.ch" \
                  "${CACHE_DIR}/timezone.ch" \
                  "${CACHE_DIR}/country_success_done" \
                  "${CACHE_DIR}/timezone_success_done"
            select_country
            ;;
        *)
            ;;
    esac
}

# ğŸ”´ã€€ãƒ¡ã‚¤ãƒ³ã€€ã“ã“ã¾ã§ã€€ğŸ”´ã€€-------------------------------------------------------------------------------------------------------------------------------------------

check_option "$@"
