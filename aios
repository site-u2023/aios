#!/bin/sh
# =========================================================
# ğŸ“Œ OpenWrt / Alpine Linux POSIX-Compliant Shell Script
# ğŸš€ Last Update: 2025-02-21
#
# ğŸ·ï¸ License: CC0 (Public Domain)
# ğŸ¯ Compatibility: OpenWrt >= 19.07 (Tested on 24.10.0)
#
# âš ï¸ IMPORTANT NOTICE:
# OpenWrt OS exclusively uses **Almquist Shell (ash)** and
# is **NOT** compatible with Bourne-Again Shell (bash).
#
# ğŸ“¢ POSIX Compliance Guidelines:
# âœ… Use `[` instead of `[[` for conditions
# âœ… Use `$(command)` instead of backticks `` `command` ``
# âœ… Use `$(( ))` for arithmetic instead of `let`
# âœ… Define functions as `func_name() {}` (no `function` keyword)
# âœ… No associative arrays (`declare -A` is NOT supported)
# âœ… No here-strings (`<<<` is NOT supported)
# âœ… No `-v` flag in `test` or `[[`
#
# ğŸ› ï¸ Keep it simple, POSIX-compliant, and lightweight for OpenWrt!
# =========================================================
# aios (ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ)

SCRIPT_VERSION="2025.02.21-00-03"
echo -e "\033[7;40mUpdated to version $SCRIPT_VERSION aios \033[0m"

DEV_NULL="${DEV_NULL:-on}"
BASE_WGET="${BASE_WGET:-wget -q -O}"
BIN_PATH="/usr/bin/aios"

BASE_URL="${BASE_URL:-https://raw.githubusercontent.com/site-u2023/aios/main}"
BASE_DIR="${BASE_DIR:-/tmp/aios}"

COMMON_SH="$BASE_DIR/common.sh"
CACHE_DIR="${CACHE_DIR:-$BASE_DIR/cache}"
LOG_DIR="${LOG_DIR:-$BASE_DIR/logs}"
DEBUG_MODE="${DEBUG_MODE:-false}"

# æ¨©é™è¨­å®š
chmod_aios() {
    chmod +x "$BIN_PATH"
}

# åˆæœŸåŒ–å‡¦ç†
delete_aios() {
    rm -rf "${BASE_DIR}"
}

# å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
make_directory() {
    mkdir -p "$BASE_DIR" "$CACHE_DIR" "$LOG_DIR"
}

# `common.sh` ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ & èª­ã¿è¾¼ã¿
download_common() {
    if [ ! -f "${BASE_DIR}/common.sh" ]; then
        ${BASE_WGET} "${BASE_DIR}/common.sh" "${BASE_URL}/common.sh" || {
            echo "Failed to download common.sh"
            exit 1
        }
    fi
    source "${BASE_DIR}/common.sh" || {
        echo "Failed to source common.sh"
        exit 1
    }
}

# ãƒãƒŠãƒ¼è¡¨ç¤º
print_banner() {
    echo
    color magenta "                    ii i"
    color blue    "         aaaa      iii       oooo      sssss"
    color cyan    "            aa      ii      oo  oo    ss"
    color green   "         aaaaa      ii      oo  oo     sssss"
    color yellow  "        aa  aa      ii      oo  oo         ss"
    color red     "         aaaaa     iiii      oooo     ssssss"
    echo

    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_DECCRIPTION")")"
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_NAME")")"
    printf "%s\n" "$(color red "$(get_message "MSG_BANNER_DISCLAIMER")")"
}

print_banner_matrix() {
    clear
    local banner_text="
                    ii i
         aaaa      iii       oooo      sssss
            aa      ii      oo  oo    ss
         aaaaa      ii      oo  oo     sssss
        aa  aa      ii      oo  oo         ss
         aaaaa     iiii      oooo     ssssss
    "
    
    local delay=0.05  # æ–‡å­—ãŒè½ã¡ã‚‹é€Ÿåº¦
    local i=0

    echo "$banner_text" | while IFS= read -r line; do
        tput cup $(expr $i + 3) 10  # ç”»é¢ã®é©å½“ãªä½ç½®ã‹ã‚‰é–‹å§‹
        echo -e "$(color green "$line")"
        sleep $delay
        i=$(expr $i + 1)
    done

    echo
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_DECCRIPTION")")"
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_NAME")")"
    printf "%s\n" "$(color red "$(get_message "MSG_BANNER_DISCLAIMER")")"
}

print_banner_wave() {
    clear
    local banner_text="
                    ii i
         aaaa      iii       oooo      sssss
            aa      ii      oo  oo    ss
         aaaaa      ii      oo  oo     sssss
        aa  aa      ii      oo  oo         ss
         aaaaa     iiii      oooo     ssssss
    "

    local delay=0.07  # æºã‚Œã‚‹ã‚¹ãƒ”ãƒ¼ãƒ‰
    local wave=0

    while [ "$wave" -lt 3 ]; do  # 3å›æºã‚‰ã™
        clear
        local i=0
        local offset=$(expr \( "$wave" % 2 \) \* 2)  # å¶æ•°å›ã¯å³ã€å¥‡æ•°å›ã¯å·¦ã«ã‚ºãƒ©ã™

        echo "$banner_text" | while IFS= read -r line; do
            tput cup $(expr "$i" + 3) $(expr 10 + "$offset")
            echo "$(color blue "$line")"
            i=$(expr "$i" + 1)
        done

        sleep $delay
        wave=$(expr "$wave" + 1)
    done

    echo
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_DECCRIPTION")")"
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_NAME")")"
    printf "%s\n" "$(color red "$(get_message "MSG_BANNER_DISCLAIMER")")"
}


print_banner_fadein() {
    local banner_text=(
        "                    ii i"
        "         aaaa      iii       oooo      sssss"
        "            aa      ii      oo  oo    ss"
        "         aaaaa      ii      oo  oo     sssss"
        "        aa  aa      ii      oo  oo         ss"
        "         aaaaa     iiii      oooo     ssssss"
    )
    
    local delay=0.1  # ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã®é–“éš”

    for ((i = 0; i < ${#banner_text[@]}; i++)); do
        sleep $delay
        echo -e "$(color cyan "${banner_text[$i]}")"
    done

    echo
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_DECCRIPTION")")"
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_NAME")")"
    printf "%s\n" "$(color red "$(get_message "MSG_BANNER_DISCLAIMER")")"
}

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
packages() {
    # uconv ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    install_build build_uconv yn

    # ä»–ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    install_package luci-app-cpu-status custom1 yn
    install_package ttyd custom test yn hidden
    install_package luci-app-ttyd yn hidden test
    install_package test openssh-sftp-server yn hidden
    install_package update
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
chmod_aios
delete_aios
make_directory
download_common
check_option "$@"
print_banner
print_banner_matrix
print_banner_wave
print_banner_fadein
packages
# download openwrt-config.sh
