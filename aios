#!/bin/sh

SCRIPT_VERSION="2025.03.12-18-00"

# =========================================================
# ğŸ“Œ OpenWrt / Alpine Linux POSIX-Compliant Shell Script
# ğŸš€ Last Update: 2025-02-21
#
# ğŸ·ï¸ License: CC0 (Public Domain)
# ğŸ¯ Compatibility: OpenWrt >= 19.07 (Tested on 24.10.0)
#
# âš ï¸ IMPORTANT NOTICE:
# OpenWrt OS exclusively uses **Almquist Shell (ash)** and
# is **NOT** compatible with Bourne-Again Shell (bash).
#
# ğŸ“¢ POSIX Compliance Guidelines:
# âœ… Use `[` instead of `[[` for conditions
# âœ… Use $(command) instead of backticks `command`
# âœ… Use $(( )) for arithmetic instead of let
# âœ… Define functions as func_name() {} (no function keyword)
# âœ… No associative arrays (declare -A is NOT supported)
# âœ… No here-strings (<<< is NOT supported)
# âœ… No -v flag in test or [[
# âœ… Avoid bash-specific string operations like ${var:0:3}
# âœ… Avoid arrays entirely when possible (even indexed arrays can be problematic)
# âœ… Use printf followed by read instead of read -p
# âœ… Use printf instead of echo -e for portable formatting
# âœ… Avoid process substitution <() and >()
# âœ… Prefer case statements over complex if/elif chains
# âœ… Use command -v instead of which or type for command existence checks
# âœ… Keep scripts modular with small, focused functions
# âœ… Use simple error handling instead of complex traps
# âœ… Test scripts with ash/dash explicitly, not just bash
#
# ğŸ› ï¸ Keep it simple, POSIX-compliant, and lightweight for OpenWrt!
### =========================================================
### ğŸ“Œ AI Assistance Request: POSIX-Compliant Debugging Guide
### 
### When debugging or fixing errors in this POSIX shell script:
### 
### 1ï¸âƒ£ Create a minimal reproducible test case (avoid bash features)
### 2ï¸âƒ£ Test with ash/dash explicitly: dash ./test.sh
### 3ï¸âƒ£ Use portable debugging methods: echo, printf, or set -x
### 4ï¸âƒ£ Validate fixes against all POSIX compliance guidelines
### 5ï¸âƒ£ Ensure the solution works in resource-constrained OpenWrt
### 
### âš ï¸ IMPORTANT:
### - Avoid suggesting bash-specific solutions
### - Always test fixes with ash/dash before implementation
### - Prefer simple solutions over complex ones
### - Do not modify production code without test verification
### 
### ğŸ› ï¸ Keep debugging simple, focused, and POSIX-compliant!
### =========================================================

DEV_NULL="${DEV_NULL:-on}"
# ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰
# export DEV_NULL="on"
# é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
# unset DEV_NULL

# åŸºæœ¬å®šæ•°ã®è¨­å®š 
BASE_WGET="${BASE_WGET:-wget --no-check-certificate -q -O}"
# BASE_WGET="${BASE_WGET:-wget -O}"
DEBUG_MODE="${DEBUG_MODE:-false}"
BIN_PATH=$(readlink -f "$0")
BIN_DIR="$(dirname "$BIN_PATH")"
BIN_FILE="$(basename "$BIN_PATH")"
BASE_URL="${BASE_URL:-https://raw.githubusercontent.com/site-u2023/aios/main}"
BASE_DIR="${BASE_DIR:-/tmp/aios}"
CACHE_DIR="${CACHE_DIR:-$BASE_DIR/cache}"
FEED_DIR="${FEED_DIR:-$BASE_DIR/feed}"
LOG_DIR="${LOG_DIR:-$BASE_DIR/logs}"
UPDATE_CACHE="${CACHE_DIR}/update.ch"
GITHUB_TOKEN_FILE="/etc/aios_token"

# ğŸ”µã€€ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ»ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µ-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# Last Update: 2025-02-16 16:00:00 (JST) ğŸš€
# "Clarity in errors, precision in handling. Every function must be robust."
#
# ã€è¦ä»¶ã€‘
# 1. ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ `messages.db` ã§ç®¡ç†ã—ã€å¤šè¨€èªå¯¾å¿œã™ã‚‹ã€‚
# 2. `debug_log("ERROR", message)` ã‚‚ `messages.db` ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
# 3. `{file}`, `{version}` ãªã©ã®å¤‰æ•°ã‚’å‹•çš„ã«ç½®æ›ã€‚
# 4. å½±éŸ¿ç¯„å›²: `aios` & `common.sh`ï¼ˆçŸ›ç›¾ãªãé©ç”¨ï¼‰ã€‚
#########################################################################
handle_error() {
    local error_key="$1"
    local file="$2"
    local version="$3"
    local exit_required="${4:-no}"

    local error_message
    error_message=$(get_message "$error_key")

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if [ -z "$error_message" ]; then
        error_message="Unknown error occurred. Key: $error_key"
    fi

    # å¤‰æ•°ã‚’ç½®æ›
    error_message=$(echo "$error_message" | sed -e "s/{file}/$file/g" -e "s/{version}/$version/g")

    # ãƒ­ã‚°è¨˜éŒ² & è¡¨ç¤º
    debug_log "ERROR" "$error_message"
    echo -e "$(color red "$error_message")"

    if [ "$exit_required" = "yes" ]; then
        debug_log "ERROR" "Critical error occurred, exiting: $error_message"
        exit 1
    else
        debug_log "DEBUG" "Non-critical error: $error_message"
        return 1
    fi
}

#########################################################################
# Last Update: 2025-02-16 16:10:00 (JST) ğŸš€
# "Logging with clarity, debugging with precision."
#
# ã€è¦ä»¶ã€‘
# 1. ã™ã¹ã¦ã®ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ `messages.db` ã§ç®¡ç†ã—ã€å¤šè¨€èªå¯¾å¿œã™ã‚‹ã€‚
# 2. `{file}`, `{version}` ãªã©ã®å¤‰æ•°ã‚’ `sed` ã§å‹•çš„ã«ç½®æ›ã™ã‚‹ã€‚
# 3. `DEBUG_MODE` ã®è¨­å®šã«å¿œã˜ã¦ `DEBUG`, `INFO`, `WARN`, `ERROR` ã‚’ç®¡ç†ã™ã‚‹ã€‚
# 4. å½±éŸ¿ç¯„å›²: `aios` & `common.sh`ï¼ˆçŸ›ç›¾ãªãé©ç”¨ï¼‰ã€‚
#########################################################################
# ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
debug_log() {
    local level="$1"
    local message="$2"
    local file="$3"
    local version="$4"

    # `$1` ã«ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ `DEBUG` ã«ã™ã‚‹
    case "$level" in
        "DEBUG"|"INFO"|"WARN"|"ERROR") ;;  # ä½•ã‚‚ã—ãªã„ (æ­£ã—ã„ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«)
        "")
            level="DEBUG"
            message="$1"
            file="$2"
            version="$3"
            ;;
        *)
            message="$1"
            file="$2"
            version="$3"
            level="DEBUG"
            ;;
    esac

    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼‰
    if echo "$message" | grep -q "version\|Version"; then
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
        local cleaned_message="$message"
        # aios - [2025-03-10... ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
        if echo "$message" | grep -q " - "; then
            local prefix=$(echo "$message" | sed 's/ - .*//')
            local version_part=$(echo "$message" | sed 's/.* - //')
            
            # clean_version_stringé–¢æ•°ã‚’å‘¼ã³å‡ºã—
            local cleaned_version=$(clean_version_string "$version_part")
            
            cleaned_message="$prefix - $cleaned_version"
        fi
        message="$cleaned_message"
    fi

    # å¤‰æ•°ã‚’ç½®æ›
    message=$(echo "$message" | sed -e "s/{file}/$file/g" -e "s/{version}/$version/g")

    # ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡
    case "$DEBUG_LEVEL" in
        DEBUG)    allowed_levels="DEBUG INFO WARN ERROR" ;;
        INFO)     allowed_levels="INFO WARN ERROR" ;;
        WARN)     allowed_levels="WARN ERROR" ;;
        ERROR)    allowed_levels="ERROR" ;;
        *)        allowed_levels="ERROR" ;;
    esac

    if echo "$allowed_levels" | grep -q "$level"; then
        local timestamp
        timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        local log_message="[$timestamp] $level: $message"

        # ã‚«ãƒ©ãƒ¼è¡¨ç¤º
        case "$level" in
            "ERROR") echo -e "$(color red "$log_message")" ;;
            "WARN") echo -e "$(color yellow "$log_message")" ;;
            "INFO") echo -e "$(color cyan "$log_message")" ;;
            "DEBUG") echo -e "$(color white "$log_message")" ;;
        esac

        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
        if [ "$AIOS_INITIALIZED" = "true" ]; then
            echo "$log_message" >> "$LOG_DIR/debug.log"
        fi
    fi
}

#########################################################################
# handle_exit: æ­£å¸¸çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
#########################################################################
handle_exit() {
    local message="$1"
    color yellow "$message"
    exit 0
}

# ğŸ”´ã€€ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ»ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------

#########################################################################
# print_help: ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
#########################################################################
print_help() {
    echo "Usage: aios.sh [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -reset, --reset, -r     Reset all cached data"
    echo "  -help, --help, -h       Show this help message"
    echo "  ja, en, zh-cn, ...      Set language"
    echo ""
    echo "Examples:"
    echo "  sh aios.sh full ja       # Run in full mode with language set to Japanese"
    echo "  sh aios.sh full          # If language cache exists, use it; otherwise, prompt for language"
}

#########################################################################
# color: ANSI ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’ä½¿ã£ã¦è‰²ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°
#########################################################################
color() {
    local color_code
    color_code=$(color_code_map "$1")
    shift
    echo -e "${color_code}$*$(color_code_map "reset")"
}

#########################################################################
# color_code_map: ã‚«ãƒ©ãƒ¼åã‹ã‚‰ ANSI ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’è¿”ã™é–¢æ•°
#########################################################################
color_code_map() {
    local color="$1"
    case "$color" in
        "red") echo "\033[1;31m" ;;
        "green") echo "\033[1;32m" ;;
        "yellow") echo "\033[1;33m" ;;
        "blue") echo "\033[1;34m" ;;
        "magenta") echo "\033[1;35m" ;;
        "cyan") echo "\033[1;36m" ;;
        "white") echo "\033[1;37m" ;;
        "red_underline") echo "\033[4;31m" ;;
        "green_underline") echo "\033[4;32m" ;;
        "yellow_underline") echo "\033[4;33m" ;;
        "blue_underline") echo "\033[4;34m" ;;
        "magenta_underline") echo "\033[4;35m" ;;
        "cyan_underline") echo "\033[4;36m" ;;
        "white_underline") echo "\033[4;37m" ;;
        "red_white") echo "\033[1;41m" ;;
        "green_white") echo "\033[1;42m" ;;
        "yellow_white") echo "\033[1;43m" ;;
        "blue_white") echo "\033[1;44m" ;;
        "magenta_white") echo "\033[1;45m" ;;
        "cyan_white") echo "\033[1;46m" ;;
        "white_black") echo "\033[7;40m" ;;
        "reset") echo "\033[0;39m" ;;
        *) echo "\033[0;39m" ;;  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒªã‚»ãƒƒãƒˆ
    esac
}

#########################################################################
# Last Update: 2025-02-18 18:00:00 (JST) ğŸš€
# "Efficiency in retrieval, clarity in communication."
# get_message: ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹é–¢æ•°
#
# ã€è¦ä»¶ã€‘
# 1. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯**
#    - `$ACTIVE_LANGUAGE` ã‚’æœ€å„ªå…ˆã§ä½¿ç”¨ï¼ˆ`normalize_language()` ã§è¨­å®šï¼‰
#    - `$ACTIVE_LANGUAGE` ãŒæœªè¨­å®šã®å ´åˆã¯ `US` ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨
#
# 2. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œç´¢ã®é †åº**
#    â‘  `$ACTIVE_LANGUAGE|ã‚­ãƒ¼=` ã§ `messages.db` ã‚’æ¤œç´¢
#    â‘¡ `US|ã‚­ãƒ¼=` ã§ `messages.db` ã‚’æ¤œç´¢ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
#    â‘¢ ã©ã¡ã‚‰ã«ã‚‚è©²å½“ã—ãªã„å ´åˆã€`ã‚­ãƒ¼` ã‚’ãã®ã¾ã¾è¿”ã™
#
# 3. **å‹•ä½œã®æœ€é©åŒ–**
#    - `$ACTIVE_LANGUAGE` ã‚’ç›´æ¥å‚ç…§ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (`message.ch`) ã«ã¯ä¾å­˜ã—ãªã„
#    - `$quiet_flag` ã« `"quiet"` ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã€å‡ºåŠ›ã›ãšã« `return 0`
#
# 4. **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**
#    - è¨€èªå–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ `normalize_language()` ã«çµ±ä¸€ã—ã€è²¬å‹™ã‚’åˆ†é›¢
#    - `get_message()` ã¯ã€Œå–å¾—ã™ã‚‹ã ã‘ã€ã«ç‰¹åŒ–ã—ã€æ›¸ãè¾¼ã¿ãƒ»è¨­å®šã¯è¡Œã‚ãªã„
#
# 5. **å½±éŸ¿ç¯„å›²**
#    - `common.sh` å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—å…¨èˆ¬ï¼ˆ`debug_log()` å«ã‚€ï¼‰
#    - `messages.db` ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›´æ™‚ã‚‚ `get_message()` ã®ä¿®æ­£ã¯ä¸è¦
#########################################################################
get_message() {
    local key="$1"
    local params="$2"
    local quiet_flag="$3"
    local message_db="${BASE_DIR}/messages.db"
    local message_cache="${CACHE_DIR}/message.ch"
    local lang="US"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯US

    # message.chã‹ã‚‰è¨€èªã‚’èª­ã¿å–ã‚‹
    if [ -f "$message_cache" ]; then
        lang=$(cat "$message_cache")
    fi

    # `messages.db` ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ã‚­ãƒ¼ãã®ã¾ã¾ã‚’è¿”ã™
    if [ ! -f "$message_db" ]; then
        message="$key"
    else
        # è¨€èªå„ªå…ˆæ¤œç´¢
        message=$(grep "^${lang}|${key}=" "$message_db" | cut -d'=' -f2-)

        # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢
        if [ -z "$message" ]; then
            message=$(grep "^US|${key}=" "$message_db" | cut -d'=' -f2-)
        fi

        # ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã€ã‚­ãƒ¼ãã®ã¾ã¾ã‚’è¿”ã™
        if [ -z "$message" ]; then
            message="$key"
        fi
    fi

    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç½®æ›
    if [ -n "$params" ]; then
        for param in $params; do
            key=$(echo "$param" | cut -d'=' -f1)
            value=$(echo "$param" | cut -d'=' -f2)
            # `sed` ã‚³ãƒãƒ³ãƒ‰ã§ä½¿ç”¨ã™ã‚‹éš›ã« `value` ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
            escaped_value=$(echo "$value" | sed -e 's/[\/&]/\\&/g')
            message=$(echo "$message" | sed -e "s/{$key}/$escaped_value/g")
        done
    fi

    # quiet ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
    if [ "$quiet_flag" = "quiet" ]; then
        return 0
    else
        echo "$message"
    fi
}

# ğŸ”µã€€ãƒˆãƒ¼ã‚¯ãƒ³ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------

#########################################################################
# Last Update: 2025-03-10 10:34:56 (JST) ğŸš€
# "å …ç‰¢ãªGitHub APIå‘¼ã³å‡ºã—æ©Ÿèƒ½ã®å®Ÿè£…"
#
# ã€è¦ä»¶ã€‘
# 1. **èªè¨¼ç®¡ç†**
#   - åˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ã‚’ä½¿ç”¨
#   - ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯åŒ¿åãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
#   - èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã¨Acceptãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é©åˆ‡ã«è¨­å®š
#
# 2. **ã‚¨ãƒ©ãƒ¼æ¤œå‡ºã¨å‡¦ç†**
#   - APIåˆ¶é™ã‚¨ãƒ©ãƒ¼ã®æ¤œå‡ºã¨é©åˆ‡ãªãƒ­ã‚°è¨˜éŒ²
#   - èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆBad credentialsï¼‰ã®æ¤œå‡ºã¨é€šçŸ¥
#   - ãã®ä»–ã®APIã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æŠ½å‡ºã¨è¡¨ç¤º
#
# 3. **æˆ»ã‚Šå€¤ã¨çŠ¶æ…‹é€šçŸ¥**
#   - æˆåŠŸæ™‚: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¨™æº–å‡ºåŠ›ã«è¿”ã™
#   - å¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã«å¿œã˜ãŸçµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™
#     * 1: ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é
#     * 2: èªè¨¼ã‚¨ãƒ©ãƒ¼
#     * 3: ãã®ä»–ã®APIã‚¨ãƒ©ãƒ¼
#
# 4. **ãƒ‡ãƒãƒƒã‚°æ”¯æ´**
#   - ãƒˆãƒ¼ã‚¯ãƒ³é•·ã®ãƒ­ã‚°è¨˜éŒ²ï¼ˆå€¤è‡ªä½“ã¯è¨˜éŒ²ã—ãªã„ï¼‰
#   - èªè¨¼çŠ¶æ…‹ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ–¹æ³•ã®è¨˜éŒ²
#   - ã‚¨ãƒ©ãƒ¼æ™‚ã®è©³ç´°æƒ…å ±ã‚’æä¾›
#
# 5. **POSIXäº’æ›æ€§**
#   - wgetã®ã¿ã‚’ä½¿ç”¨ã—ã€curlã«ä¾å­˜ã—ãªã„å®Ÿè£…
#   - ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯åºƒç¯„å›²ã®ç’°å¢ƒã§å‹•ä½œã™ã‚‹åŸºæœ¬çš„ãªã‚‚ã®ã«é™å®š
#########################################################################
github_api_request() {
    local endpoint="$1"
    local token=$(get_github_token)
    local response=""
    
    if [ -n "$token" ]; then
        debug_log "DEBUG" "Attempting authenticated request with token (${#token} chars)"
        response=$(wget -q --header="Authorization: token $token" \
            --header="Accept: application/vnd.github.v3+json" \
            -O- "https://api.github.com/$endpoint" 2>/dev/null)
            
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼ - ãƒªãƒŸãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        if echo "$response" | grep -q '"message":"API rate limit exceeded'; then
            debug_log "WARN" "GitHub API rate limit exceeded"
            return 1
        fi
        
        # èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        if echo "$response" | grep -q '"message":"Bad credentials"'; then
            debug_log "ERROR" "GitHub API authentication failed: Bad credentials"
            return 2
        fi
        
        # ãã®ä»–ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        if echo "$response" | grep -q '"message":"'; then
            local error_msg=$(echo "$response" | grep -o '"message":"[^"]*"' | cut -d':' -f2- | tr -d '"')
            debug_log "ERROR" "GitHub API error: $error_msg"
            return 3
        fi
        
        # æˆåŠŸ
        echo "$response"
        return 0
    else
        debug_log "DEBUG" "No token found, using unauthenticated request"
        wget -q -O- "https://api.github.com/$endpoint" 2>/dev/null
        return $?
    fi
}


#########################################################################
# Last Update: 2025-03-10 10:34:56 (JST) ğŸš€
# "GitHub APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®‰å…¨ã«ä¿å­˜ã™ã‚‹"
#
# ã€è¦ä»¶ã€‘
# 1. **åŸºæœ¬æ©Ÿèƒ½**
#   - æä¾›ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³æ–‡å­—åˆ—ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
#   - ä¿å­˜å…ˆãƒ•ã‚¡ã‚¤ãƒ«: $GITHUB_TOKEN_FILE ï¼ˆé€šå¸¸ã¯/etc/aios_tokenï¼‰
#
# 2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**
#   - ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’600ã«è¨­å®šï¼ˆæ‰€æœ‰è€…ã®ã¿èª­ã¿æ›¸ãå¯èƒ½ï¼‰
#   - ç©ºã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒæä¾›ã•ã‚ŒãŸå ´åˆã¯ä¿å­˜ã‚’æ‹’å¦
#
# 3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
#   - ãƒˆãƒ¼ã‚¯ãƒ³ãŒç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¨˜éŒ²ã—ã¦å¤±æ•—ã‚’è¿”ã™
#   - ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿å¤±æ•—æ™‚ã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¨˜éŒ²
#   - æˆåŠŸ/å¤±æ•—çŠ¶æ…‹ã‚’æˆ»ã‚Šå€¤ã§æ˜ç¤ºçš„ã«é€šçŸ¥
#
# 4. **ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**
#   - æ“ä½œã®æˆåŠŸãƒ»å¤±æ•—ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
#   - ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸè©³ç´°æƒ…å ±ã®æä¾›
#
# 5. **POSIXäº’æ›æ€§**
#   - å…¨ã¦ã®å‡¦ç†ã¯POSIXäº’æ›ã®ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã®ã¿ã§å®Ÿè£…
#   - OpenWrtç’°å¢ƒã§ã®å‹•ä½œã‚’ä¿è¨¼
#########################################################################
save_github_token() {
    token="$1"
    
    if [ -z "$token" ]; then
        debug_log "ERROR" "Empty token provided, cannot save"
        return 1
    fi
    
    # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¦æ¨©é™ã‚’è¨­å®š
    echo "$token" > "$GITHUB_TOKEN_FILE"
    chmod 600 "$GITHUB_TOKEN_FILE"
    
    if [ $? -eq 0 ]; then
        debug_log "INFO" "GitHub token saved to $GITHUB_TOKEN_FILE"
        return 0
    else
        debug_log "ERROR" "Failed to save token to $GITHUB_TOKEN_FILE"
        return 1
    fi
}

#########################################################################
# Last Update: 2025-03-10 10:34:56 (JST) ğŸš€
# "å¯¾è©±å‹ã®GitHubãƒˆãƒ¼ã‚¯ãƒ³è¨­å®šæ©Ÿèƒ½"
#
# ã€è¦ä»¶ã€‘
# 1. **åŸºæœ¬æ©Ÿèƒ½**
#   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¯¾è©±çš„ã«å–å¾—
#   - ãƒˆãƒ¼ã‚¯ãƒ³ã®å®‰å…¨ãªä¿å­˜ã¨æ¨©é™è¨­å®š
#
# 2. **UI/UXè¨­è¨ˆ**
#   - æ˜ç¢ºãªèª¬æ˜ã¨æŒ‡ç¤ºã‚’è¡¨ç¤º
#   - ä¿å­˜å ´æ‰€ã¨ç›®çš„ã®é€šçŸ¥
#   - å‡¦ç†çµæœã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›
#
# 3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**
#   - sttyãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã€å…¥åŠ›æ™‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’éè¡¨ç¤ºã«
#   - sttyãŒåˆ©ç”¨ã§ããªã„ç’°å¢ƒã§ã‚‚ä»£æ›¿æ‰‹æ®µã‚’æä¾›
#   - ä¿å­˜æ™‚ã«é©åˆ‡ãªæ¨©é™ã‚’è¨­å®š
#
# 4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
#   - ç©ºã®å…¥åŠ›ã«å¯¾ã™ã‚‹é©åˆ‡ãªå‡¦ç†
#   - ä¿å­˜å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
#
# 5. **ç’°å¢ƒäº’æ›æ€§**
#   - OpenWrt/BusyBoxã®åˆ¶é™ã•ã‚ŒãŸç’°å¢ƒã§ã‚‚å‹•ä½œ
#   - sttyã‚³ãƒãƒ³ãƒ‰æœ‰ç„¡ã«å¿œã˜ãŸå‡¦ç†åˆ†å²
#   - æ¨™æº–çš„ãªã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã®ã¿ä½¿ç”¨
#########################################################################
setup_github_token() {
    echo "GitHub API Token Setup"
    echo "======================"
    echo "This will save a GitHub Personal Access Token to $GITHUB_TOKEN_FILE"
    echo "The token will be used for API requests to avoid rate limits."
    echo ""
    
    # OpenWrtã¯sttyãŒåˆ©ç”¨ã§ããªã„ã“ã¨ã‚’å‰æã¨ã™ã‚‹
    printf "Enter your GitHub Personal Access Token: "
    read -r token
    echo ""
    
    if [ -n "$token" ]; then
        if save_github_token "$token"; then
            echo "Token has been saved successfully!"
            echo "API requests will now use authentication."
        else
            echo "Failed to save token. Please check permissions."
        fi
    else
        echo "No token entered. Operation cancelled."
    fi

    return 0
}

# ğŸ”´ã€€ãƒˆãƒ¼ã‚¯ãƒ³ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------


# ğŸ”µã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# Last Update: 2025-03-10 10:34:56 (JST) ğŸš€
# "å …ç‰¢ãªGitHub APIå‘¼ã³å‡ºã—æ©Ÿèƒ½ã®å®Ÿè£…"
#
# ã€è¦ä»¶ã€‘
# 1. **èªè¨¼ç®¡ç†**
#   - åˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ã‚’ä½¿ç”¨
#   - ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯åŒ¿åãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
#   - èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã¨Acceptãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é©åˆ‡ã«è¨­å®š
#
# 2. **ã‚¨ãƒ©ãƒ¼æ¤œå‡ºã¨å‡¦ç†**
#   - APIåˆ¶é™ã‚¨ãƒ©ãƒ¼ã®æ¤œå‡ºã¨é©åˆ‡ãªãƒ­ã‚°è¨˜éŒ²
#   - èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆBad credentialsï¼‰ã®æ¤œå‡ºã¨é€šçŸ¥
#   - ãã®ä»–ã®APIã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æŠ½å‡ºã¨è¡¨ç¤º
#
# 3. **æˆ»ã‚Šå€¤ã¨çŠ¶æ…‹é€šçŸ¥**
#   - æˆåŠŸæ™‚: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¨™æº–å‡ºåŠ›ã«è¿”ã™
#   - å¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã«å¿œã˜ãŸçµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™
#     * 1: ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é
#     * 2: èªè¨¼ã‚¨ãƒ©ãƒ¼
#     * 3: ãã®ä»–ã®APIã‚¨ãƒ©ãƒ¼
#
# 4. **ãƒ‡ãƒãƒƒã‚°æ”¯æ´**
#   - ãƒˆãƒ¼ã‚¯ãƒ³é•·ã®ãƒ­ã‚°è¨˜éŒ²ï¼ˆå€¤è‡ªä½“ã¯è¨˜éŒ²ã—ãªã„ï¼‰
#   - èªè¨¼çŠ¶æ…‹ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ–¹æ³•ã®è¨˜éŒ²
#   - ã‚¨ãƒ©ãƒ¼æ™‚ã®è©³ç´°æƒ…å ±ã‚’æä¾›
#
# 5. **POSIXäº’æ›æ€§**
#   - wgetã®ã¿ã‚’ä½¿ç”¨ã—ã€curlã«ä¾å­˜ã—ãªã„å®Ÿè£…
#   - ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯åºƒç¯„å›²ã®ç’°å¢ƒã§å‹•ä½œã™ã‚‹åŸºæœ¬çš„ãªã‚‚ã®ã«é™å®š
#########################################################################
github_api_request() {
    local endpoint="$1"
    local token=$(get_github_token)
    local response=""
    
    if [ -n "$token" ]; then
        debug_log "DEBUG" "Attempting authenticated request with token (${#token} chars)"
        response=$(wget -q --header="Authorization: token $token" \
            --header="Accept: application/vnd.github.v3+json" \
            -O- "https://api.github.com/$endpoint" 2>/dev/null)
            
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼ - ãƒªãƒŸãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        if echo "$response" | grep -q '"message":"API rate limit exceeded'; then
            debug_log "WARN" "GitHub API rate limit exceeded"
            return 1
        fi
        
        # èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        if echo "$response" | grep -q '"message":"Bad credentials"'; then
            debug_log "ERROR" "GitHub API authentication failed: Bad credentials"
            return 2
        fi
        
        # ãã®ä»–ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        if echo "$response" | grep -q '"message":"'; then
            local error_msg=$(echo "$response" | grep -o '"message":"[^"]*"' | cut -d':' -f2- | tr -d '"')
            debug_log "ERROR" "GitHub API error: $error_msg"
            return 3
        fi
        
        # æˆåŠŸ
        echo "$response"
        return 0
    else
        debug_log "DEBUG" "No token found, using unauthenticated request"
        wget -q -O- "https://api.github.com/$endpoint" 2>/dev/null
        return $?
    fi
}

#########################################################################
# Last Update: 2025-03-10 10:34:56 (JST) ğŸš€
# "GitHub APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®‰å…¨ã‹ã¤æŸ”è»Ÿã«å–å¾—ã™ã‚‹"
#
# ã€è¦ä»¶ã€‘
# 1. **ãƒˆãƒ¼ã‚¯ãƒ³ã‚½ãƒ¼ã‚¹å„ªå…ˆé †ä½**
#   - ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ$GITHUB_TOKEN_FILEï¼‰ã‚’æœ€å„ªå…ˆã§ä½¿ç”¨
#   - ç’°å¢ƒå¤‰æ•°ï¼ˆ$GITHUB_TOKENï¼‰ã‚’ã‚»ã‚«ãƒ³ãƒ‰ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨
#
# 2. **ãƒˆãƒ¼ã‚¯ãƒ³ã®æŠ½å‡ºã¨æ¤œè¨¼**
#   - ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿å–ã£ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰æ”¹è¡Œãƒ»ç©ºç™½ã‚’å‰Šé™¤
#   - 'ghp_'ã§å§‹ã¾ã‚‹40æ–‡å­—ã®è‹±æ•°å­—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
#   - é•·ã•ã¨å½¢å¼ã®åŸºæœ¬çš„ãªæ¤œè¨¼ã‚’å®Ÿæ–½
#
# 3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
#   - ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç’°å¢ƒå¤‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯
#   - ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³å½¢å¼ã®å ´åˆã¯è­¦å‘Šãƒ­ã‚°ã‚’è¨˜éŒ²
#   - ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç©ºæ–‡å­—ã‚’è¿”ã—ã€å‘¼ã³å‡ºã—å…ƒãŒé©åˆ‡ã«å‡¦ç†
#
# 4. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …**
#   - ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸€éƒ¨ã®ã¿ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ï¼ˆæ¼æ´©é˜²æ­¢ï¼‰
#   - ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ã‚’ç¢ºèªï¼ˆèª­ã¿å–ã‚Šæ¨©é™ï¼‰
#
# 5. **POSIXäº’æ›æ€§**
#   - å…¨ã¦ã®å‡¦ç†ã¯POSIXäº’æ›ã®ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè£…
#   - OpenWrt/Alpine Linuxç’°å¢ƒã§ã®å‹•ä½œã‚’ä¿è¨¼
#########################################################################
get_github_token() {
    if [ -f "$GITHUB_TOKEN_FILE" ] && [ -r "$GITHUB_TOKEN_FILE" ]; then
        # å˜ç´”ã«æ”¹è¡Œã ã‘å‰Šé™¤ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™ï¼ˆã‚ˆã‚Šå …ç‰¢ï¼‰
        cat "$GITHUB_TOKEN_FILE" | tr -d '\n\r' | head -1
        return 0
    fi
    
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã®å–å¾—
    if [ -n "$GITHUB_TOKEN" ]; then
        echo "$GITHUB_TOKEN"
        return 0
    fi
    
    return 1
}

save_version_to_cache() {
    local file_name="$1"
    local version="$2"
    local script_file="$3"
    
    # tmpãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ç½®ãæ›ãˆã‚‹ï¼ˆå¤ã„sedã§ã‚‚å‹•ä½œï¼‰
    if [ -f "$script_file" ]; then
        grep -v "^${file_name}=" "$script_file" > "${script_file}.tmp"
        echo "${file_name}=${version}" >> "${script_file}.tmp"
        mv "${script_file}.tmp" "$script_file"
    else
        echo "${file_name}=${version}" > "$script_file"
    fi
}

#########################################################################
# Last Update: 2025-03-10 10:34:56 (JST) ğŸš€
# "GitHub APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®‰å…¨ã«ä¿å­˜ã™ã‚‹"
#
# ã€è¦ä»¶ã€‘
# 1. **åŸºæœ¬æ©Ÿèƒ½**
#   - æä¾›ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³æ–‡å­—åˆ—ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
#   - ä¿å­˜å…ˆãƒ•ã‚¡ã‚¤ãƒ«: $GITHUB_TOKEN_FILE ï¼ˆé€šå¸¸ã¯/etc/aios_tokenï¼‰
#
# 2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**
#   - ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’600ã«è¨­å®šï¼ˆæ‰€æœ‰è€…ã®ã¿èª­ã¿æ›¸ãå¯èƒ½ï¼‰
#   - ç©ºã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒæä¾›ã•ã‚ŒãŸå ´åˆã¯ä¿å­˜ã‚’æ‹’å¦
#
# 3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
#   - ãƒˆãƒ¼ã‚¯ãƒ³ãŒç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¨˜éŒ²ã—ã¦å¤±æ•—ã‚’è¿”ã™
#   - ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿å¤±æ•—æ™‚ã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¨˜éŒ²
#   - æˆåŠŸ/å¤±æ•—çŠ¶æ…‹ã‚’æˆ»ã‚Šå€¤ã§æ˜ç¤ºçš„ã«é€šçŸ¥
#
# 4. **ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**
#   - æ“ä½œã®æˆåŠŸãƒ»å¤±æ•—ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
#   - ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸè©³ç´°æƒ…å ±ã®æä¾›
#
# 5. **POSIXäº’æ›æ€§**
#   - å…¨ã¦ã®å‡¦ç†ã¯POSIXäº’æ›ã®ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã®ã¿ã§å®Ÿè£…
#   - OpenWrtç’°å¢ƒã§ã®å‹•ä½œã‚’ä¿è¨¼
#########################################################################
save_github_token() {
    token="$1"
    
    if [ -z "$token" ]; then
        debug_log "ERROR" "Empty token provided, cannot save"
        return 1
    fi
    
    # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¦æ¨©é™ã‚’è¨­å®š
    echo "$token" > "$GITHUB_TOKEN_FILE"
    chmod 600 "$GITHUB_TOKEN_FILE"
    
    if [ $? -eq 0 ]; then
        debug_log "INFO" "GitHub token saved to $GITHUB_TOKEN_FILE"
        return 0
    else
        debug_log "ERROR" "Failed to save token to $GITHUB_TOKEN_FILE"
        return 1
    fi
}

#########################################################################
# Last Update: 2025-03-10 10:34:56 (JST) ğŸš€
# "å¯¾è©±å‹ã®GitHubãƒˆãƒ¼ã‚¯ãƒ³è¨­å®šæ©Ÿèƒ½"
#
# ã€è¦ä»¶ã€‘
# 1. **åŸºæœ¬æ©Ÿèƒ½**
#   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¯¾è©±çš„ã«å–å¾—
#   - ãƒˆãƒ¼ã‚¯ãƒ³ã®å®‰å…¨ãªä¿å­˜ã¨æ¨©é™è¨­å®š
#
# 2. **UI/UXè¨­è¨ˆ**
#   - æ˜ç¢ºãªèª¬æ˜ã¨æŒ‡ç¤ºã‚’è¡¨ç¤º
#   - ä¿å­˜å ´æ‰€ã¨ç›®çš„ã®é€šçŸ¥
#   - å‡¦ç†çµæœã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›
#
# 3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**
#   - sttyãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã€å…¥åŠ›æ™‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’éè¡¨ç¤ºã«
#   - sttyãŒåˆ©ç”¨ã§ããªã„ç’°å¢ƒã§ã‚‚ä»£æ›¿æ‰‹æ®µã‚’æä¾›
#   - ä¿å­˜æ™‚ã«é©åˆ‡ãªæ¨©é™ã‚’è¨­å®š
#
# 4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
#   - ç©ºã®å…¥åŠ›ã«å¯¾ã™ã‚‹é©åˆ‡ãªå‡¦ç†
#   - ä¿å­˜å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
#
# 5. **ç’°å¢ƒäº’æ›æ€§**
#   - OpenWrt/BusyBoxã®åˆ¶é™ã•ã‚ŒãŸç’°å¢ƒã§ã‚‚å‹•ä½œ
#   - sttyã‚³ãƒãƒ³ãƒ‰æœ‰ç„¡ã«å¿œã˜ãŸå‡¦ç†åˆ†å²
#   - æ¨™æº–çš„ãªã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã®ã¿ä½¿ç”¨
#########################################################################
setup_github_token() {
    echo "GitHub API Token Setup"
    echo "======================"
    echo "This will save a GitHub Personal Access Token to $GITHUB_TOKEN_FILE"
    echo "The token will be used for API requests to avoid rate limits."
    echo ""
    
    # OpenWrtã¯sttyãŒåˆ©ç”¨ã§ããªã„ã“ã¨ã‚’å‰æã¨ã™ã‚‹
    printf "Enter your GitHub Personal Access Token: "
    read -r token
    echo ""
    
    if [ -n "$token" ]; then
        if save_github_token "$token"; then
            echo "Token has been saved successfully!"
            echo "API requests will now use authentication."
        else
            echo "Failed to save token. Please check permissions."
        fi
    else
        echo "No token entered. Operation cancelled."
    fi
}

# ğŸ”´ã€€ãƒˆãƒ¼ã‚¯ãƒ³ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´-------------------------------------------------------------------------------------------------------------------------------------------


# ğŸ”µã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç³»ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# Last Update: 2025-03-10 10:34:56 (JST) ğŸš€
# "GitHub APIèªè¨¼çŠ¶æ…‹ã®è¨ºæ–­ã¨è¡¨ç¤º"
#
# ã€è¦ä»¶ã€‘
# 1. **è¨ºæ–­æ©Ÿèƒ½**
#   - ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨æ¨©é™è¡¨ç¤º
#   - ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§æ¤œè¨¼
#   - GitHub APIèªè¨¼çŠ¶æ…‹ã®ç¢ºèªï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™æƒ…å ±å–å¾—ï¼‰
#
# 2. **è¡¨ç¤ºæƒ…å ±**
#   - ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ã¨å­˜åœ¨çŠ¶æ…‹
#   - ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå…ˆé ­5æ–‡å­—ã®ã¿ï¼‰
#   - APIåˆ¶é™å€¤ï¼ˆèªè¨¼çŠ¶æ…‹ã«ä¾å­˜ï¼‰
#   - æ®‹ã‚Šãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
#   - èªè¨¼çŠ¶æ…‹ã®æ˜ç¤ºçš„ãªè¡¨ç¤ºï¼ˆâœ…/âŒï¼‰
#
# 3. **ãƒ„ãƒ¼ãƒ«ä¾å­˜æ€§**
#   - jqã‚’ä½¿ç”¨ã—ãŸJSONãƒ‡ãƒ¼ã‚¿ã®è§£æ
#   - wgetã‚’ä½¿ç”¨ã—ãŸAPIé€šä¿¡
#   - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ãŸçµæœä¿å­˜ã¨è§£æ
#
# 4. **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**
#   - è¦‹ã‚„ã™ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Šï¼ˆ=====ï¼‰
#   - èªè¨¼çŠ¶æ…‹ã«å¿œã˜ãŸè¨˜å·è¡¨ç¤ºï¼ˆâœ…/âŒï¼‰
#   - é‡è¦æƒ…å ±ã®æ˜ç¤ºçš„ãªè¡¨ç¤º
#
# 5. **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**
#   - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®é©åˆ‡ãªå‰Šé™¤
#   - ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®é©åˆ‡ãªè¡¨ç¤º
#########################################################################
check_token_status() {
    echo "========== GitHub Token Status =========="
    
    # ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
    if [ -f "$GITHUB_TOKEN_FILE" ]; then
        echo "Token file: $GITHUB_TOKEN_FILE (EXISTS)"
        ls -l "$GITHUB_TOKEN_FILE"
        
        # ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
        local token=$(get_github_token)
        if [ -n "$token" ]; then
            local token_preview=${token:0:5}
            echo "Token starts with: ${token_preview}..."
            
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¿å­˜
            local temp_file="/tmp/aios_token_test.tmp"
            wget -q -O "$temp_file" --header="Authorization: token $token" "https://api.github.com/rate_limit" 2>/dev/null
            
            if [ -f "$temp_file" ] && [ -s "$temp_file" ]; then
                local core_limit=""
                local core_remaining=""
                
                # jqãŒåˆ©ç”¨å¯èƒ½ãªã‚‰jqã‚’ä½¿ã†
                if check_jq_available; then
                    echo "Parser: jq available (preferred method)"
                    core_limit=$(jq -r '.resources.core.limit' "$temp_file" 2>/dev/null)
                    core_remaining=$(jq -r '.resources.core.remaining' "$temp_file" 2>/dev/null)
                else
                    echo "Parser: fallback method (grep/sed)"
                    core_limit=$(grep -A3 '"core"' "$temp_file" | grep '"limit"' | head -1 | grep -o '[0-9]\+')
                    core_remaining=$(grep -A3 '"core"' "$temp_file" | grep '"remaining"' | head -1 | grep -o '[0-9]\+')
                fi
                
                echo "Core rate limit: $core_limit"
                echo "Core remaining: $core_remaining"
                
                # èªè¨¼çŠ¶æ…‹ã®åˆ¤æ–­
                if [ "$core_limit" = "5000" ]; then
                    echo "Auth status: âœ… AUTHENTICATED (Higher limits active)"
                else
                    echo "Auth status: âŒ UNAUTHENTICATED (Standard limits)"
                fi
                
                # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
                rm -f "$temp_file"
            else
                echo "Could not retrieve rate limit information"
            fi
        else
            echo "Could not extract valid token from file"
        fi
    else
        echo "Token file: $GITHUB_TOKEN_FILE (NOT FOUND)"
    fi
    
    echo "========================================"
}

check_jq_available() {
    if command -v jq >/dev/null 2>&1; then
        return 0 # jqãŒåˆ©ç”¨å¯èƒ½
    else
        return 1 # jqãŒåˆ©ç”¨ã§ããªã„
    fi
}

#########################################################################
# Last Update: 2025-03-10 10:34:56 (JST) ğŸš€
# "GitHub APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å†…éƒ¨ç›£è¦–"
#
# ã€è¦ä»¶ã€‘
# 1. **åŸºæœ¬æ©Ÿèƒ½**
#   - APIãƒ¬ãƒ¼ãƒˆåˆ¶é™æƒ…å ±ã®å–å¾—ã¨è§£æ
#   - ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿å‹•ä½œï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®ï¼‰
#
# 2. **å–å¾—æƒ…å ±**
#   - Core APIåˆ¶é™å€¤ï¼ˆèªè¨¼/éèªè¨¼ã§ç•°ãªã‚‹ï¼‰
#   - æ®‹ã‚Šãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
#   - åˆ¶é™ãƒªã‚»ãƒƒãƒˆã¾ã§ã®æ™‚é–“
#
# 3. **è¡¨ç¤ºå½¢å¼**
#   - èªè¨¼çŠ¶æ…‹è¡¨ç¤ºï¼ˆauthenticated/anonymousï¼‰
#   - æ®‹ã‚Šåˆ¶é™ã‚«ã‚¦ãƒ³ãƒˆï¼ˆä½¿ç”¨æ¸ˆ/åˆè¨ˆï¼‰
#   - ãƒªã‚»ãƒƒãƒˆã¾ã§ã®æ™‚é–“ï¼ˆåˆ†:ç§’ï¼‰
#
# 4. **å®Ÿè£…è¦ä»¶**
#   - jqã‚’ä½¿ç”¨ã—ãŸJSONè§£æ
#   - è»½é‡ãªå‡¦ç†ï¼ˆDEBUG_MODE=trueã®å ´åˆã®ã¿å®Ÿè¡Œï¼‰
#   - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®é©åˆ‡ãªç®¡ç†
#
# 5. **éåŒæœŸå‹•ä½œ**
#   - ä»–ã®å‡¦ç†ã‚’å¦¨ã’ãªã„è¨­è¨ˆï¼ˆå¸¸ã«æˆåŠŸã‚’è¿”ã™ï¼‰
#   - ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã‚‚é™ã‹ã«å¤±æ•—ï¼ˆãƒ¡ã‚¤ãƒ³å‡¦ç†ã«å½±éŸ¿ãªã—ï¼‰
#   - æƒ…å ±ã¯ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã«ã®ã¿è¨˜éŒ²
#########################################################################
check_api_rate_limit() {
    if [ "$DEBUG_MODE" = "true" ]; then
        local token="$(get_github_token)"
        local temp_file="/tmp/aios_api_limit.tmp"
        
        # APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        if [ -n "$token" ]; then
            wget -q -O "$temp_file" --header="Authorization: token $token" "https://api.github.com/rate_limit" 2>/dev/null
        else
            wget -q -O "$temp_file" "https://api.github.com/rate_limit" 2>/dev/null
        fi
        
        if [ -f "$temp_file" ] && [ -s "$temp_file" ]; then
            local core_limit=""
            local core_remaining=""
            local core_reset=""
            
            # jqãŒåˆ©ç”¨å¯èƒ½ãªã‚‰jqã§ãƒ‘ãƒ¼ã‚¹
            if check_jq_available; then
                debug_log "DEBUG" "Using jq for JSON parsing"
                core_limit=$(jq -r '.resources.core.limit' "$temp_file" 2>/dev/null)
                core_remaining=$(jq -r '.resources.core.remaining' "$temp_file" 2>/dev/null)
                core_reset=$(jq -r '.resources.core.reset' "$temp_file" 2>/dev/null)
            else
                # jqãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                debug_log "DEBUG" "jq not available, using fallback parsing method"
                core_limit=$(grep -A3 '"core"' "$temp_file" | grep '"limit"' | head -1 | grep -o '[0-9]\+')
                core_remaining=$(grep -A3 '"core"' "$temp_file" | grep '"remaining"' | head -1 | grep -o '[0-9]\+')
                core_reset=$(grep -A3 '"core"' "$temp_file" | grep '"reset"' | head -1 | grep -o '[0-9]\+')
            fi
            
            # æ™‚é–“è¨ˆç®—ï¼ˆã‚¨ãƒ©ãƒ¼ã«å¼·ã„å®Ÿè£…ï¼‰
            if [ -n "$core_reset" ]; then
                local now_time=$(date +%s)
                local diff_sec=0
                
                # å®‰å…¨ãªæ¯”è¼ƒã¨æ¸›ç®—
                if [ "$core_reset" -gt "$now_time" ]; then
                    diff_sec=$(expr $core_reset - $now_time)
                fi
                
                # åˆ†ã¨ç§’ã®è¨ˆç®—
                local mins=0
                local secs=0
                
                if [ $diff_sec -gt 0 ]; then
                    mins=$(expr $diff_sec / 60)
                    secs=$(expr $diff_sec % 60)
                fi
                
                # èªè¨¼çŠ¶æ…‹åˆ¤å®š
                local auth_text="anonymous"
                if [ "$core_limit" = "5000" ]; then
                    auth_text="authenticated"
                fi
                
                debug_log "DEBUG" "API Limits: Core $core_remaining/$core_limit ($auth_text), Reset in ${mins}m ${secs}s"
            fi
            
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
            rm -f "$temp_file"
        fi
    fi
    return 0
}

#########################################################################
# Last Update: 2025-03-10 10:30:32 (JST) ğŸš€
# "ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ã‚’æ¨™æº–å½¢å¼ã«æ­£è¦åŒ–ã™ã‚‹"
#
# ã€è¦ä»¶ã€‘
# 1. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ã®æ¨™æº–åŒ–**
#    - å…¥åŠ›: ä»»æ„å½¢å¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—
#    - å‡ºåŠ›: 'YYYY.MM.DD-SHA' å½¢å¼ã«æ¨™æº–åŒ–ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
#
# 2. **å‡¦ç†å†…å®¹**
#    - æ”¹è¡Œãƒ»å¾©å¸°æ–‡å­—ã®å‰Šé™¤
#    - è§’æ‹¬å¼§ã‚„ä¸è¦ãªè¨˜å·ã®å‰Šé™¤
#    - ANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ã®é™¤å»ï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œï¼‰
#    - æ—¥ä»˜ã®é‡è¤‡è¡¨ç¾ã‚’ä¿®æ­£
#
# 3. **ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**
#    - 'YYYY.MM.DD-HASH' å½¢å¼ã«ãƒãƒƒãƒã™ã‚‹éƒ¨åˆ†ã‚’å„ªå…ˆçš„ã«æŠ½å‡º
#    - ãƒãƒƒãƒã—ãªã„å ´åˆã¯ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã—ãŸå…¨ä½“æ–‡å­—åˆ—ã‚’è¿”ã™
#
# 4. **å½±éŸ¿ç¯„å›²**
#    - `download()`: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒæ™‚ã«ä½¿ç”¨
#    - `debug_log()`: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±è¡¨ç¤ºæ™‚ã«ä½¿ç”¨
#    - `version_is_newer()`: æ¯”è¼ƒå‰ã®å‰å‡¦ç†ã¨ã—ã¦ä½¿ç”¨
#########################################################################
clean_version_string() {
    local version_str="$1"
    
    # 1. æ”¹è¡Œã¨å¾©å¸°ã‚’å‰Šé™¤
    local cleaned=$(printf "%s" "$version_str" | tr -d '\n\r')
    
    # 2. è§’æ‹¬å¼§ã‚’å‰Šé™¤
    cleaned=$(printf "%s" "$cleaned" | sed 's/\[//g; s/\]//g')
    
    # 3. ANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
    cleaned=$(printf "%s" "$cleaned" | sed 's/\x1b\[[0-9;]*[mK]//g')
    
    # 4. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®æŠ½å‡ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªæ–¹æ³•ï¼‰
    if echo "$cleaned" | grep -q '20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]'; then
        # å¹´.æœˆ.æ—¥ å½¢å¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡º
        local date_part=$(printf "%s" "$cleaned" | grep -o '20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]')
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ã®æ®‹ã‚Šã®éƒ¨åˆ†ãŒã‚ã‚Œã°è¿½åŠ 
        if echo "$cleaned" | grep -q "${date_part}-"; then
            local remainder=$(printf "%s" "$cleaned" | sed "s/.*${date_part}-//; s/[^0-9a-zA-Z-].*//")
            printf "%s-%s" "$date_part" "$remainder"
        else
            printf "%s" "$date_part"
        fi
    else
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…ƒã®æ–‡å­—åˆ—ã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã—ãŸã‚‚ã®ã‚’è¿”ã™
        printf "%s" "$cleaned"
    fi
}

OK_clean_version_string() {
    local version_str="$1"
    
    # 1. æ”¹è¡Œã¨å¾©å¸°ã‚’å‰Šé™¤
    local cleaned=$(echo "$version_str" | tr -d '\n\r')
    
    # 2. è§’æ‹¬å¼§ã‚’å‰Šé™¤
    cleaned=$(echo "$cleaned" | sed 's/\[//g' | sed 's/\]//g')
    
    # 3. ANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
    cleaned=$(echo "$cleaned" | sed -e 's/\x1b\[[0-9;]*m//g' -e 's/[0-9]\+;[0-9]\+m//g')
    
    # 4. ä¸å¿…è¦ãªé‡è¤‡ã‚’å‰Šé™¤ï¼ˆæ—¥ä»˜ã®é‡è¤‡ãªã©ï¼‰
    cleaned=$(echo "$cleaned" | sed -e 's/\(20[0-9][0-9]-[0-9][0-9]-[0-9][0-9]\)\1*/\1/g' -e 's/\(20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]\)\1*/\1/g')
    
    # 5. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä¸€èˆ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã ã‘ã‚’æŠ½å‡ºï¼ˆæ—¥ä»˜-ãƒãƒƒã‚·ãƒ¥å€¤ï¼‰
    local version_pattern=$(echo "$cleaned" | grep -o '20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]-[0-9a-zA-Z]\+' | head -1)
    
    # ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¯ãƒªãƒ¼ãƒ³åŒ–ã—ãŸæ–‡å­—åˆ—ã‚’è¿”ã™
    if [ -n "$version_pattern" ]; then
        echo "$version_pattern"
    else
        echo "$cleaned"
    fi
}

AI_clean_version_string() {
    local version_str="$1"
    
    # 1. æ”¹è¡Œã¨å¾©å¸°ã‚’å‰Šé™¤
    local cleaned=$(printf "%s" "$version_str" | tr -d '\n\r')
    
    # 2. è§’æ‹¬å¼§ã‚’å‰Šé™¤
    cleaned=$(printf "%s" "$cleaned" | sed 's/\[//g; s/\]//g')
    
    # 3. ANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
    cleaned=$(printf "%s" "$cleaned" | sed 's/\x1b\[[0-9;]*[mK]//g')
    
    # 4. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®æŠ½å‡ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªæ–¹æ³•ï¼‰
    if echo "$cleaned" | grep -q '20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]'; then
        # å¹´.æœˆ.æ—¥ å½¢å¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡º
        local date_part=$(printf "%s" "$cleaned" | grep -o '20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]')
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ã®æ®‹ã‚Šã®éƒ¨åˆ†ãŒã‚ã‚Œã°è¿½åŠ 
        if echo "$cleaned" | grep -q "${date_part}-"; then
            local remainder=$(printf "%s" "$cleaned" | sed "s/.*${date_part}-//; s/[^0-9a-zA-Z-].*//")
            printf "%s-%s" "$date_part" "$remainder"
        else
            printf "%s" "$date_part"
        fi
    else
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…ƒã®æ–‡å­—åˆ—ã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã—ãŸã‚‚ã®ã‚’è¿”ã™
        printf "%s" "$cleaned"
    fi
}

#########################################################################
# Last Update: 2025-03-10 10:30:32 (JST) ğŸš€
# "GitHub APIã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³åŒ–ã™ã‚‹"
#
# ã€è¦ä»¶ã€‘
# 1. **APIã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•**
#   - GitHub API v3ã‚’ä½¿ç”¨ã—ã€æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
#   - ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ã‚’å„ªå…ˆä½¿ç”¨ï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
#   - èªè¨¼å¤±æ•—æ™‚ã¯åŒ¿åã‚¢ã‚¯ã‚»ã‚¹ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
#
# 2. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ç”Ÿæˆ**
#   - ã‚³ãƒŸãƒƒãƒˆæ—¥ä»˜ã¨SHAãƒãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ã‚’æ§‹ç¯‰
#   - å½¢å¼: `YYYY.MM.DD-SHA(çŸ­ç¸®å½¢)`
#   - æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›: YYYY-MM-DD â†’ YYYY.MM.DD
#   - SHA: å…ˆé ­7æ–‡å­—ã®ã¿ä½¿ç”¨
#
# 3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
#   - APIå¤±æ•—æ™‚ã¯ç¾åœ¨æ—¥ä»˜ã¨"unknown"ã‚’ä½¿ç”¨ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¿”ã™
#   - èªè¨¼çŠ¶æ…‹ã‚’2ã¤ç›®ã®æˆ»ã‚Šå€¤ã¨ã—ã¦è¿”ã™ï¼ˆtoken/directï¼‰
#   - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã€å‡¦ç†å¾Œã«é©åˆ‡ã«å‰Šé™¤
#
# 4. **ä¾å­˜ãƒ„ãƒ¼ãƒ«**
#   - jq: JSONãƒ‘ãƒ¼ã‚¹ç”¨ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ä½¿ç”¨ï¼‰
#   - wget: APIãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨
#   - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«: /tmp/aios_commit_info.tmp
#
# 5. **æ—¢å­˜å®Ÿè£…ã‹ã‚‰ã®å¤‰æ›´ç‚¹**
#   - Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ãŒä¸è¦ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã§ã¯ãªãã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’ä½¿ç”¨ï¼‰
#   - èªè¨¼çŠ¶æ…‹ã‚’ã‚ˆã‚Šæ­£ç¢ºã«è­˜åˆ¥ã—ã¦è¿”ã™
#########################################################################
#########################################################################
# Last Update: 2025-03-12 02:14:00 (JST) ğŸš€
# "GitHub APIã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³åŒ–ã™ã‚‹"
#
# ã€è¦ä»¶ã€‘
# 1. **APIã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•**
#   - GitHub API v3ã‚’ä½¿ç”¨ã—ã€æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
#   - ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ã‚’å„ªå…ˆä½¿ç”¨ï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
#   - èªè¨¼å¤±æ•—æ™‚ã¯åŒ¿åã‚¢ã‚¯ã‚»ã‚¹ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
#   - jqéä¾å­˜ã®å …ç‰¢ãªå®Ÿè£…
#
# 2. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ç”Ÿæˆ**
#   - ã‚³ãƒŸãƒƒãƒˆæ—¥ä»˜ã¨SHAãƒãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ã‚’æ§‹ç¯‰
#   - å½¢å¼: `YYYY.MM.DD-SHA(çŸ­ç¸®å½¢)`
#   - æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›: YYYY-MM-DD â†’ YYYY.MM.DD
#   - SHA: å…ˆé ­7æ–‡å­—ã®ã¿ä½¿ç”¨
#
# 3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
#   - APIå¤±æ•—æ™‚ã¯ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥å–å¾—ã‚’è©¦ã¿ã‚‹
#   - æœ€çµ‚æ‰‹æ®µã¨ã—ã¦ç¾åœ¨æ—¥ä»˜ã¨ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ä½¿ç”¨
#   - èªè¨¼çŠ¶æ…‹ã‚’2ã¤ç›®ã®æˆ»ã‚Šå€¤ã¨ã—ã¦è¿”ã™
#
# 4. **BusyBoxç’°å¢ƒå¯¾å¿œ**
#   - OpenWrt 19.07ã®BusyBox v1.35.0ã‚’æƒ³å®š
#   - ã‚·ãƒ³ãƒ—ãƒ«ãªgrepã¨sedã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ä¾å­˜
#   - POSIXã‚·ã‚§ãƒ«æº–æ‹ 
#########################################################################
get_commit_version() {
    local file_path="$1"
    
    # ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±
    local repo_owner="site-u2023"
    local repo_name="aios"
    local api_url="repos/${repo_owner}/${repo_name}/commits?path=${file_path}&per_page=1"
    local temp_file="/tmp/aios_commit_info.tmp"
    local auth_method="direct"
    
    # ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    local token="$(get_github_token)"
    if [ -n "$token" ]; then
        debug_log "DEBUG" "ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ã‚’ä½¿ç”¨ã—ã¦APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™"
        
        # ä¸­é–“çµæœã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã—ãªã„ã€é™ã‹ã«å¤±æ•—ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆ
        if wget -q -O "$temp_file" --header="Authorization: token $token" "https://api.github.com/$api_url" 2>/dev/null; then
            # wgetæˆåŠŸã®å ´åˆ
            auth_method="token"
            if ! grep -q '"sha"' "$temp_file"; then
                # APIã‚¨ãƒ©ãƒ¼ã¾ãŸã¯å¿œç­”ç„¡åŠ¹ã®å ´åˆ
                wget -q -O "$temp_file" "https://api.github.com/$api_url" 2>/dev/null
                auth_method="direct"
            fi
        else
            # wgetå¤±æ•—ã®å ´åˆã¯åŒ¿åã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œ
            wget -q -O "$temp_file" "https://api.github.com/$api_url" 2>/dev/null
            auth_method="direct"
        fi
    else
        debug_log "DEBUG" "ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„ãŸã‚ç›´æ¥APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™"
        wget -q -O "$temp_file" "https://api.github.com/$api_url" 2>/dev/null
        auth_method="direct"
    fi
    
    # å¿œç­”ã®ç¢ºèª
    if [ ! -s "$temp_file" ]; then
        debug_log "WARN" "GitHub APIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã™ã€‚ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã‚’è©¦ã¿ã¾ã™"
        # APIã«å¤±æ•—ã—ãŸå ´åˆã¯ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        local direct_file="/tmp/aios_direct_file.tmp"
        if wget -q -O "$direct_file" "https://raw.githubusercontent.com/$repo_owner/$repo_name/main/$file_path" 2>/dev/null; then
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆï¼ˆæœ€åˆã®7æ–‡å­—ã ã‘ä½¿ç”¨ï¼‰
            local file_hash=$(sha256sum "$direct_file" 2>/dev/null | cut -c1-7)
            rm -f "$direct_file" 2>/dev/null
            rm -f "$temp_file" 2>/dev/null
            local today=$(date +%Y.%m.%d)
            echo "$today-$file_hash direct"
            return 0
        else
            debug_log "ERROR" "ãƒ•ã‚¡ã‚¤ãƒ«ã®ç›´æ¥å–å¾—ã«ã‚‚å¤±æ•—ã—ã¾ã—ãŸ"
            rm -f "$direct_file" 2>/dev/null
            rm -f "$temp_file" 2>/dev/null
            echo "$(date +%Y.%m.%d)-unknown $auth_method"
            return 1
        fi
    fi
    
    # APIã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
    if grep -q "API rate limit exceeded" "$temp_file"; then
        debug_log "WARN" "GitHub APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸã€‚ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã‚’è©¦ã¿ã¾ã™"
        # ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        local direct_file="/tmp/aios_direct_file.tmp"
        if wget -q -O "$direct_file" "https://raw.githubusercontent.com/$repo_owner/$repo_name/main/$file_path" 2>/dev/null; then
            local file_hash=$(sha256sum "$direct_file" 2>/dev/null | cut -c1-7)
            rm -f "$direct_file" 2>/dev/null
            rm -f "$temp_file" 2>/dev/null
            local today=$(date +%Y.%m.%d)
            echo "$today-$file_hash direct"
            return 0
        else
            debug_log "ERROR" "ãƒ•ã‚¡ã‚¤ãƒ«ã®ç›´æ¥å–å¾—ã«ã‚‚å¤±æ•—ã—ã¾ã—ãŸ"
            rm -f "$direct_file" 2>/dev/null
            rm -f "$temp_file" 2>/dev/null
            echo "$(date +%Y.%m.%d)-ratelimit $auth_method"
            return 2
        fi
    fi
    
    # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±æŠ½å‡ºï¼ˆjqéä¾å­˜ã®å …ç‰¢æ–¹å¼ï¼‰
    local commit_date=""
    local commit_sha=""
    
    # 1. SHAæƒ…å ±ã®æŠ½å‡ºï¼ˆã‚ˆã‚Šå …ç‰¢ãªè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
    commit_sha=$(grep -o '"sha"[[:space:]]*:[[:space:]]*"[a-f0-9]\+' "$temp_file" | head -1 | grep -o '[a-f0-9]\{7,40\}' | head -c 7)
    
    if [ -z "$commit_sha" ]; then
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‘ã‚¿ãƒ¼ãƒ³
        commit_sha=$(grep -o '[a-f0-9]\{40\}' "$temp_file" | head -1 | head -c 7)
    fi
    
    # 2. æ—¥ä»˜æƒ…å ±ã®æŠ½å‡ºï¼ˆã‚ˆã‚Šå …ç‰¢ãªè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
    # ãƒ‘ã‚¿ãƒ¼ãƒ³1: "date": "YYYY-MM-DD..."
    commit_date=$(grep -o '"date"[[:space:]]*:[[:space:]]*"[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}' "$temp_file" | 
                  head -1 | 
                  grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
    
    if [ -z "$commit_date" ]; then
        # ãƒ‘ã‚¿ãƒ¼ãƒ³2: YYYY-MM-DDTHH:MM:SSZå½¢å¼
        commit_date=$(grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}T[0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\}Z' "$temp_file" | 
                     head -1 | 
                     grep -o '^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
    fi
    
    if [ -z "$commit_date" ] || [ -z "$commit_sha" ]; then
        debug_log "WARN" "ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã®æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚ˆã‚Šå …ç‰¢ãªæ–¹æ³•ã‚’è©¦ã—ã¾ã™"
        
        # æœ€çµ‚æ‰‹æ®µ: å…¨ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
        commit_sha=$(tr -cd 'a-f0-9' < "$temp_file" | grep -o '[a-f0-9]\{40\}' | head -1 | head -c 7)
        commit_date=$(grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}' "$temp_file" | head -1)
        
        if [ -z "$commit_sha" ]; then
            commit_sha="unknown"
        fi
        
        if [ -z "$commit_date" ]; then
            commit_date=$(date +%Y-%m-%d)
        fi
    fi
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—æ§‹ç¯‰ã¨çµæœè¿”å´
    if [ -n "$commit_date" ] && [ -n "$commit_sha" ]; then
        # æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å¤‰æ›ï¼ˆYYYY-MM-DD â†’ YYYY.MM.DDï¼‰
        local formatted_date=$(echo "$commit_date" | tr '-' '.')
        local version="${formatted_date}-${commit_sha}"
        
        debug_log "DEBUG" "ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã®æŠ½å‡ºæˆåŠŸ: $version ($auth_methodçµŒç”±)"
        rm -f "$temp_file" 2>/dev/null
        echo "$version $auth_method"
        return 0
    fi
    
    # å…¨ã¦ã®æ–¹æ³•ãŒå¤±æ•—ã—ãŸå ´åˆ
    debug_log "ERROR" "ã™ã¹ã¦ã®æ–¹æ³•ã§ã‚³ãƒŸãƒƒãƒˆæƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
    rm -f "$temp_file" 2>/dev/null
    echo "$(date +%Y.%m.%d)-fallback $auth_method"
    return 1
}

#########################################################################
# Last Update: 2025-03-10 10:30:32 (JST) ğŸš€
# "ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ã‚’æ¯”è¼ƒã—ã¦æ›´æ–°ãŒå¿…è¦ã‹åˆ¤å®šã™ã‚‹"
#
# ã€è¦ä»¶ã€‘
# 1. **å…¥åŠ›ã¨å‡ºåŠ›**
#   - å…¥åŠ›: 2ã¤ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ï¼ˆcurrent, referenceï¼‰
#   - å‡ºåŠ›: æ›´æ–°ãŒå¿…è¦ã‹ã‚’ç¤ºã™çµ‚äº†ã‚³ãƒ¼ãƒ‰ï¼ˆ0=æ›´æ–°å¿…è¦ã€1=æ›´æ–°ä¸è¦ï¼‰
#
# 2. **æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯**
#   - æ—¥ä»˜éƒ¨åˆ†ï¼ˆYYYY.MM.DDï¼‰ã‚’å„ªå…ˆçš„ã«æ¯”è¼ƒ
#   - æ—¥ä»˜ãŒåŒä¸€ã®å ´åˆã¯ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ï¼ˆSHAï¼‰ã‚’æ¯”è¼ƒ
#   - "unknown"ã‚„"No version"ã‚’å«ã‚€å ´åˆã¯å¸¸ã«æ›´æ–°ãŒå¿…è¦ã¨åˆ¤å®š
#
# 3. **å …ç‰¢æ€§**
#   - æ§˜ã€…ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰æ—¥ä»˜éƒ¨åˆ†ã‚’æ­£è¦è¡¨ç¾ã§æŠ½å‡º
#   - æŠ½å‡ºã§ããªã„å ´åˆã¯å®‰å…¨ã®ãŸã‚æ›´æ–°ãŒå¿…è¦ã¨åˆ¤æ–­
#   - æ—¥ä»˜ã‚’æ•°å€¤åŒ–ã—ã¦æ¯”è¼ƒï¼ˆYYYYMMDDå½¢å¼ã«å¤‰æ›ï¼‰
#
# 4. **ä½¿ç”¨ä¾‹**
#   - ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ¯”è¼ƒ
#   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹æ€§åˆ¤æ–­
#   - æ›´æ–°ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œåˆ¤æ–­
#########################################################################
version_is_newer() {
    local current="$1"  # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³
    local reference="$2"  # ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    
    # ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã‚’è¿½åŠ 
    debug_log "DEBUG" "æ¯”è¼ƒ: ãƒªãƒ¢ãƒ¼ãƒˆ=$current, ãƒ­ãƒ¼ã‚«ãƒ«=$reference"
    
    # ã©ã¡ã‚‰ã‹ãŒä¸æ˜ã®å ´åˆã¯æ›´æ–°å¿…è¦
    if echo "$current $reference" | grep -q "No version\|unknown"; then
        debug_log "DEBUG" "ä¸æ˜ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚‹ãŸã‚æ›´æ–°å¿…è¦"
        return 0
    fi
    
    # å®Œå…¨ä¸€è‡´ã®å ´åˆã¯æ›´æ–°ä¸è¦
    if [ "$current" = "$reference" ]; then
        debug_log "DEBUG" "å®Œå…¨ä¸€è‡´: æ›´æ–°ä¸è¦"
        return 1
    fi
    
    # æ—¥ä»˜éƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆYYYY.MM.DDå½¢å¼ï¼‰
    local current_date=$(echo "$current" | grep -o "[0-9][0-9][0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]" | head -1)
    local reference_date=$(echo "$reference" | grep -o "[0-9][0-9][0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]" | head -1)
    
    # æ—¥ä»˜ãŒæŠ½å‡ºã§ããªã‹ã£ãŸå ´åˆã¯æ›´æ–°ãŒå¿…è¦
    if [ -z "$current_date" ] || [ -z "$reference_date" ]; then
        debug_log "DEBUG" "æ—¥ä»˜æŠ½å‡ºå¤±æ•—: å®‰å…¨ã®ãŸã‚æ›´æ–°"
        return 0
    fi
    
    # æ—¥ä»˜ã‚’æ•°å€¤ã«å¤‰æ›ï¼ˆåŒºåˆ‡ã‚Šæ–‡å­—ã‚’å‰Šé™¤ï¼‰
    local current_num=$(echo "$current_date" | tr -d '.')
    local reference_num=$(echo "$reference_date" | tr -d '.')
    
    # æ•°å€¤æ¯”è¼ƒï¼ˆæ—¥ä»˜å½¢å¼ï¼‰
    if [ "$current_num" -gt "$reference_num" ]; then
        debug_log "DEBUG" "ãƒªãƒ¢ãƒ¼ãƒˆæ—¥ä»˜ãŒæ–°ã—ã„: æ›´æ–°å¿…è¦"
        return 0  # ãƒªãƒ¢ãƒ¼ãƒˆï¼ˆcurrentï¼‰ãŒæ–°ã—ã„
    elif [ "$current_num" -lt "$reference_num" ]; then
        debug_log "DEBUG" "ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ãŒæ–°ã—ã„: æ›´æ–°ä¸è¦"
        return 1  # ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆreferenceï¼‰ãŒæ–°ã—ã„
    fi
    
    # æ—¥ä»˜ãŒåŒã˜å ´åˆã¯SHAéƒ¨åˆ†ã‚’æ¯”è¼ƒ
    local current_sha=$(echo "$current" | grep -o "\-[a-z0-9]*" | sed 's/^-//' | head -1)
    local reference_sha=$(echo "$reference" | grep -o "\-[a-z0-9]*" | sed 's/^-//' | head -1)
    
    # SHAæƒ…å ±ã‚’ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
    debug_log "DEBUG" "SHAæ¯”è¼ƒ: ãƒªãƒ¢ãƒ¼ãƒˆ=$current_sha, ãƒ­ãƒ¼ã‚«ãƒ«=$reference_sha"
    
    if [ -n "$current_sha" ] && [ -n "$reference_sha" ] && [ "$current_sha" != "$reference_sha" ]; then
        debug_log "DEBUG" "SHAç•°ãªã‚‹: æ›´æ–°å¿…è¦"
        return 0  # ç•°ãªã‚‹ã‚³ãƒŸãƒƒãƒˆ
    fi
    
    debug_log "DEBUG" "ãƒãƒ¼ã‚¸ãƒ§ãƒ³åŒä¸€ã¾ãŸã¯æ¯”è¼ƒä¸èƒ½: æ›´æ–°ä¸è¦"
    return 1  # åŒä¸€ãƒãƒ¼ã‚¸ãƒ§ãƒ³
}

#########################################################################
# Last Update: 2025-03-10 10:30:32 (JST) ğŸš€
# "åŠ¹ç‡çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†"
#
# ã€è¦ä»¶ã€‘
# 1. **åŸºæœ¬æ©Ÿèƒ½**
#   - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ + ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† + ã‚ªãƒ—ã‚·ãƒ§ãƒ³å‡¦ç†
#   - GitHub APIã¨é€£æºã—ã€ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã«åŸºã¥ã„ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ¤å®š
#   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿæ§‹ã«ã‚ˆã‚‹ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æœ€é©åŒ–
#
# 2. **ã‚ªãƒ—ã‚·ãƒ§ãƒ³**
#   - hidden: è©³ç´°å‡ºåŠ›ã®æœ‰ç„¡ï¼ˆtrue=è©³ç´°è¡¨ç¤ºã€false=æœ€å°é™ã®è¡¨ç¤ºï¼‰
#   - quiet: ã™ã¹ã¦ã®å‡ºåŠ›ã‚’æŠ‘åˆ¶
#   - chmod: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸ï¼ˆ+xï¼‰
#   - read: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆsourceï¼‰
#   - debug: ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã®å®Ÿè¡Œ
#
# 3. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³å‡¦ç†**
#   - ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³: GitHubã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‹ã‚‰å–å¾—ï¼ˆYYYY.MM.DD-SHAå½¢å¼ï¼‰
#   - ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã€ãªã‘ã‚Œã°"No version control"
#   - æ¯”è¼ƒ: `version_is_newer()` ã§åˆ¤å®šã—ã€å¿…è¦ãªå ´åˆã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
#
# 4. **å‡ºåŠ›ã¨ãƒ­ã‚°**
#   - èªè¨¼çŠ¶æ…‹ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰çŠ¶æ…‹ã‚’å«ã‚€è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
#   - ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸãƒ­ã‚°è¨˜éŒ²
#   - hidden=trueã®å ´åˆã¯è‰²ä»˜ãã§è¡¨ç¤ºã€ãã‚Œä»¥å¤–ã¯debug_logã‚’ä½¿ç”¨
#
# 5. **ç‰¹æ®Šå‡¦ç†**
#   - *.shãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿ï¼ˆsourceï¼‰
#   - ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã¯${CACHE_DIR}/script.chã«ä¿å­˜
#   - æ¨©é™ä»˜ä¸ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ™‚ã¯chmod +xã‚’å®Ÿè¡Œ
#
# 6. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
#   - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—æ™‚ã®è©³ç´°ã‚¨ãƒ©ãƒ¼å‡ºåŠ›
#   - ç©ºãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºã¨é©åˆ‡ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
#   - APIåˆ¶é™ã«é”ã—ãŸå ´åˆã®è­¦å‘Šè¡¨ç¤º
#########################################################################
download() {
    # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æœ€åˆã®å¼•æ•°ã¨ã—ã¦å‡¦ç†ã€æ®‹ã‚Šã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    local file_name="$1"
    shift
    
    # è¨­å®šå¤‰æ•°
    local hidden_mode="false"
    local quiet_mode="${QUIET_MODE:-false}"
    local chmod_mode="false"
    local read_mode="false"
    local script_file="${CACHE_DIR}/script.ch"
    local dummy_version="No version control"
    
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã®å‡¦ç†
    while [ $# -gt 0 ]; do
        case "$1" in
            hidden) hidden_mode="true" ;;
            quiet)  quiet_mode="true" ;;
            debug)  DEBUG_MODE="true" ;;
            chmod)  chmod_mode="true" ;;
            read)   read_mode="true" ;;
            *)      debug_log "WARN" "Unknown option: $1, ignoring" ;;
        esac
        shift
    done
    
    # ãƒ‘ã‚¹è¨­å®š
    local install_path="${BASE_DIR}/$file_name"
    local remote_url="${BASE_URL}/$file_name"
    
    # APIåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ï¼‰
    [ "$DEBUG_MODE" = "true" ] && check_api_rate_limit
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®å–å¾—
    local remote_version_info=$(get_commit_version "$file_name")
    local remote_version=$(printf "%s" "$remote_version_info" | cut -d' ' -f1)
    local auth_method=$(printf "%s" "$remote_version_info" | cut -d' ' -f2)
    local local_version=""
    
    # ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å–å¾—
    if [ -f "$script_file" ]; then
        local_version=$(grep "^${file_name}=" "$script_file" | cut -d'=' -f2)
    fi
    [ -z "$local_version" ] && local_version="$dummy_version"

    local clean_remote_version=$(clean_version_string "$remote_version")
    local clean_local_version=$(clean_version_string "$local_version")

    # èªè¨¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨­å®š
    local auth_message=""
    case "$auth_method" in
        token)    auth_message="via token auth" ;;
        standard) auth_message="via standard API" ;;
        *)        auth_message="via direct download" ;;
    esac
    
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰åˆ¤æ–­
    local status_message="No update needed"
    local update_required=false
    
    if [ "$local_version" = "$dummy_version" ]; then
        debug_log "DEBUG" "åˆå›ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: $file_name"
        update_required=true
    elif [ "$clean_remote_version" = "$clean_local_version" ]; then
        debug_log "DEBUG" "å®Œå…¨ä¸€è‡´: æ›´æ–°ä¸è¦ $file_name"
        update_required=false
    else
        debug_log "DEBUG" "ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒé–‹å§‹: $file_name"
        version_is_newer "$clean_remote_version" "$clean_local_version"
        if [ $? -eq 0 ]; then
            debug_log "DEBUG" "æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¤œå‡º: æ›´æ–°å¿…è¦ $file_name"
            update_required=true
        else
            debug_log "DEBUG" "æ—¢å­˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³: æ›´æ–°ä¸è¦ $file_name"
            update_required=false
        fi
    fi
    
    debug_log "DEBUG" "Remote version: $file_name - $clean_remote_version"
    debug_log "DEBUG" "Local version: $file_name - $clean_local_version"
    debug_log "DEBUG" "Update required: $file_name -$(printf "%s" "$update_required")"
    
    if [ "$update_required" = "true" ]; then
        # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        if ! $BASE_WGET "$install_path" "$remote_url"; then
            debug_log "ERROR" "Download failed: $file_name is empty"
            return 1
        fi
        
        # ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
        if [ ! -s "$install_path" ]; then
            debug_log "ERROR" "Download failed: $file_name is empty"
            return 1
        fi
        
        # æ¨©é™è¨­å®š
        if [ "$chmod_mode" = "true" ]; then
            chmod +x "$install_path"
            debug_log "DEBUG" "chmod +x applied to $file_name"
        fi
        
    	# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®æ›´æ–°
    	if [ ! -f "$script_file" ]; then
        printf "%s=%s\n" "${file_name}" "${clean_remote_version}" > "$script_file"
    else
        if grep -q "^${file_name}=" "$script_file"; then
            # ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’æ”¹è‰¯
            escaped_file=$(echo "$file_name" | sed 's/[\/&]/\\&/g')
            escaped_version=$(echo "$clean_remote_version" | sed 's/[\/&]/\\&/g')
            sed -i "s/^${escaped_file}=.*/${escaped_file}=${escaped_version}/" "$script_file"
        else
            printf "%s=%s\n" "${file_name}" "${clean_remote_version}" >> "$script_file"
        fi
    fi
    
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¿®æ­£
        status_message="Download completed"
    fi
    
    # èª­ã¿è¾¼ã¿å‡¦ç†
    local action_message=""
    if [ "$read_mode" = "true" ] || echo "$file_name" | grep -q ".*\\.sh"; then
        . "$install_path"
        action_message="Loaded"
        debug_log "DEBUG" "read applied to $file_name"
    fi
    
    # å‡ºåŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¿®æ­£
    local message="${status_message}: ${file_name} - Version: ${clean_remote_version} ${auth_message}"
    if [ -n "$action_message" ]; then
        message="${message} (${action_message})"
    fi

    # å‡ºåŠ›
    if [ "$hidden_mode" = "true" ]; then
        debug_log "DEBUG" "$(color blue "Quiet mode ${message}")"
        
    else
        echo -e "$(color green "${message}")"
    fi
    
    return 0
}

# ğŸ”´ã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç³»ã€€ã“ã“ã¾ã§ã€€ğŸ”´ã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ğŸ”µã€€ãƒ¡ã‚¤ãƒ³ã€€ã“ã“ã‹ã‚‰ã€€ğŸ”µã€€-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# ãƒãƒŠãƒ¼è¡¨ç¤º
#########################################################################
print_banner() {
    echo
    color magenta "                    ii i"
    color blue    "         aaaa      iii       oooo      sssss"
    color cyan    "            aa      ii      oo  oo    ss"
    color green   "         aaaaa      ii      oo  oo     sssss"
    color yellow  "        aa  aa      ii      oo  oo         ss"
    color red     "         aaaaa     iiii      oooo     ssssss"
    echo
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_DECCRIPTION")")"
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_NAME")")"
    printf "%s\n" "$(color red "$(get_message "MSG_BANNER_DISCLAIMER")")"
}

#########################################################################
# aiosã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å‡¦ç†ã¨ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡
#########################################################################

# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æãƒ»æ­£è¦åŒ–é–¢æ•°
check_option() {

    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
    ORIGINAL_ARGS="$@"
    MODE="${MODE:-update}"
    SELECTED_LANGUAGE=""
    DEBUG_MODE="false"
    DEBUG_LEVEL="INFO"
    DRY_RUN="false"
    LOGFILE=""
    FORCE="false"
    RESET="false"
    HELP="false"

    # è¨€èªãŠã‚ˆã³ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã®å‡¦ç†
    while [ "$#" -gt 0 ]; do
        case "$1" in
            -h|--h|-help|--help|-\?|--\?)
                HELP="true"
                print_help
                exit 0
                ;;
            -v|--v|-version|--version)
                script_version
                exit 0
                ;;
            -d|--d|-debug|--debug|-d1|--d1)
                DEBUG_MODE="true"
                DEBUG_LEVEL="DEBUG"
                ;;
            -d2|--d2|-debug2|--debug2)
                DEBUG_MODE="true"
                DEBUG_LEVEL="DEBUG2"
                ;;
            -cf|--cf|-common_full|--common_full)
                MODE="full"
                ;;
            -cl|--cl|-ocommon_light|--ocommon_light)
                MODE="light"
                ;;
            -cd|--cd|-common_debug|--common_debug|--ocommon_debug)
                MODE="debug"
                ;;
            -r|--r|-reset|--reset|-resrt|--resrt)
                MODE="reset"
                RESET="true"
                ;;
            -f|--f|-force|--force)
                FORCE="true"
                ;;
            -dr|--dr|-dry-run|--dry-run)
                DRY_RUN="true"
                ;;
            -l|--l|-logfile|--logfile)
                if [ -n "$2" ] && [ "${2#-}" = "$2" ]; then
                    LOGFILE="$2"
                    shift
                else
                    echo "Error: --logfile requires a path argument"
                    exit 1
                fi
                ;;
            -u|--u|-update|--update)
                debug_log "DEBUG" "check_option: aios update"
                MODE="update"
                ;;
            -t|--t|-token|--token)
                setup_github_token
                ;;
            -ts|--ts|--token-status)
                check_token_status
                exit 0
                ;;
            -test_api)
                $BASE_WGET "${BASE_DIR}/github_api_test.sh" "${BASE_URL}/github_api_test.sh"
                chmod +x "${BASE_DIR}/github_api_test.sh"
                sh "${BASE_DIR}/github_api_test.sh"
                exit 0
                ;;
            -*)
                echo "Warning: Unknown option: $1" >&2
                ;;
            *)
                if [ -z "$SELECTED_LANGUAGE" ]; then
                    SELECTED_LANGUAGE="$1"
                fi
                ;;
        esac
        shift
    done

    # ç’°å¢ƒå¤‰æ•°è¨­å®š
    export SELECTED_LANGUAGE DEBUG_MODE DEBUG_LEVEL MODE DRY_RUN LOGFILE FORCE RESET HELP

    # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
    debug_log "DEBUG" "aios - Version: $SCRIPT_VERSION"
    debug_log "DEBUG" "check_option received before args: $ORIGINAL_ARGS"
    debug_log "DEBUG" "check_option: MODE=$MODE, SELECTED_LANGUAGE=$SELECTED_LANGUAGE DEBUG_MODE=$DEBUG_MODE DEBUG_LEVEL=$DEBUG_LEVEL DRY_RUN=$DRY_RUN LOGFILE=$LOGFILE FORCE=$FORCE RESET=$RESET HELP=$HELP"

    # è¨­å®šã•ã‚ŒãŸè¨€èªã‚’ `check_common()` ã«æ¸¡ã™
    check_common "$SELECTED_LANGUAGE" "$MODE"
}

#########################################################################
# Last Update: 2025-02-16 21:45:00 (JST) ğŸš€
# "Ensuring seamless updates, one script at a time."
#
# ã€è¦ä»¶ã€‘
# 1. `download_script()` ã‚’ `download()` ã«çµ±åˆã—ã€ä¸€è²«æ€§ã‚’ç¢ºä¿ã™ã‚‹ã€‚
# 2. `debug_log()` ã‚’å¼·åŒ–ã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰çŠ¶æ³ã‚’è©³ç´°ã«è¨˜éŒ²ã€‚
# 3. `download()` ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¦‹ç›´ã—ã€å¤±æ•—æ™‚ã®æŒ™å‹•ã‚’æ”¹å–„ã€‚
# 4. `openwrt.db`, `messages.db`, `country.db`, `packages.db` ã‚’é©åˆ‡ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚
# 5. å½±éŸ¿ç¯„å›²: `common.sh`ï¼ˆçŸ›ç›¾ãªãé©ç”¨ï¼‰ã€‚
#########################################################################
# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å‡¦ç†ã¨ãƒ¢ãƒ¼ãƒ‰ã«åŸºã¥ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠ
check_common() {
    local lang_code="$SELECTED_LANGUAGE"
    local mode="$MODE"

    debug_log "DEBUG" "check_common: MODE=$MODE"
    debug_log "DEBUG" "check_common: mode=$mode"

    # ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®å‡¦ç†
    case "$mode" in
        reset|return)
            if ! rm -rf "${CACHE_DIR}"; then
                debug_log "ERROR" "Failed to remove cache directory: ${CACHE_DIR}"
                echo "Reset failed: Could not remove cache directory."
                return 1
            fi
            # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†ä½œæˆ
            mkdir -p "${CACHE_DIR}" || {
                debug_log "ERROR" "Failed to recreate cache directory: ${CACHE_DIR}"
                echo "Reset partially failed: Cache removed but could not be recreated."
            }
            echo "$(get_message "MSG_RESET_COMPLETE")"
            exit 0
            ;;
        debug)
            download "dynamic-system-info.sh" "hidden" "chmod"
            download "common-country.sh" "hidden" "chmod"
            download "common-package.sh" "hidden" "chmod"
            download "common-feed-package.sh" "hidden" "chmod"
            download "messages.db" "hidden"
            download "country.db" "hidden"
            download "local-package.db" "hidden"
            download "custom-package.db" "hidden"
            print_banner       
            select_country "$lang_code"
            download "system-config.sh" "hidden" "chmod"
            #packages
            ;;
        full)
            download "dynamic-system-info.sh" "chmod" "read"
            download "common-country.sh" "chmod" "read"
            download "common-package.sh" "chmod" "read"
            download "common-feed-package.sh" "chmod" "read"
            download "messages.db"
            download "country.db"
            download "local-package.db"
            download "custom-package.db"
            print_banner        
            select_country "$lang_code"
            download "system-config.sh" "chmod" "read"
            #packages
            ;;
        update)
            check_update "$ORIGINAL_ARGS"
            ;;
        light)
            ;;
        *)
            ;;
    esac
    
    return 0
}

#########################################################################
# aiosåˆæœŸåŒ–ã¨ã‚·ã‚¹ãƒ†ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–¢é€£é–¢æ•°
#########################################################################

# å®Ÿè¡Œæ¨©é™ã®è¨­å®š
chmod_aios() {
    if ! chmod +x "$BIN_PATH"; then
        debug_log "ERROR" "Failed to set execute permission"
        return 1
    fi
    return 0
}

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤å‡¦ç†
delete_aios() {
    if ! rm -rf "${BASE_DIR}"; then
        debug_log "ERROR" "Failed to delete $BASE_DIR"
        return 1
    fi
    return 0
}

# å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
make_directory() {
    if ! mkdir -p "${BASE_DIR}" "$CACHE_DIR" "$LOG_DIR" "$FEED_DIR"; then
        debug_log "ERROR" "Failed to create required directories"
        return 1
    fi
}

# ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆçŠ¶æ…‹ç¢ºèª
check_update() {
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šï¼ˆå¼•æ•°ãŒãªãã¦ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«ï¼‰
    MODE="${MODE:-update}"
    
    # å…¨å¼•æ•°ã‚’å‡¦ç†
    local all_args="$@"
    local has_args=0
    
    # å¼•æ•°ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    [ $# -gt 0 ] && has_args=1
    
    # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé–¢é€£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    local filtered_args=""
    
    # å¼•æ•°ãŒã‚ã‚‹å ´åˆã®ã¿å‡¦ç†
    if [ $has_args -eq 1 ]; then
        while [ $# -gt 0 ]; do
            case "$1" in
                -u|--u|-update|--update)
                    # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé–¢é€£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯é™¤å¤–
                    ;;
                *)
                    # ãã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä¿æŒ
                    filtered_args="${filtered_args:+$filtered_args }$1"
                    ;;
            esac
            shift
        done
    fi
    
    debug_log "DEBUG" "Original args: $all_args"
    debug_log "DEBUG" "Filtered args: $filtered_args"
    
    # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
    download "aios" "chmod"
    MODE="full"

    # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ç§»å‹•ã—ã¦exec
    if [ -f "$BASE_DIR/$BIN_FILE" ]; then
        mv -f "$BASE_DIR/$BIN_FILE" "$BIN_PATH"
    fi

    exec "$BIN_PATH" $filtered_args
}

# åˆæœŸåŒ–å‡¦ç†ã®ãƒ¡ã‚¤ãƒ³
main() {
    # å®Ÿè¡Œæ¨©é™ã‚’è¨­å®š
    if ! chmod_aios; then
        debug_log "ERROR" "Failed to set execute permission"
        return 1
    fi

    # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    if ! make_directory; then
        debug_log "ERROR" "Failed to create required directories"
        return 1
    fi

    check_option "$@"
}

# ğŸ”´ã€€ãƒ¡ã‚¤ãƒ³ã€€ã“ã“ã¾ã§ã€€ğŸ”´ã€€-------------------------------------------------------------------------------------------------------------------------------------------

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"
