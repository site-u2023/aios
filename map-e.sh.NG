#!/bin/sh
# map-e.sh (BusyBox ash / POSIX sh compatible)
# Based on original script from http://ipv4.web.fc2.com/map-e.html
# Converted from bash to ash by removing bashisms:
#  - declare -A
#  - [[ ... ]], (( ... )), {0..3}, etc.
#  - replaced with grep-based lookups, arithmetic expansions, and standard POSIX constructs.

# ---------------------------------------------------------------------
# 0) Source external scripts (OpenWrt standard)
# ---------------------------------------------------------------------
. /lib/functions.sh
. /lib/functions/network.sh
. /lib/netifd/netifd-proto.sh

# ---------------------------------------------------------------------
# 1) Clear network cache & get WAN6 interface info
# ---------------------------------------------------------------------
network_flush_cache
network_find_wan6 NET_IF6
network_get_ipaddr6 NET_ADDR6 "${NET_IF6}"
new_ip6_prefix="${NET_ADDR6}"

# ---------------------------------------------------------------------
# 2) 連想配列代替
# ruleprefix31, ruleprefix38, ruleprefix38_20 を文字列定義し、
# grep で取り出すヘルパー関数を用意
#  - フォーマット: "0xhexkey=value"
#  - value = "106,72" のようにカンマ区切り
# ---------------------------------------------------------------------

ruleprefix31_data='
604700688=106,72
604700690=14,8
604701264=14,10
604701266=14,12
604273280=133,200
604273284=133,206
'
# （本来は全エントリを並べる。以下は例示の一部のみ）
# 実際はユーザの元スクリプトにある全キーを貼り付けてください。

ruleprefix38_data='
6042795008=125,196,208
6042795012=125,196,212
6042795016=125,198,140
6042795020=125,198,144
6042795024=125,198,212
6042795028=125,198,244
6042795032=122,131,104
6042795036=125,195,20
6042795040=133,203,160
6042795044=133,203,164
6042795048=133,203,168
6042795052=133,203,172
6042795056=133,203,176
6042795060=133,203,180
6042795064=133,203,184
6042795068=133,203,188
6042795072=133,209,0
6042795076=133,209,4
6042795080=133,209,8
6042795084=133,209,12
6042795088=133,209,16
6042795092=133,209,20
6042795096=133,209,24
6042795100=133,209,28
6042795104=133,204,192
6042795108=133,204,196
6042795112=133,204,200
6042795116=133,204,204
6042795120=133,204,208
6042795124=133,204,212
6042795128=133,204,216
6042795132=133,204,220
6042795136=133,203,224
6042795140=133,203,228
6042795144=133,203,232
6042795148=133,203,236
6042795152=133,203,240
6042795156=133,203,244
6042795160=133,203,248
6042795164=133,203,252
6042795168=125,194,192
6042795172=125,194,196
6042795176=125,194,200
6042795180=125,194,204
6042795184=119,239,128
6042795188=119,239,132
6042795192=119,239,136
6042795196=119,239,140
6042795200=125,194,32
6042795204=125,194,36
6042795208=125,194,40
6042795212=125,194,44
6042795216=125,195,24
6042795220=125,195,28
6042795224=122,130,192
6042795228=122,130,196
6042795232=122,135,64
6042795236=122,135,68
6042795240=125,192,240
6042795244=125,192,244
6042795248=125,193,176
6042795252=125,193,180
6042795256=122,130,176
6042795260=122,130,180
6042795264=122,131,24
6042795268=122,131,28
6042795272=122,131,32
6042795276=122,131,36
6042795280=119,243,112
6042795284=119,243,116
6042795288=219,107,136
6042795292=219,107,140
6042795296=220,144,224
6042795300=220,144,228
6042795304=125,194,64
6042795308=125,194,68
6042795312=221,171,40
6042795316=221,171,44
6042795320=110,233,80
6042795324=110,233,84
6042795328=119,241,184
6042795332=119,241,188
6042795336=119,243,56
6042795340=119,243,60
6042795344=125,199,8
6042795348=125,199,12
6042795352=125,196,96
6042795356=125,196,100
6042795360=122,130,104
6042795364=122,130,108
6042795368=122,130,112
6042795372=122,130,116
6042795376=49,129,152
6042795380=49,129,156
6042795384=49,129,192
6042795388=49,129,196
6042795392=49,129,120
6042795396=49,129,124
6042795400=221,170,40
6042795404=221,170,44
6042795408=60,239,108
6042795412=60,236,24
6042795416=122,130,120
6042795420=60,236,84
6042795424=60,239,180
6042795428=60,239,184
6042795432=118,110,136
6042795436=119,242,136
6042795440=60,238,188
6042795444=60,238,204
6042795448=122,134,52
6042795452=119,244,60
6042795456=119,243,100
6042795460=221,170,236
6042795464=221,171,48
6042795468=60,238,36
6042795472=125,195,236
6042795476=60,236,20
6042795480=118,108,76
6042795484=118,110,108
6042795488=118,110,112
6042795492=118,111,88
6042795496=118,111,228
6042795500=118,111,236
6042795504=119,241,148
6042795508=119,242,124
6042795512=125,194,28
6042795516=125,194,96
6042795520=133,204,128
6042795524=133,204,132
6042795528=133,204,136
6042795532=133,204,140
6042795536=133,204,144
6042795540=133,204,148
6042795544=133,204,152
6042795548=133,204,156
6042795552=133,204,160
6042795556=133,204,164
6042795560=133,204,168
6042795564=133,204,172
6042795568=133,204,176
6042795572=133,204,180
6042795576=133,204,184
6042795580=133,204,188
6042795584=133,203,192
6042795588=133,203,196
6042795592=133,203,200
6042795596=133,203,204
6042795600=133,203,208
6042795604=133,203,212
6042795608=133,203,216
6042795612=133,203,220
6042795616=133,204,0
6042795620=133,204,4
6042795624=133,204,8
6042795628=133,204,12
6042795632=133,204,16
6042795636=133,204,20
6042795640=133,204,24
6042795644=133,204,28
6042795648=133,204,64
6042795652=133,204,68
6042795656=133,204,72
6042795660=133,204,76
6042795664=133,204,80
6042795668=133,204,84
6042795672=133,204,88
6042795676=133,204,92
6042795680=221,171,112
6042795684=221,171,116
6042795688=221,171,120
6042795692=221,171,124
6042795696=125,195,184
6042795700=125,196,216
6042795704=221,171,108
6042795708=219,107,152
6042795712=60,239,128
6042795716=60,239,132
6042795720=60,239,136
6042795724=60,239,140
6042795728=118,110,80
6042795732=118,110,84
6042795736=118,110,88
6042795740=118,110,92
6042795744=125,194,176
6042795748=125,194,180
6042795752=125,194,184
6042795756=125,194,188
6042795760=60,239,112
6042795764=60,239,116
6042795768=60,239,120
6042795772=60,239,124
6042795776=125,195,56
6042795780=125,195,60
6042795784=125,196,32
6042795788=125,196,36
6042795792=118,108,80
6042795796=118,108,84
6042795800=118,111,80
6042795804=118,111,84
6042795808=218,227,176
6042795812=218,227,180
6042795816=60,239,208
6042795820=60,239,212
6042795824=118,109,56
6042795828=118,109,60
6042795832=122,131,88
6042795836=122,131,92
6042795840=122,131,96
6042795844=122,131,100
6042795848=122,130,48
6042795852=122,130,52
6042795856=125,198,224
6042795860=125,198,228
6042795864=119,243,104
6042795868=119,243,108
6042795872=118,109,152
6042795876=118,109,156
6042795880=118,111,104
6042795884=118,111,108
6042795888=119,239,48
6042795892=119,239,52
6042795896=122,130,16
6042795900=122,130,20
6042795904=125,196,128
6042795908=125,196,132
6042795912=122,131,48
6042795916=122,131,52
6042795920=122,134,104
6042795924=122,134,108
6042795928=60,238,208
6042795932=60,238,212
6042795936=220,144,192
6042795940=220,144,196
6042795944=110,233,48
6042795948=122,131,84
6042795952=111,169,152
6042795956=119,241,132
6042795960=119,241,136
6042795964=119,244,68
6042795968=60,236,92
6042795972=60,237,108
6042795976=60,238,12
6042795980=60,238,44
6042795984=60,238,216
6042795988=60,238,232
6042795992=49,129,72
6042795996=110,233,4
6042796000=110,233,192
6042796004=119,243,20
6042796008=119,243,24
6042796012=125,193,4
6042796016=125,193,148
6042796020=118,110,76
6042796024=118,110,96
6042796028=125,193,152
'

ruleprefix38_20_data='
604279654400=153,240,0
604279654404=153,240,16
604279654408=153,240,32
604279654412=153,240,48
604279654416=153,240,64
604279654420=153,240,80
604279654424=153,240,96
604279654428=153,240,112
604279654432=153,240,128
604279654436=153,240,144
604279654440=153,240,160
604279654444=153,240,176
604279654448=153,240,192
604279654452=153,240,208
604279654456=153,240,224
604279654460=153,240,240
604279654464=153,241,0
604279654468=153,241,16
604279654472=153,241,32
604279654476=153,241,48
604279654480=153,241,64
604279654484=153,241,80
604279654488=153,241,96
604279654492=153,241,112
604279654496=153,241,128
604279654500=153,241,144
604279654504=153,241,160
604279654508=153,241,176
604279654512=153,241,192
604279654516=153,241,208
604279654520=153,241,224
604279654524=153,241,240
604279654528=153,242,0
604279654532=153,242,16
604279654536=153,242,32
604279654540=153,242,48
604279654544=153,242,64
604279654548=153,242,80
604279654552=153,242,96
604279654556=153,242,112
604279654560=153,242,128
604279654564=153,242,144
604279654568=153,242,160
604279654572=153,242,176
604279654576=153,242,192
604279654580=153,242,208
604279654584=153,242,224
604279654588=153,242,240
604279654592=153,243,0
604279654596=153,243,16
604279654600=153,243,32
604279654604=153,243,48
604279654608=153,243,64
604279654612=153,243,80
604279654616=153,243,96
604279654620=153,243,112
604279654624=153,243,128
604279654628=153,243,144
604279654632=153,243,160
604279654636=153,243,176
604279654640=153,243,192
604279654644=153,243,208
604279654648=153,243,224
604279654652=153,243,240
604279654656=153,244,0
604279654660=153,244,16
604279654664=153,244,32
604279654668=153,244,48
604279654672=153,244,64
604279654676=153,244,80
604279654680=153,244,96
604279654684=153,244,112
604279654688=153,244,128
604279654692=153,244,144
604279654696=153,244,160
604279654700=153,244,176
604279654704=153,244,192
604279654708=153,244,208
604279654712=153,244,224
604279654716=153,244,240
604279654720=122,26,0
604279654724=122,26,16
604279654728=122,26,32
604279654732=122,26,48
604279654736=122,26,64
604279654740=122,26,80
604279654744=122,26,96
604279654748=122,26,112
604279654752=114,146,64
604279654756=114,146,80
604279654760=114,146,96
604279654764=114,146,112
604279654768=114,148,192
604279654772=114,148,208
604279654776=114,148,224
604279654780=114,148,240
604279654784=114,150,192
604279654788=114,150,208
604279654792=114,150,224
604279654796=114,150,240
604279654800=114,163,64
604279654804=114,163,80
604279654808=114,163,96
604279654812=114,163,112
604279654816=114,172,192
604279654820=114,172,208
604279654824=114,172,224
604279654828=114,172,240
604279654832=114,177,64
604279654836=114,177,80
604279654840=114,177,96
604279654844=114,177,112
604279654848=118,0,64
604279654852=118,0,80
604279654856=118,0,96
604279654860=118,0,112
604279654864=118,7,64
604279654868=118,7,80
604279654872=118,7,96
604279654876=118,7,112
604279654880=123,225,192
604279654884=123,225,208
604279654888=123,225,224
604279654892=123,225,240
604279654896=153,134,0
604279654900=153,134,16
604279654904=153,134,32
604279654908=153,134,48
604279654912=153,139,128
604279654916=153,139,144
604279654920=153,139,160
604279654924=153,139,176
604279654928=153,151,64
604279654932=153,151,80
604279654936=153,151,96
604279654940=153,151,112
604279654944=118,8,192
604279654948=118,8,208
604279654952=118,8,224
604279654956=118,8,240
604279654960=118,9,0
604279654964=118,9,16
604279654968=118,9,32
604279654972=118,9,48
604279654976=123,218,64
604279654980=123,218,80
604279654984=123,218,96
604279654988=123,218,112
604279654992=123,220,128
604279654996=123,220,144
604279655000=123,220,160
604279655004=123,220,176
604279655008=153,170,64
604279655012=153,170,80
604279655016=153,170,96
604279655020=153,170,112
604279655024=153,170,192
604279655028=153,170,208
604279655032=153,170,224
604279655036=153,170,240
604279655040=61,127,128
604279655044=61,127,144
604279655048=114,146,0
604279655052=114,146,16
604279655056=114,146,128
604279655060=114,146,144
604279655064=114,148,64
604279655068=114,148,80
604279655072=114,148,160
604279655076=114,148,176
604279655080=114,149,0
604279655084=114,149,16
604279655088=114,150,160
604279655092=114,150,176
604279655096=114,158,0
604279655100=114,158,16
604279655104=114,163,128
604279655108=114,163,144
604279655112=114,163,160
604279655116=114,163,176
604279655120=114,167,64
604279655124=114,167,80
604279655128=114,167,96
604279655132=114,167,112
604279655136=114,162,128
604279655140=114,162,144
604279655144=114,163,0
604279655148=114,163,16
604279655152=114,165,224
604279655156=114,165,240
604279655160=114,167,192
604279655164=114,167,208
604279655168=114,177,128
604279655172=114,177,144
604279655176=114,178,224
604279655180=114,178,240
604279655184=118,1,0
604279655188=118,1,16
604279655192=118,3,192
604279655196=118,3,208
604279655296=153,173,0
604279655300=153,173,16
604279655304=153,173,32
604279655308=153,173,48
604279655312=153,173,64
604279655316=153,173,80
604279655320=153,173,96
604279655324=153,173,112
604279655328=153,173,128
604279655332=153,173,144
604279655336=153,173,160
604279655340=153,173,176
604279655344=153,173,192
604279655348=153,173,208
604279655352=153,173,224
604279655356=153,173,240
604279655360=153,238,0
604279655364=153,238,16
604279655368=153,238,32
604279655372=153,238,48
604279655376=153,238,64
604279655380=153,238,80
604279655384=153,238,96
604279655388=153,238,112
604279655392=153,238,128
604279655396=153,238,144
604279655400=153,238,160
604279655404=153,238,176
604279655408=153,238,192
604279655412=153,238,208
604279655416=153,238,224
604279655420=153,238,240
604279719936=153,239,0
604279719940=153,239,16
604279719944=153,239,32
604279719948=153,239,48
604279719952=153,239,64
604279719956=153,239,80
604279719960=153,239,96
604279719964=153,239,112
604279719968=153,239,128
604279719972=153,239,144
604279719976=153,239,160
604279719980=153,239,176
604279719984=153,239,192
604279719988=153,239,208
604279719992=153,239,224
604279719996=153,239,240
604279720000=153,252,0
604279720004=153,252,16
604279720008=153,252,32
604279720012=153,252,48
604279720016=153,252,64
604279720020=153,252,80
604279720024=153,252,96
604279720028=153,252,112
604279720032=153,252,128
604279720036=153,252,144
604279720040=153,252,160
604279720044=153,252,176
604279720048=153,252,192
604279720052=153,252,208
604279720056=153,252,224
604279720060=153,252,240
604279720064=123,222,96
604279720068=123,222,112
604279720072=123,225,96
604279720076=123,225,112
604279720080=123,225,160
604279720084=123,225,176
604279720088=124,84,96
604279720092=124,84,112
604279720832=180,12,128
604279720836=180,12,144
604279720840=180,26,96
604279720844=180,26,112
604279720848=180,26,160
604279720852=180,26,176
604279720856=180,26,224
604279720860=180,26,240
604279720864=180,30,0
604279720868=180,30,16
604279720872=180,31,96
604279720876=180,31,112
604279720880=180,46,0
604279720884=180,46,16
604279720888=180,48,0
604279720892=180,48,16
604279720896=180,50,192
604279720900=180,50,208
604279720904=180,53,0
604279720908=180,53,16
604279720912=180,32,64
604279720916=180,32,80
604279720920=180,34,160
604279720924=180,34,176
604279720928=218,230,128
604279720932=218,230,144
604279720936=219,161,64
604279720940=219,161,80
604279720944=220,96,64
604279720948=220,96,80
604279720952=220,99,0
604279720956=220,99,16
604279721216=180,60,0
604279721220=180,60,16
604279721224=180,60,32
604279721228=180,60,48
604279721232=180,60,64
604279721236=180,60,80
604279721240=180,60,96
604279721244=180,60,112
604279721248=180,60,128
604279721252=180,60,144
604279721256=180,60,160
604279721260=180,60,176
604279721264=180,60,192
604279721268=180,60,208
604279721272=180,60,224
604279721276=180,60,240
604279721280=153,139,0
604279721284=153,139,16
604279721288=153,139,32
604279721292=153,139,48
604279721296=153,139,64
604279721300=153,139,80
604279721304=153,139,96
604279721308=153,139,112
604279721312=219,161,128
604279721316=219,161,144
604279721320=219,161,160
604279721324=219,161,176
604279721328=219,161,192
604279721332=219,161,208
604279721336=219,161,224
604279721340=219,161,240
604279721472=124,84,128
604279721476=124,84,144
604279721480=124,98,192
604279721484=124,98,208
604279721728=153,187,0
604279721732=153,187,16
604279721736=153,187,32
604279721740=153,187,48
604279721744=153,191,0
604279721748=153,191,16
604279721752=153,191,32
604279721756=153,191,48
604279721760=180,12,64
604279721764=180,12,80
604279721768=180,12,96
604279721772=180,12,112
604279721776=180,13,0
604279721780=180,13,16
604279721784=180,13,32
604279721788=180,13,48
604279721808=124,100,0
604279721812=124,100,16
604279721816=124,100,224
604279721820=124,100,240
604279722240=153,165,96
604279722244=153,165,112
604279722248=153,165,160
604279722252=153,165,176
604279722256=153,171,224
604279722260=153,171,240
604279722264=153,175,0
604279722268=153,175,16
604279722308=220,106,48
604279722372=220,106,80
604279722304=220,106,32
604279722368=220,106,64
604279722288=153,181,0
604279722292=153,181,16
604279722296=153,183,224
604279722300=153,183,240
604279722304=153,184,128
604279722308=153,184,144
604279722312=153,187,224
604279722316=153,187,240
604279722368=153,191,192
604279722372=153,191,208
604279722312=153,188,0
604279722316=153,188,16
604279722320=153,190,128
604279722324=153,190,144
604279722328=153,191,64
604279722332=153,191,80
604279722344=153,194,96
604279722348=153,194,112
604279721984=180,16,0
604279721988=180,16,16
604279721992=180,16,32
604279721996=180,16,48
604279722000=180,29,128
604279722004=180,29,144
604279722008=180,29,160
604279722012=180,29,176
604279722016=180,59,64
604279722020=180,59,80
604279722024=180,59,96
604279722028=180,59,112
604279720496=219,161,0
604279720500=219,161,16
604279720504=219,161,32
604279720508=219,161,48
604279720528=153,131,96
604279720532=153,131,112
604279720544=153,131,128
604279720548=153,131,144
604279720552=153,132,128
604279720556=153,132,144
604279720512=153,129,160
604279720516=153,129,176
604279720520=153,130,0
604279720524=153,130,16
604279720560=153,134,64
604279720564=153,134,80
604279720568=153,137,0
604279720572=153,137,16
604279720576=153,139,192
604279720580=153,139,208
604279720584=153,151,32
604279720588=153,151,48
604279720592=153,156,96
604279720596=153,156,112
604279720600=153,156,128
604279720604=153,156,144
'

# 連想配列取得関数（十進数のキーで検索）
get_ruleprefix31() {
  # $1 = decimal key (例："604700688")
  echo "$ruleprefix31_data" | grep "^$1=" | cut -d'=' -f2
}
get_ruleprefix38() {
  echo "$ruleprefix38_data" | grep "^$1=" | cut -d'=' -f2
}
get_ruleprefix38_20() {
  echo "$ruleprefix38_20_data" | grep "^$1=" | cut -d'=' -f2
}

# ---------------------------------------------------------------------
# 3) check ip6_prefix_tmp / parse
# ---------------------------------------------------------------------

# "::" だけだと grep が失敗する場合があるので補正
ip6_prefix_tmp=$(echo "$new_ip6_prefix" | sed 's/::/:0::/')

# Bash の =~ の代わりに grep -E でチェック
if echo "$ip6_prefix_tmp" | grep -Eq '^([0-9A-Fa-f]{1,4}:){3}[0-9A-Fa-f]{0,4}'; then
  # ":" で分割して prefix_parts に格納
  prefix_parts=$(echo "$ip6_prefix_tmp" | sed 's/:/ /g')
  i=0
  for t in $prefix_parts; do
    eval "tmp_$i=\"\$t\""
    i=$((i+1))
    [ "$i" -ge 4 ] && break
  done
  [ -z "$tmp_0" ] && tmp_0=0
  [ -z "$tmp_1" ] && tmp_1=0
  [ -z "$tmp_2" ] && tmp_2=0
  [ -z "$tmp_3" ] && tmp_3=0

  hextet_0=$(printf "%d" "0x$tmp_0")
  hextet_1=$(printf "%d" "0x$tmp_1")
  hextet_2=$(printf "%d" "0x$tmp_2")
  hextet_3=$(printf "%d" "0x$tmp_3")
else
  echo "プレフィックスを認識できません"
  echo "ONUに直接接続していますか"
  echo "終了します"
  exit 1
fi

# ---------------------------------------------------------------------
# 4) prefix31 と prefix38 を計算
# ---------------------------------------------------------------------
# ※下記計算結果はすでに10進数となる
prefix31=$(( (hextet_0 * 65536) + (hextet_1 & 0xfffe) ))
prefix38=$(( (hextet_0 * 16777216) + (hextet_1 * 256) + ((hextet_2 & 0xfc00) >> 8) ))

offset=6
rfc=false

# ※ここでは、すでに十進数になっているのでそのまま使用
prefix31_dec="$prefix31"
prefix38_dec="$prefix38"

ruleval31=$(get_ruleprefix31 "$prefix31_dec")
ruleval38=$(get_ruleprefix38 "$prefix38_dec")
ruleval38_20=$(get_ruleprefix38_20 "$prefix38_dec")

ip6prefixlen=""
psidlen=""

# ---------------------------------------------------------------------
# 5) 各ルールに応じた処理
# ---------------------------------------------------------------------
if [ -n "$ruleval38" ]; then
  # 例: ruleval38="125,196,208"
  octet_0=$(echo "$ruleval38" | cut -d',' -f1)
  octet_1=$(echo "$ruleval38" | cut -d',' -f2)
  octet_2=$(echo "$ruleval38" | cut -d',' -f3)
  tmpval=$(( (hextet_2 & 0x0300) >> 8 ))
  octet_2=$(( octet_2 | tmpval ))
  octet_3=$(( hextet_2 & 0x00ff ))
  ip6prefixlen=38
  psidlen=8
  offset=4
elif [ -n "$ruleval31" ]; then
  # 例: ruleval31="106,72"
  octet_0=$(echo "$ruleval31" | cut -d',' -f1)
  octet_1=$(echo "$ruleval31" | cut -d',' -f2)
  octet_1=$(( octet_1 | (hextet_1 & 0x1) ))
  octet_2=$(( (hextet_2 & 0xff00) >> 8 ))
  octet_3=$(( hextet_2 & 0x00ff ))
  ip6prefixlen=31
  psidlen=8
  offset=4
elif [ -n "$ruleval38_20" ]; then
  # 例: ruleval38_20="153,240,0"
  octet_0=$(echo "$ruleval38_20" | cut -d',' -f1)
  octet_1=$(echo "$ruleval38_20" | cut -d',' -f2)
  octet_2=$(echo "$ruleval38_20" | cut -d',' -f3)
  tmpval=$(( (hextet_2 & 0x03c0) >> 6 ))
  octet_2=$(( octet_2 | tmpval ))
  octet_3=$(( ((hextet_2 & 0x003f) << 2) | ((hextet_3 & 0xc000) >> 14) ))
  ip6prefixlen=38
  psidlen=6
else
  echo "未対応のプレフィックス"
  exit 1
fi

# ---------------------------------------------------------------------
# 6) psid 計算
# ---------------------------------------------------------------------
psid=0
if [ "$psidlen" = "8" ]; then
  psid=$(( (hextet_3 & 0xff00) >> 8 ))
elif [ "$psidlen" = "6" ]; then
  psid=$(( (hextet_3 & 0x3f00) >> 8 ))
fi

# offset 分のポート計算
Amax=$(( (1 << offset) - 1 ))
ports=""
A=1
while [ "$A" -le "$Amax" ]; do
  port=$(( (A << (16 - offset)) | (psid << (16 - offset - psidlen)) ))
  port2=$(( port + ((1 << (16 - offset - psidlen)) - 1) ))
  if [ -z "$ports" ]; then
    ports="${port}-${port2}"
  else
    mod=$(( A % 3 ))
    if [ "$mod" -eq 0 ]; then
      ports="$ports\n${port}-${port2}"
    else
      ports="$ports ${port}-${port2}"
    fi
  fi
  A=$((A+1))
done

# ---------------------------------------------------------------------
# 7) CE アドレス計算
# ---------------------------------------------------------------------
if [ $(( hextet_3 & 0xff )) -ne 0 ]; then
  echo "入力値とCEとで/64が異なる"
fi

hextet_3=$(( hextet_3 & 0xff00 ))
hextet_4=0
hextet_5=0
hextet_6=0
hextet_7=0

hextet_4=$octet_0
hextet_5=$(( (octet_1 << 8) | octet_2 ))
hextet_6=$(( octet_3 << 8 ))
hextet_7=$(( psid << 8 ))

ce_0=$(printf "%x" "$hextet_0")
ce_1=$(printf "%x" "$hextet_1")
ce_2=$(printf "%x" "$hextet_2")
ce_3=$(printf "%x" "$hextet_3")
CE="${ce_0}:${ce_1}:${ce_2}:${ce_3}"

ealen=$(( 56 - ip6prefixlen ))
ip4prefixlen=$(( 32 - ( ealen - psidlen ) ))

hextet2_0=""
hextet2_1=""
hextet2_2=""
if [ "$ip6prefixlen" = "38" ]; then
  hextet2_0=$hextet_0
  hextet2_1=$hextet_1
  tmp_2=$(( hextet_2 & 0xfc00 ))
  hextet2_2=$tmp_2
elif [ "$ip6prefixlen" = "31" ]; then
  hextet2_0=$hextet_0
  tmp_1=$(( hextet_1 & 0xfffe ))
  hextet2_1=$tmp_1
fi

ip6prefix_0=$(printf "%x" "$hextet2_0")
ip6prefix_1=$(printf "%x" "$hextet2_1")
ip6prefix_2=""
[ -n "$hextet2_2" ] && ip6prefix_2=$(printf "%x" "$hextet2_2")

# ---------------------------------------------------------------------
# 8) peeraddr 設定（10進数キーで比較）
# ---------------------------------------------------------------------
# 例: 0x24047a80=604273280, 0x24047a84=604273284, 0x240b0010=604700688, 0x240b0014=604700692,
#      0x240b0250=604701264, 0x240b0254=604701268
if [ "$prefix31_dec" -ge 604273280 ] && [ "$prefix31_dec" -lt 604273284 ]; then
  peeraddr="2001:260:700:1::1:275"
elif [ "$prefix31_dec" -ge 604273284 ] && [ "$prefix31_dec" -lt 604273288 ]; then
  peeraddr="2001:260:700:1::1:276"
elif [ "$prefix31_dec" -ge 604700688 ] && [ "$prefix31_dec" -lt 604700692 ]; then
  peeraddr="2404:9200:225:100::64"
elif [ "$prefix31_dec" -ge 604701264 ] && [ "$prefix31_dec" -lt 604701268 ]; then
  peeraddr="2404:9200:225:100::64"
elif [ -n "$ruleval38_20" ]; then
  peeraddr="2001:380:a120::9"
else
  peeraddr=""
fi

ipaddr=(${ipaddr//,/ })
ip4a="$(IFS="."; echo "${ipaddr[*]}")"
ip6pfx="$(IFS=":"; echo "${ip6prefix[*]}")"
PFX="$new_ip6_prefix"
CE="$(IFS=":"; echo "${ce[*]}")"
IPV4=${octet[0]}.${octet[1]}.${octet[2]}.${octet[3]}
PSID=$psid
BR=$peeraddr

# ip4
# octet_0..octet_3 すでにあり
ipaddr4a="${octet_0}.${octet_1}.${octet_2}.${octet_3}"

# ip6prefix
if [ -n "$ip6prefix_2" ]; then
  ip6pfx="${ip6prefix_0}:${ip6prefix_1}:${ip6prefix_2}"
else
  ip6pfx="${ip6prefix_0}:${ip6prefix_1}"
fi

# new_ip6_prefix = $PFX
# CE, etc.
WANMAPE='wanmape'
PFX="$new_ip6_prefix"
CEFULL="${CE}::/64"

# ---------------------------------------------------------------------
# 8) バックアップ & UCI 設定書き換え
# ---------------------------------------------------------------------
cp /etc/config/network /etc/config/network.map-e.old
cp /etc/config/dhcp /etc/config/dhcp.map-e.old
cp /etc/config/firewall /etc/config/firewall.map-e.old

# WAN
uci set network.wan.auto='0'

# DHCP LAN
uci set dhcp.lan.ra='relay'
uci set dhcp.lan.dhcpv6='relay'
uci set dhcp.lan.ndp='relay'
uci set dhcp.lan.force='1'

# DHCP WAN6
uci set dhcp.wan6='dhcp'
uci set dhcp.wan6.master='1'
uci set dhcp.wan6.ra='relay'
uci set dhcp.wan6.dhcpv6='relay'
uci set dhcp.wan6.ndp='relay'

# WAN6
uci set network.wan6.proto='dhcpv6'
uci set network.wan6.reqaddress='try'
uci set network.wan6.reqprefix='auto'
uci set network.wan6.ip6prefix="${CE}::/64"

# WANMAPE
uci set network.${WANMAPE}=interface
uci set network.${WANMAPE}.proto='map'
uci set network.${WANMAPE}.maptype='map-e'
[ -n "$peeraddr" ] && uci set network.${WANMAPE}.peeraddr="${peeraddr}"
uci set network.${WANMAPE}.ipaddr="${ipaddr4a}"
uci set network.${WANMAPE}.ip4prefixlen="${ip4prefixlen}"
uci set network.${WANMAPE}.ip6prefix="${ip6pfx}::"
uci set network.${WANMAPE}.ip6prefixlen="${ip6prefixlen}"
uci set network.${WANMAPE}.ealen="${ealen}"
uci set network.${WANMAPE}.psidlen="${psidlen}"
uci set network.${WANMAPE}.offset="${offset}"
uci set network.${WANMAPE}.mtu='1460'
uci set network.${WANMAPE}.encaplimit='ignore'

# Firewall
ZOON_NO='1'
uci del_list firewall.@zone["${ZOON_NO}"].network='wan'
uci add_list firewall.@zone["${ZOON_NO}"].network="${WANMAPE}"

# ---------------------------------------------------------------------
# 9) Version-specific settings
# ---------------------------------------------------------------------
OPENWRT_RELEAS=$(grep 'DISTRIB_RELEASE' /etc/openwrt_release | cut -d"'" -f2 | cut -c 1-2)

if [ "$OPENWRT_RELEAS" = "SN" ] || [ "$OPENWRT_RELEAS" = "24" ] || \
   [ "$OPENWRT_RELEAS" = "23" ] || [ "$OPENWRT_RELEAS" = "22" ] || [ "$OPENWRT_RELEAS" = "21" ]; then
  uci set dhcp.wan6.interface='wan6'
  uci set dhcp.wan6.ignore='1'
  uci set network.${WANMAPE}.legacymap='1'
  uci set network.${WANMAPE}.tunlink='wan6'
elif [ "$OPENWRT_RELEAS" = "19" ]; then
  uci add_list network.${WANMAPE}.tunlink='wan6'
fi

uci commit

# ---------------------------------------------------------------------
# 10) 最終表示
# ---------------------------------------------------------------------
printf "\033[1;33m wan ipaddr6: %s\033[0;33m\n" "$NET_ADDR6"
printf "\033[1;32m wan6 ip6prefix: \033[0;39m%s\n" "$CEFULL"
printf "\033[1;32m %s peeraddr: \033[0;39m%s\n" "$WANMAPE" "$peeraddr"
printf "\033[1;32m %s ip4prefixlen: \033[0;39m%s\n" "$WANMAPE" "$ip4prefixlen"
printf "\033[1;32m %s ip6pfx: \033[0;39m%s::\n" "$WANMAPE" "$ip6pfx"
printf "\033[1;32m %s ip6prefixlen: \033[0;39m%s\n" "$WANMAPE" "$ip6prefixlen"
printf "\033[1;32m %s ealen: \033[0;39m%s\n" "$WANMAPE" "$ealen"
printf "\033[1;32m %s psidlen: \033[0;39m%s\n" "$WANMAPE" "$psidlen"
printf "\033[1;32m %s offset: \033[0;39m%s\n" "$WANMAPE" "$offset"

# もし ports の表示など必要なら適宜追加
# echo "Mapped ports: $ports"

exit 0
