#!/bin/sh

# =========================================================
# aios - Command launcher for OpenWrt
#
# This script is designed for use on OpenWrt systems only.
# POSIX-compliant and compatible with Almquist Shell (ash).
#
# Usage: aios [options]
#
# Version: 2025-04-29
# License: CC0 (Public Domain)
# Author: site-u2023
# =========================================================

BASE_DIR="/tmp/aios"
BASE_FILE="aios.sh"
BASE_PATH="$BASE_DIR/$BASE_FILE"
BASE_URL="https://raw.githubusercontent.com/site-u2023/aios/main/$BASE_FILE"

if ! chmod +x "$0"; then
    printf "Failed to set executable: %s\n" "$0" >&2
    exit 1
fi

if [ ! -d "$BASE_DIR" ]; then
    if ! mkdir -p "$BASE_DIR"; then
        printf "Failed to create directory: %s\n" "$BASE_DIR" >&2
        exit 1
    fi
fi

if ! wget -q -O "$BASE_PATH" "$BASE_URL"; then
    printf "Failed to download: %s\n" "$BASE_URL" >&2
    exit 1
fi

if ! chmod +x "$BASE_PATH"; then
    printf "Failed to set executable: %s\n" "$BASE_PATH" >&2
    exit 1
fi

SYSCONF="/etc/sysupgrade.conf"
CMD_PATH="/usr/bin/aios"
COMMENT1="# The following entry ensures that the 'aios' command is also backed up"
COMMENT2="# when you perform a sysupgrade and choose to preserve your configuration."

if ! grep -Fxq "$CMD_PATH" "$SYSCONF" 2>/dev/null; then
    {
        printf "%s\n" "$COMMENT1"
        printf "%s\n" "$COMMENT2"
        printf "%s\n" "$CMD_PATH"
    } >> "$SYSCONF"
    printf "%s\n%s\n%s\n" "$COMMENT1" "$COMMENT2" "$CMD_PATH"
fi

exec "$BASE_PATH" "$@"
