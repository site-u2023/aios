#!/bin/sh

SCRIPT_VERSION="2025.03.10-03-09"

echo -e "\033[1;35mCurrent Version: aios - Version: $SCRIPT_VERSION\033[0m"

# =========================================================
# üìå OpenWrt / Alpine Linux POSIX-Compliant Shell Script
# üöÄ Last Update: 2025-02-21
#
# üè∑Ô∏è License: CC0 (Public Domain)
# üéØ Compatibility: OpenWrt >= 19.07 (Tested on 24.10.0)
#
# ‚ö†Ô∏è IMPORTANT NOTICE:
# OpenWrt OS exclusively uses **Almquist Shell (ash)** and
# is **NOT** compatible with Bourne-Again Shell (bash).
#
# üì¢ POSIX Compliance Guidelines:
# ‚úÖ Use `[` instead of `[[` for conditions
# ‚úÖ Use `$(command)` instead of backticks `` `command` ``
# ‚úÖ Use `$(( ))` for arithmetic instead of `let`
# ‚úÖ Define functions as `func_name() {}` (no `function` keyword)
# ‚úÖ No associative arrays (`declare -A` is NOT supported)
# ‚úÖ No here-strings (`<<<` is NOT supported)
# ‚úÖ No `-v` flag in `test` or `[[`
#
# üõ†Ô∏è Keep it simple, POSIX-compliant, and lightweight for OpenWrt!
# =========================================================
### =========================================================
### üìå AI Assistance Request: Bug Fixing Procedure
### 
### When debugging or fixing errors in this script, follow these steps:
### 
### 1Ô∏è‚É£ Create a minimal test script to identify the bug.
### 2Ô∏è‚É£ Execute the test and verify the reproducibility of the error.
### 3Ô∏è‚É£ Fix the error and re-run the test to confirm the solution.
### 4Ô∏è‚É£ Apply the corrected code to the production environment.
### 
### ‚ö†Ô∏è DO NOT modify the main script without first confirming the fix 
###     through a dedicated test script.
### 
### üõ†Ô∏è Keep the debugging process structured, efficient, and reliable.
### =========================================================

DEV_NULL="${DEV_NULL:-on}"
# „Çµ„Ç§„É¨„É≥„Éà„É¢„Éº„Éâ
# export DEV_NULL="on"
# ÈÄöÂ∏∏„É¢„Éº„Éâ
# unset DEV_NULL

# Âü∫Êú¨ÂÆöÊï∞„ÅÆË®≠ÂÆö 
BASE_WGET="${BASE_WGET:-wget --no-check-certificate -q -O}"
# BASE_WGET="${BASE_WGET:-wget -O}"
DEBUG_MODE="${DEBUG_MODE:-false}"
BIN_PATH=$(readlink -f "$0")
BIN_DIR="$(dirname "$BIN_PATH")"
BIN_FILE="$(basename "$BIN_PATH")"
BASE_URL="${BASE_URL:-https://raw.githubusercontent.com/site-u2023/aios/main}"
BASE_DIR="${BASE_DIR:-/tmp/aios}"
CACHE_DIR="${CACHE_DIR:-$BASE_DIR/cache}"
FEED_DIR="${FEED_DIR:-$BASE_DIR/feed}"
LOG_DIR="${LOG_DIR:-$BASE_DIR/logs}"
UPDATE_CACHE="${CACHE_DIR}/update.ch"
GITHUB_TOKEN_FILE="/etc/aios_token"

# üîµ„ÄÄ„Ç®„É©„Éº„Éª„Éá„Éê„ÉÉ„Ç∞„Éª„Ç¢„ÉÉ„Éó„Éá„Éº„ÉàÁ≥ª„ÄÄ„Åì„Åì„Åã„Çâ„ÄÄüîµ-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# Last Update: 2025-02-16 16:00:00 (JST) üöÄ
# "Clarity in errors, precision in handling. Every function must be robust."
#
# „ÄêË¶Å‰ª∂„Äë
# 1. „Åô„Åπ„Å¶„ÅÆ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„Çí `messages.db` „ÅßÁÆ°ÁêÜ„Åó„ÄÅÂ§öË®ÄË™ûÂØæÂøú„Åô„Çã„ÄÇ
# 2. `debug_log("ERROR", message)` „ÇÇ `message.db` „Çí‰ΩøÁî®„Åô„Çã„ÄÇ
# 3. `{file}`, `{version}` „Å™„Å©„ÅÆÂ§âÊï∞„ÇíÂãïÁöÑ„Å´ÁΩÆÊèõ„ÄÇ
# 4. ÂΩ±ÈüøÁØÑÂõ≤: `aios` & `common.sh`ÔºàÁüõÁõæ„Å™„ÅèÈÅ©Áî®Ôºâ„ÄÇ
#########################################################################
handle_error() {
    local error_key="$1"
    local file="$2"
    local version="$3"
    local exit_required="${4:-no}"

    local error_message
    error_message=$(get_message "$error_key")

    # „É°„ÉÉ„Çª„Éº„Ç∏„ÅåÂèñÂæó„Åß„Åç„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
    if [ -z "$error_message" ]; then
        error_message="Unknown error occurred. Key: $error_key"
    fi

    # Â§âÊï∞„ÇíÁΩÆÊèõ
    error_message=$(echo "$error_message" | sed -e "s/{file}/$file/g" -e "s/{version}/$version/g")

    # „É≠„Ç∞Ë®òÈå≤ & Ë°®Á§∫
    debug_log "ERROR" "$error_message"
    echo -e "$(color red "$error_message")"

    if [ "$exit_required" = "yes" ]; then
        debug_log "ERROR" "Critical error occurred, exiting: $error_message"
        exit 1
    else
        debug_log "DEBUG" "Non-critical error: $error_message"
        return 1
    fi
}

#########################################################################
# Last Update: 2025-02-16 16:10:00 (JST) üöÄ
# "Logging with clarity, debugging with precision."
#
# „ÄêË¶Å‰ª∂„Äë
# 1. „Åô„Åπ„Å¶„ÅÆ„É≠„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏„Çí `messages.db` „ÅßÁÆ°ÁêÜ„Åó„ÄÅÂ§öË®ÄË™ûÂØæÂøú„Åô„Çã„ÄÇ
# 2. `{file}`, `{version}` „Å™„Å©„ÅÆÂ§âÊï∞„Çí `sed` „ÅßÂãïÁöÑ„Å´ÁΩÆÊèõ„Åô„Çã„ÄÇ
# 3. `DEBUG_MODE` „ÅÆË®≠ÂÆö„Å´Âøú„Åò„Å¶ `DEBUG`, `INFO`, `WARN`, `ERROR` „ÇíÁÆ°ÁêÜ„Åô„Çã„ÄÇ
# 4. ÂΩ±ÈüøÁØÑÂõ≤: `aios` & `common.sh`ÔºàÁüõÁõæ„Å™„ÅèÈÅ©Áî®Ôºâ„ÄÇ
#########################################################################
# „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞Èñ¢Êï∞„ÅÆ‰øÆÊ≠£ÁâàÔºà„Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„Çí„ÇØ„É™„Éº„É≥„Å´Ë°®Á§∫Ôºâ
debug_log() {
    local level="$1"
    local message="$2"
    local file="$3"
    local version="$4"

    # `$1` „Å´„É≠„Ç∞„É¨„Éô„É´„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÄÅ„Éá„Éï„Ç©„É´„Éà„Çí `DEBUG` „Å´„Åô„Çã
    case "$level" in
        "DEBUG"|"INFO"|"WARN"|"ERROR") ;;  # ‰Ωï„ÇÇ„Åó„Å™„ÅÑ (Ê≠£„Åó„ÅÑ„É≠„Ç∞„É¨„Éô„É´)
        "")
            level="DEBUG"
            message="$1"
            file="$2"
            version="$3"
            ;;
        *)
            message="$1"
            file="$2"
            version="$3"
            level="DEBUG"
            ;;
    esac

    # „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÅÆ„ÇØ„É™„Éº„Éã„É≥„Ç∞Ôºà„É°„ÉÉ„Çª„Éº„Ç∏„Å´„Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÅåÂê´„Åæ„Çå„ÇãÂ†¥ÂêàÔºâ
    if echo "$message" | grep -q "version\|Version"; then
        # „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±ÈÉ®ÂàÜ„ÇíÊäΩÂá∫„Åó„Å¶„ÇØ„É™„Éº„Éã„É≥„Ç∞
        local cleaned_message="$message"
        # aios - [2025-03-10... „ÅÆ„Çà„ÅÜ„Å™„Éë„Çø„Éº„É≥„ÇíÊ§úÂá∫
        if echo "$message" | grep -q " - "; then
            local prefix=$(echo "$message" | sed 's/ - .*//')
            local version_part=$(echo "$message" | sed 's/.* - //')
            local cleaned_version=$(clean_version_string "$version_part")
            cleaned_message="$prefix - $cleaned_version"
        fi
        message="$cleaned_message"
    fi

    # Â§âÊï∞„ÇíÁΩÆÊèõ
    message=$(echo "$message" | sed -e "s/{file}/$file/g" -e "s/{version}/$version/g")

    # „É≠„Ç∞„É¨„Éô„É´Âà∂Âæ°
    case "$DEBUG_LEVEL" in
        DEBUG)    allowed_levels="DEBUG INFO WARN ERROR" ;;
        INFO)     allowed_levels="INFO WARN ERROR" ;;
        WARN)     allowed_levels="WARN ERROR" ;;
        ERROR)    allowed_levels="ERROR" ;;
        *)        allowed_levels="ERROR" ;;
    esac

    if echo "$allowed_levels" | grep -q "$level"; then
        local timestamp
        timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        local log_message="[$timestamp] $level: $message"

        # „Ç´„É©„ÉºË°®Á§∫
        case "$level" in
            "ERROR") echo -e "$(color red "$log_message")" ;;
            "WARN") echo -e "$(color yellow "$log_message")" ;;
            "INFO") echo -e "$(color cyan "$log_message")" ;;
            "DEBUG") echo -e "$(color white "$log_message")" ;;
        esac

        # „É≠„Ç∞„Éï„Ç°„Ç§„É´„Å´Ë®òÈå≤
        if [ "$AIOS_INITIALIZED" = "true" ]; then
            echo "$log_message" >> "$LOG_DIR/debug.log"
        fi
    fi
}

#########################################################################
# Last Update: 2025-02-16 17:30:00 (JST) üöÄ
# "Debug with clarity, test with precision. Every log tells a story."
#
# „ÄêË¶Å‰ª∂„Äë
# 1. `test_country_search()`, `test_timezone_search()`, `test_cache_contents()` „ÇíÁµ±Âêà„ÄÇ
# 2. `debug_log()` „Çí‰ΩøÁî®„Åó„ÄÅ„É°„ÉÉ„Çª„Éº„Ç∏„Çí `message.db` „Åã„ÇâÂèñÂæó„ÄÇ
# 3. `country.db` „ÅÆÊ§úÁ¥¢ÁµêÊûú„ÅåÈÅ©Âàá„Å´Âá∫Âäõ„Åï„Çå„Çã„ÅãÁ¢∫Ë™ç„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã„ÄÇ
# 4. ÂΩ±ÈüøÁØÑÂõ≤: `common.sh` „ÅÆ„ÅøÔºà`aios` „Å´„ÅØÂΩ±Èüø„Å™„ÅóÔºâ„ÄÇ
#########################################################################
test_debug_functions() {
    local test_type="$1"
    local test_input="$2"

    case "$test_type" in
        country)
            debug_log "DEBUG" "MSG_TEST_COUNTRY_SEARCH" "$test_input"
            if [ ! -f "${BASE_DIR}/country.db" ]; then
                handle_error "ERR_FILE_NOT_FOUND" "country.db"
                return 1
            fi
            awk -v query="$test_input" '
                $2 ~ query || $3 ~ query || $4 ~ query || $5 ~ query {
                    print NR, $2, $3, $4, $5, $6, $7, $8, $9
                }' "${BASE_DIR}/country.db"
            ;;

        timezone)
            debug_log "DEBUG" "MSG_TEST_TIMEZONE_SEARCH" "$test_input"
            if [ ! -f "${BASE_DIR}/country.db" ]; then
                handle_error "ERR_FILE_NOT_FOUND" "country.db"
                return 1
            fi
            awk -v country="$test_input" '
                $2 == country || $4 == country || $5 == country {
                    print NR, $5, $6, $7, $8, $9, $10, $11
                }' "${BASE_DIR}/country.db"
            ;;

        cache)
            debug_log "DEBUG" "MSG_TEST_CACHE_CONTENTS"
            for cache_file in "country_tmp.ch" "zone_tmp.ch"; do
                if [ -f "${CACHE_DIR}/$cache_file" ]; then
                    debug_log "DEBUG" "MSG_CACHE_CONTENTS" "$cache_file"
                    cat "${CACHE_DIR}/$cache_file"
                else
                    debug_log "DEBUG" "MSG_CACHE_NOT_FOUND" "$cache_file"
                fi
            done
            ;;
        
        *)
            debug_log "ERROR" "ERR_INVALID_ARGUMENT" "$test_type"
            return 1
            ;;
    esac
}

#########################################################################
# country_DEBUG: ÈÅ∏Êäû„Åï„Çå„ÅüÂõΩ„Å®Ë®ÄË™û„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÇíË°®Á§∫
#########################################################################
country_DEBUG() {
    local country_DEBUG_file="${BASE_DIR}/country.ch"
    local selected_language_code=$(cat "${BASE_DIR}/check_country")
    if [ -f "$country_DEBUG_file" ]; then
        grep -w "$selected_language_code" "$country_DEBUG_file"
    else
        printf "%s\n" "$(color red "Country DEBUGrmation not found.")"
    fi
}

#########################################################################
# handle_exit: Ê≠£Â∏∏ÁµÇ‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åó„Å¶ÁµÇ‰∫Ü
#########################################################################
handle_exit() {
    local message="$1"
    color yellow "$message"
    exit 0
}

# üî¥„ÄÄ„Ç®„É©„Éº„Éª„Éá„Éê„ÉÉ„Ç∞„Éª„Ç¢„ÉÉ„Éó„Éá„Éº„ÉàÁ≥ª„ÄÄ„Åì„Åì„Åæ„Åß„ÄÄüî¥-------------------------------------------------------------------------------------------------------------------------------------------

#########################################################################
# print_help: „Éò„É´„Éó„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
#########################################################################
print_help() {
    echo "Usage: aios.sh [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -reset, --reset, -r     Reset all cached data"
    echo "  -help, --help, -h       Show this help message"
    echo "  ja, en, zh-cn, ...      Set language"
    echo ""
    echo "Examples:"
    echo "  sh aios.sh full ja       # Run in full mode with language set to Japanese"
    echo "  sh aios.sh full          # If language cache exists, use it; otherwise, prompt for language"
}

#########################################################################
# color: ANSI „Ç®„Çπ„Ç±„Éº„Éó„Ç∑„Éº„Ç±„É≥„Çπ„Çí‰Ωø„Å£„Å¶Ëâ≤‰ªò„Åç„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂá∫Âäõ„Åô„ÇãÈñ¢Êï∞
#########################################################################
color() {
    local color_code
    color_code=$(color_code_map "$1")
    shift
    echo -e "${color_code}$*$(color_code_map "reset")"
}

#########################################################################
# color_code_map: „Ç´„É©„ÉºÂêç„Åã„Çâ ANSI „Ç®„Çπ„Ç±„Éº„Éó„Ç∑„Éº„Ç±„É≥„Çπ„ÇíËøî„ÅôÈñ¢Êï∞
#########################################################################
color_code_map() {
    local color="$1"
    case "$color" in
        "red") echo "\033[1;31m" ;;
        "green") echo "\033[1;32m" ;;
        "yellow") echo "\033[1;33m" ;;
        "blue") echo "\033[1;34m" ;;
        "magenta") echo "\033[1;35m" ;;
        "cyan") echo "\033[1;36m" ;;
        "white") echo "\033[1;37m" ;;
        "red_underline") echo "\033[4;31m" ;;
        "green_underline") echo "\033[4;32m" ;;
        "yellow_underline") echo "\033[4;33m" ;;
        "blue_underline") echo "\033[4;34m" ;;
        "magenta_underline") echo "\033[4;35m" ;;
        "cyan_underline") echo "\033[4;36m" ;;
        "white_underline") echo "\033[4;37m" ;;
        "red_white") echo "\033[1;41m" ;;
        "green_white") echo "\033[1;42m" ;;
        "yellow_white") echo "\033[1;43m" ;;
        "blue_white") echo "\033[1;44m" ;;
        "magenta_white") echo "\033[1;45m" ;;
        "cyan_white") echo "\033[1;46m" ;;
        "white_black") echo "\033[7;40m" ;;
        "reset") echo "\033[0;39m" ;;
        *) echo "\033[0;39m" ;;  # „Éá„Éï„Ç©„É´„Éà„Åß„É™„Çª„ÉÉ„Éà
    esac
}

#########################################################################
# check_openwrt: OpenWrt„ÅÆ„Éê„Éº„Ç∏„Éß„É≥Á¢∫Ë™ç„ÉªÁÆ°ÁêÜ„ÅÆ„Åø„ÇíÊãÖÂΩì
#########################################################################
check_openwrt() {
    local version_file="${CACHE_DIR}/openwrt.ch"

    # **„Ç≠„É£„ÉÉ„Ç∑„É•„Åå„ÅÇ„Çå„Å∞‰ΩøÁî®**
    if [ -f "$version_file" ]; then
        CURRENT_VERSION=$(cat "$version_file")
    else
        local raw_version=""
        local distrib_id=""

        # **‚ë† /etc/openwrt_release „Åã„ÇâÂèñÂæóÔºàÊúÄÂÑ™ÂÖàÔºâ**
        if [ -f "/etc/openwrt_release" ]; then
            distrib_id=$(awk -F"'" '/DISTRIB_ID/ {print $2}' /etc/openwrt_release)
            
            # **GL.iNet „Ç´„Çπ„Çø„É†Áâà„ÅØÂºæ„Åè**
            if [ "$distrib_id" != "OpenWrt" ]; then
                handle_error "Unsupported OpenWrt version: $distrib_id (Only OpenWrt - supported)"
                exit 1  # üö® „Çπ„ÇØ„É™„Éó„ÉàÂÖ®‰Ωì„ÇíÁµÇ‰∫Ü
            fi

            if grep -q "DISTRIB_RELEASE=" /etc/openwrt_release; then
                raw_version=$(awk -F"'" '/DISTRIB_RELEASE/ {print $2}' /etc/openwrt_release)
            fi
        fi

        # **‚ë° /etc/openwrt_version „ÅåÂ≠òÂú®„Åô„Çå„Å∞‰ΩøÁî®**
        if [ -z "$raw_version" ] && [ -f "/etc/openwrt_version" ]; then
            raw_version=$(cat /etc/openwrt_version)
        fi

        # **‚ë¢ „Éê„Éº„Ç∏„Éß„É≥„ÅåÂèñÂæó„Åß„Åç„Å™„Åë„Çå„Å∞„Çπ„ÇØ„É™„Éó„ÉàÂÖ®‰Ωì„ÇíÁµÇ‰∫Ü**
        if [ -z "$raw_version" ]; then
            handle_error "Could not determine OpenWrt version. Check system files."
            exit 1  # üö® „Çπ„ÇØ„É™„Éó„ÉàÂÖ®‰Ωì„ÇíÁµÇ‰∫Ü
        fi

        # **‚ë£ „Éê„Éº„Ç∏„Éß„É≥Ë°®Ë®ò„ÅÆÁµ±‰∏Ä**
        CURRENT_VERSION=$(echo "$raw_version" | tr '-' '.')

        # **‚ë§ „Ç≠„É£„ÉÉ„Ç∑„É•„Å´Êõ∏„ÅçÂá∫„Åó**
        echo "$CURRENT_VERSION" > "$version_file"
        chmod 444 "$version_file"  # Ë™≠„ÅøÂèñ„ÇäÂ∞ÇÁî®
    fi

    # **‚ë• „Éá„Éº„Çø„Éô„Éº„Çπ„Å´„Éê„Éº„Ç∏„Éß„É≥„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç**
    if grep -q "^$CURRENT_VERSION=" "${BASE_DIR}/openwrt.db"; then
        local db_entry=$(grep "^$CURRENT_VERSION=" "${BASE_DIR}/openwrt.db" | cut -d'=' -f2)
        PACKAGE_MANAGER=$(echo "$db_entry" | cut -d'|' -f1)
        VERSION_STATUS=$(echo "$db_entry" | cut -d'|' -f2)
        echo -e "$(color green "OpnWrt version: $CURRENT_VERSION - supported ($VERSION_STATUS)")"
    else
        handle_error "Unsupported OpenWrt version: $CURRENT_VERSION"
        exit 1  # üö® „Çπ„ÇØ„É™„Éó„ÉàÂÖ®‰Ωì„ÇíÁµÇ‰∫Ü
    fi
}

#########################################################################
# check_architecture: OpenWrt„ÅÆ„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£„ÇíÁ¢∫Ë™ç„Éª„Ç≠„É£„ÉÉ„Ç∑„É•
#########################################################################
check_architecture() {
    local arch_file="${CACHE_DIR}/architecture.ch"

    # **„Ç≠„É£„ÉÉ„Ç∑„É•„Åå„ÅÇ„Çå„Å∞ÂÜçÂèñÂæó„Åó„Å™„ÅÑ**
    if [ -f "$arch_file" ]; then
        arch=$(cat "$arch_file" | tr -d '\r')
        debug_log "DEBUG" "Using cached architecture: $arch"
        return 0
    fi

    # **„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£„ÇíÂèñÂæó**
    local arch=$(uname -m)

    # **„Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠òÔºà„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£Âêç„ÅÆ„ÅøÔºâ**
    echo "$arch" > "$arch_file"

    debug_log "DEBUG" "Architecture detected: $arch"
}

#########################################################################
# check_downloader: „Éë„ÉÉ„Ç±„Éº„Ç∏„Éû„Éç„Éº„Ç∏„É£„ÉºÂà§ÂÆöÔºàapk / opkg ÂØæÂøúÔºâ
#########################################################################
check_downloader() {
    if [ -f "${BASE_DIR}/downloader.ch" ]; then
        PACKAGE_MANAGER=$(cat "${CACHE_DIR}/downloader.ch")
        PACKAGE_EXTENSION=$(cat "${CACHE_DIR}/extension.ch")
    else
        if command -v apk >/dev/null 2>&1; then
            PACKAGE_MANAGER="apk"
            PACKAGE_EXTENSION="apk"
        elif command -v opkg >/dev/null 2>&1; then
            PACKAGE_MANAGER="opkg"
            PACKAGE_EXTENSION="ipk"
        else 
            PACKAGE_MANAGER="opkg"  # „Éá„Éï„Ç©„É´„Éà„Çí„Çª„ÉÉ„Éà
            PACKAGE_EXTENSION="ipk" 
        fi
        echo "$PACKAGE_MANAGER" > "${CACHE_DIR}/downloader.ch"
        echo "$PACKAGE_EXTENSION" > "${CACHE_DIR}/extension.ch"
    fi
    echo -e "$(color green "Package Manager: $PACKAGE_MANAGER - supported (stable)")"
    echo -e "$(color green "Package Extension: $PACKAGE_EXTENSION - supported (stable)")"
}

#########################################################################
# Last Update: 2025-02-18 18:00:00 (JST) üöÄ
# "Efficiency in retrieval, clarity in communication."
# get_message: „Ç∑„Çπ„ÉÜ„É†„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
#
# „ÄêË¶Å‰ª∂„Äë
# 1. **„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂèñÂæó„É≠„Ç∏„ÉÉ„ÇØ**
#    - `$ACTIVE_LANGUAGE` „ÇíÊúÄÂÑ™ÂÖà„Åß‰ΩøÁî®Ôºà`normalize_language()` „ÅßË®≠ÂÆöÔºâ
#    - `$ACTIVE_LANGUAGE` „ÅåÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„ÅØ `US` „Çí„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Å®„Åó„Å¶‰ΩøÁî®
#
# 2. **„É°„ÉÉ„Çª„Éº„Ç∏Ê§úÁ¥¢„ÅÆÈ†ÜÂ∫è**
#    ‚ë† `$ACTIVE_LANGUAGE|„Ç≠„Éº=` „Åß `messages.db` „ÇíÊ§úÁ¥¢
#    ‚ë° `US|„Ç≠„Éº=` „Åß `messages.db` „ÇíÊ§úÁ¥¢Ôºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
#    ‚ë¢ „Å©„Å°„Çâ„Å´„ÇÇË©≤ÂΩì„Åó„Å™„ÅÑÂ†¥Âêà„ÄÅ`„Ç≠„Éº` „Çí„Åù„ÅÆ„Åæ„ÅæËøî„Åô
#
# 3. **Âãï‰Ωú„ÅÆÊúÄÈÅ©Âåñ**
#    - `$ACTIVE_LANGUAGE` „ÇíÁõ¥Êé•ÂèÇÁÖß„Åó„ÄÅ„Ç≠„É£„ÉÉ„Ç∑„É• (`message.ch`) „Å´„ÅØ‰æùÂ≠ò„Åó„Å™„ÅÑ
#    - `$quiet_flag` „Å´ `"quiet"` „ÅåÊåáÂÆö„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂá∫Âäõ„Åõ„Åö„Å´ `return 0`
#
# 4. **„É°„É≥„ÉÜ„Éä„É≥„Çπ**
#    - Ë®ÄË™ûÂèñÂæó„É≠„Ç∏„ÉÉ„ÇØ„Çí `normalize_language()` „Å´Áµ±‰∏Ä„Åó„ÄÅË≤¨Âãô„ÇíÂàÜÈõ¢
#    - `get_message()` „ÅØ„ÄåÂèñÂæó„Åô„Çã„Å†„Åë„Äç„Å´ÁâπÂåñ„Åó„ÄÅÊõ∏„ÅçËæº„Åø„ÉªË®≠ÂÆö„ÅØË°å„Çè„Å™„ÅÑ
#
# 5. **ÂΩ±ÈüøÁØÑÂõ≤**
#    - `common.sh` ÂÜÖ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ÂèñÂæóÂÖ®Ëà¨Ôºà`debug_log()` Âê´„ÇÄÔºâ
#    - `messages.db` „ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÂ§âÊõ¥ÊôÇ„ÇÇ `get_message()` „ÅÆ‰øÆÊ≠£„ÅØ‰∏çË¶Å
#########################################################################
get_message() {
    local key="$1"
    local params="$2"
    local quiet_flag="$3"
    local message_db="${BASE_DIR}/messages.db"
    local message_cache="${CACHE_DIR}/message.ch"
    local lang="US"  # „Éá„Éï„Ç©„É´„Éà„ÅØUS

    # message.ch„Åã„ÇâË®ÄË™û„ÇíË™≠„ÅøÂèñ„Çã
    if [ -f "$message_cache" ]; then
        lang=$(cat "$message_cache")
    fi

    # `messages.db` „ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÄÅ„Ç≠„Éº„Åù„ÅÆ„Åæ„Åæ„ÇíËøî„Åô
    if [ ! -f "$message_db" ]; then
        message="$key"
    else
        # Ë®ÄË™ûÂÑ™ÂÖàÊ§úÁ¥¢
        message=$(grep "^${lang}|${key}=" "$message_db" | cut -d'=' -f2-)

        # „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÊ§úÁ¥¢
        if [ -z "$message" ]; then
            message=$(grep "^US|${key}=" "$message_db" | cut -d'=' -f2-)
        fi

        # „Åù„Çå„Åß„ÇÇË¶ã„Å§„Åã„Çâ„Å™„Åë„Çå„Å∞„ÄÅ„Ç≠„Éº„Åù„ÅÆ„Åæ„Åæ„ÇíËøî„Åô
        if [ -z "$message" ]; then
            message="$key"
        fi
    fi

    # „Éë„É©„É°„Éº„ÇøÁΩÆÊèõ
    if [ -n "$params" ]; then
        for param in $params; do
            key=$(echo "$param" | cut -d'=' -f1)
            value=$(echo "$param" | cut -d'=' -f2)
            # `sed` „Ç≥„Éû„É≥„Éâ„Åß‰ΩøÁî®„Åô„ÇãÈöõ„Å´ `value` „Çí„Ç®„Çπ„Ç±„Éº„Éó„Åô„Çã
            escaped_value=$(echo "$value" | sed -e 's/[\/&]/\\&/g')
            message=$(echo "$message" | sed -e "s/{$key}/$escaped_value/g")
        done
    fi

    # quiet „É¢„Éº„ÉâÂØæÂøú
    if [ "$quiet_flag" = "quiet" ]; then
        return 0
    else
        echo "$message"
    fi
}

# üîµ„ÄÄ„Éà„Éº„ÇØ„É≥Á≥ª„ÄÄ„Åì„Åì„Åã„Çâ„ÄÄüîµ„ÄÄ-------------------------------------------------------------------------------------------------------------------------------------------

# GitHub APIÂëº„Å≥Âá∫„ÅóÔºà„Éá„Éê„ÉÉ„Ç∞Âº∑ÂåñÁâàÔºâ
github_api_request() {
    local endpoint="$1"
    local token=$(get_github_token)
    local response=""
    
    if [ -n "$token" ]; then
        debug_log "DEBUG" "Attempting authenticated request with token (${#token} chars)"
        response=$(wget -q --header="Authorization: token $token" \
            --header="Accept: application/vnd.github.v3+json" \
            -O- "https://api.github.com/$endpoint" 2>/dev/null)
            
        # „É¨„Çπ„Éù„É≥„ÇπÊ§úË®º - „É™„Éü„ÉÉ„Éà„ÉÅ„Çß„ÉÉ„ÇØ
        if echo "$response" | grep -q '"message":"API rate limit exceeded'; then
            debug_log "WARN" "GitHub API rate limit exceeded"
            return 1
        fi
        
        # Ë™çË®º„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ
        if echo "$response" | grep -q '"message":"Bad credentials"'; then
            debug_log "ERROR" "GitHub API authentication failed: Bad credentials"
            return 2
        fi
        
        # „Åù„ÅÆ‰ªñ„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ
        if echo "$response" | grep -q '"message":"'; then
            local error_msg=$(echo "$response" | grep -o '"message":"[^"]*"' | cut -d':' -f2- | tr -d '"')
            debug_log "ERROR" "GitHub API error: $error_msg"
            return 3
        fi
        
        # ÊàêÂäü
        echo "$response"
        return 0
    else
        debug_log "DEBUG" "No token found, using unauthenticated request"
        wget -q -O- "https://api.github.com/$endpoint" 2>/dev/null
        return $?
    fi
}

# „Éà„Éº„ÇØ„É≥ÂèñÂæóÈñ¢Êï∞
get_github_token() {
    if [ -f "$GITHUB_TOKEN_FILE" ] && [ -r "$GITHUB_TOKEN_FILE" ]; then
        # Âé≥Ê†º„Å™„Éà„Éº„ÇØ„É≥ÊäΩÂá∫„Å®Ê§úË®º
        local raw_token=$(cat "$GITHUB_TOKEN_FILE")
        local token=$(echo "$raw_token" | tr -d '\n\r\t ' | grep -o '^[a-zA-Z0-9_]\+')
        
        if [ -n "$token" ] && [ ${#token} -ge 30 ]; then
            echo "$token"
            return 0
        else
            debug_log "WARN" "Invalid token format in $GITHUB_TOKEN_FILE"
        fi
    fi
    return 1
}

# „Éà„Éº„ÇØ„É≥‰øùÂ≠òÈñ¢Êï∞
save_github_token() {
    token="$1"
    
    if [ -z "$token" ]; then
        debug_log "ERROR" "Empty token provided, cannot save"
        return 1
    fi
    
    # „Éà„Éº„ÇØ„É≥„Çí‰øùÂ≠ò„Åó„Å¶Ê®©Èôê„ÇíË®≠ÂÆö
    echo "$token" > "$GITHUB_TOKEN_FILE"
    chmod 600 "$GITHUB_TOKEN_FILE"
    
    if [ $? -eq 0 ]; then
        debug_log "INFO" "GitHub token saved to $GITHUB_TOKEN_FILE"
        return 0
    else
        debug_log "ERROR" "Failed to save token to $GITHUB_TOKEN_FILE"
        return 1
    fi
}

# GitHub APIÂëº„Å≥Âá∫„ÅóÔºà„Éà„Éº„ÇØ„É≥ÂØæÂøúÁâàÔºâ
github_api() {
    endpoint="$1"
    
    # „Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó
    token=$(get_github_token)
    
    if [ -n "$token" ]; then
        # „Éà„Éº„ÇØ„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË™çË®º‰ªò„Åç„É™„ÇØ„Ç®„Çπ„Éà
        debug_log "DEBUG" "Using authenticated GitHub API request"
        wget -qO- --header="Authorization: token $token" \
            "https://api.github.com/$endpoint" 2>/dev/null
    else
        # „Éà„Éº„ÇØ„É≥„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÂ∏∏„É™„ÇØ„Ç®„Çπ„Éà
        debug_log "DEBUG" "Using unauthenticated GitHub API request"
        wget -qO- "https://api.github.com/$endpoint" 2>/dev/null
    fi
}

# „Éà„Éº„ÇØ„É≥Ë®≠ÂÆö„Ç≥„Éû„É≥„ÉâÔºàOpenWrt‰∫íÊèõÊÄßÂº∑ÂåñÁâàÔºâ
setup_github_token() {
    echo "GitHub API Token Setup"
    echo "======================"
    echo "This will save a GitHub Personal Access Token to $GITHUB_TOKEN_FILE"
    echo "The token will be used for API requests to avoid rate limits."
    echo ""
    
    # stty„ÅåÂà©Áî®ÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    if command -v stty >/dev/null 2>&1; then
        # stty„ÅåÂà©Áî®ÂèØËÉΩ„Å™Â†¥Âêà„ÄÅÈùûË°®Á§∫„É¢„Éº„Éâ„Çí‰ΩøÁî®
        printf "Enter your GitHub Personal Access Token: "
        stty -echo
        read -r token
        stty echo
        echo ""  # ÊîπË°å
    else
        # stty„ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅÆ‰ª£ÊõøÊñπÊ≥ï
        echo "NOTE: Your input will be visible as you type (stty not available)"
        printf "Enter your GitHub Personal Access Token: "
        read -r token
        echo ""
    fi
    
    if [ -n "$token" ]; then
        if save_github_token "$token"; then
            echo "Token has been saved successfully!"
            echo "API requests will now use authentication."
        else
            echo "Failed to save token. Please check permissions."
        fi
    else
        echo "No token entered. Operation cancelled."
    fi
}

# üî¥„ÄÄ„Éà„Éº„ÇØ„É≥Á≥ª„ÄÄ„Åì„Åì„Åæ„Åß„ÄÄüî¥-------------------------------------------------------------------------------------------------------------------------------------------


# üîµ„ÄÄ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁ≥ª„ÄÄ„Åì„Åì„Åã„Çâ„ÄÄüîµ„ÄÄ-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# Last Update: 2025-02-18 23:00:00 (JST) üöÄ
# "Standardizing version formatting for consistency."
#
# „ÄêË¶Å‰ª∂„Äë
# 1. **„Éê„Éº„Ç∏„Éß„É≥Áï™Âè∑„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíÁµ±‰∏Ä**
#    - `YYYY.MM.DD-Ëá™Áî±ÂΩ¢Âºè`
#    - `YYYYMMDDHHMMSS-Ëá™Áî±ÂΩ¢Âºè`
#    - Ë®±ÂèØ„Åï„Çå„ÇãÂå∫Âàá„ÇäÊñáÂ≠ó: `- . , ; : Á©∫ÁôΩ`
#
# 2. **Âá¶ÁêÜÂÜÖÂÆπ**
#    - **Ë®±ÂèØ„Åï„Çå„ÅüÊñáÂ≠ó„ÅÆ„Åø„ÇíÊäΩÂá∫**
#    - **ÂÖàÈ†≠„ÅÆ„Çº„É≠„ÇíÂâäÈô§Ôºà‰æã: `02` ‚Üí `2`Ôºâ**
#    - **ÂâçÂæå„ÅÆ‰ΩôË®à„Å™„Çπ„Éö„Éº„Çπ„ÇíÂâäÈô§**
#
# 3. **ÈÅ©Áî®ÂØæË±°**
#    - **`download()`**: **„Çπ„ÇØ„É™„Éó„Éà„Éê„Éº„Ç∏„Éß„É≥„ÅÆÂèñÂæó„ÉªÊØîËºÉ**
#    - **`compare_versions()`**: **„Éê„Éº„Ç∏„Éß„É≥ÊØîËºÉÊôÇ„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÁµ±‰∏Ä**
#
# 4. **ÈÅ©Áî®„Åó„Å™„ÅÑÂØæË±°**
#    - **„Éê„Éº„Ç∏„Éß„É≥Áï™Âè∑„ÅÆËß£Èáà„ÇíÂ§âÊõ¥„Åó„Å™„ÅÑÔºàÈ†ÜÁï™„ÅÆÂÖ•„ÇåÊõø„Åà„ÅØ„Åó„Å™„ÅÑÔºâ**
#    - **Êó•‰ªò‰ª•Â§ñ„ÅÆÊñáÂ≠óÂàó„ÅØÂâäÈô§„Åõ„Åö„ÄÅ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅÆÊ®ôÊ∫ñÂåñ„ÅÆ„ÅøË°å„ÅÜ**
#
# 5. **‰æùÂ≠òÈñ¢‰øÇ**
#    - `normalize_input()` „Çí‰ΩøÁî®„Åó„ÄÅiconv „Å´„Çà„ÇãÂá¶ÁêÜ„ÇíÁµ±‰∏Ä
#
# 6. **ÂΩ±ÈüøÁØÑÂõ≤**
#    - `common.sh` „Å´Áµ±Âêà„Åó„ÄÅ`download()` & `compare_versions()` „Åß‰ΩøÁî®
#########################################################################
# Last Update: 2025-03-04 12:45:00 (JST) üöÄ
# "Efficient downloading with precise versioning and silent modes."
#
# „ÄêË¶Å‰ª∂„Äë
# 1. BASE_WGET „Çí‰ΩøÁî®„Åó„Å¶„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„Çã„ÄÇ
# 2. hidden „Ç™„Éó„Ç∑„Éß„É≥:
#    - „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÅÆÊàêÂê¶„É≠„Ç∞„ÇíË®òÈå≤„Åô„Çã„Åå„ÄÅÊó¢Â≠ò„Éï„Ç°„Ç§„É´„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂá∫Âäõ„ÇíÊäëÂà∂„Åô„Çã„ÄÇ
# 3. quiet „Ç™„Éó„Ç∑„Éß„É≥:
#    - check_option() „ÅßË®≠ÂÆö„Åï„Çå„Åü QUIET_MODE „Å´Âæì„ÅÑ„ÄÅ„Åô„Åπ„Å¶„ÅÆ„É≠„Ç∞„ÇíÊäëÂà∂„Åô„Çã„ÄÇ
# 4. chmod „Ç™„Éó„Ç∑„Éß„É≥:
#    - „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂæå„ÄÅÂØæË±°„Éï„Ç°„Ç§„É´„Å´ÂÆüË°åÊ®©Èôê (chmod +x) „Çí‰ªò‰∏é„Åô„Çã„ÄÇ
# 5. read „Ç™„Éó„Ç∑„Éß„É≥:
#    - „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂæå„ÄÅÂØæË±°„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄÔºàsourceÔºâ„Åô„Çã„ÄÇÔºà„Åü„Å†„Åó„ÄÅ„Éï„Ç°„Ç§„É´Âêç„Åå *common*.sh „Å´‰∏ÄËá¥„Åô„ÇãÂ†¥Âêà„ÅØËá™Âãï„ÅßË™≠„ÅøËæº„ÇÄÔºâ
#    - „Éá„Éï„Ç©„É´„Éà„Åß„ÅØË™≠„ÅøËæº„Åæ„Å™„ÅÑ„ÄÇ
# 6. ÂºïÊï∞„ÅÆÈ†ÜÂ∫è„ÅØËá™Áî±Ôºàhidden, quiet, chmod, read „ÅÆÈ†ÜÁï™„ÅØ‰ªªÊÑèÔºâ„ÄÇ
# 7. wget „ÅÆ„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÇíË°å„ÅÑ„ÄÅÂ§±ÊïóÊôÇ„ÅÆË©≥Á¥∞„Çí debug_log() „Å´Ë®òÈå≤„Åô„Çã„ÄÇ
# 8. ÂΩ±ÈüøÁØÑÂõ≤: common.sh „ÅÆ download() „ÅÆ„ÅøÔºà‰ªñ„ÅÆÈñ¢Êï∞„Å´„ÅØÂΩ±Èüø„Å™„ÅóÔºâ„ÄÇ
#########################################################################
decode_base64() {
    input="$1"
    output=""
    decoder_type=""
    base64_cache="${CACHE_DIR}/base64.ch"
    
    # „Ç≠„É£„ÉÉ„Ç∑„É•„Éï„Ç°„Ç§„É´„Åã„Çâ‰ª•ÂâçÊ§úÂá∫„Åó„Åü„Éá„Ç≥„Éº„ÉÄ„Éº„ÇíÁ¢∫Ë™ç
    if [ -f "$base64_cache" ]; then
        # shellcheck disable=SC1090
        . "$base64_cache"
        debug_log "DEBUG" "base64: using cached decoder: $BASE64_DECODER"
    else
        # Âà©Áî®ÂèØËÉΩ„Å™„Éá„Ç≥„Éº„ÉÄ„Éº„ÇíÊ§úÁ¥¢
        if command -v base64 >/dev/null 2>&1; then
            BASE64_DECODER="coreutils"
            debug_log "DEBUG" "base64: found coreutils-base64"
        elif command -v openssl >/dev/null 2>&1; then
            BASE64_DECODER="openssl" 
            debug_log "DEBUG" "base64: found openssl"
        else
            debug_log "WARN" "base64: no decoder found, attempting to install coreutils-base64"
            
            # DEBUG„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØÈÄöÂ∏∏Ë°®Á§∫„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØ„Çµ„Ç§„É¨„É≥„Éà
            if [ "$DEBUG_MODE" = "true" ]; then
                debug_log "INFO" "Running: opkg update"
                opkg update
                debug_log "INFO" "Running: opkg install coreutils-base64"
                opkg install coreutils-base64
            else
                # „Çµ„Ç§„É¨„É≥„Éà„Åß„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí„Ç§„É≥„Çπ„Éà„Éº„É´Ë©¶Ë°å
                opkg update >/dev/null 2>&1
                opkg install coreutils-base64 >/dev/null 2>&1
            fi
            
            # „Ç§„É≥„Çπ„Éà„Éº„É´ÊàêÂäü„Åó„Åü„ÅãÁ¢∫Ë™ç
            if command -v base64 >/dev/null 2>&1; then
                BASE64_DECODER="coreutils"
                debug_log "INFO" "base64: successfully installed coreutils-base64"
            else
                debug_log "ERROR" "base64: failed to install decoder, decode operation will fail"
                BASE64_DECODER="none"
            fi
        fi
        
        # Ê§úÂá∫ÁµêÊûú„Çí„Ç≠„É£„ÉÉ„Ç∑„É•„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò
        mkdir -p "$CACHE_DIR"
        echo "BASE64_DECODER=\"$BASE64_DECODER\"" > "$base64_cache"
    fi
    
    # „Éá„Ç≥„Éº„ÉâÂÆüË°å
    case "$BASE64_DECODER" in
        "coreutils")
            output=$(echo "$input" | base64 -d 2>/dev/null)
            decoder_type="coreutils-base64"
            ;;
        "openssl")
            output=$(echo "$input" | openssl base64 -d 2>/dev/null)
            decoder_type="openssl"
            ;;
        *)
            debug_log "ERROR" "base64: no decoder available"
            return 1
            ;;
    esac
    
    # ÁµêÊûú„ÇíÁ¢∫Ë™ç
    if [ $? -eq 0 ] && [ -n "$output" ]; then
        debug_log "DEBUG" "base64: decoded with $decoder_type"
        echo "$output"
        return 0
    else
        debug_log "ERROR" "base64: decode failed with $decoder_type"
        return 1
    fi
}

# „Éà„Éº„ÇØ„É≥Ë™çË®ºÁä∂ÊÖã„ÇíÁ¢∫Ë™ç„Åô„ÇãÈñ¢Êï∞
check_token_status() {
    echo "========== GitHub Token Status =========="
    
    # „Éà„Éº„ÇØ„É≥„Éï„Ç°„Ç§„É´„ÅÆÂ≠òÂú®Á¢∫Ë™ç
    if [ -f "$GITHUB_TOKEN_FILE" ]; then
        echo "Token file: $GITHUB_TOKEN_FILE (EXISTS)"
        ls -l "$GITHUB_TOKEN_FILE"
        
        # „Éà„Éº„ÇØ„É≥„ÅÆÂÖàÈ†≠ÈÉ®ÂàÜ„Å†„Åë„ÇíË°®Á§∫Ôºà„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÅÆ„Åü„ÇÅÔºâ
        local token_preview=$(head -c 5 "$GITHUB_TOKEN_FILE")
        echo "Token starts with: ${token_preview}..."
    else
        echo "Token file: $GITHUB_TOKEN_FILE (NOT FOUND)"
    fi
    
    # „É¨„Éº„ÉàÂà∂Èôê„ÅÆÁ¢∫Ë™ç
    local token=$(get_github_token)
    local rate_info=""
    
    if [ -n "$token" ]; then
        rate_info=$(wget -qO- --header="Authorization: token $token" \
            "https://api.github.com/rate_limit" 2>/dev/null)
        echo "Using token authentication"
    else
        rate_info=$(wget -qO- "https://api.github.com/rate_limit" 2>/dev/null)
        echo "Using standard authentication"
    fi
    
    if [ -n "$rate_info" ]; then
        echo -n "Current rate limit: "
        echo "$rate_info" | grep -o '"limit":[0-9]*' | head -1 | cut -d':' -f2
        
        echo -n "Remaining requests: "
        echo "$rate_info" | grep -o '"remaining":[0-9]*' | head -1 | cut -d':' -f2
        
        # Ë™çË®ºÁä∂ÊÖã„ÅÆÂà§Êñ≠
        if echo "$rate_info" | grep -q '"limit":5000'; then
            echo "Auth status: ‚úÖ AUTHENTICATED (Higher limits active)"
        else
            echo "Auth status: ‚ùå UNAUTHENTICATED (Standard limits)"
        fi
    else
        echo "Could not retrieve rate limit information"
    fi
    
    echo "========================================"
}

# API„É¨„Éº„ÉàÂà∂ÈôêÁ¢∫Ë™çÈñ¢Êï∞
check_api_rate_limit() {
    if [ "$DEBUG_MODE" = "true" ]; then
        api_info=$(wget -qO- "https://api.github.com/rate_limit" 2>/dev/null)
        if [ -n "$api_info" ]; then
            api_remaining=$(echo "$api_info" | grep -o '"core":{"limit":[0-9]*,"remaining":[0-9]*' | grep -o 'remaining":[0-9]*' | cut -d':' -f2)
            api_limit=$(echo "$api_info" | grep -o '"core":{"limit":[0-9]*,"remaining":[0-9]*' | grep -o 'limit":[0-9]*' | cut -d':' -f2)
            api_reset=$(echo "$api_info" | grep -o '"reset":[0-9]*' | head -1 | cut -d':' -f2)
            api_now=$(date +%s)
            
            if [ -n "$api_reset" ] && [ -n "$api_now" ]; then
                api_seconds=$(expr "$api_reset" - "$api_now")
                [ "$api_seconds" -lt 0 ] && api_seconds=0
                api_minutes=$(expr "$api_seconds" / 60)
                api_seconds=$(expr "$api_seconds" % 60)
                debug_log "DEBUG" "API Limits: Core ${api_remaining:-?}/${api_limit:-?}, Reset in ${api_minutes}m ${api_seconds}s"
            fi
        fi
    fi
    return 0
}

# „Éê„Éº„Ç∏„Éß„É≥ÊñáÂ≠óÂàó„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Åô„ÇãÈñ¢Êï∞
clean_version_string() {
    local version_str="$1"
    
    # 1. ÊîπË°å„Å®Âæ©Â∏∞„ÇíÂâäÈô§
    local cleaned=$(echo "$version_str" | tr -d '\n\r')
    
    # 2. ËßíÊã¨Âºß„ÇíÂâäÈô§
    cleaned=$(echo "$cleaned" | sed 's/\[//g' | sed 's/\]//g')
    
    # 3. ANSI„Ç®„Çπ„Ç±„Éº„Éó„Ç≥„Éº„Éâ„ÇíÂâäÈô§ÔºàË§áÊï∞„Éë„Çø„Éº„É≥ÂØæÂøúÔºâ
    cleaned=$(echo "$cleaned" | sed -e 's/\x1b\[[0-9;]*m//g' -e 's/[0-9]\+;[0-9]\+m//g')
    
    # 4. ‰∏çÂøÖË¶Å„Å™ÈáçË§á„ÇíÂâäÈô§ÔºàÊó•‰ªò„ÅÆÈáçË§á„Å™„Å©Ôºâ
    cleaned=$(echo "$cleaned" | sed -e 's/\(20[0-9][0-9]-[0-9][0-9]-[0-9][0-9]\)\1*/\1/g' -e 's/\(20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]\)\1*/\1/g')
    
    # 5. „Éê„Éº„Ç∏„Éß„É≥„ÅÆ‰∏ÄËà¨ÁöÑ„Å™„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Å†„Åë„ÇíÊäΩÂá∫ÔºàÊó•‰ªò-„Éè„ÉÉ„Ç∑„É•ÂÄ§Ôºâ
    local version_pattern=$(echo "$cleaned" | grep -o '20[0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]-[0-9a-zA-Z]\+' | head -1)
    
    # „Éë„Çø„Éº„É≥„ÅåË¶ã„Å§„Åã„Å£„ÅüÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®„ÄÅË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÇØ„É™„Éº„É≥Âåñ„Åó„ÅüÊñáÂ≠óÂàó„ÇíËøî„Åô
    if [ -n "$version_pattern" ]; then
        echo "$version_pattern"
    else
        echo "$cleaned"
    fi
}

# GitHub„Ç≥„Éü„ÉÉ„Éà„Åã„Çâ„Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÇíÂèñÂæó
get_commit_version() {
    local file_path="$1"
    local repo_owner="site-u2023"
    local repo_name="aios"
    local endpoint="repos/${repo_owner}/${repo_name}/commits?path=${file_path}&per_page=1"
    local auth_method="direct"
    
    # APIÂëº„Å≥Âá∫„Åó
    local response=$(github_api_request "$endpoint")
    local api_status=$?

    # „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âü∫„Å•„ÅèË™çË®ºÊñπÊ≥ï„ÅÆÂà§Êñ≠
    case "$api_status" in
        0)  # ÊàêÂäü
            if [ -n "$(get_github_token)" ]; then
                auth_method="token"
                debug_log "INFO" "Using authenticated GitHub API"
            else
                auth_method="standard"
                debug_log "DEBUG" "Using standard GitHub API"
            fi
            ;;
        *)  # Â§±Êïó
            auth_method="failed"
            debug_log "WARN" "API request failed with status $api_status, falling back to direct download"
            ;;
    esac

    # „Éà„Éº„ÇØ„É≥„Å´„Çà„ÇãAPIË™çË®º
    local token=$(get_github_token)
    
    if [ -n "$token" ]; then
        # „Éà„Éº„ÇØ„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË™çË®º‰ªò„Åç„É™„ÇØ„Ç®„Çπ„Éà„ÇíË©¶„Åø„Çã
        debug_log "DEBUG" "Attempting token authentication for API request"
        
        # „Éà„Éº„ÇØ„É≥„ÅÆÊúâÂäπÊÄßÁ¢∫Ë™ç„ÅÆ„Åü„ÇÅ„ÄÅÊòéÁ§∫ÁöÑ„Å™„Éò„ÉÉ„ÉÄ„Éº„ÇíËøΩÂä†
        commit_info=$(wget -qO- --header="Authorization: token $token" \
            --header="Accept: application/vnd.github.v3+json" \
            "https://api.github.com/$api_url" 2>/dev/null)
            
        # „É¨„Éº„ÉàÂà∂ÈôêÊÉÖÂ†±„ÇíÁ¢∫Ë™ç„Åó„Å¶„Éà„Éº„ÇØ„É≥„ÅåÊúâÂäπ„ÅãÂà§Êñ≠
        local rate_limit=$(wget -qO- --header="Authorization: token $token" \
            "https://api.github.com/rate_limit" 2>/dev/null)
        
        if echo "$rate_limit" | grep -q '"limit":5000'; then
            debug_log "INFO" "Token authentication successful - higher rate limits enabled"
            auth_method="token"
        else
            debug_log "WARN" "Token appears valid but standard limits applied"
            auth_method="limited"
        fi
    else
        # „Éà„Éº„ÇØ„É≥„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÂ∏∏„É™„ÇØ„Ç®„Çπ„Éà
        debug_log "DEBUG" "No token found, using standard API request"
        commit_info=$(wget -qO- "https://api.github.com/$api_url" 2>/dev/null)
        auth_method="standard"
    fi
    
    if [ -z "$commit_info" ]; then
        # API„É™„ÇØ„Ç®„Çπ„Éà„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÁõ¥Êé•„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíË©¶„Åø„Çã
        debug_log "WARN" "API request failed, trying direct download"
        commit_info=$(wget -qO- "https://api.github.com/$api_url" 2>/dev/null)
        auth_method="direct"
    fi
    
    if [ -n "$commit_info" ]; then
        # Êó•‰ªò„Å®SHA„ÇíÊäΩÂá∫
        local commit_date=$(echo "$commit_info" | tr -d '\n\r' | grep -o '"date": *"[^"]*"' | head -1 | sed 's/.*"date": *"\([^"]*\)".*/\1/')
        local commit_sha=$(echo "$commit_info" | tr -d '\n\r' | grep -o '"sha": *"[^"]*"' | head -1 | sed 's/.*"sha": *"\([^"]*\)".*/\1/' | cut -c 1-7)
        
        if [ -n "$commit_date" ] && [ -n "$commit_sha" ]; then
            # YYYY.MM.DD-SHA ÂΩ¢Âºè„Å´Â§âÊèõ
            local formatted_date=$(echo "$commit_date" | sed 's/T.*Z//g;s/-/./g')
            local clean_version="${formatted_date}-${commit_sha}"
            
            debug_log "DEBUG" "Successfully extracted commit info: $clean_version via $auth_method"
            echo "$clean_version $auth_method"
            return 0
        fi
        debug_log "DEBUG" "Failed to extract commit info from response"
    else
        debug_log "DEBUG" "No API response received for: $file_path"
    fi
    
    # APIÂèñÂæóÂ§±ÊïóÊôÇ„ÅØÁèæÂú®ÊôÇÂàª„Çí‰ΩøÁî®
    echo "$(date +%Y.%m.%d)-unknown ${auth_method}"
    return 1
}

# „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÇíÂÆâÂÖ®„Å´Êõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞ÔºàÂÆåÂÖ®ÁâàÔºâ
update_file_version() {
    local file_name="$1"
    local version="$2"
    local script_file="$3"
    
    # „Éê„Éº„Ç∏„Éß„É≥ÊñáÂ≠óÂàó„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
    version=$(clean_version_string "$version")
    
    if [ ! -f "$script_file" ]; then
        printf "%s=%s\n" "${file_name}" "${version}" > "$script_file"
        return 0
    fi
    
    # ‰∏ÄÊôÇ„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®„Åó„ÅüÂÆâÂÖ®„Å™Êõ∏„ÅçÊèõ„Åà
    local tmp_file="${script_file}.tmp"
    > "$tmp_file"  # ‰∏ÄÊôÇ„Éï„Ç°„Ç§„É´„ÇíÂàùÊúüÂåñ
    
    if grep -q "^${file_name}=" "$script_file"; then
        # Ë©≤ÂΩìË°å„ÇíÁΩÆÊèõ
        while IFS= read -r line; do
            if echo "$line" | grep -q "^${file_name}="; then
                echo "${file_name}=${version}" >> "$tmp_file"
            else
                echo "$line" >> "$tmp_file"
            fi
        done < "$script_file"
    else
        # „Éï„Ç°„Ç§„É´„Çí„Åù„ÅÆ„Åæ„Åæ„Ç≥„Éî„Éº„Åó„Å¶Êñ∞„Åó„ÅÑ„Ç®„É≥„Éà„É™„ÇíËøΩÂä†
        cat "$script_file" > "$tmp_file"
        echo "${file_name}=${version}" >> "$tmp_file"
    fi
    
    # ‰∏ÄÊôÇ„Éï„Ç°„Ç§„É´„ÇíÂÖÉ„ÅÆ„Éï„Ç°„Ç§„É´„Å´ÁßªÂãï
    mv "$tmp_file" "$script_file"
    
    return 0
}

# „Éê„Éº„Ç∏„Éß„É≥ÊØîËºÉÈñ¢Êï∞
version_is_newer() {
    local current="$1"
    local reference="$2"
    
    # „Å©„Å°„Çâ„Åã„Åå‰∏çÊòé„ÅÆÂ†¥Âêà„ÅØÊõ¥Êñ∞ÂøÖË¶Å
    if echo "$current $reference" | grep -q "No version\|unknown"; then
        return 0
    fi
    
    # Êó•‰ªòÈÉ®ÂàÜ„ÇíÊäΩÂá∫ÔºàYYYY.MM.DDÂΩ¢ÂºèÔºâ- „Çà„ÇäÂ†ÖÁâ¢„Å™ÊñπÊ≥ï
    local current_date=$(echo "$current" | grep -o "[0-9][0-9][0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]" | head -1)
    local reference_date=$(echo "$reference" | grep -o "[0-9][0-9][0-9][0-9]\.[0-9][0-9]\.[0-9][0-9]" | head -1)
    
    # Êó•‰ªò„ÅåÊäΩÂá∫„Åß„Åç„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅØÊõ¥Êñ∞„ÅåÂøÖË¶Å
    if [ -z "$current_date" ] || [ -z "$reference_date" ]; then
        return 0
    fi
    
    # Êó•‰ªò„ÇíÊï∞ÂÄ§„Å´Â§âÊèõÔºàÂå∫Âàá„ÇäÊñáÂ≠ó„ÇíÂâäÈô§Ôºâ
    local current_num=$(echo "$current_date" | tr -d '.')
    local reference_num=$(echo "$reference_date" | tr -d '.')
    
    # Êï∞ÂÄ§ÊØîËºÉÔºàÊó•‰ªòÂΩ¢ÂºèÔºâ
    if [ "$current_num" -gt "$reference_num" ]; then
        return 0  # ÁèæÂú®„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÅåÊñ∞„Åó„ÅÑ
    elif [ "$current_num" -lt "$reference_num" ]; then
        return 1  # „É™„Éï„Ç°„É¨„É≥„Çπ„Éê„Éº„Ç∏„Éß„É≥„ÅåÊñ∞„Åó„ÅÑ
    fi
    
    # Êó•‰ªò„ÅåÂêå„ÅòÂ†¥Âêà„ÅØSHAÈÉ®ÂàÜ„ÇíÊØîËºÉ
    local current_sha=$(echo "$current" | grep -o "\-[a-z0-9]*" | sed 's/^-//' | head -1)
    local reference_sha=$(echo "$reference" | grep -o "\-[a-z0-9]*" | sed 's/^-//' | head -1)
    
    if [ -n "$current_sha" ] && [ -n "$reference_sha" ] && [ "$current_sha" != "$reference_sha" ]; then
        return 0  # Áï∞„Å™„Çã„Ç≥„Éü„ÉÉ„Éà
    fi
    
    return 1  # Âêå‰∏Ä„Éê„Éº„Ç∏„Éß„É≥
}

# „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÈñ¢Êï∞
download() {
    # „Éï„Ç°„Ç§„É´Âêç„ÇíÊúÄÂàù„ÅÆÂºïÊï∞„Å®„Åó„Å¶Âá¶ÁêÜ„ÄÅÊÆã„Çä„ÅØ„Ç™„Éó„Ç∑„Éß„É≥
    local file_name="$1"
    shift
    
    # Ë®≠ÂÆöÂ§âÊï∞
    local hidden_mode="false"
    local quiet_mode="${QUIET_MODE:-false}"
    local chmod_mode="false"
    local read_mode="false"
    local script_file="${CACHE_DIR}/script.ch"
    local dummy_version="No version control"
    
    # „Ç™„Éó„Ç∑„Éß„É≥ÂºïÊï∞„ÅÆÂá¶ÁêÜ
    while [ $# -gt 0 ]; do
        case "$1" in
            hidden) hidden_mode="true" ;;
            quiet)  quiet_mode="true" ;;
            debug)  DEBUG_MODE="true" ;;
            chmod)  chmod_mode="true" ;;
            read)   read_mode="true" ;;
            *)      debug_log "WARN" "Unknown option: $1, ignoring" ;;
        esac
        shift
    done
    
    # „Éë„ÇπË®≠ÂÆö
    local install_path="${BASE_DIR}/$file_name"
    local remote_url="${BASE_URL}/$file_name"
    
    # APIÂà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøÔºâ
    [ "$DEBUG_MODE" = "true" ] && check_api_rate_limit
    
    # „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÅÆÂèñÂæó
    local remote_version_info=$(get_commit_version "$file_name")
    local remote_version=$(printf "%s" "$remote_version_info" | cut -d' ' -f1)
    local auth_method=$(printf "%s" "$remote_version_info" | cut -d' ' -f2)
    local local_version=""
    
    # „É≠„Éº„Ç´„É´„Éê„Éº„Ç∏„Éß„É≥„ÅÆÂèñÂæó
    if [ -f "$script_file" ]; then
        local_version=$(grep "^${file_name}=" "$script_file" | cut -d'=' -f2)
    fi
    [ -z "$local_version" ] && local_version="$dummy_version"

    local clean_remote_version=$(clean_version_string "$remote_version")
    local clean_local_version=$(clean_version_string "$local_version")

    # Ë™çË®º„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË®≠ÂÆö
    local auth_message=""
    case "$auth_method" in
        token)    auth_message="via token auth" ;;
        standard) auth_message="via standard API" ;;
        *)        auth_message="via direct download" ;;
    esac
    
    # „Éê„Éº„Ç∏„Éß„É≥ÊØîËºÉ„Å®„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂà§Êñ≠
    local status_message="No update needed"
    local update_required=false
    
    if [ "$local_version" = "$dummy_version" ]; then
        update_required=true
    else
        version_is_newer "$remote_version" "$local_version"
        [ $? -eq 0 ] && update_required=true
    fi
    
    debug_log "DEBUG" "Remote version: $file_name - $clean_remote_version"
    debug_log "DEBUG" "Local version: $file_name - $clean_local_version"
    debug_log "DEBUG" "Update required: $file_name -$(printf "%s" "$update_required")"
    
    if [ "$update_required" = "true" ]; then
        # „Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        if ! $BASE_WGET "$install_path" "$remote_url"; then
            debug_log "ERROR" "Download failed: $file_name is empty"
            return 1
        fi
        
        # „Éï„Ç°„Ç§„É´Ê§úË®º
        if [ ! -s "$install_path" ]; then
            debug_log "ERROR" "Download failed: $file_name is empty"
            return 1
        fi
        
        # Ê®©ÈôêË®≠ÂÆö
        if [ "$chmod_mode" = "true" ]; then
            chmod +x "$install_path"
            debug_log "DEBUG" "chmod +x applied to $file_name"
        fi
        
    	# „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
    	if [ ! -f "$script_file" ]; then
            printf "%s=%s\n" "${file_name}" "${clean_remote_version}" > "$script_file"
    	else
            if grep -q "^${file_name}=" "$script_file"; then
                # „Ç®„Çπ„Ç±„Éº„ÉóÂá¶ÁêÜ„ÇíÊîπËâØ
                escaped_file=$(echo "$file_name" | sed 's/[\/&]/\\&/g')
                escaped_version=$(echo "$clean_remote_version" | sed 's/[\/&]/\\&/g')
                sed -i "s/^${escaped_file}=.*/${escaped_file}=${escaped_version}/" "$script_file"
            else
                printf "%s=%s\n" "${file_name}" "${clean_remote_version}" >> "$script_file"
            fi
        fi
    
        # „Çπ„ÉÜ„Éº„Çø„Çπ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ‰øÆÊ≠£
        status_message="Download completed"
    fi
    
    # Ë™≠„ÅøËæº„ÅøÂá¶ÁêÜ
    local action_message=""
    if [ "$read_mode" = "true" ] || echo "$file_name" | grep -q "common.*\\.sh"; then
        . "$install_path"
        action_message="Loaded"
    fi
    
    # Âá∫Âäõ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ‰øÆÊ≠£
    local message="${file_name}: ${status_message} - Version: ${clean_remote_version} ${auth_message}"
    if [ -n "$action_message" ]; then
        message="${message} (${action_message})"
    fi

    # Âá∫Âäõ
    if [ "$hidden_mode" = "true" ]; then
        echo -e "$(color green "${message}")"
    else
        debug_log "DEBUG" "Quiet mode ${message}"
    fi
    
    return 0
}

# üî¥„ÄÄ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁ≥ª„ÄÄ„Åì„Åì„Åæ„Åß„ÄÄüî¥„ÄÄ-------------------------------------------------------------------------------------------------------------------------------------------

# üîµ„ÄÄ„É°„Ç§„É≥„ÄÄ„Åì„Åì„Åã„Çâ„ÄÄüîµ„ÄÄ-------------------------------------------------------------------------------------------------------------------------------------------
#########################################################################
# „Éê„Éä„ÉºË°®Á§∫
#########################################################################
print_banner() {
    echo
    color magenta "                    ii i"
    color blue    "         aaaa      iii       oooo      sssss"
    color cyan    "            aa      ii      oo  oo    ss"
    color green   "         aaaaa      ii      oo  oo     sssss"
    color yellow  "        aa  aa      ii      oo  oo         ss"
    color red     "         aaaaa     iiii      oooo     ssssss"
    echo
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_DECCRIPTION")")"
    printf "%s\n" "$(color white "$(get_message "MSG_BANNER_NAME")")"
    printf "%s\n" "$(color red "$(get_message "MSG_BANNER_DISCLAIMER")")"
}

#########################################################################
# „Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´ („Ç™„Éó„Ç∑„Éß„É≥)
# „ÉÜ„Çπ„ÉàÁî®ÔºàÊúÄÁµÇÁöÑ„Å´Êé®Â•®„Éë„ÉÉ„Ç±„Éº„Ç∏„Çπ„ÇØ„É™„Éó„Éà„Å´ÁßªÂãïÔºâ
#########################################################################
packages() {
    # „Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
    #install_package luci yn hidden
    install_package ttyd yn hidden
    install_package luci-app-ttyd yn hidden
    install_package luci-i18n-ttyd yn hidden
    install_package openssh-sftp-server yn hidden
    install_package luci-mod-dashboard yn hidden
    #install_package coreutils yn hidden
    install_package irqbalance yn hidden

    feed_package gSpotx2f packages-openwrt current luci-app-cpu-perf yn hidden
    feed_package gSpotx2f packages-openwrt current luci-app-cpu-status yn hidden
    feed_package gSpotx2f packages-openwrt current luci-app-temp-status yn hidden
    feed_package gSpotx2f packages-openwrt current luci-app-log-viewer yn hidden
    feed_package gSpotx2f packages-openwrt current luci-app-log yn hidden
    feed_package gSpotx2f packages-openwrt current internet-detector yn hidden disabled

    feed_package_release lisaac luci-app-diskman yn hidden disabled

    feed_package_release jerrykuku luci-theme-argon yn hidden disabled
    
    # install_package list
}

#########################################################################
# ÂàùÊúüË®≠ÂÆö
#########################################################################
# Ê®©ÈôêË®≠ÂÆö
chmod_aios() {

    echo "$(color magenta "Setting permissions for $BIN_PATH")"

    if ! chmod +x "$BIN_PATH"; then
        debug_log "ERROR" "Failed to set permissions for $BIN_PATH"
        return 1
    fi
}

# ÂàùÊúüÂåñÂá¶ÁêÜ
delete_aios() {
    debug_log "ERROR" "Deleting $BASE_DIR"
    if ! rm -rf "${BASE_DIR}"; then
        debug_log "ERROR" "Failed to delete $BASE_DIR"
        return 1
    fi
}

# ÂøÖË¶Å„Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê
make_directory() {

    echo "$(color magenta "Creating required directories")"

    if ! mkdir -p "${BASE_DIR}" "$CACHE_DIR" "$LOG_DIR" "$FEED_DIR"; then
        debug_log "ERROR" "Failed to create required directories"
        return 1
    fi
}

check_update() {
    # Á¢∫ÂÆü„Å´„Ç≠„É£„ÉÉ„Ç∑„É•„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç
    mkdir -p "$CACHE_DIR" 2>/dev/null

    # „Ç¢„ÉÉ„Éó„Éá„Éº„ÉàÂæå„ÅÆÁâπÊÆäÂá¶ÁêÜ
    POST_UPDATE="false"
    if [ -f "${CACHE_DIR}/post_update_flag" ]; then
        POST_UPDATE="true"
        rm -f "${CACHE_DIR}/post_update_flag"
        debug_log "DEBUG" "Post-update detected, continuing with normal execution"
        MODE="full"  # Êõ¥Êñ∞Âæå„ÅØÊ®ôÊ∫ñ„É¢„Éº„Éâ„Å´Ë®≠ÂÆö
        return 0
    fi

    # „Ç¢„ÉÉ„Éó„Éá„Éº„ÉàÁä∂ÊÖã„Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç
    if [ ! -f "$UPDATE_CACHE" ]; then
        # ÂàùÂõûÂÆüË°å: „Ç¢„ÉÉ„Éó„Éá„Éº„Éà„É¢„Éº„Éâ„Çí„Çª„ÉÉ„Éà
        debug_log "DEBUG" "First run detected, setting update mode"
        MODE="update"
        # Áä∂ÊÖã„Éï„Ç°„Ç§„É´‰ΩúÊàêÔºà„Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÇíË®òÈå≤Ôºâ
        echo "$SCRIPT_VERSION" > "$UPDATE_CACHE" || debug_log "WARN" "Could not create $UPDATE_CACHE"
    else
        # ÂÜçÂÆüË°å: „Ç¢„ÉÉ„Éó„Éá„Éº„Éà„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        local cached_version=$(cat "$UPDATE_CACHE" 2>/dev/null || echo "unknown")
        if [ "$cached_version" != "$SCRIPT_VERSION" ]; then
            debug_log "DEBUG" "Version changed from $cached_version to $SCRIPT_VERSION"
            # „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            echo "$SCRIPT_VERSION" > "$UPDATE_CACHE" || debug_log "WARN" "Could not update $UPDATE_CACHE"
        fi
        # ÂºïÊï∞„ÅßÊòéÁ§∫ÁöÑ„Å™„É¢„Éº„ÉâÊåáÂÆö„Åå„Å™„Åë„Çå„Å∞full„Çí„Éá„Éï„Ç©„É´„Éà„Å´
        [ -z "$MODE" ] && MODE="full"
    fi

    # Â∏∏„Å´ÊàêÂäü„ÇíËøî„ÅôÔºà„Ç®„É©„Éº„Åå„ÅÇ„Å£„Å¶„ÇÇÂá¶ÁêÜ„ÇíÁ∂ôÁ∂öÔºâ
    return 0
}

# ÂàùÊúüÂåñÂá¶ÁêÜ„ÇíÂÆüË°å
initialization() {
    # ÂÆüË°åÊ®©Èôê„ÇíË®≠ÂÆö
    if ! chmod_aios; then
        debug_log "ERROR" "Failed to set execute permission"
        return 1
    fi

    # ÂøÖË¶Å„Å™„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí‰ΩúÊàê
    if ! make_directory; then
        debug_log "ERROR" "Failed to create required directories"
        return 1
    fi

    check_update || debug_log "WARN" "Update check had issues, continuing anyway"
    return 0
}

#########################################################################
# Last Update: 2025-02-15 10:00:00 (JST) üöÄ
# check_option: „Ç≥„Éû„É≥„Éâ„É©„Ç§„É≥„Ç™„Éó„Ç∑„Éß„É≥Ëß£Êûê„ÉªÊ≠£Ë¶èÂåñÈñ¢Êï∞
#
# „ÄêÊ¶ÇË¶Å„Äë
# „Åì„ÅÆÈñ¢Êï∞„ÅØ„ÄÅaios Ëµ∑ÂãïÊôÇ„Å´Ê∏°„Åï„Çå„Åü„Ç≥„Éû„É≥„Éâ„É©„Ç§„É≥ÂºïÊï∞„ÇíËß£Êûê„Åó„ÄÅ
# „ÉÄ„ÉÉ„Ç∑„É•‰ªò„Åç„ÅÆÂºïÊï∞„ÅØ„Ç™„Éó„Ç∑„Éß„É≥„Å®„Åó„Å¶Ëß£Êûê„ÄÅÈùû„ÉÄ„ÉÉ„Ç∑„É•ÂºïÊï∞„ÅØ„Åô„Åπ„Å¶
# Ë®ÄË™û„Ç™„Éó„Ç∑„Éß„É≥„Å®„Åó„Å¶Êâ±„ÅÑ„ÄÅÊúÄÂàù„Å´Ë¶ã„Å§„Åã„Å£„ÅüÂÄ§„Çí SELECTED_LANGUAGE „Å´Ë®≠ÂÆö„Åó„Åæ„Åô„ÄÇ
#
# ‚Äª MODE „ÅÆÊåáÂÆö„ÅØÂøÖ„Åö„ÉÄ„ÉÉ„Ç∑„É•‰ªò„Åç„ÅßË°å„ÅÑ„ÄÅ‰ª•‰∏ã„ÅÆÂêÑ„Éë„Çø„Éº„É≥„ÇíÂèó„Åë‰ªò„Åë„Åæ„Åô„ÄÇ
#     common_full  : -cf, --cf, -common_full, --common_full  ‚Üí MODE="full"
#     common_light : -cl, --cl, -ocommon_light, --ocommon_light ‚Üí MODE="light"
#     common_debug : -cd, --cd, -common_debug, --common_debug, --ocommon_debug ‚Üí MODE="debug"
#     reset        : -r, --r, -reset, --reset, -resrt, --resrt ‚Üí MODE="reset" „Åä„Çà„Å≥ RESET="true"
#
# „ÄêÂØæÂøú„Ç™„Éó„Ç∑„Éß„É≥„Äë
#  - „Éò„É´„Éó:         -h, --h, -help, --help, -?, --?  
#  - „Éê„Éº„Ç∏„Éß„É≥:     -v, --v, -version, --version  
#  - „Éá„Éê„ÉÉ„Ç∞:       -d, --d, -debug, --debug, -d1, --d1  
#                     ‚Üí DEBUG_MODE="true", DEBUG_LEVEL="DEBUG"
#                   -d2, --d2, -debug2, --debug2  
#                     ‚Üí DEBUG_MODE="true", DEBUG_LEVEL="DEBUG2"
#  - „É¢„Éº„ÉâÊåáÂÆö:
#       - full:       -cf, --cf, -common_full, --common_full  ‚Üí MODE="full"
#       - light:      -cl, --cl, -ocommon_light, --ocommon_light ‚Üí MODE="light"
#       - debug:      -cd, --cd, -common_debug, --common_debug, --ocommon_debug ‚Üí MODE="debug"
#       - reset:      -r, --r, -reset, --reset, -resrt, --resrt ‚Üí MODE="reset", RESET="true"
#  - Âº∑Âà∂ÂÆüË°å:       -f, --f, -force, --force  ‚Üí FORCE="true"
#  - „Éâ„É©„Ç§„É©„É≥:     -dr, --dr, -dry-run, --dry-run  ‚Üí DRY_RUN="true"
#  - „É≠„Ç∞Âá∫ÂäõÂÖà:     -l, --l, -logfile, --logfile <path>  ‚Üí LOGFILE „Å´ÊåáÂÆö„Éë„Çπ
#
# „Äê‰ªïÊßò„Äë
# 1. „ÉÄ„ÉÉ„Ç∑„É•‰ªò„Åç„ÅÆÂºïÊï∞„ÅØ„Ç™„Éó„Ç∑„Éß„É≥„Å®„Åó„Å¶Ëß£Êûê„Åó„ÄÅÈùû„ÉÄ„ÉÉ„Ç∑„É•ÂºïÊï∞„ÅØ„Åô„Åπ„Å¶ SELECTED_LANGUAGE „Å®„Åó„Å¶Êâ±„ÅÑ„Åæ„Åô„ÄÇ
# 2. Ëß£ÊûêÁµêÊûú„ÅØ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ SELECTED_LANGUAGE, DEBUG_MODE, DEBUG_LEVEL, MODE, DRY_RUN, LOGFILE, FORCE, RESET, HELP „Å®„Åó„Å¶„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åï„Çå„ÄÅ
#    ÂæåÁ∂ö„ÅÆ check_common(), select_country(), debug(), script_version() „Å™„Å©„Å´Ê≠£Ë¶èÂåñ„Åï„Çå„ÅüÂÄ§„Å®„Åó„Å¶Ê∏°„Åï„Çå„Åæ„Åô„ÄÇ
#
# „Äê‰ΩøÁî®‰æã„Äë
#   sh aios.sh -d --dry-run --reset -l /var/log/aios.log -f -cf en
#    ‚Üí Ë®ÄË™û "en" „Åå SELECTED_LANGUAGE „Å´Ë®≠ÂÆö„Åï„Çå„ÄÅMODE „ÅØ "full"Ôºà-cfÁ≠â„ÅßÊåáÂÆöÔºâ„ÄÅ„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊúâÂäπ„ÄÅ
#       „Ç≠„É£„ÉÉ„Ç∑„É•„É™„Çª„ÉÉ„Éà„ÄÅ„Éâ„É©„Ç§„É©„É≥„ÄÅ„É≠„Ç∞Âá∫ÂäõÂÖà /var/log/aios.log„ÄÅÂº∑Âà∂ÂÆüË°å„ÅåÊúâÂäπ„Å´„Å™„Çã„ÄÇ
#########################################################################
check_option() {

    echo "$(color magenta "check_option received before args: $*")"

    # „Éá„Éï„Ç©„É´„ÉàÂÄ§„ÅÆË®≠ÂÆö
    SELECTED_LANGUAGE=""
    DEBUG_MODE="false"
    DEBUG_LEVEL="INFO"
    DRY_RUN="false"
    LOGFILE=""
    FORCE="false"
    RESET="false"
    HELP="false"

    # Ë®ÄË™û„Åä„Çà„Å≥„Ç™„Éó„Ç∑„Éß„É≥ÂºïÊï∞„ÅÆÂá¶ÁêÜ
    while [ "$#" -gt 0 ]; do
        case "$1" in
            -h|--h|-help|--help|-\?|--\?)
                HELP="true"
                print_help
                exit 0
                ;;
            -v|--v|-version|--version)
                script_version
                exit 0
                ;;
            -d|--d|-debug|--debug|-d1|--d1)
                DEBUG_MODE="true"
                DEBUG_LEVEL="DEBUG"
                ;;
            -d2|--d2|-debug2|--debug2)
                DEBUG_MODE="true"
                DEBUG_LEVEL="DEBUG2"
                ;;
            -cf|--cf|-common_full|--common_full)
                MODE="full"
                ;;
            -cl|--cl|-ocommon_light|--ocommon_light)
                MODE="light"
                ;;
            -cd|--cd|-common_debug|--common_debug|--ocommon_debug)
                MODE="debug"
                ;;
            -r|--r|-reset|--reset|-resrt|--resrt)
                MODE="reset"
                RESET="true"
                ;;
            -f|--f|-force|--force)
                FORCE="true"
                ;;
            -dr|--dr|-dry-run|--dry-run)
                DRY_RUN="true"
                ;;
            -l|--l|-logfile|--logfile)
                if [ -n "$2" ] && [ "${2#-}" != "$2" ]; then
                    LOGFILE="$2"
                    shift
                else
                    echo "Error: --logfile requires a path argument"
                    exit 1
                fi
                ;;
	    -u|--u|-update|--update)
		debug_log "DEBUG" "check_option: aios update"
    		MODE="update"
    		;;
	    -t|--t|-token|--token)
		setup_github_token
		;;
	    -ts|--ts|--token-status)
    		check_token_status
    		exit 0
    		;;
            -*)
                echo "Warning: Unknown option: $1" >&2
                ;;
            *)
                if [ -z "$SELECTED_LANGUAGE" ]; then
                    SELECTED_LANGUAGE="$1"
                fi
                ;;
        esac
        shift
    done

    # Áí∞Â¢ÉÂ§âÊï∞„Å®„Åó„Å¶Ë®≠ÂÆö
    export SELECTED_LANGUAGE DEBUG_MODE DEBUG_LEVEL MODE DRY_RUN LOGFILE FORCE RESET HELP

    # „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÂá∫Âäõ
    debug_log "DEBUG" "check_option: MODE=$MODE, SELECTED_LANGUAGE=$SELECTED_LANGUAGE"
    debug_log "DEBUG" "check_option: DEBUG_MODE=$DEBUG_MODE, DEBUG_LEVEL=$DEBUG_LEVEL"
    debug_log "DEBUG" "check_option: DRY_RUN=$DRY_RUN, LOGFILE=$LOGFILE"
    debug_log "DEBUG" "check_option: FORCE=$FORCE, RESET=$RESET, HELP=$HELP"

    # Ë®≠ÂÆö„Åï„Çå„ÅüË®ÄË™û„Çí `check_common()` „Å´Ê∏°„Åô
    check_common "$SELECTED_LANGUAGE" "$MODE"
}

#########################################################################
# Last Update: 2025-02-16 21:45:00 (JST) üöÄ
# "Ensuring seamless updates, one script at a time."
#
# „ÄêË¶Å‰ª∂„Äë
# 1. `download_script()` „Çí `download()` „Å´Áµ±Âêà„Åó„ÄÅ‰∏ÄË≤´ÊÄß„ÇíÁ¢∫‰øù„Åô„Çã„ÄÇ
# 2. `debug_log()` „ÇíÂº∑Âåñ„Åó„ÄÅ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁä∂Ê≥Å„ÇíË©≥Á¥∞„Å´Ë®òÈå≤„ÄÇ
# 3. `download()` „ÅÆ„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÇíË¶ãÁõ¥„Åó„ÄÅÂ§±ÊïóÊôÇ„ÅÆÊåôÂãï„ÇíÊîπÂñÑ„ÄÇ
# 4. `openwrt.db`, `messages.db`, `country.db`, `packages.db` „ÇíÈÅ©Âàá„Å´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÄÇ
# 5. ÂΩ±ÈüøÁØÑÂõ≤: `common.sh`ÔºàÁüõÁõæ„Å™„ÅèÈÅ©Áî®Ôºâ„ÄÇ
#########################################################################
check_common() {
    local lang_code="$1"
    local mode="$2"

    debug_log "DEBUG" "check_common: MODE=$MODE"
    debug_log "DEBUG" "check_common: mode=$mode"

    if [ -n "$mode" ]; then
        MODE="$mode"
    fi

    # „É¢„Éº„Éâ„Åî„Å®„ÅÆÂá¶ÁêÜ
    case "$MODE" in
        reset)
            rm -f "${CACHE_DIR}/country.ch" \
                  "${CACHE_DIR}/language.ch" \
                  "${CACHE_DIR}/luci.ch" \
                  "${CACHE_DIR}/zone.ch" \
                  "${CACHE_DIR}/zonename.ch" \
                  "${CACHE_DIR}/timezone.ch" \
                  "${CACHE_DIR}/country_success_done" \
                  "${CACHE_DIR}/timezone_success_done"
            echo "$(get_message "MSG_RESET_COMPLETE")"
            exit 0
            ;;
        update)
	    download "aios" "hidden" "chmod"
	    if [ ! -f "${CACHE_DIR}/post_update_flag" ]; then
		MODE="full"
		check_common "$lang_code" "$MODE" "$@"
	    else
		MODE="full"
		exec "$BIN_PATH" $(echo "$@" | sed 's/update//g' | sed 's/--update//g' | sed 's/-u//g' | sed 's/--u//g')
	    fi
	    ;;
        debug)
            download "common-country.sh" "hidden"
            download "common-package.sh" "hidden"
            download "common-feed-package.sh" "hidden"
            download "messages.db" "hidden"
            download "openwrt.db" "hidden"
            download "country.db" "hidden"
            download "local-package.db" "hidden"
            download "custom-package.db" "hidden"
            check_openwrt
            check_architecture
            check_downloader
            print_banner
            select_country "$lang_code"
            download "hidden" "system-config.sh" "chmod" "read"
            #packages
            ;;
        light)
            download "common-country.sh"
            download "common-package.sh"
            download "common-feed-package.sh"
            download "messages.db"
            download "openwrt.db"
            download "country.db"
            download "local-package.db"
            download "custom-package.db"
            check_openwrt
            check_architecture
            check_downloader
            print_banner
            select_country "$lang_code"
            download "hidden" "system-config.sh" "chmod" "read"
            #packages
            ;;
        full)
            download "common-country.sh"
            download "common-package.sh"
            download "common-feed-package.sh"
            download "messages.db"
            download "openwrt.db"
            download "country.db"
            download "local-package.db"
            download "custom-package.db"
            check_openwrt
            check_architecture
            check_downloader
            print_banner
            select_country "$lang_code"
            download "system-config.sh" "chmod" "read"
            #packages
            ;;
        return)
            rm -f "${CACHE_DIR}/country.ch" \
                  "${CACHE_DIR}/language.ch" \
                  "${CACHE_DIR}/luci.ch" \
                  "${CACHE_DIR}/zone.ch" \
                  "${CACHE_DIR}/zonename.ch" \
                  "${CACHE_DIR}/timezone.ch" \
                  "${CACHE_DIR}/country_success_done" \
                  "${CACHE_DIR}/timezone_success_done"
            select_country
            ;;
	test_api)
	    #wget -q -O /tmp/aios/github_api_test.sh "https://raw.githubusercontent.com/site-u2023/aios/main/github_api_test.sh"
	    BASE_WGET "$BASE_DIR"/github_api_test.sh "$BASE_URL"/github_api_test.sh
	    chmod +x /tmp/aios/github_api_test.sh
	    sh /tmp/aios/github_api_test.sh
	    ;;
        *)
            ;;
    esac
}

# „É°„Ç§„É≥Âá¶ÁêÜ
main() {
    initialization
    check_option "$@"
}

# üî¥„ÄÄ„É°„Ç§„É≥„ÄÄ„Åì„Åì„Åæ„Åß„ÄÄüî¥„ÄÄ-------------------------------------------------------------------------------------------------------------------------------------------

# „Çπ„ÇØ„É™„Éó„ÉàÂÆüË°å
main "$@"
